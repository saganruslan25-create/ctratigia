<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–°–¢–†–ê–¢–ï–ì–Ü–Ø | –û–ü–ï–†–ê–¶–Ü–Ø –î–ù–Ü–ü–†–û</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Oswald:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#040608;--panel:#080c10;--border:rgba(34,197,94,.18);
  --green:#22c55e;--green2:#4ade80;--red:#ef4444;--blue:#3b82f6;
  --gold:#f59e0b;--teal:#14b8a6;--purple:#a855f7;--water:#1e40af;
  --text:#e2e8f0;--dim:#64748b;--dark:#020305;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;height:100vh;overflow:hidden;user-select:none;}
input,select,textarea{user-select:text!important;-webkit-user-select:text!important;}
.screen{position:fixed;inset:0;display:none;z-index:100;}
.screen.active{display:flex;}

/* ‚îÄ‚îÄ MENU ‚îÄ‚îÄ */
#screen-menu{flex-direction:column;align-items:center;justify-content:center;
  background:radial-gradient(ellipse at 20% 30%,rgba(34,197,94,.07) 0%,transparent 50%),
             radial-gradient(ellipse at 80% 70%,rgba(59,130,246,.05) 0%,transparent 50%),var(--bg);}
.menu-bg-grid{position:absolute;inset:0;
  background-image:linear-gradient(rgba(34,197,94,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(34,197,94,.04) 1px,transparent 1px);
  background-size:40px 40px;mask-image:radial-gradient(ellipse at center,black 40%,transparent 80%);}
.menu-logo{position:relative;z-index:1;text-align:center;margin-bottom:40px;}
.menu-logo-top{font-family:'Oswald',sans-serif;font-size:11px;font-weight:400;color:var(--green);letter-spacing:8px;margin-bottom:8px;opacity:.7;}
.menu-logo-title{font-family:'Oswald',sans-serif;font-size:56px;font-weight:700;line-height:.9;letter-spacing:2px;
  background:linear-gradient(135deg,#fff 30%,var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.menu-logo-sub{font-size:12px;color:var(--dim);letter-spacing:4px;margin-top:10px;}
.menu-user{position:relative;z-index:1;margin-bottom:20px;padding:8px 20px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:20px;
  font-size:11px;color:var(--dim);display:flex;align-items:center;gap:8px;}
.menu-user-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-family:'Oswald',sans-serif;letter-spacing:1px;}
.badge-admin{background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3);}
.badge-anon{background:rgba(100,116,139,.1);color:var(--dim);border:1px solid rgba(100,116,139,.2);}
.menu-btns{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;width:320px;}
.mbtn{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);color:var(--text);
  font-family:'Oswald',sans-serif;font-size:15px;font-weight:500;letter-spacing:2px;padding:13px 24px;
  cursor:pointer;transition:all .2s;text-align:left;position:relative;overflow:hidden;border-radius:4px;}
.mbtn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);transform:scaleY(0);transition:transform .2s;}
.mbtn:hover{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);color:#fff;}
.mbtn:hover::before{transform:scaleY(1);}
.mbtn .mico{margin-right:14px;font-size:16px;}
.mbtn.primary{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4);color:var(--green2);}
.mbtn.primary:hover{background:rgba(34,197,94,.2);}
.mbtn.admin-btn{background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.2);color:var(--gold);}
.mbtn.admin-btn:hover{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.4);}
.menu-auth-btns{position:relative;z-index:1;display:flex;gap:8px;margin-top:8px;}
.menu-ver{position:absolute;bottom:16px;right:20px;font-size:10px;color:#1a2a1a;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;
  align-items:center;justify-content:center;z-index:8000;backdrop-filter:blur(6px);}
.modal-overlay.vis{display:flex;}
.modal-box{background:rgba(8,12,16,.98);border:1px solid var(--border);border-radius:12px;
  padding:28px;width:100%;max-width:480px;margin:16px;}
.modal-title{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:var(--green2);letter-spacing:2px;margin-bottom:20px;}
.modal-tabs{display:flex;gap:0;margin-bottom:20px;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;}
.modal-tab{flex:1;padding:9px;text-align:center;cursor:pointer;font-family:'Oswald',sans-serif;
  font-size:13px;font-weight:600;letter-spacing:1px;color:var(--dim);transition:.2s;}
.modal-tab.active{background:rgba(34,197,94,.12);color:var(--green2);}
.modal-tab-content{display:none;}
.modal-tab-content.active{display:block;}

/* AI MODE SELECTION */
.ai-mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.ai-mode-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;
  padding:16px;cursor:pointer;transition:.2s;text-align:center;}
.ai-mode-card:hover{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.05);}
.ai-mode-card.selected{border-color:var(--green);background:rgba(34,197,94,.1);}
.ai-mode-card.red-mode:hover,.ai-mode-card.red-mode.selected{border-color:var(--red);background:rgba(239,68,68,.08);}
.ai-mode-emoji{font-size:32px;margin-bottom:8px;}
.ai-mode-title{font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:#fff;margin-bottom:4px;}
.ai-mode-desc{font-size:10px;color:var(--dim);line-height:1.5;}
.ai-team-sel{display:flex;gap:8px;margin-bottom:14px;}
.ai-team-btn{flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,.1);
  font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:.2s;text-align:center;}
.ai-team-btn.blue-team{background:rgba(59,130,246,.08);color:#60a5fa;border-color:rgba(59,130,246,.3);}
.ai-team-btn.blue-team.selected{background:rgba(59,130,246,.25);border-color:#3b82f6;}
.ai-team-btn.red-team{background:rgba(239,68,68,.08);color:#f87171;border-color:rgba(239,68,68,.3);}
.ai-team-btn.red-team.selected{background:rgba(239,68,68,.25);border-color:#ef4444;}

/* ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ */
.lobby-box{background:rgba(8,12,16,.9);border:1px solid var(--border);border-radius:12px;padding:28px;width:100%;max-width:480px;}
.lobby-title{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:var(--green2);letter-spacing:2px;margin-bottom:20px;}
.lobby-code-display{background:rgba(34,197,94,.08);border:2px solid rgba(34,197,94,.3);border-radius:8px;padding:18px;text-align:center;margin-bottom:16px;}
.lcd-label{font-size:10px;color:var(--dim);letter-spacing:3px;margin-bottom:6px;}
.lcd-code{font-family:'Oswald',sans-serif;font-size:40px;font-weight:700;color:var(--green);letter-spacing:8px;}
.lcd-sub{font-size:11px;color:var(--dim);margin-top:4px;}
.lobby-players{display:flex;gap:10px;margin-bottom:16px;}
.lp-slot{flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:12px;text-align:center;}
.lp-slot.filled{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);}
.lp-slot.p1{border-color:rgba(59,130,246,.3);background:rgba(59,130,246,.05);}
.lps-icon{font-size:22px;margin-bottom:4px;}
.lps-label{font-size:10px;color:var(--dim);letter-spacing:2px;}
.lps-name{font-size:12px;font-weight:700;margin-top:3px;color:#fff;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.form-row{display:flex;gap:8px;margin-bottom:10px;}
.form-input{flex:1;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);color:#fff;
  padding:9px 13px;border-radius:6px;font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;transition:.2s;}
.form-input:focus{border-color:var(--green);}
.form-label{font-size:10px;color:var(--dim);letter-spacing:2px;margin-bottom:5px;display:block;}
.btn-primary{background:var(--green);color:#000;border:none;padding:10px 18px;border-radius:6px;
  font-family:'Oswald',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;white-space:nowrap;}
.btn-primary:hover{background:var(--green2);}
.btn-secondary{background:transparent;color:var(--dim);border:1px solid rgba(255,255,255,.1);padding:10px 18px;
  border-radius:6px;font-family:'Oswald',sans-serif;font-weight:600;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;}
.btn-secondary:hover{border-color:rgba(255,255,255,.3);color:#fff;}
.btn-gold{background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3);padding:10px 18px;
  border-radius:6px;font-family:'Oswald',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;}
.btn-gold:hover{background:rgba(245,158,11,.25);}
.status-box{padding:7px 12px;border-radius:6px;font-size:11px;margin-bottom:10px;display:none;}
.status-box.vis{display:block;}
.status-box.ok{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:var(--green2);}
.status-box.err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#f87171;}
.status-box.warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--gold);}
.lobby-map-section{border-top:1px solid rgba(255,255,255,.06);padding-top:14px;margin-top:4px;}
.lms-title{font-size:10px;color:var(--dim);letter-spacing:3px;margin-bottom:8px;}
.map-upload-area{border:2px dashed rgba(255,255,255,.1);border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:.2s;}
.map-upload-area:hover{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.03);}
.map-preview{width:100%;height:70px;object-fit:cover;border-radius:6px;border:1px solid var(--border);display:none;}
.map-saved-list{display:flex;flex-direction:column;gap:6px;max-height:120px;overflow-y:auto;}
.map-saved-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);cursor:pointer;transition:.2s;}
.map-saved-item:hover,.map-saved-item.active{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);}
.msi-thumb{width:40px;height:28px;object-fit:cover;border-radius:4px;flex-shrink:0;}
.msi-info{flex:1;}
.msi-name{font-size:12px;font-weight:700;color:#fff;}
.msi-date{font-size:10px;color:var(--dim);}

/* ‚îÄ‚îÄ DISCONNECT BANNER ‚îÄ‚îÄ */
.disconnect-banner{position:fixed;top:0;left:0;right:0;z-index:7000;
  background:rgba(239,68,68,.95);padding:12px 20px;
  display:none;flex-direction:column;align-items:center;gap:6px;
  border-bottom:2px solid #f87171;}
.disconnect-banner.vis{display:flex;}
.dc-title{font-family:'Oswald',sans-serif;font-size:16px;font-weight:700;color:#fff;letter-spacing:2px;}
.dc-timer{font-family:'Oswald',sans-serif;font-size:28px;font-weight:700;color:#fff;}
.dc-sub{font-size:11px;color:rgba(255,255,255,.8);}

/* ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ */
#screen-admin{flex-direction:column;background:var(--bg);}
.admin-header{height:52px;background:rgba(8,12,16,.98);border-bottom:1px solid rgba(245,158,11,.2);
  display:flex;align-items:center;padding:0 20px;gap:14px;flex-shrink:0;}
.admin-title{font-family:'Oswald',sans-serif;font-size:18px;font-weight:700;color:var(--gold);letter-spacing:3px;}
.admin-body{flex:1;display:flex;gap:0;overflow:hidden;}
.admin-sidebar{width:200px;background:rgba(4,6,8,.8);border-right:1px solid rgba(255,255,255,.06);
  padding:16px;display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.admin-nav-btn{padding:9px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--dim);
  transition:.2s;border:1px solid transparent;}
.admin-nav-btn:hover,.admin-nav-btn.active{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.2);color:var(--gold);}
.admin-content{flex:1;padding:20px;overflow-y:auto;}
.admin-section{display:none;}
.admin-section.active{display:block;}
.admin-card{background:rgba(8,12,16,.8);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:20px;margin-bottom:16px;}
.admin-card-title{font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;color:var(--gold);letter-spacing:2px;margin-bottom:14px;}
.admin-maps-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
.admin-map-card{border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;cursor:pointer;
  transition:.2s;background:rgba(0,0,0,.3);}
.admin-map-card:hover{border-color:rgba(245,158,11,.4);}
.admin-map-card.active-map{border-color:var(--green);box-shadow:0 0 12px rgba(34,197,94,.2);}
.amc-img{width:100%;height:100px;object-fit:cover;}
.amc-info{padding:8px 10px;}
.amc-name{font-size:12px;font-weight:700;color:#fff;margin-bottom:3px;}
.amc-meta{font-size:10px;color:var(--dim);}
.amc-actions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}
.amc-btn{flex:1;padding:4px 8px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:10px;
  font-weight:700;letter-spacing:1px;cursor:pointer;border:none;transition:.2s;white-space:nowrap;}
.amc-btn.set{background:rgba(34,197,94,.2);color:var(--green2);}
.amc-btn.set:hover{background:var(--green);color:#000;}
.amc-btn.del{background:rgba(239,68,68,.1);color:#f87171;}
.amc-btn.del:hover{background:var(--red);color:#fff;}
.amc-btn.edit{background:rgba(59,130,246,.15);color:#60a5fa;}
.amc-btn.edit:hover{background:var(--blue);color:#fff;}

/* ‚îÄ‚îÄ MAP EDITOR ‚îÄ‚îÄ */
.map-editor-wrap{display:flex;gap:16px;height:100%;}
.map-editor-canvas-wrap{flex:1;position:relative;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;background:#111;}
#adminMapCanvas{width:100%;height:100%;display:block;}
.map-editor-tools{width:200px;flex-shrink:0;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
.tool-btn{padding:8px 12px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;
  letter-spacing:1px;cursor:pointer;border:1px solid rgba(255,255,255,.1);color:var(--dim);background:transparent;transition:.2s;width:100%;}
.tool-btn:hover,.tool-btn.active{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3);color:var(--gold);}
.color-row{display:flex;gap:4px;flex-wrap:wrap;}
.color-swatch{width:24px;height:24px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:.15s;}
.color-swatch:hover,.color-swatch.active{border-color:#fff;}
.editor-sep{height:1px;background:rgba(255,255,255,.06);margin:4px 0;}

/* ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ */
#screen-game{flex-direction:column;}
.game-hud{height:46px;background:rgba(4,6,8,.97);border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0;position:relative;z-index:50;}
.hud-logo{font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;color:var(--green);letter-spacing:2px;flex-shrink:0;}
.hud-sep{width:1px;height:18px;background:rgba(255,255,255,.08);}
.hud-stat{display:flex;align-items:center;gap:5px;font-size:11px;}
.hud-stat-label{color:var(--dim);font-size:9px;letter-spacing:1px;}
.hud-stat-val{font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;}
.hud-stat-val.blue{color:#60a5fa;}
.hud-stat-val.red{color:#f87171;}
.hud-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;flex-direction:column;}
.hud-timer{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:#fff;letter-spacing:2px;}
.hud-turn{font-size:9px;color:var(--dim);letter-spacing:2px;}
.hud-right{margin-left:auto;display:flex;align-items:center;gap:6px;}
.hud-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);color:var(--text);
  padding:4px 10px;border-radius:5px;font-family:'Oswald',sans-serif;font-size:10px;font-weight:600;
  letter-spacing:1px;cursor:pointer;transition:.2s;}
.hud-btn:hover{border-color:rgba(34,197,94,.4);color:var(--green2);}
.hud-btn.danger:hover{border-color:rgba(239,68,68,.4);color:#f87171;}

/* GAME BODY - FIXED: no black walls */
.game-body{flex:1;display:flex;overflow:hidden;position:relative;background:#06090d;}
#mapCanvas,#unitsCanvas,#frontCanvas,#uiCanvas,#interCanvas{position:absolute;top:0;left:0;}
#interCanvas{touch-action:none;}
#unitsCanvas,#frontCanvas,#uiCanvas{pointer-events:none;}

.side-panel{width:220px;min-width:220px;background:rgba(4,6,8,.97);border-left:1px solid var(--border);
  display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;position:relative;z-index:10;}
.sp-section{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);}
.sp-label{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:7px;}
.sp-unit-btn{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:6px;
  background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);cursor:pointer;transition:.2s;margin-bottom:4px;}
.sp-unit-btn:hover,.sp-unit-btn.active{background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.3);}
.sp-unit-btn.active{border-color:var(--blue);}
.sp-unit-icon{font-size:16px;width:22px;text-align:center;}
.sp-unit-info{flex:1;}
.sp-unit-name{font-size:11px;font-weight:700;color:#fff;}
.sp-unit-stat{font-size:9px;color:var(--dim);}
.sp-unit-cost{font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;color:var(--gold);}
.sp-resources{display:flex;flex-direction:column;gap:5px;}
.sp-res-row{display:flex;justify-content:space-between;align-items:center;}
.sp-res-label{font-size:9px;color:var(--dim);}
.sp-res-val{font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;}
.sp-log{flex:1;overflow-y:auto;padding:6px 10px;display:flex;flex-direction:column;gap:2px;}
.log-entry{font-size:10px;color:var(--dim);line-height:1.4;padding:2px 0;}
.log-entry.good{color:#4ade80;}.log-entry.bad{color:#f87171;}.log-entry.info{color:#60a5fa;}.log-entry.warn{color:var(--gold);}

/* Cities HUD */
.cities-hud{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.04);}
.city-row{display:flex;align-items:center;gap:5px;padding:3px 0;font-size:10px;}
.city-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.city-dot.blue{background:#3b82f6;}.city-dot.red{background:#ef4444;}.city-dot.neutral{background:#64748b;}
.city-name{flex:1;color:var(--dim);}
.city-income{font-family:'Oswald',sans-serif;font-size:10px;font-weight:700;color:var(--gold);}

.placement-hint{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);
  background:rgba(4,6,8,.95);border:1px solid rgba(34,197,94,.4);border-radius:8px;
  padding:8px 18px;font-size:12px;color:var(--green2);pointer-events:none;z-index:100;
  display:none;letter-spacing:1px;font-family:'Oswald',sans-serif;}
.placement-hint.vis{display:block;}
.casualties-overlay{position:absolute;bottom:14px;left:14px;
  background:rgba(4,6,8,.85);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:10px 14px;pointer-events:none;z-index:30;}
.co-title{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:5px;}
.co-row{display:flex;align-items:center;gap:10px;font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;}
.co-blue{color:#60a5fa;}.co-red{color:#f87171;}
.sel-info{position:absolute;top:8px;left:14px;background:rgba(4,6,8,.93);border:1px solid var(--border);
  border-radius:8px;padding:10px 14px;min-width:150px;pointer-events:none;z-index:30;display:none;}
.sel-info.vis{display:block;}
.si-name{font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;color:#fff;}
.si-hp-bar{height:4px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px;}
.si-hp-fill{height:100%;background:var(--green);border-radius:4px;transition:width .3s;}
.si-stats{display:flex;gap:8px;margin-top:5px;font-size:10px;color:var(--dim);}
.si-stat{display:flex;flex-direction:column;align-items:center;gap:1px;}
.si-stat b{font-family:'Oswald',sans-serif;font-size:12px;color:#fff;}
.zoom-ind{position:absolute;bottom:14px;right:234px;background:rgba(4,6,8,.8);border:1px solid rgba(255,255,255,.06);
  border-radius:6px;padding:4px 8px;font-size:10px;color:var(--dim);pointer-events:none;z-index:30;}
.result-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;flex-direction:column;
  align-items:center;justify-content:center;z-index:9000;backdrop-filter:blur(10px);}
.result-overlay.vis{display:flex;}
.result-box{background:rgba(8,12,16,.98);border:1px solid var(--border);border-radius:16px;padding:36px;text-align:center;max-width:420px;}
.result-emoji{font-size:58px;margin-bottom:14px;}
.result-title{font-family:'Oswald',sans-serif;font-size:34px;font-weight:700;letter-spacing:3px;margin-bottom:8px;}
.result-sub{font-size:13px;color:var(--dim);margin-bottom:22px;line-height:1.8;white-space:pre-line;}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(8,12,16,.97);
  border:1px solid var(--green);padding:9px 18px;border-radius:8px;font-size:12px;font-weight:700;
  color:var(--green2);z-index:9999;display:none;box-shadow:0 0 20px rgba(34,197,94,.2);white-space:nowrap;}
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;
  align-items:center;justify-content:center;z-index:9999;}
.loading-screen.hidden{display:none;}
.ld-title{font-family:'Oswald',sans-serif;font-size:30px;font-weight:700;color:var(--green);letter-spacing:4px;margin-bottom:18px;}
.ld-bar{width:180px;height:3px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;}
.ld-fill{height:100%;background:var(--green);animation:ldanim 1.4s ease-in-out infinite;}
@keyframes ldanim{0%{width:0;margin-left:0}50%{width:100%;margin-left:0}100%{width:0;margin-left:100%}}
.ld-text{margin-top:10px;font-size:10px;color:var(--dim);letter-spacing:2px;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:rgba(34,197,94,.2);border-radius:4px;}
/* Income tick animation */
@keyframes incomeFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-30px)}}
.income-float{position:absolute;font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;
  color:var(--gold);pointer-events:none;z-index:200;animation:incomeFloat 1.5s ease-out forwards;}
@media(max-width:700px){.side-panel{display:none;}.menu-logo-title{font-size:38px;}.menu-btns{width:90%;}}
</style>
</head>
<body>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="ld-title">–°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
  <div class="ld-bar"><div class="ld-fill"></div></div>
  <div class="ld-text" id="ldText">–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...</div>
</div>

<!-- DISCONNECT BANNER -->
<div class="disconnect-banner" id="dcBanner">
  <div class="dc-title">‚ö†Ô∏è –û–ü–û–ù–ï–ù–¢ –í–Ü–î–ö–õ–Æ–ß–ò–í–°–Ø</div>
  <div class="dc-timer" id="dcTimer">60</div>
  <div class="dc-sub">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è... –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —è–∫—â–æ –æ–ø–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—è</div>
</div>

<!-- MENU -->
<div class="screen" id="screen-menu">
  <div class="menu-bg-grid"></div>
  <div class="menu-logo">
    <div class="menu-logo-top">–û–ø–µ—Ä–∞—Ü—ñ—è</div>
    <div class="menu-logo-title">–°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
    <div class="menu-logo-sub">–¢–ê–ö–¢–ò–ß–ù–ê –ë–û–ô–û–í–ê –°–ò–°–¢–ï–ú–ê v3.0</div>
  </div>
  <div class="menu-user" id="menuUser">
    <span id="menuUserName">–ê–Ω–æ–Ω—ñ–º</span>
    <span class="menu-user-badge badge-anon" id="menuUserBadge">–ì–Ü–°–¢–¨</span>
  </div>
  <div class="menu-btns">
    <button class="mbtn primary" onclick="showLobbyCreate()"><span class="mico">‚öîÔ∏è</span>–°–¢–í–û–†–ò–¢–ò –õ–û–ë–Ü</button>
    <button class="mbtn" onclick="showLobbyJoin()"><span class="mico">üîó</span>–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>
    <button class="mbtn" onclick="showAIModeSelect()"><span class="mico">ü§ñ</span>–ü–†–û–¢–ò –Ü–Ü</button>
    <button class="mbtn admin-btn" id="adminMenuBtn" style="display:none" onclick="showScreen('screen-admin');adminNav('maps')"><span class="mico">üëë</span>–ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨</button>
  </div>
  <div class="menu-auth-btns">
    <button class="btn-secondary" id="authMenuBtn" onclick="showAuthModal()">üîê –£–≤—ñ–π—Ç–∏ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
    <button class="btn-secondary" id="logoutBtn" style="display:none" onclick="doLogout()">–í–∏–π—Ç–∏</button>
  </div>
  <div class="menu-ver">v3.0 | –°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
</div>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="authModal">
  <div class="modal-box">
    <div class="modal-title">üîê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø</div>
    <div class="modal-tabs">
      <div class="modal-tab active" onclick="switchAuthTab('login')">–£–í–Ü–ô–¢–ò</div>
      <div class="modal-tab" onclick="switchAuthTab('register')">–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</div>
    </div>
    <div class="modal-tab-content active" id="tab-login">
      <div id="loginStatus" class="status-box"></div>
      <div class="form-label">EMAIL</div>
      <div class="form-row"><input class="form-input" id="loginEmail" type="email" placeholder="email@example.com"></div>
      <div class="form-label">–ü–ê–†–û–õ–¨</div>
      <div class="form-row"><input class="form-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button class="btn-primary" onclick="doLogin()" style="flex:1">‚ñ∂ –£–í–Ü–ô–¢–ò</button>
        <button class="btn-secondary" onclick="closeAuthModal()">‚úï</button>
      </div>
    </div>
    <div class="modal-tab-content" id="tab-register">
      <div id="registerStatus" class="status-box"></div>
      <div class="form-label">–ü–û–ó–ò–í–ù–ò–ô</div>
      <div class="form-row"><input class="form-input" id="regName" placeholder="–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π" maxlength="20"></div>
      <div class="form-label">EMAIL</div>
      <div class="form-row"><input class="form-input" id="regEmail" type="email" placeholder="email@example.com"></div>
      <div class="form-label">–ü–ê–†–û–õ–¨</div>
      <div class="form-row"><input class="form-input" id="regPass" type="password" placeholder="–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤"></div>
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button class="btn-primary" onclick="doRegister()" style="flex:1">‚úÖ –ó–ê–†–ï–Ñ–°–¢–†–£–í–ê–¢–ò–°–¨</button>
        <button class="btn-secondary" onclick="closeAuthModal()">‚úï</button>
      </div>
    </div>
  </div>
</div>

<!-- AI MODE SELECT MODAL -->
<div class="modal-overlay" id="aiModeModal">
  <div class="modal-box" style="max-width:520px;">
    <div class="modal-title">ü§ñ –†–ï–ñ–ò–ú –ü–†–û–¢–ò –Ü–Ü</div>
    <div class="form-label" style="margin-bottom:10px;">–û–ë–ï–†–Ü–¢–¨ –í–ê–®–£ –°–¢–û–†–û–ù–£</div>
    <div class="ai-team-sel">
      <div class="ai-team-btn blue-team selected" id="teamBtnBlue" onclick="selectAITeam('blue')">üîµ –°–ò–ù–Ü</div>
      <div class="ai-team-btn red-team" id="teamBtnRed" onclick="selectAITeam('red')">üî¥ –ß–ï–†–í–û–ù–Ü</div>
    </div>
    <div class="form-label" style="margin-bottom:10px;">–û–ë–ï–†–Ü–¢–¨ –†–ï–ñ–ò–ú –ì–†–ò</div>
    <div class="ai-mode-grid">
      <div class="ai-mode-card selected" id="aimode-defense" onclick="selectAIMode('defense')">
        <div class="ai-mode-emoji">üõ°Ô∏è</div>
        <div class="ai-mode-title">–û–ë–û–†–û–ù–ê</div>
        <div class="ai-mode-desc">–ó–∞—Ö–∏—â–∞–π—Ç–µ —Å–≤–æ—ó –º—ñ—Å—Ç–∞ —Ç–∞ –±–∞–∑—É –≤—ñ–¥ –∞—Ç–∞–∫ –≤–æ—Ä–æ–∂–æ–≥–æ –Ü–Ü. –Ü–Ü –∞–∫—Ç–∏–≤–Ω–æ –∞—Ç–∞–∫—É—î —Ö–≤–∏–ª—è–º–∏.</div>
      </div>
      <div class="ai-mode-card" id="aimode-attack" onclick="selectAIMode('attack')">
        <div class="ai-mode-emoji">‚öîÔ∏è</div>
        <div class="ai-mode-title">–ù–ê–°–¢–£–ü</div>
        <div class="ai-mode-desc">–ê—Ç–∞–∫—É–π—Ç–µ –≤–æ—Ä–æ–∂—É –±–∞–∑—É —Ç–∞ –∑–∞—Ö–æ–ø–ª—é–π—Ç–µ –º—ñ—Å—Ç–∞. –Ü–Ü –æ–±–æ—Ä–æ–Ω—è—î—Ç—å—Å—è —Ç–∞ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É—î.</div>
      </div>
      <div class="ai-mode-card" id="aimode-blitz" onclick="selectAIMode('blitz')">
        <div class="ai-mode-emoji">‚ö°</div>
        <div class="ai-mode-title">–ë–õ–Ü–¶–ö–†–ò–ì</div>
        <div class="ai-mode-desc">–®–≤–∏–¥–∫–∞ –≥—Ä–∞: –∑–∞—Ö–æ–ø—ñ—Ç—å 3+ –º—ñ—Å—Ç–∞ –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω –∞–±–æ –∑–Ω–∏—â—ñ—Ç—å –±–∞–∑—É.</div>
      </div>
      <div class="ai-mode-card" id="aimode-conquest" onclick="selectAIMode('conquest')">
        <div class="ai-mode-emoji">üèÜ</div>
        <div class="ai-mode-title">–ó–ê–í–û–Æ–í–ê–ù–ù–Ø</div>
        <div class="ai-mode-desc">–ö–æ–Ω—Ç—Ä–æ–ª—å—Ç–µ –≤—Å—ñ –º—ñ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—ñ. –Ü–Ü –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Å–∫–ª–∞–¥–Ω—É —Ç–∞–∫—Ç–∏–∫—É.</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn-primary" onclick="startVsAI()" style="flex:1">‚ñ∂ –ü–û–ß–ê–¢–ò</button>
      <button class="btn-secondary" onclick="closeAIModeModal()">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>

<!-- LOBBY CREATE -->
<div class="screen" id="screen-lobby-create">
  <div class="lobby-box">
    <div class="lobby-title">‚öîÔ∏è –ù–û–í–ï –õ–û–ë–Ü</div>
    <div id="lcStatus" class="status-box vis warn">‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...</div>
    <div class="lobby-code-display">
      <div class="lcd-label">–ö–û–î –õ–û–ë–Ü</div>
      <div class="lcd-code" id="lcCode">----</div>
      <div class="lcd-sub">–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–º</div>
      <button onclick="copyLobbyCode()" style="margin-top:10px;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);color:var(--green2);padding:6px 20px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;cursor:pointer;width:100%;transition:.2s;">üìã –°–ö–û–ü–Ü–Æ–í–ê–¢–ò –ö–û–î</button>
    </div>
    <div class="lobby-players">
      <div class="lp-slot p1 filled">
        <div class="lps-icon">üîµ</div>
        <div class="lps-label">–°–ò–ù–Ü–ô</div>
        <div class="lps-name" id="lcP1Name">–í–∏</div>
      </div>
      <div class="lp-slot" id="lcP2Slot">
        <div class="lps-icon">‚è≥</div>
        <div class="lps-label">–ß–ï–†–í–û–ù–ò–ô</div>
        <div class="lps-name" id="lcP2Name">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div>
      </div>
    </div>
    <div class="lobby-map-section">
      <div class="lms-title">–ö–ê–†–¢–ê</div>
      <div id="lobbyGlobalMaps" class="map-saved-list" style="margin-bottom:10px;"></div>
      <input type="file" id="mapFileInput" accept="image/*" style="display:none" onchange="handleMapUpload(this)">
      <div class="map-upload-area" onclick="document.getElementById('mapFileInput').click()" id="mapUploadArea">
        <div style="font-size:22px;margin-bottom:4px">üìÅ</div>
        <div style="font-size:11px;color:var(--dim)">–ê–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤–æ—î —Ñ–æ—Ç–æ –∫–∞—Ä—Ç–∏</div>
      </div>
      <img id="mapPreview" class="map-preview" alt="">
      <div style="font-size:10px;color:var(--dim);margin-top:5px;text-align:center" id="mapUploadStatus"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="btn-primary" id="lcStartBtn" onclick="hostStartGame()" disabled style="flex:1">‚ñ∂ –°–¢–ê–†–¢</button>
      <button class="btn-secondary" onclick="leaveLobby()">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>

<!-- LOBBY JOIN -->
<div class="screen" id="screen-lobby-join">
  <div class="lobby-box">
    <div class="lobby-title">üîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</div>
    <div id="ljStatus" class="status-box vis warn">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ª–æ–±—ñ</div>
    <div class="form-row">
      <input type="text" class="form-input" id="joinCodeInput" placeholder="–ö–û–î –õ–û–ë–Ü"
        maxlength="8" style="text-transform:uppercase;letter-spacing:4px;font-size:18px;text-align:center">
    </div>
    <div class="form-row">
      <input type="text" class="form-input" id="joinNameInput" placeholder="–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π" maxlength="20">
    </div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn-primary" onclick="joinLobby()" style="flex:1">üîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>
      <button class="btn-secondary" onclick="showScreen('screen-menu')">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>

<!-- ADMIN PANEL -->
<div class="screen" id="screen-admin">
  <div class="admin-header">
    <span class="admin-title">üëë –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨</span>
    <div style="margin-left:auto;display:flex;gap:8px;">
      <button class="hud-btn" onclick="showScreen('screen-menu')">‚Üê –ú–ï–ù–Æ</button>
    </div>
  </div>
  <div class="admin-body">
    <div class="admin-sidebar">
      <div class="admin-nav-btn active" onclick="adminNav('maps')" id="anav-maps">üó∫Ô∏è –ö–∞—Ä—Ç–∏</div>
      <div class="admin-nav-btn" onclick="adminNav('editor')" id="anav-editor">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</div>
      <div class="admin-nav-btn" onclick="adminNav('users')" id="anav-users">üë• –ì—Ä–∞–≤—Ü—ñ</div>
    </div>
    <div class="admin-content">
      <!-- MAPS -->
      <div class="admin-section active" id="asec-maps">
        <div class="admin-card">
          <div class="admin-card-title">üó∫Ô∏è –ì–õ–û–ë–ê–õ–¨–ù–Ü –ö–ê–†–¢–ò</div>
          <p style="font-size:11px;color:var(--dim);margin-bottom:14px;">–ö–∞—Ä—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å—ñ–º –≥—Ä–∞–≤—Ü—è–º. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –†–ï–î–ê–ì–£–í–ê–¢–ò —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –º—ñ—Å—Ç–∞, –≤–æ–¥—É —Ç–∞ –º–æ—Å—Ç–∏.</p>
          <div style="display:flex;gap:8px;margin-bottom:14px;">
            <input type="file" id="adminMapUpload" accept="image/*" style="display:none" onchange="adminUploadMap(this)">
            <button class="btn-gold" onclick="document.getElementById('adminMapUpload').click()">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ä—Ç—É</button>
            <button class="btn-secondary" onclick="adminNav('editor')">‚úèÔ∏è –ù–æ–≤–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
          </div>
          <div id="adminMapsGrid" class="admin-maps-grid"></div>
          <div id="adminMapUploadStatus" style="font-size:11px;color:var(--dim);margin-top:8px;"></div>
        </div>
      </div>
      <!-- EDITOR -->
      <div class="admin-section" id="asec-editor">
        <div class="admin-card" style="height:calc(100vh - 160px);display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-shrink:0;flex-wrap:wrap;">
            <div class="admin-card-title" style="margin-bottom:0">‚úèÔ∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–ò</div>
            <span style="font-size:10px;color:var(--dim)">–ú–∞–ª—é–π—Ç–µ —Ç–µ—Ä–µ–Ω, –≤–æ–¥—É, –º–æ—Å—Ç–∏, –º—ñ—Å—Ç–∞, –±–∞–∑–∏</span>
            <div style="margin-left:auto;display:flex;gap:6px;">
              <input type="file" id="editorBgUpload" accept="image/*" style="display:none" onchange="loadEditorBackground(this)">
              <button class="tool-btn" style="width:auto;padding:5px 12px" onclick="document.getElementById('editorBgUpload').click()">üì∑ –§–æ—Ç–æ –æ—Å–Ω–æ–≤–∞</button>
              <button class="tool-btn" style="width:auto;padding:5px 12px" onclick="editorUndo()">‚Ü© –í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
            </div>
          </div>
          <div class="map-editor-wrap" style="flex:1;min-height:0;">
            <div class="map-editor-canvas-wrap" style="position:relative;">
              <canvas id="adminMapCanvas"></canvas>
              <div id="editorMarkers" style="position:absolute;top:0;left:0;pointer-events:none;"></div>
            </div>
            <div class="map-editor-tools">
              <div class="sp-label">–Ü–ù–°–¢–†–£–ú–ï–ù–¢</div>
              <button class="tool-btn active" onclick="setEditorTool('draw')" id="tool-draw">‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏</button>
              <button class="tool-btn" onclick="setEditorTool('erase')" id="tool-erase">üßπ –°—Ç–µ—Ä—Ç–∏</button>
              <button class="tool-btn" onclick="setEditorTool('fill')" id="tool-fill">ü™£ –ó–∞–ª–∏–≤–∫–∞</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–¢–ï–†–ï–ù</div>
              <button class="tool-btn" onclick="setEditorTool('water')" id="tool-water" style="color:#60a5fa">üåä –í–æ–¥–∞</button>
              <button class="tool-btn" onclick="setEditorTool('bridge')" id="tool-bridge" style="color:#a16207">üåâ –ú—ñ—Å—Ç</button>
              <button class="tool-btn" onclick="setEditorTool('forest')" id="tool-forest" style="color:#16a34a">üå≤ –õ—ñ—Å</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–†–û–ó–ú–Ü–©–ï–ù–ù–Ø</div>
              <button class="tool-btn" onclick="setEditorTool('city')" id="tool-city">üèôÔ∏è –ú—ñ—Å—Ç–æ</button>
              <button class="tool-btn" onclick="setEditorTool('base_blue')" id="tool-base_blue">üè† –ë–∞–∑–∞ –°–ò–ù–Ü–•</button>
              <button class="tool-btn" onclick="setEditorTool('base_red')" id="tool-base_red">üèöÔ∏è –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–ü–û–ß–ê–¢–ö–û–í–Ü –Æ–ù–Ü–¢–ò</div>
              <button class="tool-btn" onclick="setEditorTool('unit_blue')" id="tool-unit_blue">üîµ –Æ–Ω—ñ—Ç –°–ò–ù–Ü–•</button>
              <button class="tool-btn" onclick="setEditorTool('unit_red')" id="tool-unit_red">üî¥ –Æ–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•</button>
              <select id="editorUnitType" style="width:100%;margin-top:4px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.1);color:#fff;padding:5px 8px;border-radius:5px;font-size:11px;">
                <option value="infantry">üë• –ü—ñ—Ö–æ—Ç–∞</option>
                <option value="apc">üöõ –ë–¢–†</option>
                <option value="tank">üõ°Ô∏è –¢–∞–Ω–∫</option>
                <option value="heli">üöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
                <option value="artillery">üí• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è</option>
              </select>
              <div class="editor-sep"></div>
              <div class="sp-label">–ö–û–õ–Ü–† –ü–ï–ù–ó–õ–Ø</div>
              <div class="color-row" id="colorSwatches"></div>
              <div class="sp-label" style="margin-top:8px">–†–û–ó–ú–Ü–†: <span id="brushSizeVal">8</span></div>
              <input type="range" id="brushSize" min="2" max="60" value="8" style="width:100%" oninput="document.getElementById('brushSizeVal').textContent=this.value">
              <div style="margin-top:10px;display:flex;flex-direction:column;gap:5px;">
                <button class="tool-btn" onclick="clearEditorCanvas()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
                <button class="tool-btn" onclick="clearEditorMarkers()">üö´ –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏</button>
                <button class="btn-gold" onclick="saveEditorAsMap()" style="width:100%;margin-top:4px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç—É</button>
              </div>
              <div class="sp-label" style="margin-top:10px">–†–û–ó–ú–Ü–©–ï–ù–û</div>
              <div id="editorMarkerList" style="font-size:10px;color:var(--dim);max-height:120px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- USERS -->
      <div class="admin-section" id="asec-users">
        <div class="admin-card">
          <div class="admin-card-title">üë• –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –ì–†–ê–í–¶–Ø–ú–ò</div>
          <div id="adminUsersList" style="display:flex;flex-direction:column;gap:8px;"></div>
          <button class="btn-gold" style="margin-top:12px" onclick="loadAdminUsers()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- GAME SCREEN -->
<div class="screen" id="screen-game">
  <div class="game-hud">
    <div class="hud-logo">‚öî –°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
    <div class="hud-sep"></div>
    <div class="hud-stat">
      <span class="hud-stat-label">–•–í–ò–õ–Ø</span>
      <span class="hud-stat-val" id="hudWave">1</span>
    </div>
    <div class="hud-sep"></div>
    <div class="hud-stat">
      <span class="hud-stat-label">üí∞</span>
      <span class="hud-stat-val" style="color:var(--gold)" id="hudFunds">2000</span>
    </div>
    <div class="hud-center">
      <div class="hud-timer" id="hudTimer">00:00</div>
      <div class="hud-turn" id="hudPhase">–†–û–ó–ú–Ü–©–ï–ù–ù–Ø</div>
    </div>
    <div class="hud-right">
      <div class="hud-stat"><span style="color:#60a5fa">üîµ</span><span class="hud-stat-val blue" id="hudBlueUnits">0</span></div>
      <div class="hud-stat"><span style="color:#f87171">üî¥</span><span class="hud-stat-val red" id="hudRedUnits">0</span></div>
      <div class="hud-sep"></div>
      <button class="hud-btn" onclick="resetView()">‚Ü∫ –í–ò–î</button>
      <button class="hud-btn danger" onclick="confirmQuit()">–í–ò–ô–¢–ò</button>
    </div>
  </div>
  <div class="game-body" id="gameBody">
    <canvas id="mapCanvas"></canvas>
    <canvas id="unitsCanvas"></canvas>
    <canvas id="frontCanvas"></canvas>
    <canvas id="uiCanvas"></canvas>
    <canvas id="interCanvas"></canvas>
    <div class="casualties-overlay">
      <div class="co-title">–í–¢–†–ê–¢–ò</div>
      <div class="co-row">
        <span class="co-blue">üîµ <span id="casBlue">0</span></span>
        <span class="co-red">üî¥ <span id="casRed">0</span></span>
      </div>
    </div>
    <div class="sel-info" id="selInfo">
      <div class="si-name" id="siName">‚Äî</div>
      <div style="display:flex;justify-content:space-between;margin-top:3px;">
        <span style="font-size:9px;color:var(--dim)">HP</span>
        <span style="font-family:'Oswald',sans-serif;font-size:11px" id="siHPText">‚Äî</span>
      </div>
      <div class="si-hp-bar"><div class="si-hp-fill" id="siHPBar" style="width:100%"></div></div>
      <div class="si-stats">
        <div class="si-stat"><span>–ê–¢–ö</span><b id="siAtk">‚Äî</b></div>
        <div class="si-stat"><span>–ó–ê–•</span><b id="siDef">‚Äî</b></div>
        <div class="si-stat"><span>–®–í</span><b id="siSpd">‚Äî</b></div>
      </div>
    </div>
    <div class="zoom-ind" id="zoomInd">100%</div>
    <div class="placement-hint" id="placementHint">–ö–õ–Ü–ö–ù–Ü–¢–¨ –ù–ê –°–í–û–á–ô –ü–û–õ–û–í–ò–ù–Ü</div>
    <!-- Income floaters container -->
    <div id="incomeFloaters" style="position:absolute;inset:0;pointer-events:none;z-index:50;overflow:hidden;"></div>
  </div>
  <div class="side-panel" id="sidePanel">
    <div class="sp-section">
      <div class="sp-label">–†–ï–°–£–†–°–ò</div>
      <div class="sp-resources">
        <div class="sp-res-row"><span class="sp-res-label">üí∞ –§–û–ù–î–ò</span><span class="sp-res-val" style="color:var(--gold)" id="spFunds">0</span></div>
        <div class="sp-res-row"><span class="sp-res-label">üèôÔ∏è –î–û–•–û–î/–•–í</span><span class="sp-res-val" style="color:var(--green)" id="spIncome">0</span></div>
        <div class="sp-res-row"><span class="sp-res-label">‚öîÔ∏è –Æ–ù–Ü–¢–ò</span><span class="sp-res-val" style="color:var(--blue)" id="spUnits">0</span></div>
        <div class="sp-res-row"><span class="sp-res-label">üíÄ –í–¢–†–ê–¢–ò</span><span class="sp-res-val" style="color:var(--red)" id="spCasualties">0</span></div>
      </div>
    </div>
    <!-- Cities list -->
    <div class="sp-section">
      <div class="sp-label">üèôÔ∏è –ú–Ü–°–¢–ê</div>
      <div id="citiesList" class="cities-hud" style="padding:0;"></div>
    </div>
    <div class="sp-section">
      <div class="sp-label">–†–û–ó–ú–Ü–°–¢–ò–¢–ò –Æ–ù–Ü–¢</div>
      <div id="unitTypesList"></div>
      <button class="hud-btn" style="width:100%;margin-top:6px;padding:8px" onclick="startBattle()">‚ñ∂ –ü–û–ß–ê–¢–ò –ë–Ü–ô (Space)</button>
    </div>
    <div class="sp-section"><div class="sp-label">–ë–û–ô–û–í–ò–ô –ñ–£–†–ù–ê–õ</div></div>
    <div class="sp-log" id="spLog"></div>
  </div>
</div>

<div class="result-overlay" id="resultOverlay">
  <div class="result-box">
    <div class="result-emoji" id="resultEmoji">üèÜ</div>
    <div class="result-title" id="resultTitle">–ü–ï–†–ï–ú–û–ì–ê</div>
    <div class="result-sub" id="resultSub"></div>
    <button class="btn-primary" style="width:100%" onclick="backToMenu()">‚Üê –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ</button>
  </div>
</div>
<div class="toast" id="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getFirestore,doc,setDoc,getDoc,updateDoc,onSnapshot,deleteDoc,collection,getDocs,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,updateProfile}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const fbApp=initializeApp({
  apiKey:"AIzaSyAXTOcA4I5AYP0jfbVWb1de-lZjwf1DRhc",
  authDomain:"ctratigia.firebaseapp.com",
  projectId:"ctratigia",
  storageBucket:"ctratigia.firebasestorage.app",
  messagingSenderId:"71283939831",
  appId:"1:71283939831:web:6725da39c4b58c0065b6f2"
});
const db=getFirestore(fbApp);
const auth=getAuth(fbApp);
const CL_CLOUD='dimpa9w8w',CL_PRESET='ctratigia_map';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let uid=null,myName='–ì—Ä–∞–≤–µ—Ü—å',isAdmin=false,isAnon=true;
let lobbyId=null,myRole=null;
let lobbyUnsub=null,gameUnsub=null,presenceUnsub=null;
let isAI=false;
let aiMode='defense'; // defense | attack | blitz | conquest
let aiTeam='red'; // which team AI plays
let G={};
let mapBg=null,mapBgW=0,mapBgH=0;
let camX=0,camY=0,camScale=1;
let isDragging=false,dragLX=0,dragLY=0;
let selectedUnitId=null,placingType=null;
let gamePhase='placement';
let gameTimer=0,timerInterval=null;
let animFrame=null;
let gameOver=false;
let dcCountdown=null,dcSeconds=0;
let incomeInterval=null;
let editorHistoryStack=[];
let editorBg=null; // background image in editor

const UNIT_DEFS={
  infantry:{name:'–ü—ñ—Ö–æ—Ç–∞',emoji:'üë•',radius:8,hp:100,maxHp:100,atk:12,def:5,speed:18,range:40,cost:150},
  apc:{name:'–ë–¢–†',emoji:'üöõ',radius:10,hp:200,maxHp:200,atk:20,def:15,speed:28,range:50,cost:350},
  tank:{name:'–¢–∞–Ω–∫',emoji:'üõ°Ô∏è',radius:12,hp:350,maxHp:350,atk:40,def:30,speed:20,range:60,cost:600},
  heli:{name:'–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä',emoji:'üöÅ',radius:9,hp:150,maxHp:150,atk:35,def:5,speed:55,range:80,cost:500},
  artillery:{name:'–ê—Ä—Ç–∏–ª–µ—Ä—ñ—è',emoji:'üí•',radius:8,hp:120,maxHp:120,atk:70,def:3,speed:10,range:200,cost:700},
};

// City income per tick (every 15s)
const CITY_INCOME=150;
const BASE_INCOME=50; // base income per tick

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLdText(t){const el=document.getElementById('ldText');if(el)el.textContent=t;}

window.addEventListener('DOMContentLoaded',async()=>{
  setLdText('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è...');
  await new Promise(r=>setTimeout(r,500));
  if(!auth.currentUser){
    await signInAnonymously(auth).catch(()=>{});
  }
});

onAuthStateChanged(auth,async user=>{
  if(user){
    uid=user.uid;
    isAnon=user.isAnonymous;
    myName=user.displayName||(isAnon?'–ì—Ä–∞–≤–µ—Ü—å_'+uid.slice(-4).toUpperCase():user.email?.split('@')[0]||'–ì—Ä–∞–≤–µ—Ü—å');
    if(!isAnon){
      const usnap=await getDoc(doc(db,'users',uid)).catch(()=>null);
      isAdmin=usnap?.data()?.role==='admin';
    }else{isAdmin=false;}
    updateMenuUI();
    document.getElementById('loadingScreen').classList.add('hidden');
    showScreen('screen-menu');
    initGameCanvases();
    buildUnitList();
    loadGlobalMaps();
  }
});

function updateMenuUI(){
  document.getElementById('menuUserName').textContent=myName;
  const badge=document.getElementById('menuUserBadge');
  if(isAdmin){badge.textContent='–ê–î–ú–Ü–ù';badge.className='menu-user-badge badge-admin';}
  else if(!isAnon){badge.textContent='–ì–†–ê–í–ï–¶–¨';badge.className='menu-user-badge';}
  else{badge.textContent='–ì–Ü–°–¢–¨';badge.className='menu-user-badge badge-anon';}
  document.getElementById('adminMenuBtn').style.display=isAdmin?'block':'none';
  document.getElementById('authMenuBtn').style.display=isAnon?'block':'none';
  document.getElementById('logoutBtn').style.display=!isAnon?'block':'none';
}

window.showAuthModal=()=>document.getElementById('authModal').classList.add('vis');
window.closeAuthModal=()=>document.getElementById('authModal').classList.remove('vis');
window.switchAuthTab=tab=>{
  document.querySelectorAll('.modal-tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
  document.querySelectorAll('.modal-tab-content').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
};

window.doLogin=async()=>{
  const em=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPass').value;
  setStatus('loginStatus','‚ü≥ –í—Ö—ñ–¥...','warn');
  try{await signInWithEmailAndPassword(auth,em,pw);closeAuthModal();}
  catch(e){setStatus('loginStatus','‚ùå '+friendlyAuthErr(e),'err');}
};

window.doRegister=async()=>{
  const nm=document.getElementById('regName').value.trim();
  const em=document.getElementById('regEmail').value.trim();
  const pw=document.getElementById('regPass').value;
  if(!nm){setStatus('registerStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –ø–æ–∑–∏–≤–Ω–∏–π','err');return;}
  if(pw.length<6){setStatus('registerStatus','‚ùå –ü–∞—Ä–æ–ª—å –º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤','err');return;}
  setStatus('registerStatus','‚ü≥ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...','warn');
  try{
    const cred=await createUserWithEmailAndPassword(auth,em,pw);
    await updateProfile(cred.user,{displayName:nm});
    await setDoc(doc(db,'users',cred.user.uid),{name:nm,email:em,role:'player',createdAt:serverTimestamp()});
    closeAuthModal();
  }catch(e){setStatus('registerStatus','‚ùå '+friendlyAuthErr(e),'err');}
};

window.doLogout=async()=>{await signOut(auth);await signInAnonymously(auth);};

function friendlyAuthErr(e){
  if(e.code==='auth/email-already-in-use')return'Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è';
  if(e.code==='auth/wrong-password'||e.code==='auth/invalid-credential')return'–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å';
  if(e.code==='auth/too-many-requests')return'–ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ';
  return e.message||'–ü–æ–º–∏–ª–∫–∞';
}
function setStatus(id,msg,type){const el=document.getElementById(id);if(!el)return;el.textContent=msg;el.className='status-box vis';if(type)el.classList.add(type);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI MODE SELECTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedAIMode='defense',selectedAITeam='blue';

window.showAIModeSelect=()=>{
  document.getElementById('aiModeModal').classList.add('vis');
};
window.closeAIModeModal=()=>{document.getElementById('aiModeModal').classList.remove('vis');};

window.selectAIMode=mode=>{
  selectedAIMode=mode;
  document.querySelectorAll('.ai-mode-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('aimode-'+mode)?.classList.add('selected');
};
window.selectAITeam=team=>{
  selectedAITeam=team;
  document.getElementById('teamBtnBlue').classList.toggle('selected',team==='blue');
  document.getElementById('teamBtnRed').classList.toggle('selected',team==='red');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL MAPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let globalMaps=[];
async function loadGlobalMaps(){
  try{
    const snap=await getDoc(doc(db,'appData','globalMaps'));
    globalMaps=snap.exists()?(snap.data().maps||[]):[];
    renderLobbyGlobalMaps();
    if(isAdmin)renderAdminMaps();
    if(globalMaps.length>0&&!mapBgW)loadMapFromUrl(globalMaps[0].url);
  }catch(e){}
}

function renderLobbyGlobalMaps(){
  const el=document.getElementById('lobbyGlobalMaps');
  if(!el)return;
  if(!globalMaps.length){el.innerHTML='<div style="font-size:10px;color:var(--dim);text-align:center;padding:8px">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∫–∞—Ä—Ç</div>';return;}
  el.innerHTML=globalMaps.map((m,i)=>`
    <div class="map-saved-item" onclick="selectGlobalMap(${i})" id="gmap_${i}">
      <img src="${m.url}" class="msi-thumb" onerror="this.style.display='none'">
      <div class="msi-info">
        <div class="msi-name">${m.name}</div>
        <div class="msi-date">${m.date||''} ${m.cities?'| üèôÔ∏è'+m.cities.length+' –º—ñ—Å—Ç':''}</div>
      </div>
    </div>`).join('');
}

window.selectGlobalMap=async(i)=>{
  const m=globalMaps[i];
  document.querySelectorAll('.map-saved-item').forEach(e=>e.classList.remove('active'));
  document.getElementById('gmap_'+i)?.classList.add('active');
  loadMapFromUrl(m.url);
  if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrl:m.url,mapIdx:i,mapVer:Date.now().toString()}).catch(()=>{});
  document.getElementById('mapPreview').style.display='none';
  document.getElementById('mapUploadArea').style.display='block';
  toast('‚úÖ –ö–∞—Ä—Ç–∞ –≤–∏–±—Ä–∞–Ω–∞: '+m.name);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN - MAPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.adminUploadMap=async(input)=>{
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('adminMapUploadStatus');
  st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';
  try{
    const comp=await compressImage(file,3000,3000,.85);
    st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';
    const url=await uploadCloudinary(comp,'admin_map_'+Date.now());
    const name=file.name.replace(/\.[^.]+$/,'').slice(0,30);
    const date=new Date().toLocaleDateString('uk-UA');
    globalMaps.push({url,name,date,cities:[],water:[],bridges:[],spawns:null});
    await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});
    st.textContent='‚úÖ –ö–∞—Ä—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –†–ï–î–ê–ì–£–í–ê–¢–ò –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.';
    renderAdminMaps();renderLobbyGlobalMaps();
    toast('‚úÖ –ö–∞—Ä—Ç–∞ –¥–æ–¥–∞–Ω–∞!');
    input.value='';
  }catch(e){st.textContent='‚ùå '+e.message;}
};

function renderAdminMaps(){
  const el=document.getElementById('adminMapsGrid');if(!el)return;
  if(!globalMaps.length){el.innerHTML='<div style="font-size:11px;color:var(--dim)">–ö–∞—Ä—Ç –Ω–µ–º–∞—î. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à—É!</div>';return;}
  el.innerHTML=globalMaps.map((m,i)=>`
    <div class="admin-map-card" id="amc_${i}">
      <img src="${m.url}" class="amc-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1 1%22/>'">
      <div class="amc-info">
        <div class="amc-name">${m.name}</div>
        <div class="amc-meta">${m.date||''} ${m.cities?'üèôÔ∏è'+m.cities.length:'0'} –º—ñ—Å—Ç ${m.water?'üíß':'‚¨ú'}</div>
        <div class="amc-actions">
          <button class="amc-btn set" onclick="adminSetActiveMap(${i})">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</button>
          <button class="amc-btn edit" onclick="adminEditMap(${i})">‚úèÔ∏è</button>
          <button class="amc-btn del" onclick="adminDeleteMap(${i})">üóëÔ∏è</button>
        </div>
      </div>
    </div>`).join('');
}

window.adminSetActiveMap=async(i)=>{
  const m=globalMaps.splice(i,1)[0];globalMaps.unshift(m);
  await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});
  renderAdminMaps();renderLobbyGlobalMaps();
  toast('‚úÖ –ö–∞—Ä—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—é');
};
window.adminDeleteMap=async(i)=>{
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ä—Ç—É "'+globalMaps[i].name+'"?'))return;
  globalMaps.splice(i,1);
  await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});
  renderAdminMaps();renderLobbyGlobalMaps();
  toast('üóëÔ∏è –ö–∞—Ä—Ç—É –≤–∏–¥–∞–ª–µ–Ω–æ');
};
window.adminEditMap=async(i)=>{
  adminNav('editor');
  // Load this map into editor
  editorEditingMapIdx=i;
  const m=globalMaps[i];
  editorMarkers=[];
  // Restore existing markers
  if(m.spawns){
    if(m.spawns.blueBase)editorMarkers.push({type:'base',team:'blue',nx:m.spawns.blueBase.nx,ny:m.spawns.blueBase.ny,px:0,py:0});
    if(m.spawns.redBase)editorMarkers.push({type:'base',team:'red',nx:m.spawns.redBase.nx,ny:m.spawns.redBase.ny,px:0,py:0});
    (m.spawns.units||[]).forEach(u=>editorMarkers.push({type:'unit',team:u.team,unitType:u.unitType,nx:u.nx,ny:u.ny,px:0,py:0}));
  }
  (m.cities||[]).forEach(c=>editorMarkers.push({type:'city',nx:c.nx,ny:c.ny,name:c.name,px:0,py:0}));
  // Load bg image
  editorBg=null;
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()=>{
    editorBg=img;
    drawEditorBase();
    // Convert px from normalized
    const cv=document.getElementById('adminMapCanvas');
    if(cv){
      editorMarkers.forEach(mk=>{mk.px=mk.nx*cv.width;mk.py=mk.ny*cv.height;});
    }
    renderEditorMarkers();updateEditorMarkerList();
  };
  img.src=m.url;
  toast('‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: '+m.name);
};
let editorEditingMapIdx=-1;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN - EDITOR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editorCtx,editorTool='draw',editorColor='#22c55e',editorSize=8;
let editorDrawing=false,editorLastX=0,editorLastY=0;
let editorMarkers=[];
const EDITOR_COLORS=['#22c55e','#3b82f6','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#ffffff','#1a2810','#5c3d1a','#1e3a5f','#0d2d4a','#000000','#6b7280'];

window.adminNav=section=>{
  document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.admin-nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('asec-'+section)?.classList.add('active');
  document.getElementById('anav-'+section)?.classList.add('active');
  if(section==='editor')initEditor();
  if(section==='maps'){renderAdminMaps();loadGlobalMaps();}
  if(section==='users')loadAdminUsers();
};

function initEditor(){
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  const wrap=cv.parentElement;
  cv.width=wrap.clientWidth||900;cv.height=wrap.clientHeight||550;
  editorCtx=cv.getContext('2d');
  editorHistoryStack=[];
  drawEditorBase();
  const sw=document.getElementById('colorSwatches');
  if(sw)sw.innerHTML=EDITOR_COLORS.map(c=>`<div class="color-swatch ${c===editorColor?'active':''}" style="background:${c}" onclick="setEditorColor('${c}')"></div>`).join('');
  cv.onmousedown=e=>{
    if(editorTool.startsWith('base_')||editorTool.startsWith('unit_')||editorTool==='city'){
      placeEditorMarker(e.offsetX,e.offsetY);return;
    }
    if(editorTool==='fill'){floodFill(e.offsetX,e.offsetY);return;}
    saveEditorHistory();
    editorDrawing=true;editorLastX=e.offsetX;editorLastY=e.offsetY;
    editorCtx.beginPath();editorCtx.moveTo(editorLastX,editorLastY);
  };
  cv.onmousemove=e=>{
    if(!editorDrawing)return;
    if(editorTool==='water'){drawTerrainStroke(e,'#1e40af',editorSize);}
    else if(editorTool==='bridge'){drawTerrainStroke(e,'#92400e',editorSize*.6);}
    else if(editorTool==='forest'){drawTerrainStroke(e,'#166534',editorSize);}
    else if(editorTool==='erase'){drawTerrainStroke(e,editorBg?null:'#1a2810',editorSize*2,true);}
    else{drawTerrainStroke(e,editorColor,editorSize);}
  };
  cv.onmouseup=cv.onmouseleave=()=>{editorDrawing=false;};
  const bs=document.getElementById('brushSize');
  if(bs)bs.oninput=e=>{editorSize=+e.target.value;};
}

function drawTerrainStroke(e,color,size,erase=false){
  if(erase&&editorBg){
    // Restore from bg
    editorCtx.drawImage(editorBg,e.offsetX-size,e.offsetY-size,size*2,size*2,e.offsetX-size,e.offsetY-size,size*2,size*2);
  }else{
    editorCtx.strokeStyle=color;
    editorCtx.lineWidth=size;
    editorCtx.lineCap='round';editorCtx.lineJoin='round';
    editorCtx.beginPath();editorCtx.moveTo(editorLastX,editorLastY);editorCtx.lineTo(e.offsetX,e.offsetY);editorCtx.stroke();
  }
  editorLastX=e.offsetX;editorLastY=e.offsetY;
}

function floodFill(sx,sy){
  saveEditorHistory();
  const cv=document.getElementById('adminMapCanvas');
  const imgData=editorCtx.getImageData(0,0,cv.width,cv.height);
  const data=imgData.data;
  const idx=(x,y)=>(y*cv.width+x)*4;
  const target=[data[idx(sx,sy)],data[idx(sx,sy)+1],data[idx(sx,sy)+2],data[idx(sx,sy)+3]];
  const fill=hexToRgb(editorColor);
  if(!fill)return;
  if(target[0]===fill.r&&target[1]===fill.g&&target[2]===fill.b)return;
  const stack=[[sx,sy]];const visited=new Uint8Array(cv.width*cv.height);
  while(stack.length){
    const [x,y]=stack.pop();
    if(x<0||x>=cv.width||y<0||y>=cv.height)continue;
    const i=idx(x,y);const vi=y*cv.width+x;
    if(visited[vi])continue;visited[vi]=1;
    if(Math.abs(data[i]-target[0])>30||Math.abs(data[i+1]-target[1])>30||Math.abs(data[i+2]-target[2])>30)continue;
    data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  editorCtx.putImageData(imgData,0,0);
}
function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};}

function saveEditorHistory(){
  const cv=document.getElementById('adminMapCanvas');if(!editorCtx||!cv)return;
  editorHistoryStack.push(editorCtx.getImageData(0,0,cv.width,cv.height));
  if(editorHistoryStack.length>30)editorHistoryStack.shift();
}

window.editorUndo=()=>{
  if(!editorHistoryStack.length){toast('‚ö†Ô∏è –ù–µ–º–∞ —â–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏');return;}
  const imgData=editorHistoryStack.pop();
  editorCtx.putImageData(imgData,0,0);
  renderEditorMarkers();
};

window.loadEditorBackground=input=>{
  const file=input.files[0];if(!file)return;
  const img=new Image();
  img.onload=()=>{
    editorBg=img;
    const cv=document.getElementById('adminMapCanvas');if(!cv)return;
    saveEditorHistory();
    editorCtx.clearRect(0,0,cv.width,cv.height);
    editorCtx.drawImage(img,0,0,cv.width,cv.height);
  };
  img.src=URL.createObjectURL(file);
  toast('üì∑ –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —è–∫ –æ—Å–Ω–æ–≤–∞');
};

function drawEditorBase(){
  const cv=document.getElementById('adminMapCanvas');if(!editorCtx||!cv)return;
  if(editorBg){editorCtx.drawImage(editorBg,0,0,cv.width,cv.height);return;}
  // Default terrain
  editorCtx.fillStyle='#1a2810';editorCtx.fillRect(0,0,cv.width,cv.height);
  editorCtx.strokeStyle='rgba(255,255,255,.04)';editorCtx.lineWidth=1;
  for(let x=0;x<cv.width;x+=50){editorCtx.beginPath();editorCtx.moveTo(x,0);editorCtx.lineTo(x,cv.height);editorCtx.stroke();}
  for(let y=0;y<cv.height;y+=50){editorCtx.beginPath();editorCtx.moveTo(0,y);editorCtx.lineTo(cv.height,y);editorCtx.stroke();}
  editorCtx.strokeStyle='rgba(255,255,255,.18)';editorCtx.lineWidth=2;editorCtx.setLineDash([10,8]);
  editorCtx.beginPath();editorCtx.moveTo(cv.width/2,0);editorCtx.lineTo(cv.width/2,cv.height);editorCtx.stroke();editorCtx.setLineDash([]);
  editorCtx.fillStyle='rgba(59,130,246,.07)';editorCtx.fillRect(0,0,cv.width/2,cv.height);
  editorCtx.fillStyle='rgba(239,68,68,.07)';editorCtx.fillRect(cv.width/2,0,cv.width/2,cv.height);
  editorCtx.font='bold 32px Oswald';editorCtx.textAlign='center';editorCtx.textBaseline='middle';
  editorCtx.fillStyle='rgba(59,130,246,.15)';editorCtx.fillText('–°–ò–ù–Ü',cv.width*.25,cv.height/2);
  editorCtx.fillStyle='rgba(239,68,68,.15)';editorCtx.fillText('–ß–ï–†–í–û–ù–Ü',cv.width*.75,cv.height/2);
}

function placeEditorMarker(px,py){
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  const isBase=editorTool.startsWith('base_');
  const team=editorTool.split('_')[1];
  const unitType=document.getElementById('editorUnitType')?.value||'infantry';
  const nx=px/cv.width,ny=py/cv.height;
  if(isBase){editorMarkers=editorMarkers.filter(m=>!(m.type==='base'&&m.team===team));}
  if(editorTool==='city'){
    const name=prompt('–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞ (Enter = –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏):','–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=>m.type==='city').length+1))||('–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=>m.type==='city').length+1));
    editorMarkers.push({type:'city',nx,ny,name,px,py});
  }else{
    editorMarkers.push({type:isBase?'base':'unit',team:isBase?team:editorTool.split('_')[1],unitType:isBase?null:unitType,nx,ny,px,py});
  }
  renderEditorMarkers();updateEditorMarkerList();
}

function renderEditorMarkers(){
  const wrap=document.getElementById('editorMarkers');
  const cv=document.getElementById('adminMapCanvas');
  if(!wrap||!cv)return;
  wrap.innerHTML=editorMarkers.map((m,i)=>{
    let emoji,color;
    if(m.type==='city'){emoji='üèôÔ∏è';color='#f59e0b';}
    else if(m.type==='base'){emoji=m.team==='blue'?'üè†':'üèöÔ∏è';color=m.team==='blue'?'#60a5fa':'#f87171';}
    else{emoji=UNIT_DEFS[m.unitType]?.emoji||'‚ö™';color=m.team==='blue'?'#60a5fa':'#f87171';}
    const px=m.nx*cv.width,py=m.ny*cv.height;
    return`<div style="position:absolute;left:${px-14}px;top:${py-14}px;font-size:20px;cursor:pointer;filter:drop-shadow(0 0 4px ${color});pointer-events:auto" title="${m.type} ${m.name||m.team||''}" onclick="removeEditorMarker(${i})">${emoji}</div>`;
  }).join('');
  wrap.style.pointerEvents='none';
}

function updateEditorMarkerList(){
  const el=document.getElementById('editorMarkerList');if(!el)return;
  if(!editorMarkers.length){el.textContent='–ù–µ–º–∞—î –º–∞—Ä–∫–µ—Ä—ñ–≤';return;}
  el.innerHTML=editorMarkers.map((m,i)=>{
    const label=m.type==='city'?`üèôÔ∏è ${m.name}`:m.type==='base'?`–ë–∞–∑–∞ ${m.team}`:`${UNIT_DEFS[m.unitType]?.name||m.unitType} (${m.team})`;
    return`<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04)">
      <span>${label}</span><span style="cursor:pointer;color:#f87171" onclick="removeEditorMarker(${i})">‚úï</span>
    </div>`;
  }).join('');
}

window.removeEditorMarker=i=>{editorMarkers.splice(i,1);renderEditorMarkers();updateEditorMarkerList();};
window.clearEditorMarkers=()=>{editorMarkers=[];renderEditorMarkers();updateEditorMarkerList();toast('üóëÔ∏è –ú–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');};
window.setEditorTool=t=>{
  editorTool=t;
  document.querySelectorAll('.tool-btn[id^="tool-"]').forEach(b=>b.classList.remove('active'));
  document.getElementById('tool-'+t)?.classList.add('active');
};
window.setEditorColor=c=>{
  editorColor=c;
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('active',s.style.background===c||s.style.backgroundColor===c));
};
window.clearEditorCanvas=()=>{
  if(!editorCtx)return;
  editorHistoryStack=[];editorBg=null;
  drawEditorBase();
  toast('üóëÔ∏è –ü–æ–ª–æ—Ç–Ω–æ –æ—á–∏—â–µ–Ω–æ');
};

window.saveEditorAsMap=async()=>{
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  let name='–ú–æ—è –∫–∞—Ä—Ç–∞';
  if(editorEditingMapIdx>=0)name=globalMaps[editorEditingMapIdx].name;
  else{const n=prompt('–ù–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏:','–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞');if(n===null)return;name=n||'–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';}
  const dataUrl=cv.toDataURL('image/jpeg',.92);
  const st=document.getElementById('adminMapUploadStatus')||{textContent:''};
  st.textContent='‚ü≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
  toast('‚ü≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–∞—Ä—Ç—É...');
  try{
    const url=await uploadCloudinary(dataUrl,'editor_map_'+(editorEditingMapIdx>=0?'edit_'+editorEditingMapIdx:'new_'+Date.now()));
    const date=new Date().toLocaleDateString('uk-UA');
    const spawns={
      blueBase:editorMarkers.find(m=>m.type==='base'&&m.team==='blue')||null,
      redBase:editorMarkers.find(m=>m.type==='base'&&m.team==='red')||null,
      units:editorMarkers.filter(m=>m.type==='unit').map(m=>({team:m.team,unitType:m.unitType,nx:m.nx,ny:m.ny})),
    };
    const cities=editorMarkers.filter(m=>m.type==='city').map(m=>({nx:m.nx,ny:m.ny,name:m.name}));
    const mapEntry={url,name,date,spawns,cities};
    if(editorEditingMapIdx>=0){globalMaps[editorEditingMapIdx]=mapEntry;}
    else{globalMaps.push(mapEntry);}
    await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});
    toast('‚úÖ "'+name+'" –∑–±–µ—Ä–µ–∂–µ–Ω–∞!');
    editorMarkers=[];editorEditingMapIdx=-1;
    adminNav('maps');
  }catch(e){toast('‚ùå '+e.message);}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN - USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.loadAdminUsers=async()=>{
  const el=document.getElementById('adminUsersList');
  el.innerHTML='<div style="color:var(--dim);font-size:11px">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  try{
    const snaps=await getDocs(collection(db,'users'));
    if(snaps.empty){el.innerHTML='<div style="color:var(--dim);font-size:11px">–ù–µ–º–∞—î –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤</div>';return;}
    el.innerHTML=snaps.docs.map(d=>{const u=d.data();
      return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);">
        <span style="font-size:16px">${u.role==='admin'?'üëë':'üë§'}</span>
        <div style="flex:1"><div style="font-size:12px;font-weight:700;color:#fff">${u.name||'‚Äî'}</div><div style="font-size:10px;color:var(--dim)">${u.email||'‚Äî'}</div></div>
        <span style="font-size:10px;padding:2px 8px;border-radius:10px;${u.role==='admin'?'background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3)':'background:rgba(100,116,139,.1);color:var(--dim);border:1px solid rgba(100,116,139,.2)'}">${u.role||'player'}</span>
        ${u.role!=='admin'?`<button class="amc-btn set" onclick="grantAdmin('${d.id}')">üëë –ê–¥–º—ñ–Ω</button>`:''}
      </div>`;
    }).join('');
  }catch(e){el.innerHTML='<div style="color:#f87171;font-size:11px">‚ùå '+e.message+'</div>';}
};
window.grantAdmin=async(userId)=>{
  if(!confirm('–ù–∞–¥–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞?'))return;
  await updateDoc(doc(db,'users',userId),{role:'admin'});
  toast('‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞ –Ω–∞–¥–∞–Ω–æ');loadAdminUsers();
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showScreen=name=>{
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(name)?.classList.add('active');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOBBY CREATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genCode(){return Array.from({length:5},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');}

window.copyLobbyCode=()=>{
  const code=document.getElementById('lcCode').textContent;
  const fb=()=>{const ta=document.createElement('textarea');ta.value=code;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);};
  if(navigator.clipboard){navigator.clipboard.writeText(code).then(()=>toast('‚úÖ –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: '+code)).catch(()=>{fb();toast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');});}
  else{fb();toast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');}
};

function setLobbyMapHostOnly(isHost){
  const upload=document.getElementById('mapUploadArea');
  const fileInp=document.getElementById('mapFileInput');
  [upload,fileInp].forEach(el=>{if(el)el.style.display=isHost?'':'none';});
}

window.showLobbyCreate=async()=>{
  showScreen('screen-lobby-create');
  setStatus('lcStatus','‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...','warn');
  const code=genCode();lobbyId=code;myRole='blue';
  document.getElementById('lcCode').textContent=code;
  document.getElementById('lcP1Name').textContent=myName;
  document.getElementById('lcP2Name').textContent='–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...';
  document.getElementById('lcP2Slot').classList.remove('filled');
  document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='‚è≥';
  document.getElementById('lcStartBtn').disabled=true;
  mapBg=null;mapBgW=0;mapBgH=0;
  document.getElementById('mapPreview').style.display='none';
  document.getElementById('mapUploadArea').style.display='block';
  document.getElementById('mapUploadStatus').textContent='';
  renderLobbyGlobalMaps();setLobbyMapHostOnly(true);
  if(globalMaps.length>0)loadMapFromUrl(globalMaps[0].url);
  try{
    await setDoc(doc(db,'lobbies',code),{
      code,host:uid,hostName:myName,guestUid:null,guestName:null,
      mapUrl:globalMaps[0]?.url||null,mapIdx:0,mapVer:'0',status:'waiting',
      createdAt:serverTimestamp(),presence:{blue:Date.now(),red:0}
    });
    setStatus('lcStatus','‚úÖ –õ–æ–±—ñ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ö–æ–¥: '+code,'ok');
    listenLobby(code,'host');
    startPresencePing(code,'blue');
  }catch(e){setStatus('lcStatus','‚ùå '+e.message,'err');}
};

window.showLobbyJoin=()=>{showScreen('screen-lobby-join');};

window.joinLobby=async()=>{
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  const nm=document.getElementById('joinNameInput').value.trim()||myName;
  if(!code){setStatus('ljStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!','err');return;}
  myName=nm;
  setStatus('ljStatus','‚ü≥ –ü–æ—à—É–∫...','warn');
  try{
    const snap=await getDoc(doc(db,'lobbies',code));
    if(!snap.exists()){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!','err');return;}
    const d=snap.data();
    if(d.status!=='waiting'&&d.status!=='ready'){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ','err');return;}
    if(d.guestUid&&d.guestUid!==uid){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ','err');return;}
    lobbyId=code;myRole='red';
    await updateDoc(doc(db,'lobbies',code),{guestUid:uid,guestName:myName,status:'ready','presence.red':Date.now()});
    showScreen('screen-lobby-create');
    document.getElementById('lcCode').textContent=code;
    document.getElementById('lcP1Name').textContent=d.hostName||'–•–æ—Å—Ç';
    document.getElementById('lcP2Name').textContent=myName;
    document.getElementById('lcP2Slot').classList.add('filled');
    document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';
    document.getElementById('lcStartBtn').disabled=true;
    mapBg=null;mapBgW=0;mapBgH=0;
    renderLobbyGlobalMaps();setLobbyMapHostOnly(false);
    setStatus('lcStatus','‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å! –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ä—Ç—É...','ok');
    listenLobby(code,'guest');
    startPresencePing(code,'red');
    if(d.mapUrl)loadMapFromUrl(d.mapUrl);
    else if(globalMaps.length>0)loadMapFromUrl(globalMaps[0].url);
  }catch(e){setStatus('ljStatus','‚ùå '+e.message,'err');}
};

function listenLobby(code,role){
  if(lobbyUnsub)lobbyUnsub();
  lobbyUnsub=onSnapshot(doc(db,'lobbies',code),snap=>{
    if(!snap.exists())return;
    const d=snap.data();
    if(d.guestName){
      document.getElementById('lcP2Name').textContent=d.guestName;
      document.getElementById('lcP2Slot').classList.add('filled');
      document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';
      if(role==='host'){document.getElementById('lcStartBtn').disabled=false;setStatus('lcStatus','‚úÖ '+d.guestName+' –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –°–¢–ê–†–¢.','ok');}
    }
    if(d.mapUrl)loadMapFromUrl(d.mapUrl);
    if(d.status==='started'){
      if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
      startGame(code,role,d);
    }
  });
}

window.hostStartGame=async()=>{if(!lobbyId)return;await updateDoc(doc(db,'lobbies',lobbyId),{status:'started'});};

window.leaveLobby=async()=>{
  if(lobbyId&&myRole==='blue'){await deleteDoc(doc(db,'lobbies',lobbyId)).catch(()=>{});}
  if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
  if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}
  lobbyId=null;myRole=null;showScreen('screen-menu');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRESENCE / DISCONNECT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startPresencePing(code,role){
  if(presenceUnsub)clearInterval(presenceUnsub);
  presenceUnsub=setInterval(async()=>{
    if(!lobbyId)return;
    await updateDoc(doc(db,'games',code),{['presence.'+role]:Date.now()}).catch(()=>{});
  },5000);
}

function monitorOpponentPresence(code){
  const oppRole=myRole==='blue'?'red':'blue';
  setInterval(async()=>{
    if(gameOver||!lobbyId)return;
    const snap=await getDoc(doc(db,'games',code)).catch(()=>null);
    if(!snap?.exists())return;
    const ts=snap.data()?.presence?.[oppRole]||0;
    const elapsed=(Date.now()-ts)/1000;
    if(elapsed>10&&elapsed<75){showDcBanner(75-Math.floor(elapsed));}
    else if(elapsed>=75){hideDcBanner();showResult(myRole,'–û–ø–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è');}
    else{hideDcBanner();}
  },3000);
}

let dcInterval=null;
function showDcBanner(sec){
  dcSeconds=sec;
  const b=document.getElementById('dcBanner');b.classList.add('vis');
  document.getElementById('dcTimer').textContent=sec;
  if(dcInterval)return;
  dcInterval=setInterval(()=>{dcSeconds--;document.getElementById('dcTimer').textContent=Math.max(0,dcSeconds);if(dcSeconds<=0){clearInterval(dcInterval);dcInterval=null;}},1000);
}
function hideDcBanner(){
  document.getElementById('dcBanner').classList.remove('vis');
  if(dcInterval){clearInterval(dcInterval);dcInterval=null;}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VS AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startVsAI=()=>{
  aiMode=selectedAIMode;
  // AI always plays the opposite team
  myRole=selectedAITeam;
  const oppTeam=myRole==='blue'?'red':'blue';
  isAI=true;lobbyId='ai_'+Date.now();
  closeAIModeModal();
  const mapMeta=globalMaps[0]||null;
  const mapUrl=mapMeta?.url||null;
  mapBg=null;mapBgW=0;mapBgH=0;
  initGameState(mapMeta,myRole);
  showScreen('screen-game');
  setTimeout(()=>{resizeCanvases();if(mapUrl)loadMapFromUrl(mapUrl);},50);
  startGameLoop();
  addLog(`ü§ñ –†–µ–∂–∏–º: ${aiModeLabel(aiMode)} | –í–∏: ${myRole==='blue'?'üîµ –°–ò–ù–Ü':'üî¥ –ß–ï–†–í–û–ù–Ü'}`,'warn');
};

function aiModeLabel(m){return{defense:'üõ°Ô∏è –û–ë–û–†–û–ù–ê',attack:'‚öîÔ∏è –ù–ê–°–¢–£–ü',blitz:'‚ö° –ë–õ–Ü–¶–ö–†–ò–ì',conquest:'üèÜ –ó–ê–í–û–Æ–í–ê–ù–ù–Ø'}[m]||m;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(code,role,lobbyData){
  isAI=false;myRole=role;lobbyId=code;
  const mapIdx=lobbyData?.mapIdx||0;
  const mapUrl=lobbyData?.mapUrl||globalMaps[0]?.url||null;
  const mapMeta=mapIdx>=0&&mapIdx<globalMaps.length?globalMaps[mapIdx]:(globalMaps.find(m=>m.url===mapUrl)||null);
  mapBg=null;mapBgW=0;mapBgH=0;
  initGameState(mapMeta,myRole);
  showScreen('screen-game');
  setTimeout(()=>{resizeCanvases();if(mapUrl)loadMapFromUrl(mapUrl);},50);
  startGameLoop();
  listenGameState(code);
  startPresencePing(code,role);
  monitorOpponentPresence(code);
}

function initGameState(mapData,playerRole){
  G={
    units:[],
    funds:{blue:2000,red:2000},
    casualties:{blue:0,red:0},
    cities:[],
    water:[],bridges:[],
    phase:'placement',wave:1,startTime:Date.now(),nextId:1
  };
  gamePhase='placement';gameOver=false;gameTimer=0;
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=setInterval(tickTimer,1000);
  if(incomeInterval)clearInterval(incomeInterval);
  incomeInterval=setInterval(tickIncome,15000);
  document.getElementById('hudPhase').textContent='–†–û–ó–ú–Ü–©–ï–ù–ù–Ø';
  document.getElementById('placementHint').classList.add('vis');
  // Init cities from map metadata
  if(mapData?.cities&&mapData.cities.length>0){
    // Cities loaded ‚Äî will be positioned after mapBg loads
    G._pendingCities=mapData.cities;
  }else{
    // Default cities if map has none
    G._pendingCities=null;
  }
  if(mapData?.spawns){
    G._pendingSpawns=mapData.spawns;
  }
  // Water areas from map (we detect blue pixels) or use stored
  G._waterAreas=mapData?.water||[];
  G._bridges=mapData?.bridges||[];
  updateHUD();updateCitiesPanel();
}

function applyMapData(){
  if(!mapBgW||!mapBgH)return;
  const mw=mapBgW,mh=mapBgH;
  // Apply cities
  if(G._pendingCities&&G._pendingCities.length>0){
    G.cities=G._pendingCities.map((c,i)=>({
      id:'city_'+i,name:c.name||('–ú—ñ—Å—Ç–æ '+(i+1)),
      x:c.nx*mw,y:c.ny*mh,nx:c.nx,ny:c.ny,
      owner:'neutral',income:CITY_INCOME,
      hp:300,maxHp:300,captureProgress:{blue:0,red:0}
    }));
    G._pendingCities=null;
    addLog('üèôÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ '+G.cities.length+' –º—ñ—Å—Ç','info');
  }else if(!G.cities.length){
    // Generate default cities spread across map
    G.cities=generateDefaultCities(mw,mh);
    addLog('üèôÔ∏è –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ '+G.cities.length+' –º—ñ—Å—Ç','info');
  }
  // Apply spawn data
  if(G._pendingSpawns){
    const spawns=G._pendingSpawns;
    if(spawns.blueBase){G.bases={...G.bases||{},blue:{x:spawns.blueBase.nx*mw,y:spawns.blueBase.ny*mh}};}
    if(spawns.redBase){G.bases={...G.bases||{},red:{x:spawns.redBase.nx*mw,y:spawns.redBase.ny*mh}};}
    (spawns.units||[]).forEach(s=>{
      const def=UNIT_DEFS[s.unitType]||UNIT_DEFS.infantry;
      G.units.push({id:G.nextId++,type:s.unitType,owner:s.team,
        x:s.nx*mw,y:s.ny*mh,tx:s.nx*mw,ty:s.ny*mh,vx:0,vy:0,
        hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,
        state:'idle',attackTarget:null,lastAttack:0,lastAttackAnim:0});
    });
    G._pendingSpawns=null;
  }
  // Default bases if not set
  if(!G.bases){
    G.bases={blue:{x:mw*.12,y:mh*.5},red:{x:mw*.88,y:mh*.5}};
  }
  updateHUD();updateCitiesPanel();
}

function generateDefaultCities(mw,mh){
  const positions=[
    {nx:.5,ny:.5,name:'–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ'},
    {nx:.3,ny:.3,name:'–õ—ñ—Å–∞'},
    {nx:.7,ny:.3,name:'–°—Ö—ñ–¥'},
    {nx:.3,ny:.7,name:'–ü—ñ–≤–¥–µ–Ω—å'},
    {nx:.7,ny:.7,name:'–ì–æ—Ä–∏'},
  ];
  return positions.map((p,i)=>({
    id:'city_'+i,name:p.name,x:p.nx*mw,y:p.ny*mh,nx:p.nx,ny:p.ny,
    owner:'neutral',income:CITY_INCOME,hp:300,maxHp:300,captureProgress:{blue:0,red:0}
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INCOME SYSTEM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickIncome(){
  if(gameOver||gamePhase!=='battle')return;
  let blueIncome=BASE_INCOME,redIncome=BASE_INCOME;
  G.cities.forEach(c=>{
    if(c.owner==='blue')blueIncome+=c.income;
    else if(c.owner==='red')redIncome+=c.income;
  });
  G.funds.blue+=blueIncome;
  G.funds.red+=redIncome;
  updateHUD();
  // Floating income text on canvas
  spawnIncomeFloat(myRole,myRole==='blue'?blueIncome:redIncome);
  addLog(`üí∞ –î–æ—Ö–æ–¥: +${myRole==='blue'?blueIncome:redIncome} ‚Ç¥ (${G.cities.filter(c=>c.owner===myRole).length} –º—ñ—Å—Ç)`,'warn');
}

function getIncome(role){
  let inc=BASE_INCOME;
  G.cities?.forEach(c=>{if(c.owner===role)inc+=c.income;});
  return inc;
}

function spawnIncomeFloat(role,amount){
  const body=document.getElementById('gameBody');
  const base=G.bases?.[role];if(!base||!body)return;
  // Convert world to screen
  const sx=base.x*camScale+camX;
  const sy=base.y*camScale+camY;
  const el=document.createElement('div');
  el.className='income-float';
  el.textContent='+'+amount+'‚Ç¥';
  el.style.left=sx+'px';el.style.top=(sy-20)+'px';
  document.getElementById('incomeFloaters').appendChild(el);
  setTimeout(()=>el.remove(),1600);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CITY CAPTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCityCapture(dt){
  if(!G.cities)return;
  const now=performance.now();
  G.cities.forEach(city=>{
    // Count units near city
    const captureRange=30;
    const blueNear=G.units.filter(u=>u.owner==='blue'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)<captureRange).length;
    const redNear=G.units.filter(u=>u.owner==='red'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)<captureRange).length;
    if(blueNear>0&&redNear===0){
      city.captureProgress.blue=Math.min(100,(city.captureProgress.blue||0)+dt*15);
      city.captureProgress.red=Math.max(0,(city.captureProgress.red||0)-dt*10);
      if(city.captureProgress.blue>=100&&city.owner!=='blue'){
        city.owner='blue';city.captureProgress={blue:100,red:0};
        addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –°–ò–ù–Ü–ú–ò!','good');
        toast('üèôÔ∏è '+city.name+' ‚Äî –Ω–∞—à–µ!');
        syncGameState();updateCitiesPanel();
      }
    }else if(redNear>0&&blueNear===0){
      city.captureProgress.red=Math.min(100,(city.captureProgress.red||0)+dt*15);
      city.captureProgress.blue=Math.max(0,(city.captureProgress.blue||0)-dt*10);
      if(city.captureProgress.red>=100&&city.owner!=='red'){
        city.owner='red';city.captureProgress={blue:0,red:100};
        addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –ß–ï–†–í–û–ù–ò–ú–ò!',myRole==='blue'?'bad':'good');
        if(myRole==='blue')toast('‚ö†Ô∏è '+city.name+' ‚Äî –∑–∞—Ö–æ–ø–ª–µ–Ω–æ!');
        syncGameState();updateCitiesPanel();
      }
    }else{
      // Decay slowly if contested or empty
      if(city.owner==='neutral'){
        city.captureProgress.blue=Math.max(0,(city.captureProgress.blue||0)-dt*3);
        city.captureProgress.red=Math.max(0,(city.captureProgress.red||0)-dt*3);
      }
    }
  });
}

function updateCitiesPanel(){
  const el=document.getElementById('citiesList');if(!el||!G.cities)return;
  if(!G.cities.length){el.innerHTML='<div style="font-size:10px;color:var(--dim)">–ù–µ–º–∞—î –º—ñ—Å—Ç</div>';return;}
  el.innerHTML=G.cities.map(c=>`
    <div class="city-row">
      <div class="city-dot ${c.owner==='neutral'?'neutral':c.owner}"></div>
      <span class="city-name">${c.name}</span>
      ${c.owner!=='neutral'?`<span class="city-income">+${c.income}‚Ç¥</span>`:''}
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickTimer(){
  gameTimer++;
  const m=Math.floor(gameTimer/60),s=gameTimer%60;
  document.getElementById('hudTimer').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  // Wave system: every 2 minutes advance wave
  if(isAI&&gameTimer%120===0&&!gameOver){
    G.wave++;
    document.getElementById('hudWave').textContent=G.wave;
    addLog('üåä –•–í–ò–õ–Ø '+G.wave+' ‚Äî –≤–æ—Ä–æ–≥ –ø–æ—Å–∏–ª—é—î—Ç—å—Å—è!','warn');
    if(gamePhase==='battle')spawnAIWave();
  }
  // Blitz mode timer: 5 min limit
  if(isAI&&aiMode==='blitz'&&gameTimer>=300&&!gameOver){
    const myCities=G.cities.filter(c=>c.owner===myRole).length;
    const oppCities=G.cities.filter(c=>c.owner!=myRole&&c.owner!=='neutral').length;
    if(myCities>oppCities)showResult(myRole,'–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å –∑–∞ –º—ñ—Å—Ç–∞–º–∏ —É –±–ª–∏—Ü–∫—Ä–∏–≥—É!');
    else showResult(myRole==='blue'?'red':'blue','–ß–∞—Å –≤–∏–π—à–æ–≤ ‚Äî –≤–æ—Ä–æ–≥ –∫–æ–Ω—Ç—Ä–æ–ª—é—î –±—ñ–ª—å—à–µ –º—ñ—Å—Ç!');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIRESTORE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let syncThrottle=null;
function syncGameState(){
  if(!lobbyId||isAI)return;
  if(syncThrottle)clearTimeout(syncThrottle);
  syncThrottle=setTimeout(async()=>{
    try{
      await setDoc(doc(db,'games',lobbyId),{
        units:G.units.filter(u=>!u._dead).map(u=>({id:u.id,type:u.type,owner:u.owner,x:Math.round(u.x),y:Math.round(u.y),hp:Math.round(u.hp)})),
        funds:G.funds,casualties:G.casualties,
        cities:G.cities.map(c=>({id:c.id,owner:c.owner,captureProgress:c.captureProgress})),
        phase:gamePhase,wave:G.wave,ts:Date.now(),
        ['presence.'+myRole]:Date.now()
      },{merge:true});
    }catch(e){}
  },150);
}

function listenGameState(code){
  if(gameUnsub)gameUnsub();
  gameUnsub=onSnapshot(doc(db,'games',code),snap=>{
    if(!snap.exists())return;
    const d=snap.data();
    const oppRole=myRole==='blue'?'red':'blue';
    const myUnits=G.units.filter(u=>u.owner===myRole);
    const remOpp=(d.units||[]).filter(u=>u.owner===oppRole).map(u=>{
      const ex=G.units.find(x=>x.id===u.id&&x.owner===oppRole);
      if(ex){ex.hp=u.hp;ex.tx=u.x;ex.ty=u.y;return ex;}
      const def=UNIT_DEFS[u.type]||UNIT_DEFS.infantry;
      return{...def,...u,tx:u.x,ty:u.y,vx:0,vy:0,state:'idle',attackTarget:null,lastAttack:0,lastAttackAnim:0};
    });
    G.units=[...myUnits,...remOpp];
    if(d.funds)G.funds=d.funds;
    if(d.casualties)G.casualties=d.casualties;
    // Sync city ownership
    if(d.cities&&G.cities){
      d.cities.forEach(dc=>{const lc=G.cities.find(c=>c.id===dc.id);if(lc){lc.owner=dc.owner;lc.captureProgress=dc.captureProgress;}});
      updateCitiesPanel();
    }
    if(d.phase&&d.phase!==gamePhase){
      gamePhase=d.phase;
      if(gamePhase==='battle'){document.getElementById('hudPhase').textContent='–ë–Ü–ô';document.getElementById('placementHint').classList.remove('vis');}
    }
    updateHUD();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleMapUpload=async(input)=>{
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('mapUploadStatus');
  st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';
  try{
    const comp=await compressImage(file,3000,3000,.85);
    st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';
    const prev=document.getElementById('mapPreview');prev.src=comp;prev.style.display='block';
    document.getElementById('mapUploadArea').style.display='none';
    const url=await uploadCloudinary(comp,'lobby_map_'+lobbyId);
    if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrl:url,mapVer:Date.now().toString()}).catch(()=>{});
    loadMapFromUrl(url);st.textContent='‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
  }catch(e){st.textContent='‚ùå '+e.message;}
};

async function uploadCloudinary(base64,publicId){
  const fd=new FormData();fd.append('file',base64);fd.append('upload_preset',CL_PRESET);
  if(publicId)fd.append('public_id',publicId);
  const r=await fetch(`https://api.cloudinary.com/v1_1/${CL_CLOUD}/image/upload`,{method:'POST',body:fd});
  if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'Upload failed');}
  return(await r.json()).secure_url;
}

function compressImage(file,maxW,maxH,q){
  return new Promise(res=>{
    const img=new Image(),url=URL.createObjectURL(file);
    img.onload=()=>{
      URL.revokeObjectURL(url);
      let w=img.width,h=img.height;
      const r=Math.min(maxW/w,maxH/h,1);w=Math.round(w*r);h=Math.round(h*r);
      const cv=document.createElement('canvas');cv.width=w;cv.height=h;
      cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',q));
    };img.src=url;
  });
}

function loadMapFromUrl(url){
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()=>{
    mapBg=img;mapBgW=img.naturalWidth;mapBgH=img.naturalHeight;
    centerMap();
    applyMapData(); // apply cities/spawns now that we know dimensions
    drawAll();
  };
  img.src=url;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS ‚Äî FIX #1: no black walls
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mapCtx,unitsCtx,frontCtx,uiCtx,interCtx,CW=0,CH=0;

function initGameCanvases(){
  [mapCtx,unitsCtx,frontCtx,uiCtx,interCtx]=['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].map(id=>document.getElementById(id).getContext('2d'));
  resizeCanvases();
  window.addEventListener('resize',()=>{if(document.getElementById('screen-game').classList.contains('active'))resizeCanvases();});
  setupInteraction();
}

function resizeCanvases(){
  const body=document.getElementById('gameBody');if(!body)return;
  // FIX: use clientWidth of gameBody minus side panel
  // Side panel is OUTSIDE gameBody now ‚Äî just use full gameBody dimensions
  CW=body.clientWidth;CH=body.clientHeight;
  CW=Math.max(1,CW);CH=Math.max(1,CH);
  ['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].forEach(id=>{
    const cv=document.getElementById(id);if(!cv)return;
    cv.width=CW;cv.height=CH;
    cv.style.width=CW+'px';cv.style.height=CH+'px';
  });
  if(mapBgW>0)centerMap();
  drawAll();
}

function centerMap(){
  if(!mapBgW||!CW||!CH)return;
  const sc=Math.min(CW/mapBgW,CH/mapBgH,.95);
  camScale=sc;camX=(CW-mapBgW*camScale)/2;camY=(CH-mapBgH*camScale)/2;
}

function s2w(sx,sy){return{wx:(sx-camX)/camScale,wy:(sy-camY)/camScale};}
window.resetView=()=>{if(mapBgW)centerMap();else{camScale=1;camX=0;camY=0;}drawAll();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INTERACTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupInteraction(){
  const cv=document.getElementById('interCanvas');
  cv.addEventListener('mousedown',onMD);cv.addEventListener('mousemove',onMM);cv.addEventListener('mouseup',onMU);
  cv.addEventListener('wheel',onWheel,{passive:false});cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('touchstart',onTStart,{passive:false});cv.addEventListener('touchmove',onTMove,{passive:false});cv.addEventListener('touchend',onTEnd,{passive:false});
  window.addEventListener('keydown',onKey);
}

let pinchDist=0;
function onTStart(e){e.preventDefault();if(e.touches.length===1){isDragging=false;dragLX=e.touches[0].clientX;dragLY=e.touches[0].clientY;}else if(e.touches.length===2)pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
function onTMove(e){e.preventDefault();if(e.touches.length===1){const dx=e.touches[0].clientX-dragLX,dy=e.touches[0].clientY-dragLY;if(Math.abs(dx)+Math.abs(dy)>4)isDragging=true;if(isDragging){camX+=dx;camY+=dy;dragLX=e.touches[0].clientX;dragLY=e.touches[0].clientY;drawAll();}}else if(e.touches.length===2){const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);zoom(nd/pinchDist,(e.touches[0].clientX+e.touches[1].clientX)/2,(e.touches[0].clientY+e.touches[1].clientY)/2);pinchDist=nd;}}
function onTEnd(e){e.preventDefault();if(!isDragging&&e.changedTouches.length===1)handleClick(e.changedTouches[0].clientX,e.changedTouches[0].clientY);isDragging=false;}
function onMD(e){if(e.button===2)return;isDragging=false;dragLX=e.clientX;dragLY=e.clientY;}
function onMM(e){if(e.buttons===1){const dx=e.clientX-dragLX,dy=e.clientY-dragLY;if(Math.abs(dx)+Math.abs(dy)>4)isDragging=true;if(isDragging){camX+=dx;camY+=dy;dragLX=e.clientX;dragLY=e.clientY;drawAll();}}}
function onMU(e){if(!isDragging)handleClick(e.clientX,e.clientY);isDragging=false;}
function onWheel(e){e.preventDefault();zoom(e.deltaY<0?1.12:0.9,e.clientX,e.clientY);}
function zoom(f,mx,my){const ns=Math.max(.08,Math.min(10,camScale*f));camX=mx-(mx-camX)*(ns/camScale);camY=my-(my-camY)*(ns/camScale);camScale=ns;document.getElementById('zoomInd').textContent=Math.round(camScale*100)+'%';drawAll();}
function onKey(e){
  if(e.code==='Escape'){placingType=null;document.getElementById('placementHint').classList.remove('vis');document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));}
  if(e.code==='Space'){e.preventDefault();if(gamePhase==='placement')startBattle();}
}

function handleClick(sx,sy){
  if(!G.units)return;
  const{wx,wy}=s2w(sx,sy);
  if(placingType){placeUnit(wx,wy);return;}
  const clicked=G.units.find(u=>Math.hypot(u.x-wx,u.y-wy)<(UNIT_DEFS[u.type]?.radius||10)+4);
  if(clicked){selectedUnitId=clicked.id;showSelInfo(clicked);}
  else{selectedUnitId=null;document.getElementById('selInfo').classList.remove('vis');}
  drawAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNIT PLACEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildUnitList(){
  document.getElementById('unitTypesList').innerHTML=Object.entries(UNIT_DEFS).map(([type,d])=>`
    <div class="sp-unit-btn" onclick="selectUnitType('${type}')" id="ubtn_${type}">
      <span class="sp-unit-icon">${d.emoji}</span>
      <div class="sp-unit-info"><div class="sp-unit-name">${d.name}</div><div class="sp-unit-stat">HP:${d.hp} ¬∑ –ê–¢–ö:${d.atk}</div></div>
      <span class="sp-unit-cost">${d.cost}</span>
    </div>`).join('');
}

window.selectUnitType=type=>{
  if(gamePhase!=='placement'){toast('‚ùå –õ–∏—à–µ –ø—ñ–¥ —á–∞—Å —Ä–æ–∑–º—ñ—â–µ–Ω–Ω—è!');return;}
  const def=UNIT_DEFS[type];
  if(G.funds[myRole]<def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤! ('+G.funds[myRole]+'/'+def.cost+')');return;}
  placingType=type;
  document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('ubtn_'+type)?.classList.add('active');
  document.getElementById('placementHint').classList.add('vis');
  document.getElementById('placementHint').textContent='–†–û–ó–ú–Ü–°–¢–Ü–¢–¨ '+def.name.toUpperCase()+' ('+def.cost+' ‚Ç¥) | ESC = —Å–∫–∞—Å—É–≤–∞—Ç–∏';
};

function isOnWater(wx,wy){
  // Check against water areas stored in G
  if(!G._waterAreas||!G._waterAreas.length)return false;
  return G._waterAreas.some(w=>Math.hypot(wx-w.x,wy-w.y)<w.r);
}

function isOnBridge(wx,wy){
  if(!G._bridges||!G._bridges.length)return false;
  return G._bridges.some(b=>Math.hypot(wx-b.x,wy-b.y)<b.r);
}

function placeUnit(wx,wy){
  if(!placingType)return;
  const def=UNIT_DEFS[placingType];if(!def){placingType=null;return;}
  const mapW=mapBgW||2000,halfW=mapW/2;
  const validZone=myRole==='blue'?wx<halfW:wx>=halfW;
  if(!validZone){toast('‚ö†Ô∏è –õ–∏—à–µ –Ω–∞ —Å–≤–æ—ó–π –ø–æ–ª–æ–≤–∏–Ω—ñ!');return;}
  if(G.funds[myRole]<def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤!');return;}
  // Check water ‚Äî only helicopters can be on water
  if(isOnWater(wx,wy)&&!isOnBridge(wx,wy)&&placingType!=='heli'){
    toast('üåä –ù–µ –º–æ–∂–Ω–∞ —Ä–æ–∑–º—ñ—â—É–≤–∞—Ç–∏ –Ω–∞ –≤–æ–¥—ñ! –õ–∏—à–µ –≥–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä –∞–±–æ –Ω–∞ –º–æ—Å—Ç—É.');return;
  }
  G.units.push({
    id:G.nextId++,type:placingType,owner:myRole,
    x:wx,y:wy,tx:wx,ty:wy,vx:0,vy:0,
    hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,
    speed:def.speed,range:def.range,radius:def.radius,
    state:'idle',attackTarget:null,lastAttack:0,lastAttackAnim:0,
  });
  G.funds[myRole]-=def.cost;
  addLog('üìç '+def.name+' —Ä–æ–∑–º—ñ—â–µ–Ω–æ','info');
  placingType=null;
  document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('placementHint').classList.remove('vis');
  syncGameState();updateHUD();drawAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BATTLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startBattle=()=>{
  if(gamePhase==='battle')return;
  if(G.units.filter(u=>u.owner===myRole).length===0){toast('‚ö†Ô∏è –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å —Ö–æ—á–∞ –± 1 —é–Ω—ñ—Ç!');return;}
  gamePhase='battle';
  document.getElementById('hudPhase').textContent='–ë–Ü–ô';
  document.getElementById('placementHint').classList.remove('vis');
  addLog('‚öîÔ∏è –ë–Ü–ô –†–û–ó–ü–û–ß–ê–¢–û!','warn');
  if(isAI)spawnAIUnits();
  syncGameState();
};

function spawnAIUnits(){
  const oppRole=myRole==='blue'?'red':'blue';
  const mapW=mapBgW||2000,mapH=mapBgH||1200;
  const spawnX=oppRole==='red'?mapW*.8:mapW*.2;
  // Different composition based on AI mode
  let types;
  if(aiMode==='defense')types=['infantry','infantry','infantry','apc','tank'];
  else if(aiMode==='attack')types=['tank','tank','apc','apc','infantry','artillery'];
  else if(aiMode==='blitz')types=['heli','heli','apc','apc','infantry'];
  else types=['infantry','apc','tank','heli','artillery','infantry'];
  types.forEach((t,i)=>{
    const def=UNIT_DEFS[t];
    G.units.push({id:G.nextId++,type:t,owner:oppRole,
      x:spawnX+rnd(-80,80),y:mapH*.15+i*((mapH*.7)/types.length),
      tx:0,ty:0,vx:0,vy:0,
      hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,
      speed:def.speed,range:def.range,radius:def.radius,
      state:aiMode==='defense'?'defend':'advance',
      defendX:spawnX,defendY:mapH*.5,
      attackTarget:null,lastAttack:0,lastAttackAnim:0});
  });
}

function spawnAIWave(){
  const oppRole=myRole==='blue'?'red':'blue';
  const mapW=mapBgW||2000,mapH=mapBgH||1200;
  const spawnX=oppRole==='red'?mapW*.82:mapW*.18;
  // Scale with wave
  const types=G.wave<3?['infantry','apc']:G.wave<5?['apc','tank','infantry']:['tank','tank','heli'];
  types.forEach((t,i)=>{
    const def=UNIT_DEFS[t];
    G.units.push({id:G.nextId++,type:t,owner:oppRole,
      x:spawnX+rnd(-40,40),y:mapH*.2+i*120+rnd(-30,30),
      tx:0,ty:0,vx:0,vy:0,
      hp:def.hp*Math.min(1+G.wave*.1,2),maxHp:def.hp*Math.min(1+G.wave*.1,2),
      atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,
      state:aiMode==='defense'?'defend':'advance',
      defendX:spawnX,defendY:mapH*.5,
      attackTarget:null,lastAttack:0,lastAttackAnim:0});
  });
}

function rnd(a,b){return a+Math.floor(Math.random()*(b-a+1));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastFrame=0;
function startGameLoop(){
  if(animFrame)cancelAnimationFrame(animFrame);
  lastFrame=performance.now();
  (function loop(ts){
    const dt=Math.min((ts-lastFrame)/1000,.05);lastFrame=ts;
    if(gamePhase==='battle'){
      updateUnits(dt);
      updateAI(dt);
      updateCityCapture(dt);
      checkWinCondition();
    }
    drawAll();
    animFrame=requestAnimationFrame(loop);
  })(performance.now());
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNIT LOGIC ‚Äî water pathing
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function canMoveTo(x,y,unitType){
  // Helis fly over water; others need bridges
  if(unitType==='heli')return true;
  if(isOnWater(x,y)&&!isOnBridge(x,y))return false;
  return true;
}

function updateUnits(dt){
  const now=performance.now();
  for(const u of G.units.filter(u=>u.owner===myRole&&!u._dead)){
    const opp=G.units.filter(e=>e.owner!==myRole&&!e._dead);
    if(!opp.length){u.state='idle';continue;}
    let nearest=null,nd=Infinity;
    for(const e of opp){const d=Math.hypot(e.x-u.x,e.y-u.y);if(d<nd){nd=d;nearest=e;}}
    if(nd<=u.range){
      u.state='attack';u.attackTarget=nearest.id;
      if(now-u.lastAttack>1000){
        u.lastAttack=now;u.lastAttackAnim=now;
        const dmg=Math.max(1,u.atk-Math.floor(nearest.def/3)+rnd(-3,3));
        nearest.hp-=dmg;
        if(nearest.hp<=0)killUnit(nearest);
      }
    }else{
      u.state='advance';
      const dx=nearest.x-u.x,dy=nearest.y-u.y,dist=Math.sqrt(dx*dx+dy*dy);
      const nx=u.x+(dx/dist)*u.speed*dt;
      const ny=u.y+(dy/dist)*u.speed*dt;
      if(canMoveTo(nx,ny,u.type)){u.x=nx;u.y=ny;}
      else{
        // Try sliding around obstacle
        if(canMoveTo(nx,u.y,u.type))u.x=nx;
        else if(canMoveTo(u.x,ny,u.type))u.y=ny;
      }
    }
  }
  G.units=G.units.filter(u=>!u._dead);
}

function killUnit(u){
  u._dead=true;
  G.casualties[u.owner]=(G.casualties[u.owner]||0)+1;
  addLog('üíÄ '+UNIT_DEFS[u.type]?.name+' –∑–Ω–∏—â–µ–Ω–æ!',u.owner===myRole?'bad':'good');
  updateHUD();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI LOGIC ‚Äî mode-aware
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAI(dt){
  if(!isAI)return;
  const oppRole=myRole==='blue'?'red':'blue';
  const now=performance.now();
  const mapW=mapBgW||2000;

  for(const u of G.units.filter(u=>u.owner===oppRole&&!u._dead)){
    const pl=G.units.filter(e=>e.owner===myRole&&!e._dead);
    const enemyCities=G.cities?.filter(c=>c.owner===myRole)||[];
    const neutralCities=G.cities?.filter(c=>c.owner==='neutral')||[];

    let target=null; // world position to move toward

    if(aiMode==='defense'){
      // AI stays near its base and counter-attacks when enemies come close
      const base=G.bases?.[oppRole];
      const baseX=base?base.x:(oppRole==='red'?mapW*.85:mapW*.15);
      const baseY=base?base.y:(mapBgH||1200)*.5;
      const nearestEnemy=pl.reduce((n,e)=>{const d=Math.hypot(e.x-u.x,e.y-u.y);return(!n||d<n.d)?{unit:e,d}:n;},null);
      if(nearestEnemy&&nearestEnemy.d<300){
        // Chase if enemy is close
        target={x:nearestEnemy.unit.x,y:nearestEnemy.unit.y};
      }else{
        // Return to defend zone
        target={x:baseX+(rnd(-100,100)),y:baseY+(rnd(-100,100))};
      }
    }else if(aiMode==='attack'||aiMode==='blitz'){
      // Aggressively push player's base
      const playerBase=G.bases?.[myRole];
      // Prioritize enemy cities first
      if(enemyCities.length>0){const c=enemyCities[Math.floor(Math.random()*Math.min(2,enemyCities.length))];target={x:c.x,y:c.y};}
      else if(pl.length>0){target={x:pl[0].x,y:pl[0].y};}
      else if(playerBase)target={x:playerBase.x,y:playerBase.y};
    }else{
      // conquest: go for neutral cities first, then enemy
      const allTargets=[...neutralCities,...enemyCities];
      if(allTargets.length>0){
        // Nearest uncaptured
        let nearC=null,nearCD=Infinity;
        for(const c of allTargets){const d=Math.hypot(c.x-u.x,c.y-u.y);if(d<nearCD){nearCD=d;nearC=c;}}
        target=nearC?{x:nearC.x,y:nearC.y}:(pl.length?{x:pl[0].x,y:pl[0].y}:null);
      }else if(pl.length>0){target={x:pl[0].x,y:pl[0].y};}
    }

    // Check attack range
    let attackTarget=null;
    for(const e of pl){if(Math.hypot(e.x-u.x,e.y-u.y)<=u.range){attackTarget=e;break;}}
    if(attackTarget){
      if(now-u.lastAttack>1000){
        u.lastAttack=now;u.lastAttackAnim=now;
        const dmg=Math.max(1,u.atk-Math.floor(attackTarget.def/3)+rnd(-3,3));
        attackTarget.hp-=dmg;if(attackTarget.hp<=0)killUnit(attackTarget);
      }
    }else if(target){
      const dx=target.x-u.x,dy=target.y-u.y,dist=Math.max(1,Math.sqrt(dx*dx+dy*dy));
      if(dist>5){
        const nx=u.x+(dx/dist)*u.speed*dt;
        const ny=u.y+(dy/dist)*u.speed*dt;
        if(canMoveTo(nx,ny,u.type)){u.x=nx;u.y=ny;}
        else{
          if(canMoveTo(nx,u.y,u.type))u.x=nx;
          else if(canMoveTo(u.x,ny,u.type))u.y=ny;
        }
      }
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIN CONDITION ‚Äî cities + base
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkWinCondition(){
  if(gameOver)return;
  const bl=G.units.filter(u=>u.owner==='blue'&&!u._dead);
  const rd=G.units.filter(u=>u.owner==='red'&&!u._dead);
  if(!bl.length&&rd.length)showResult('red','–í—Å—ñ —Å–∏–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');
  else if(!rd.length&&bl.length)showResult('blue','–í—Å—ñ —á–µ—Ä–≤–æ–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');
  else if(!bl.length&&!rd.length)return; // draw, keep going

  // Check base capture (if bases defined, unit standing on enemy base for 3+ seconds)
  if(G.bases){
    ['blue','red'].forEach(team=>{
      const enemyBase=G.bases[team==='blue'?'red':'blue'];
      if(!enemyBase)return;
      const inBase=G.units.filter(u=>u.owner===team&&!u._dead&&Math.hypot(u.x-enemyBase.x,u.y-enemyBase.y)<40);
      if(inBase.length>=2){
        if(!G._baseTimer){G._baseTimer={team,start:Date.now()};}
        else if(G._baseTimer.team===team&&(Date.now()-G._baseTimer.start)>5000){
          showResult(team,'–ë–∞–∑–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤–∑—è—Ç–∞!');
        }
      }else if(G._baseTimer?.team===team){G._baseTimer=null;}
    });
  }

  // Conquest: win when all cities captured
  if(isAI&&aiMode==='conquest'&&G.cities.length>0){
    const oppRole=myRole==='blue'?'red':'blue';
    if(G.cities.every(c=>c.owner===myRole))showResult(myRole,'–í—Å—ñ –º—ñ—Å—Ç–∞ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º!');
    else if(G.cities.every(c=>c.owner===oppRole))showResult(oppRole,'–í–æ—Ä–æ–≥ –∑–∞—Ö–æ–ø–∏–≤ –≤—Å—ñ –º—ñ—Å—Ç–∞!');
  }
}

function showResult(winner,reason=''){
  if(gameOver)return;gameOver=true;
  if(timerInterval)clearInterval(timerInterval);
  if(incomeInterval)clearInterval(incomeInterval);
  const isWinner=winner===myRole;
  document.getElementById('resultEmoji').textContent=isWinner?'üèÜ':'üíÄ';
  document.getElementById('resultTitle').textContent=isWinner?'–ü–ï–†–ï–ú–û–ì–ê!':'–ü–û–†–ê–ó–ö–ê';
  document.getElementById('resultTitle').style.color=isWinner?'var(--green)':'var(--red)';
  const blueCities=G.cities?.filter(c=>c.owner==='blue').length||0;
  const redCities=G.cities?.filter(c=>c.owner==='red').length||0;
  document.getElementById('resultSub').textContent=
    (reason?reason+'\n':'')+
    `üîµ –í—Ç—Ä–∞—Ç–∏: ${G.casualties?.blue||0} ¬∑ –ú—ñ—Å—Ç: ${blueCities}\n`+
    `üî¥ –í—Ç—Ä–∞—Ç–∏: ${G.casualties?.red||0} ¬∑ –ú—ñ—Å—Ç: ${redCities}\n`+
    `‚è± ${document.getElementById('hudTimer').textContent}`;
  document.getElementById('resultOverlay').classList.add('vis');
}

window.backToMenu=()=>{
  document.getElementById('resultOverlay').classList.remove('vis');
  if(animFrame)cancelAnimationFrame(animFrame);
  if(timerInterval)clearInterval(timerInterval);
  if(incomeInterval)clearInterval(incomeInterval);
  if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
  if(gameUnsub){gameUnsub();gameUnsub=null;}
  if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}
  hideDcBanner();
  G={};gameOver=false;placingType=null;isAI=false;lobbyId=null;
  showScreen('screen-menu');
};
window.confirmQuit=()=>{if(confirm('–í–∏–π—Ç–∏ –∑ –≥—Ä–∏?'))backToMenu();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawAll(){drawMap();drawFrontLine();drawUnits();drawUI();}

function drawMap(){
  if(!mapCtx||!CW||!CH)return;
  mapCtx.clearRect(0,0,CW,CH);
  // FIX: background color matches map area ‚Äî no black bars
  mapCtx.fillStyle='#06090d';mapCtx.fillRect(0,0,CW,CH);
  mapCtx.save();mapCtx.translate(camX,camY);mapCtx.scale(camScale,camScale);
  const w=mapBgW||2000,h=mapBgH||1200;

  if(mapBg&&mapBgW>0){
    // Draw map background
    mapCtx.drawImage(mapBg,0,0,w,h);
    // ‚îÄ‚îÄ WATER OVERLAY: detect and render blue water areas from stored data
    if(G._waterAreas&&G._waterAreas.length){
      // Water already defined via editor or detection
    }
    // Draw water from detected areas (painted blue in editor)
    // If map has no stored water, try to auto-detect large blue regions
    // (done lazily via canvas pixel analysis ‚Äî only once)
    if(!G._waterDetected&&mapBg){
      detectWaterAreas();
      G._waterDetected=true;
    }
    // Draw water shimmer overlay
    if(G._waterAreas&&G._waterAreas.length){
      const t=Date.now()/1000;
      G._waterAreas.forEach(w2=>{
        mapCtx.beginPath();mapCtx.arc(w2.x,w2.y,w2.r,0,Math.PI*2);
        mapCtx.fillStyle=`rgba(30,64,175,${0.12+Math.sin(t*1.5+w2.x*.01)*.04})`;
        mapCtx.fill();
      });
    }
    // Draw bridges (tan color strips)
    if(G._bridges&&G._bridges.length){
      G._bridges.forEach(b=>{
        mapCtx.fillStyle='rgba(146,64,14,.6)';
        mapCtx.beginPath();mapCtx.arc(b.x,b.y,b.r,0,Math.PI*2);mapCtx.fill();
        mapCtx.strokeStyle='rgba(251,191,36,.5)';mapCtx.lineWidth=2;mapCtx.stroke();
        mapCtx.font='12px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
        mapCtx.fillText('üåâ',b.x,b.y);
      });
    }
  }else{
    // Default beautiful terrain map
    mapCtx.fillStyle='#141e0e';mapCtx.fillRect(0,0,w,h);
    // Forest patches
    for(let i=0;i<20;i++){
      mapCtx.fillStyle=`rgba(${20+Math.sin(i)*8},${40+Math.cos(i)*15},${12},.7)`;
      mapCtx.beginPath();mapCtx.ellipse(w*(.05+.9*(i%10)/10),h*(.1+.8*Math.floor(i/10)/2),w*.07,h*.05,i*.4,0,Math.PI*2);mapCtx.fill();
    }
    // Water body (river in center)
    const riverGrad=mapCtx.createLinearGradient(w*.45,0,w*.55,0);
    riverGrad.addColorStop(0,'rgba(30,64,175,.6)');riverGrad.addColorStop(.5,'rgba(37,99,235,.7)');riverGrad.addColorStop(1,'rgba(30,64,175,.6)');
    mapCtx.fillStyle=riverGrad;
    mapCtx.beginPath();
    mapCtx.moveTo(w*.46,0);mapCtx.bezierCurveTo(w*.44,h*.25,w*.52,h*.5,w*.48,h*.75);mapCtx.lineTo(w*.48,h);
    mapCtx.lineTo(w*.54,h);mapCtx.bezierCurveTo(w*.56,h*.75,w*.48,h*.5,w*.52,h*.25);mapCtx.lineTo(w*.54,0);
    mapCtx.fill();
    // Bridge
    mapCtx.fillStyle='rgba(146,64,14,.8)';mapCtx.fillRect(w*.45,h*.48,w*.1,h*.04);
    mapCtx.strokeStyle='rgba(251,191,36,.7)';mapCtx.lineWidth=3;mapCtx.strokeRect(w*.45,h*.48,w*.1,h*.04);
    // Default water areas stored in G
    G._waterAreas=[{x:w*.5,y:h*.3,r:w*.06},{x:w*.5,y:h*.5,r:w*.05},{x:w*.5,y:h*.7,r:w*.06}];
    G._bridges=[{x:w*.5,y:h*.5,r:15}];
    // Grid
    mapCtx.strokeStyle='rgba(34,197,94,.03)';mapCtx.lineWidth=1;
    for(let x=0;x<w;x+=80){mapCtx.beginPath();mapCtx.moveTo(x,0);mapCtx.lineTo(x,h);mapCtx.stroke();}
    for(let y=0;y<h;y+=80){mapCtx.beginPath();mapCtx.moveTo(0,y);mapCtx.lineTo(w,y);mapCtx.stroke();}
  }

  // Placement highlight
  if(gamePhase==='placement'&&placingType){
    const zx=myRole==='blue'?0:w/2;
    mapCtx.fillStyle='rgba(34,197,94,.06)';mapCtx.fillRect(zx,0,w/2,h);
    mapCtx.strokeStyle='rgba(34,197,94,.35)';mapCtx.lineWidth=3;mapCtx.setLineDash([10,8]);
    mapCtx.strokeRect(zx+2,2,w/2-4,h-4);mapCtx.setLineDash([]);
  }

  // Draw bases
  if(G.bases){
    ['blue','red'].forEach(team=>{
      const base=G.bases[team];if(!base)return;
      const color=team==='blue'?'rgba(59,130,246,.9)':'rgba(239,68,68,.9)';
      // Pulsing ring
      const pulse=.8+Math.sin(Date.now()*.003)*.2;
      mapCtx.beginPath();mapCtx.arc(base.x,base.y,24*pulse,0,Math.PI*2);
      mapCtx.fillStyle=team==='blue'?'rgba(59,130,246,.1)':'rgba(239,68,68,.1)';mapCtx.fill();
      mapCtx.strokeStyle=color;mapCtx.lineWidth=2.5;mapCtx.stroke();
      mapCtx.font='24px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
      mapCtx.fillText(team==='blue'?'üè†':'üèöÔ∏è',base.x,base.y);
      // Label
      mapCtx.font='bold 10px Oswald';mapCtx.fillStyle=team==='blue'?'#60a5fa':'#f87171';
      mapCtx.fillText('–ë–ê–ó–ê',base.x,base.y+22);
    });
  }

  // Draw cities ‚Äî FIX #5: cities are the main objective
  if(G.cities){
    const t=Date.now();
    G.cities.forEach(city=>{
      const clr=city.owner==='blue'?'#3b82f6':city.owner==='red'?'#ef4444':'#94a3b8';
      const glowClr=city.owner==='blue'?'rgba(59,130,246,.3)':city.owner==='red'?'rgba(239,68,68,.3)':'rgba(148,163,184,.1)';
      // Glow
      mapCtx.beginPath();mapCtx.arc(city.x,city.y,28,0,Math.PI*2);
      mapCtx.fillStyle=glowClr;mapCtx.fill();
      // City icon
      mapCtx.font='22px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
      mapCtx.fillText('üèôÔ∏è',city.x,city.y);
      // Ownership ring
      mapCtx.beginPath();mapCtx.arc(city.x,city.y,18,0,Math.PI*2);
      mapCtx.strokeStyle=clr;mapCtx.lineWidth=2.5;mapCtx.stroke();
      // Name
      mapCtx.font='bold 9px Share Tech Mono';mapCtx.textAlign='center';mapCtx.textBaseline='top';
      mapCtx.fillStyle='rgba(255,255,255,.8)';
      mapCtx.fillText(city.name,city.x,city.y+20);
      // Capture progress bar
      const progress=city.captureProgress;
      if(progress){
        const barW=36,barH=4;
        const bx=city.x-barW/2,by=city.y-28;
        mapCtx.fillStyle='rgba(0,0,0,.5)';mapCtx.fillRect(bx,by,barW,barH);
        if(progress.blue>0){mapCtx.fillStyle='#3b82f6';mapCtx.fillRect(bx,by,barW*(progress.blue/100),barH);}
        if(progress.red>0){mapCtx.fillStyle='#ef4444';mapCtx.fillRect(bx+barW*(1-progress.red/100),by,barW*(progress.red/100),barH);}
      }
      // Income badge
      if(city.owner!=='neutral'){
        mapCtx.fillStyle=city.owner==='blue'?'rgba(59,130,246,.8)':'rgba(239,68,68,.8)';
        const badge='+'+city.income+'‚Ç¥';
        mapCtx.font='bold 8px Oswald';mapCtx.textAlign='center';mapCtx.textBaseline='bottom';
        mapCtx.fillText(badge,city.x,city.y-20);
      }
    });
  }

  mapCtx.restore();
}

// Auto-detect water from map image (looks for blue-dominant pixels)
function detectWaterAreas(){
  if(!mapBg||!mapBgW)return;
  // Create offscreen canvas to sample pixels
  const oc=document.createElement('canvas');oc.width=100;oc.height=Math.round(100*mapBgH/mapBgW);
  const oc2=oc.getContext('2d');oc2.drawImage(mapBg,0,0,oc.width,oc.height);
  const data=oc2.getImageData(0,0,oc.width,oc.height).data;
  const waterRegions=[];
  const step=5;
  for(let y=0;y<oc.height;y+=step){
    for(let x=0;x<oc.width;x+=step){
      const i=(y*oc.width+x)*4;
      const r=data[i],g=data[i+1],b=data[i+2];
      // Water: blue dominant, not too dark
      if(b>120&&b>r*1.4&&b>g*1.2&&r<120){
        const wx=(x/oc.width)*mapBgW;
        const wy=(y/oc.height)*mapBgH;
        waterRegions.push({x:wx,y:wy,r:mapBgW/oc.width*step*1.5});
      }
    }
  }
  if(waterRegions.length>0)G._waterAreas=waterRegions;
}

function drawFrontLine(){
  if(!frontCtx||!CW||!CH)return;
  frontCtx.clearRect(0,0,CW,CH);
  const bl=G.units?.filter(u=>u.owner==='blue'&&!u._dead);
  const rd=G.units?.filter(u=>u.owner==='red'&&!u._dead);
  if(!bl?.length||!rd?.length)return;
  const midpoints=[];
  for(const b of bl){let nearRed=null,minD=Infinity;for(const r of rd){const d=Math.hypot(r.x-b.x,r.y-b.y);if(d<minD){minD=d;nearRed=r;}}if(nearRed)midpoints.push({x:(b.x+nearRed.x)/2,y:(b.y+nearRed.y)/2});}
  for(const r of rd){let nearBlue=null,minD=Infinity;for(const b of bl){const d=Math.hypot(b.x-r.x,b.y-r.y);if(d<minD){minD=d;nearBlue=b;}}if(nearBlue)midpoints.push({x:(r.x+nearBlue.x)/2,y:(r.y+nearBlue.y)/2});}
  if(midpoints.length<2)return;
  midpoints.sort((a,b)=>a.y-b.y);
  const pts=[midpoints[0]];
  for(let i=1;i<midpoints.length;i++){const last=pts[pts.length-1];if(Math.hypot(midpoints[i].x-last.x,midpoints[i].y-last.y)>15)pts.push(midpoints[i]);}
  if(pts.length<2)return;
  frontCtx.save();frontCtx.translate(camX,camY);frontCtx.scale(camScale,camScale);
  const lw=2.5/camScale;
  frontCtx.lineCap='round';frontCtx.lineJoin='round';
  frontCtx.shadowColor='rgba(255,200,0,.8)';frontCtx.shadowBlur=12/camScale;
  frontCtx.strokeStyle='rgba(255,220,0,.5)';frontCtx.lineWidth=lw*2;
  drawSmoothLine(frontCtx,pts);
  frontCtx.shadowBlur=0;frontCtx.strokeStyle='rgba(255,240,100,.9)';frontCtx.lineWidth=lw;
  drawSmoothLine(frontCtx,pts);
  frontCtx.restore();
}

function drawSmoothLine(ctx,pts){
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  if(pts.length===2){ctx.lineTo(pts[1].x,pts[1].y);}
  else{for(let i=0;i<pts.length-1;i++){const mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;if(i===0)ctx.lineTo(mx,my);else ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);}ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);}
  ctx.stroke();
}

function drawUnits(){
  if(!unitsCtx||!CW||!CH)return;
  unitsCtx.clearRect(0,0,CW,CH);
  if(!G.units?.length)return;
  const now=performance.now();
  unitsCtx.save();unitsCtx.translate(camX,camY);unitsCtx.scale(camScale,camScale);
  for(const u of G.units){
    if(u._dead)continue;
    const def=UNIT_DEFS[u.type]||UNIT_DEFS.infantry;
    const r=def.radius,isBlue=u.owner==='blue',isSel=u.id===selectedUnitId;
    const hp=u.hp/u.maxHp,isAtk=now-u.lastAttackAnim<250;
    if(isAtk){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r*2.5,0,Math.PI*2);unitsCtx.fillStyle=isBlue?'rgba(59,130,246,.15)':'rgba(239,68,68,.15)';unitsCtx.fill();}
    if(isSel){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r+6,0,Math.PI*2);unitsCtx.strokeStyle='rgba(255,255,255,.9)';unitsCtx.lineWidth=2/camScale;unitsCtx.stroke();}
    unitsCtx.beginPath();unitsCtx.arc(u.x+1.5,u.y+2.5,r,0,Math.PI*2);unitsCtx.fillStyle='rgba(0,0,0,.5)';unitsCtx.fill();
    unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r,0,Math.PI*2);
    const g=unitsCtx.createRadialGradient(u.x-r*.3,u.y-r*.35,0,u.x,u.y,r);
    g.addColorStop(0,isBlue?'#93c5fd':'#fca5a5');g.addColorStop(1,isBlue?'#1d4ed8':'#b91c1c');
    unitsCtx.fillStyle=g;unitsCtx.fill();
    unitsCtx.strokeStyle=isBlue?'#3b82f6':'#ef4444';unitsCtx.lineWidth=1.5/camScale;unitsCtx.stroke();
    unitsCtx.font=`bold ${r*1.2}px serif`;unitsCtx.textAlign='center';unitsCtx.textBaseline='middle';
    unitsCtx.fillText(def.emoji,u.x,u.y+r*.05);
    // HP bar
    const bw=r*2.5,bh=Math.max(2,3/camScale),bx=u.x-bw/2,by=u.y-r-7/camScale;
    unitsCtx.fillStyle='rgba(0,0,0,.6)';unitsCtx.fillRect(bx-1,by-1,bw+2,bh+2);
    unitsCtx.fillStyle='#1a1a1a';unitsCtx.fillRect(bx,by,bw,bh);
    unitsCtx.fillStyle=hp>.6?'#22c55e':hp>.3?'#f59e0b':'#ef4444';unitsCtx.fillRect(bx,by,bw*hp,bh);
    // Attack line
    if(u.attackTarget&&isAtk){
      const tgt=G.units.find(x=>x.id===u.attackTarget);
      if(tgt){unitsCtx.beginPath();unitsCtx.moveTo(u.x,u.y);unitsCtx.lineTo(tgt.x,tgt.y);
        unitsCtx.strokeStyle=isBlue?'rgba(96,165,250,.6)':'rgba(248,113,113,.6)';
        unitsCtx.lineWidth=1.5/camScale;unitsCtx.setLineDash([4/camScale,4/camScale]);unitsCtx.stroke();unitsCtx.setLineDash([]);}
    }
  }
  unitsCtx.restore();
}

// ‚îÄ‚îÄ UI LAYER: capture rings on cities ‚îÄ‚îÄ
function drawUI(){
  if(!uiCtx||!CW||!CH)return;
  uiCtx.clearRect(0,0,CW,CH);
  // Capture progress arcs drawn on units canvas already via drawMap
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  if(!G.units)return;
  const myUnits=G.units.filter(u=>u.owner===myRole&&!u._dead).length;
  document.getElementById('hudBlueUnits').textContent=G.units.filter(u=>u.owner==='blue'&&!u._dead).length;
  document.getElementById('hudRedUnits').textContent=G.units.filter(u=>u.owner==='red'&&!u._dead).length;
  document.getElementById('hudWave').textContent=G.wave||1;
  document.getElementById('hudFunds').textContent=G.funds?.[myRole]||0;
  document.getElementById('spFunds').textContent=G.funds?.[myRole]||0;
  document.getElementById('spIncome').textContent='+'+getIncome(myRole)+'/15—Å';
  document.getElementById('spUnits').textContent=myUnits;
  document.getElementById('spCasualties').textContent=G.casualties?.[myRole]||0;
  document.getElementById('casBlue').textContent=G.casualties?.blue||0;
  document.getElementById('casRed').textContent=G.casualties?.red||0;
}

function showSelInfo(u){
  const def=UNIT_DEFS[u.type];
  document.getElementById('selInfo').classList.add('vis');
  document.getElementById('siName').textContent=def.emoji+' '+def.name;
  document.getElementById('siHPText').textContent=Math.round(u.hp)+'/'+u.maxHp;
  document.getElementById('siHPBar').style.width=(u.hp/u.maxHp*100)+'%';
  document.getElementById('siHPBar').style.background=u.hp/u.maxHp>.5?'var(--green)':u.hp/u.maxHp>.25?'var(--gold)':'var(--red)';
  document.getElementById('siAtk').textContent=u.atk;
  document.getElementById('siDef').textContent=u.def;
  document.getElementById('siSpd').textContent=u.speed;
}

function addLog(msg,type='info'){
  const el=document.getElementById('spLog');
  const d=document.createElement('div');d.className='log-entry '+type;d.textContent=msg;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
  if(el.children.length>80)el.removeChild(el.firstChild);
}

window.toast=(msg,dur=2500)=>{
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',dur);
};

// Continuous render loop
requestAnimationFrame(function loop(){drawAll();requestAnimationFrame(loop);});
</script>
</body>
</html>
