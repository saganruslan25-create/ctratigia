!DOCTYPE html
html lang=uk
head
meta charset=UTF-8
meta name=viewport content=width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no
title–°–¢–†–ê–¢–ï–ì–Ü–Ø  –û–ü–ï–†–ê–¶–Ü–Ø –î–ù–Ü–ü–†–ûtitle
link href=httpsfonts.googleapis.comcss2family=Rajdhaniwght@400;500;600;700&family=Oswaldwght@300;400;500;600;700&family=Share+Tech+Mono&display=swap rel=stylesheet
style
root{
  --bg#040608;--panel#080c10;--borderrgba(34,197,94,.18);
  --green#22c55e;--green2#4ade80;--red#ef4444;--blue#3b82f6;
  --gold#f59e0b;--teal#14b8a6;--purple#a855f7;--water#1e40af;
  --text#e2e8f0;--dim#64748b;--dark#020305;
}
{margin0;padding0;box-sizingborder-box;}
body{backgroundvar(--bg);colorvar(--text);font-family'Share Tech Mono',monospace;height100vh;overflowhidden;user-selectnone;}
input,select,textarea{user-selecttext!important;-webkit-user-selecttext!important;}
.screen{positionfixed;inset0;displaynone;z-index100;}
.screen.active{displayflex;}

 ‚îÄ‚îÄ MENU ‚îÄ‚îÄ 
#screen-menu{flex-directioncolumn;align-itemscenter;justify-contentcenter;
  backgroundradial-gradient(ellipse at 20% 30%,rgba(34,197,94,.07) 0%,transparent 50%),
             radial-gradient(ellipse at 80% 70%,rgba(59,130,246,.05) 0%,transparent 50%),var(--bg);}
.menu-bg-grid{positionabsolute;inset0;
  background-imagelinear-gradient(rgba(34,197,94,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(34,197,94,.04) 1px,transparent 1px);
  background-size40px 40px;mask-imageradial-gradient(ellipse at center,black 40%,transparent 80%);}
.menu-logo{positionrelative;z-index1;text-aligncenter;margin-bottom40px;}
.menu-logo-top{font-family'Oswald',sans-serif;font-size11px;font-weight400;colorvar(--green);letter-spacing8px;margin-bottom8px;opacity.7;}
.menu-logo-title{font-family'Oswald',sans-serif;font-size56px;font-weight700;line-height.9;letter-spacing2px;
  backgroundlinear-gradient(135deg,#fff 30%,var(--green2));-webkit-background-cliptext;-webkit-text-fill-colortransparent;}
.menu-logo-sub{font-size12px;colorvar(--dim);letter-spacing4px;margin-top10px;}
.menu-user{positionrelative;z-index1;margin-bottom20px;padding8px 20px;
  backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.07);border-radius20px;
  font-size11px;colorvar(--dim);displayflex;align-itemscenter;gap8px;}
.menu-user-badge{font-size10px;padding2px 8px;border-radius10px;font-family'Oswald',sans-serif;letter-spacing1px;}
.badge-admin{backgroundrgba(245,158,11,.15);colorvar(--gold);border1px solid rgba(245,158,11,.3);}
.badge-anon{backgroundrgba(100,116,139,.1);colorvar(--dim);border1px solid rgba(100,116,139,.2);}
.menu-btns{positionrelative;z-index1;displayflex;flex-directioncolumn;gap8px;width320px;}
.mbtn{backgroundrgba(255,255,255,.02);border1px solid rgba(255,255,255,.08);colorvar(--text);
  font-family'Oswald',sans-serif;font-size15px;font-weight500;letter-spacing2px;padding13px 24px;
  cursorpointer;transitionall .2s;text-alignleft;positionrelative;overflowhidden;border-radius4px;}
.mbtnbefore{content'';positionabsolute;left0;top0;bottom0;width3px;backgroundvar(--green);transformscaleY(0);transitiontransform .2s;}
.mbtnhover{border-colorrgba(34,197,94,.3);backgroundrgba(34,197,94,.05);color#fff;}
.mbtnhoverbefore{transformscaleY(1);}
.mbtn .mico{margin-right14px;font-size16px;}
.mbtn.primary{backgroundrgba(34,197,94,.1);border-colorrgba(34,197,94,.4);colorvar(--green2);}
.mbtn.primaryhover{backgroundrgba(34,197,94,.2);}
.mbtn.admin-btn{backgroundrgba(245,158,11,.05);border-colorrgba(245,158,11,.2);colorvar(--gold);}
.mbtn.admin-btnhover{backgroundrgba(245,158,11,.1);border-colorrgba(245,158,11,.4);}
.menu-auth-btns{positionrelative;z-index1;displayflex;gap8px;margin-top8px;}
.menu-ver{positionabsolute;bottom16px;right20px;font-size10px;color#1a2a1a;}

 ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ 
.modal-overlay{positionfixed;inset0;backgroundrgba(0,0,0,.8);displaynone;
  align-itemscenter;justify-contentcenter;z-index8000;backdrop-filterblur(6px);}
.modal-overlay.vis{displayflex;}
.modal-box{backgroundrgba(8,12,16,.98);border1px solid var(--border);border-radius12px;
  padding28px;width100%;max-width480px;margin16px;}
.modal-title{font-family'Oswald',sans-serif;font-size20px;font-weight700;colorvar(--green2);letter-spacing2px;margin-bottom20px;}
.modal-tabs{displayflex;gap0;margin-bottom20px;border1px solid rgba(255,255,255,.08);border-radius8px;overflowhidden;}
.modal-tab{flex1;padding9px;text-aligncenter;cursorpointer;font-family'Oswald',sans-serif;
  font-size13px;font-weight600;letter-spacing1px;colorvar(--dim);transition.2s;}
.modal-tab.active{backgroundrgba(34,197,94,.12);colorvar(--green2);}
.modal-tab-content{displaynone;}
.modal-tab-content.active{displayblock;}

 AI MODE SELECTION 
.ai-mode-grid{displaygrid;grid-template-columns1fr 1fr;gap10px;margin-bottom16px;}
.ai-mode-card{backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.08);border-radius10px;
  padding16px;cursorpointer;transition.2s;text-aligncenter;}
.ai-mode-cardhover{border-colorrgba(34,197,94,.4);backgroundrgba(34,197,94,.05);}
.ai-mode-card.selected{border-colorvar(--green);backgroundrgba(34,197,94,.1);}
.ai-mode-card.red-modehover,.ai-mode-card.red-mode.selected{border-colorvar(--red);backgroundrgba(239,68,68,.08);}
.ai-mode-emoji{font-size32px;margin-bottom8px;}
.ai-mode-title{font-family'Oswald',sans-serif;font-size14px;font-weight700;letter-spacing1px;color#fff;margin-bottom4px;}
.ai-mode-desc{font-size10px;colorvar(--dim);line-height1.5;}
.ai-team-sel{displayflex;gap8px;margin-bottom14px;}
.ai-team-btn{flex1;padding10px;border-radius6px;border1px solid rgba(255,255,255,.1);
  font-family'Oswald',sans-serif;font-size13px;font-weight700;letter-spacing1px;cursorpointer;transition.2s;text-aligncenter;}
.ai-team-btn.blue-team{backgroundrgba(59,130,246,.08);color#60a5fa;border-colorrgba(59,130,246,.3);}
.ai-team-btn.blue-team.selected{backgroundrgba(59,130,246,.25);border-color#3b82f6;}
.ai-team-btn.red-team{backgroundrgba(239,68,68,.08);color#f87171;border-colorrgba(239,68,68,.3);}
.ai-team-btn.red-team.selected{backgroundrgba(239,68,68,.25);border-color#ef4444;}

 ‚îÄ‚îÄ LOBBY ‚îÄ‚îÄ 
.lobby-box{backgroundrgba(8,12,16,.9);border1px solid var(--border);border-radius12px;padding28px;width100%;max-width480px;}
.lobby-title{font-family'Oswald',sans-serif;font-size20px;font-weight700;colorvar(--green2);letter-spacing2px;margin-bottom20px;}
.lobby-code-display{backgroundrgba(34,197,94,.08);border2px solid rgba(34,197,94,.3);border-radius8px;padding18px;text-aligncenter;margin-bottom16px;}
.lcd-label{font-size10px;colorvar(--dim);letter-spacing3px;margin-bottom6px;}
.lcd-code{font-family'Oswald',sans-serif;font-size40px;font-weight700;colorvar(--green);letter-spacing8px;}
.lcd-sub{font-size11px;colorvar(--dim);margin-top4px;}
.lobby-players{displayflex;gap10px;margin-bottom16px;}
.lp-slot{flex1;backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.07);border-radius8px;padding12px;text-aligncenter;}
.lp-slot.filled{border-colorrgba(34,197,94,.3);backgroundrgba(34,197,94,.05);}
.lp-slot.p1{border-colorrgba(59,130,246,.3);backgroundrgba(59,130,246,.05);}
.lps-icon{font-size22px;margin-bottom4px;}
.lps-label{font-size10px;colorvar(--dim);letter-spacing2px;}
.lps-name{font-size12px;font-weight700;margin-top3px;color#fff;}

 ‚îÄ‚îÄ FORM ‚îÄ‚îÄ 
.form-row{displayflex;gap8px;margin-bottom10px;}
.form-input{flex1;backgroundrgba(0,0,0,.4);border1px solid rgba(255,255,255,.1);color#fff;
  padding9px 13px;border-radius6px;font-family'Share Tech Mono',monospace;font-size13px;outlinenone;transition.2s;}
.form-inputfocus{border-colorvar(--green);}
.form-label{font-size10px;colorvar(--dim);letter-spacing2px;margin-bottom5px;displayblock;}
.btn-primary{backgroundvar(--green);color#000;bordernone;padding10px 18px;border-radius6px;
  font-family'Oswald',sans-serif;font-weight700;font-size13px;letter-spacing1px;cursorpointer;transition.2s;white-spacenowrap;}
.btn-primaryhover{backgroundvar(--green2);}
.btn-secondary{backgroundtransparent;colorvar(--dim);border1px solid rgba(255,255,255,.1);padding10px 18px;
  border-radius6px;font-family'Oswald',sans-serif;font-weight600;font-size13px;letter-spacing1px;cursorpointer;transition.2s;}
.btn-secondaryhover{border-colorrgba(255,255,255,.3);color#fff;}
.btn-gold{backgroundrgba(245,158,11,.15);colorvar(--gold);border1px solid rgba(245,158,11,.3);padding10px 18px;
  border-radius6px;font-family'Oswald',sans-serif;font-weight700;font-size13px;letter-spacing1px;cursorpointer;transition.2s;}
.btn-goldhover{backgroundrgba(245,158,11,.25);}
.status-box{padding7px 12px;border-radius6px;font-size11px;margin-bottom10px;displaynone;}
.status-box.vis{displayblock;}
.status-box.ok{backgroundrgba(34,197,94,.08);border1px solid rgba(34,197,94,.2);colorvar(--green2);}
.status-box.err{backgroundrgba(239,68,68,.08);border1px solid rgba(239,68,68,.2);color#f87171;}
.status-box.warn{backgroundrgba(245,158,11,.08);border1px solid rgba(245,158,11,.2);colorvar(--gold);}
.lobby-map-section{border-top1px solid rgba(255,255,255,.06);padding-top14px;margin-top4px;}
.lms-title{font-size10px;colorvar(--dim);letter-spacing3px;margin-bottom8px;}
.map-upload-area{border2px dashed rgba(255,255,255,.1);border-radius8px;padding16px;text-aligncenter;cursorpointer;transition.2s;}
.map-upload-areahover{border-colorrgba(34,197,94,.4);backgroundrgba(34,197,94,.03);}
.map-preview{width100%;height70px;object-fitcover;border-radius6px;border1px solid var(--border);displaynone;}
.map-saved-list{displayflex;flex-directioncolumn;gap6px;max-height120px;overflow-yauto;}
.map-saved-item{displayflex;align-itemscenter;gap8px;padding6px 10px;border-radius6px;
  backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.06);cursorpointer;transition.2s;}
.map-saved-itemhover,.map-saved-item.active{border-colorrgba(34,197,94,.3);backgroundrgba(34,197,94,.05);}
.msi-thumb{width40px;height28px;object-fitcover;border-radius4px;flex-shrink0;}
.msi-info{flex1;}
.msi-name{font-size12px;font-weight700;color#fff;}
.msi-date{font-size10px;colorvar(--dim);}

 ‚îÄ‚îÄ DISCONNECT BANNER ‚îÄ‚îÄ 
.disconnect-banner{positionfixed;top0;left0;right0;z-index7000;
  backgroundrgba(239,68,68,.95);padding12px 20px;
  displaynone;flex-directioncolumn;align-itemscenter;gap6px;
  border-bottom2px solid #f87171;}
.disconnect-banner.vis{displayflex;}
.dc-title{font-family'Oswald',sans-serif;font-size16px;font-weight700;color#fff;letter-spacing2px;}
.dc-timer{font-family'Oswald',sans-serif;font-size28px;font-weight700;color#fff;}
.dc-sub{font-size11px;colorrgba(255,255,255,.8);}

 ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ 
#screen-admin{flex-directioncolumn;backgroundvar(--bg);}
.admin-header{height52px;backgroundrgba(8,12,16,.98);border-bottom1px solid rgba(245,158,11,.2);
  displayflex;align-itemscenter;padding0 20px;gap14px;flex-shrink0;}
.admin-title{font-family'Oswald',sans-serif;font-size18px;font-weight700;colorvar(--gold);letter-spacing3px;}
.admin-body{flex1;displayflex;gap0;overflowhidden;}
.admin-sidebar{width200px;backgroundrgba(4,6,8,.8);border-right1px solid rgba(255,255,255,.06);
  padding16px;displayflex;flex-directioncolumn;gap6px;flex-shrink0;}
.admin-nav-btn{padding9px 12px;border-radius6px;cursorpointer;font-size13px;colorvar(--dim);
  transition.2s;border1px solid transparent;}
.admin-nav-btnhover,.admin-nav-btn.active{backgroundrgba(245,158,11,.08);border-colorrgba(245,158,11,.2);colorvar(--gold);}
.admin-content{flex1;padding20px;overflow-yauto;}
.admin-section{displaynone;}
.admin-section.active{displayblock;}
.admin-card{backgroundrgba(8,12,16,.8);border1px solid rgba(255,255,255,.06);border-radius10px;padding20px;margin-bottom16px;}
.admin-card-title{font-family'Oswald',sans-serif;font-size14px;font-weight700;colorvar(--gold);letter-spacing2px;margin-bottom14px;}
.admin-maps-grid{displaygrid;grid-template-columnsrepeat(auto-fill,minmax(180px,1fr));gap12px;}
.admin-map-card{border1px solid rgba(255,255,255,.08);border-radius8px;overflowhidden;cursorpointer;
  transition.2s;backgroundrgba(0,0,0,.3);}
.admin-map-cardhover{border-colorrgba(245,158,11,.4);}
.admin-map-card.active-map{border-colorvar(--green);box-shadow0 0 12px rgba(34,197,94,.2);}
.amc-img{width100%;height100px;object-fitcover;}
.amc-info{padding8px 10px;}
.amc-name{font-size12px;font-weight700;color#fff;margin-bottom3px;}
.amc-meta{font-size10px;colorvar(--dim);}
.amc-actions{displayflex;gap4px;margin-top6px;flex-wrapwrap;}
.amc-btn{flex1;padding4px 8px;border-radius4px;font-family'Oswald',sans-serif;font-size10px;
  font-weight700;letter-spacing1px;cursorpointer;bordernone;transition.2s;white-spacenowrap;}
.amc-btn.set{backgroundrgba(34,197,94,.2);colorvar(--green2);}
.amc-btn.sethover{backgroundvar(--green);color#000;}
.amc-btn.del{backgroundrgba(239,68,68,.1);color#f87171;}
.amc-btn.delhover{backgroundvar(--red);color#fff;}
.amc-btn.edit{backgroundrgba(59,130,246,.15);color#60a5fa;}
.amc-btn.edithover{backgroundvar(--blue);color#fff;}

 ‚îÄ‚îÄ MAP EDITOR ‚îÄ‚îÄ 
.map-editor-wrap{displayflex;gap16px;height100%;}
.map-editor-canvas-wrap{flex1;positionrelative;border1px solid rgba(255,255,255,.08);border-radius8px;overflowhidden;background#111;}
#adminMapCanvas{width100%;height100%;displayblock;}
.map-editor-tools{width200px;flex-shrink0;displayflex;flex-directioncolumn;gap6px;overflow-yauto;}
.tool-btn{padding8px 12px;border-radius6px;font-family'Oswald',sans-serif;font-size12px;font-weight700;
  letter-spacing1px;cursorpointer;border1px solid rgba(255,255,255,.1);colorvar(--dim);backgroundtransparent;transition.2s;width100%;}
.tool-btnhover,.tool-btn.active{backgroundrgba(245,158,11,.1);border-colorrgba(245,158,11,.3);colorvar(--gold);}
.color-row{displayflex;gap4px;flex-wrapwrap;}
.color-swatch{width24px;height24px;border-radius4px;cursorpointer;border2px solid transparent;transition.15s;}
.color-swatchhover,.color-swatch.active{border-color#fff;}
.editor-sep{height1px;backgroundrgba(255,255,255,.06);margin4px 0;}

 ‚îÄ‚îÄ STANDALONE EDITOR SCREEN ‚îÄ‚îÄ 
#screen-editor{flex-directioncolumn;backgroundvar(--bg);}
.editor-topbar{height50px;backgroundrgba(4,6,8,.97);border-bottom1px solid var(--border);
  displayflex;align-itemscenter;padding0 16px;gap12px;flex-shrink0;}
.editor-topbar-title{font-family'Oswald',sans-serif;font-size15px;font-weight700;colorvar(--gold);letter-spacing2px;}
.editor-body{flex1;displayflex;overflowhidden;}
.editor-canvas-area{flex1;positionrelative;background#0a0e12;overflowhidden;}
#editorCanvas{positionabsolute;top0;left0;cursorcrosshair;}
#editorOverlay{positionabsolute;top0;left0;pointer-eventsnone;}
.editor-sidebar{width230px;flex-shrink0;backgroundrgba(4,6,8,.97);border-left1px solid var(--border);
  displayflex;flex-directioncolumn;overflow-yauto;padding10px;}
.editor-tool-group{margin-bottom8px;}
.editor-group-label{font-size9px;colorvar(--dim);letter-spacing3px;margin-bottom5px;padding0 2px;}
.etool{displayflex;align-itemscenter;gap8px;padding7px 10px;border-radius6px;cursorpointer;
  border1px solid rgba(255,255,255,.06);backgroundtransparent;colorvar(--dim);font-family'Oswald',sans-serif;
  font-size12px;font-weight600;letter-spacing1px;transition.2s;width100%;margin-bottom3px;text-alignleft;}
.etoolhover{backgroundrgba(255,255,255,.04);color#fff;}
.etool.active{backgroundrgba(245,158,11,.12);border-colorrgba(245,158,11,.4);colorvar(--gold);}
.etool.water-tool.active{backgroundrgba(59,130,246,.12);border-colorrgba(59,130,246,.4);color#60a5fa;}
.etool.forest-tool.active{backgroundrgba(22,163,74,.12);border-colorrgba(22,163,74,.4);color#4ade80;}
.etool.road-tool.active{backgroundrgba(161,119,53,.12);border-colorrgba(161,119,53,.4);color#d97706;}
.etool.bridge-tool.active{backgroundrgba(146,64,14,.12);border-colorrgba(146,64,14,.4);color#a16207;}
.editor-cursor-hint{positionabsolute;bottom12px;left12px;backgroundrgba(4,6,8,.9);
  border1px solid var(--border);border-radius6px;padding6px 12px;font-size10px;colorvar(--dim);
  pointer-eventsnone;z-index20;}
.editor-zoom-ind{positionabsolute;bottom12px;right12px;backgroundrgba(4,6,8,.8);
  border1px solid rgba(255,255,255,.06);border-radius6px;padding4px 10px;font-size10px;colorvar(--dim);}
.editor-marker{positionabsolute;transformtranslate(-50%,-50%);font-size18px;pointer-eventsnone;
  text-shadow0 0 4px rgba(0,0,0,.9),0 0 10px rgba(0,0,0,.7);filterdrop-shadow(0 2px 3px rgba(0,0,0,.8));}

 ‚îÄ‚îÄ GAME SCREEN ‚îÄ‚îÄ 
#screen-game{flex-directioncolumn;}
.game-hud{height46px;backgroundrgba(4,6,8,.97);border-bottom1px solid var(--border);
  displayflex;align-itemscenter;padding0 12px;gap10px;flex-shrink0;positionrelative;z-index50;}
.hud-logo{font-family'Oswald',sans-serif;font-size13px;font-weight700;colorvar(--green);letter-spacing2px;flex-shrink0;}
.hud-sep{width1px;height18px;backgroundrgba(255,255,255,.08);}
.hud-stat{displayflex;align-itemscenter;gap5px;font-size11px;}
.hud-stat-label{colorvar(--dim);font-size9px;letter-spacing1px;}
.hud-stat-val{font-family'Oswald',sans-serif;font-size14px;font-weight600;}
.hud-stat-val.blue{color#60a5fa;}
.hud-stat-val.red{color#f87171;}
.hud-center{positionabsolute;left50%;transformtranslateX(-50%);displayflex;align-itemscenter;flex-directioncolumn;}
.hud-timer{font-family'Oswald',sans-serif;font-size20px;font-weight700;color#fff;letter-spacing2px;}
.hud-turn{font-size9px;colorvar(--dim);letter-spacing2px;}
.hud-right{margin-leftauto;displayflex;align-itemscenter;gap6px;}
.hud-btn{backgroundrgba(255,255,255,.04);border1px solid rgba(255,255,255,.1);colorvar(--text);
  padding4px 10px;border-radius5px;font-family'Oswald',sans-serif;font-size10px;font-weight600;
  letter-spacing1px;cursorpointer;transition.2s;}
.hud-btnhover{border-colorrgba(34,197,94,.4);colorvar(--green2);}
.hud-btn.dangerhover{border-colorrgba(239,68,68,.4);color#f87171;}

 GAME BODY - FIXED canvas area fills all remaining space 
.game-area{flex1;positionrelative;overflowhidden;background#06090d;min-width0;}
.game-body{displayflex;flex1;overflowhidden;}
#mapCanvas,#unitsCanvas,#frontCanvas,#uiCanvas,#interCanvas{positionabsolute;top0;left0;}
#interCanvas{touch-actionnone;}
#unitsCanvas,#frontCanvas,#uiCanvas{pointer-eventsnone;}

.side-panel{width220px;min-width220px;max-width220px;backgroundrgba(4,6,8,.97);border-left1px solid var(--border);
  displayflex;flex-directioncolumn;overflow-yauto;flex-shrink0;positionrelative;z-index10;}

 Unit command toolbar 
.cmd-toolbar{positionabsolute;bottom55px;left50%;transformtranslateX(-50%);
  displayflex;gap6px;z-index60;pointer-eventsauto;}
.cmd-btn{backgroundrgba(8,12,16,.95);border1px solid rgba(255,255,255,.15);colorvar(--dim);
  padding6px 14px;border-radius6px;font-family'Oswald',sans-serif;font-size11px;font-weight700;
  letter-spacing1px;cursorpointer;transition.2s;white-spacenowrap;}
.cmd-btnhover{border-colorrgba(34,197,94,.5);colorvar(--green2);}
.cmd-btn.active{backgroundrgba(34,197,94,.15);border-colorvar(--green);colorvar(--green2);}
.cmd-btn.attack-mode{border-colorrgba(239,68,68,.4);color#f87171;}
.cmd-btn.attack-modehover,.cmd-btn.attack-mode.active{backgroundrgba(239,68,68,.15);border-color#ef4444;}
.sp-section{padding10px 12px;border-bottom1px solid rgba(255,255,255,.04);}
.sp-label{font-size9px;colorvar(--dim);letter-spacing3px;margin-bottom7px;}
.sp-unit-btn{displayflex;align-itemscenter;gap7px;padding7px 9px;border-radius6px;
  backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.06);cursorpointer;transition.2s;margin-bottom4px;}
.sp-unit-btnhover,.sp-unit-btn.active{backgroundrgba(59,130,246,.08);border-colorrgba(59,130,246,.3);}
.sp-unit-btn.active{border-colorvar(--blue);}
.sp-unit-icon{font-size16px;width22px;text-aligncenter;}
.sp-unit-info{flex1;}
.sp-unit-name{font-size11px;font-weight700;color#fff;}
.sp-unit-stat{font-size9px;colorvar(--dim);}
.sp-unit-cost{font-family'Oswald',sans-serif;font-size12px;font-weight700;colorvar(--gold);}
.sp-resources{displayflex;flex-directioncolumn;gap5px;}
.sp-res-row{displayflex;justify-contentspace-between;align-itemscenter;}
.sp-res-label{font-size9px;colorvar(--dim);}
.sp-res-val{font-family'Oswald',sans-serif;font-size13px;font-weight700;}
.sp-log{flex1;overflow-yauto;padding6px 10px;displayflex;flex-directioncolumn;gap2px;}
.log-entry{font-size10px;colorvar(--dim);line-height1.4;padding2px 0;}
.log-entry.good{color#4ade80;}.log-entry.bad{color#f87171;}.log-entry.info{color#60a5fa;}.log-entry.warn{colorvar(--gold);}

 Cities HUD 
.cities-hud{padding8px 12px;border-bottom1px solid rgba(255,255,255,.04);}
.city-row{displayflex;align-itemscenter;gap5px;padding3px 0;font-size10px;}
.city-dot{width8px;height8px;border-radius50%;flex-shrink0;}
.city-dot.blue{background#3b82f6;}.city-dot.red{background#ef4444;}.city-dot.neutral{background#64748b;}
.city-name{flex1;colorvar(--dim);}
.city-income{font-family'Oswald',sans-serif;font-size10px;font-weight700;colorvar(--gold);}

.placement-hint{positionabsolute;bottom14px;left50%;transformtranslateX(-50%);
  backgroundrgba(4,6,8,.95);border1px solid rgba(34,197,94,.4);border-radius8px;
  padding8px 18px;font-size12px;colorvar(--green2);pointer-eventsnone;z-index100;
  displaynone;letter-spacing1px;font-family'Oswald',sans-serif;}
.placement-hint.vis{displayblock;}
.casualties-overlay{positionabsolute;bottom14px;left14px;
  backgroundrgba(4,6,8,.85);border1px solid rgba(255,255,255,.08);border-radius8px;padding10px 14px;pointer-eventsnone;z-index30;}
.co-title{font-size9px;colorvar(--dim);letter-spacing3px;margin-bottom5px;}
.co-row{displayflex;align-itemscenter;gap10px;font-family'Oswald',sans-serif;font-size15px;font-weight700;}
.co-blue{color#60a5fa;}.co-red{color#f87171;}
.sel-info{positionabsolute;top8px;left14px;backgroundrgba(4,6,8,.93);border1px solid var(--border);
  border-radius8px;padding10px 14px;min-width150px;pointer-eventsnone;z-index30;displaynone;}
.sel-info.vis{displayblock;}
.si-name{font-family'Oswald',sans-serif;font-size15px;font-weight700;color#fff;}
.si-hp-bar{height4px;backgroundrgba(255,255,255,.1);border-radius4px;overflowhidden;margin-top5px;}
.si-hp-fill{height100%;backgroundvar(--green);border-radius4px;transitionwidth .3s;}
.si-stats{displayflex;gap8px;margin-top5px;font-size10px;colorvar(--dim);}
.si-stat{displayflex;flex-directioncolumn;align-itemscenter;gap1px;}
.si-stat b{font-family'Oswald',sans-serif;font-size12px;color#fff;}
.zoom-ind{positionabsolute;bottom14px;right234px;backgroundrgba(4,6,8,.8);border1px solid rgba(255,255,255,.06);
  border-radius6px;padding4px 8px;font-size10px;colorvar(--dim);pointer-eventsnone;z-index30;}
.result-overlay{positionfixed;inset0;backgroundrgba(0,0,0,.85);displaynone;flex-directioncolumn;
  align-itemscenter;justify-contentcenter;z-index9000;backdrop-filterblur(10px);}
.result-overlay.vis{displayflex;}
.result-box{backgroundrgba(8,12,16,.98);border1px solid var(--border);border-radius16px;padding36px;text-aligncenter;max-width420px;}
.result-emoji{font-size58px;margin-bottom14px;}
.result-title{font-family'Oswald',sans-serif;font-size34px;font-weight700;letter-spacing3px;margin-bottom8px;}
.result-sub{font-size13px;colorvar(--dim);margin-bottom22px;line-height1.8;white-spacepre-line;}
.toast{positionfixed;bottom18px;left50%;transformtranslateX(-50%);backgroundrgba(8,12,16,.97);
  border1px solid var(--green);padding9px 18px;border-radius8px;font-size12px;font-weight700;
  colorvar(--green2);z-index9999;displaynone;box-shadow0 0 20px rgba(34,197,94,.2);white-spacenowrap;}
.loading-screen{positionfixed;inset0;backgroundvar(--bg);displayflex;flex-directioncolumn;
  align-itemscenter;justify-contentcenter;z-index9999;}
.loading-screen.hidden{displaynone;}
.ld-title{font-family'Oswald',sans-serif;font-size30px;font-weight700;colorvar(--green);letter-spacing4px;margin-bottom18px;}
.ld-bar{width180px;height3px;backgroundrgba(255,255,255,.05);border-radius3px;overflowhidden;}
.ld-fill{height100%;backgroundvar(--green);animationldanim 1.4s ease-in-out infinite;}
@keyframes ldanim{0%{width0;margin-left0}50%{width100%;margin-left0}100%{width0;margin-left100%}}
.ld-text{margin-top10px;font-size10px;colorvar(--dim);letter-spacing2px;}
-webkit-scrollbar{width4px;}-webkit-scrollbar-track{backgroundtransparent;}
-webkit-scrollbar-thumb{backgroundrgba(34,197,94,.2);border-radius4px;}
 Income tick animation 
@keyframes incomeFloat{0%{opacity1;transformtranslateY(0)}100%{opacity0;transformtranslateY(-30px)}}
.income-float{positionabsolute;font-family'Oswald',sans-serif;font-size14px;font-weight700;
  colorvar(--gold);pointer-eventsnone;z-index200;animationincomeFloat 1.5s ease-out forwards;}
@media(max-width700px){.side-panel{displaynone;}.menu-logo-title{font-size38px;}.menu-btns{width90%;}}
style
head
body

!-- LOADING --
div class=loading-screen id=loadingScreen
  div class=ld-title–°–¢–†–ê–¢–ï–ì–Ü–Ødiv
  div class=ld-bardiv class=ld-filldivdiv
  div class=ld-text id=ldText–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...div
div

!-- DISCONNECT BANNER --
div class=disconnect-banner id=dcBanner
  div class=dc-title‚ö†Ô∏è –û–ü–û–ù–ï–ù–¢ –í–Ü–î–ö–õ–Æ–ß–ò–í–°–Ødiv
  div class=dc-timer id=dcTimer60div
  div class=dc-sub–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è... –ì—Ä–∞ –∑–∞–≤–µ—Ä—à–∏—Ç—å—Å—è —è–∫—â–æ –æ–ø–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–≤–µ—Ä–Ω–µ—Ç—å—Å—èdiv
div

!-- MENU --
div class=screen id=screen-menu
  div class=menu-bg-griddiv
  div class=menu-logo
    div class=menu-logo-top–û–ø–µ—Ä–∞—Ü—ñ—èdiv
    div class=menu-logo-title–°–¢–†–ê–¢–ï–ì–Ü–Ødiv
    div class=menu-logo-sub–¢–ê–ö–¢–ò–ß–ù–ê –ë–û–ô–û–í–ê –°–ò–°–¢–ï–ú–ê v3.0div
  div
  div class=menu-user id=menuUser
    span id=menuUserName–ê–Ω–æ–Ω—ñ–ºspan
    span class=menu-user-badge badge-anon id=menuUserBadge–ì–Ü–°–¢–¨span
  div
  div class=menu-btns
    button class=mbtn primary onclick=showLobbyCreate()span class=mico‚öîÔ∏èspan–°–¢–í–û–†–ò–¢–ò –õ–û–ë–Übutton
    button class=mbtn onclick=showLobbyJoin()span class=micoüîóspan–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨button
    button class=mbtn onclick=showAIModeSelect()span class=micoü§ñspan–ü–†–û–¢–ò –Ü–Übutton
    button class=mbtn onclick=openMapEditor()span class=micoüó∫Ô∏èspan–†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–òbutton
    button class=mbtn admin-btn id=adminMenuBtn style=displaynone onclick=showScreen('screen-admin');adminNav('maps')span class=micoüëëspan–ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨button
  div
  div class=menu-auth-btns
    button class=btn-secondary id=authMenuBtn onclick=showAuthModal()üîê –£–≤—ñ–π—Ç–∏  –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—èbutton
    button class=btn-secondary id=logoutBtn style=displaynone onclick=doLogout()–í–∏–π—Ç–∏button
  div
  div class=menu-verv3.0  –°–¢–†–ê–¢–ï–ì–Ü–Ødiv
div

!-- AUTH MODAL --
div class=modal-overlay id=authModal
  div class=modal-box
    div class=modal-titleüîê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ødiv
    div class=modal-tabs
      div class=modal-tab active onclick=switchAuthTab('login')–£–í–Ü–ô–¢–òdiv
      div class=modal-tab onclick=switchAuthTab('register')–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ødiv
    div
    div class=modal-tab-content active id=tab-login
      div id=loginStatus class=status-boxdiv
      div class=form-labelEMAILdiv
      div class=form-rowinput class=form-input id=loginEmail type=email placeholder=email@example.comdiv
      div class=form-label–ü–ê–†–û–õ–¨div
      div class=form-rowinput class=form-input id=loginPass type=password placeholder=‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢div
      div style=displayflex;gap8px;margin-top4px;
        button class=btn-primary onclick=doLogin() style=flex1‚ñ∂ –£–í–Ü–ô–¢–òbutton
        button class=btn-secondary onclick=closeAuthModal()‚úïbutton
      div
    div
    div class=modal-tab-content id=tab-register
      div id=registerStatus class=status-boxdiv
      div class=form-label–ü–û–ó–ò–í–ù–ò–ôdiv
      div class=form-rowinput class=form-input id=regName placeholder=–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π maxlength=20div
      div class=form-labelEMAILdiv
      div class=form-rowinput class=form-input id=regEmail type=email placeholder=email@example.comdiv
      div class=form-label–ü–ê–†–û–õ–¨div
      div class=form-rowinput class=form-input id=regPass type=password placeholder=–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤div
      div style=displayflex;gap8px;margin-top4px;
        button class=btn-primary onclick=doRegister() style=flex1‚úÖ –ó–ê–†–ï–Ñ–°–¢–†–£–í–ê–¢–ò–°–¨button
        button class=btn-secondary onclick=closeAuthModal()‚úïbutton
      div
    div
  div
div

!-- AI MODE SELECT MODAL --
div class=modal-overlay id=aiModeModal
  div class=modal-box style=max-width520px;
    div class=modal-titleü§ñ –†–ï–ñ–ò–ú –ü–†–û–¢–ò –Ü–Üdiv
    div class=form-label style=margin-bottom10px;–û–ë–ï–†–Ü–¢–¨ –í–ê–®–£ –°–¢–û–†–û–ù–£div
    div class=ai-team-sel
      div class=ai-team-btn blue-team selected id=teamBtnBlue onclick=selectAITeam('blue')üîµ –°–ò–ù–Üdiv
      div class=ai-team-btn red-team id=teamBtnRed onclick=selectAITeam('red')üî¥ –ß–ï–†–í–û–ù–Üdiv
    div
    div class=form-label style=margin-bottom10px;–û–ë–ï–†–Ü–¢–¨ –†–ï–ñ–ò–ú –ì–†–òdiv
    div class=ai-mode-grid
      div class=ai-mode-card selected id=aimode-defense onclick=selectAIMode('defense')
        div class=ai-mode-emojiüõ°Ô∏èdiv
        div class=ai-mode-title–û–ë–û–†–û–ù–êdiv
        div class=ai-mode-desc–ó–∞—Ö–∏—â–∞–π—Ç–µ —Å–≤–æ—ó –º—ñ—Å—Ç–∞ —Ç–∞ –±–∞–∑—É –≤—ñ–¥ –∞—Ç–∞–∫ –≤–æ—Ä–æ–∂–æ–≥–æ –Ü–Ü. –Ü–Ü –∞–∫—Ç–∏–≤–Ω–æ –∞—Ç–∞–∫—É—î —Ö–≤–∏–ª—è–º–∏.div
      div
      div class=ai-mode-card id=aimode-attack onclick=selectAIMode('attack')
        div class=ai-mode-emoji‚öîÔ∏èdiv
        div class=ai-mode-title–ù–ê–°–¢–£–üdiv
        div class=ai-mode-desc–ê—Ç–∞–∫—É–π—Ç–µ –≤–æ—Ä–æ–∂—É –±–∞–∑—É —Ç–∞ –∑–∞—Ö–æ–ø–ª—é–π—Ç–µ –º—ñ—Å—Ç–∞. –Ü–Ü –æ–±–æ—Ä–æ–Ω—è—î—Ç—å—Å—è —Ç–∞ –∫–æ–Ω—Ç—Ä–∞—Ç–∞–∫—É—î.div
      div
      div class=ai-mode-card id=aimode-blitz onclick=selectAIMode('blitz')
        div class=ai-mode-emoji‚ö°div
        div class=ai-mode-title–ë–õ–Ü–¶–ö–†–ò–ìdiv
        div class=ai-mode-desc–®–≤–∏–¥–∫–∞ –≥—Ä–∞ –∑–∞—Ö–æ–ø—ñ—Ç—å 3+ –º—ñ—Å—Ç–∞ –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω –∞–±–æ –∑–Ω–∏—â—ñ—Ç—å –±–∞–∑—É.div
      div
      div class=ai-mode-card id=aimode-conquest onclick=selectAIMode('conquest')
        div class=ai-mode-emojiüèÜdiv
        div class=ai-mode-title–ó–ê–í–û–Æ–í–ê–ù–ù–Ødiv
        div class=ai-mode-desc–ö–æ–Ω—Ç—Ä–æ–ª—å—Ç–µ –≤—Å—ñ –º—ñ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—ñ. –Ü–Ü –∑–∞—Å—Ç–æ—Å–æ–≤—É—î —Å–∫–ª–∞–¥–Ω—É —Ç–∞–∫—Ç–∏–∫—É.div
      div
    div
    div style=displayflex;gap8px;margin-top4px;
      button class=btn-primary onclick=startVsAI() style=flex1‚ñ∂ –ü–û–ß–ê–¢–òbutton
      button class=btn-secondary onclick=closeAIModeModal()‚Üê –ù–ê–ó–ê–îbutton
    div
  div
div

!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STANDALONE MAP EDITOR SCREEN (for all users)
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê --
div class=screen id=screen-editor
  div class=editor-topbar
    span class=editor-topbar-titleüó∫Ô∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–òspan
    div style=displayflex;align-itemscenter;gap8px;margin-left12px;
      span id=editorMapName style=font-size11px;colorvar(--dim);font-family'Oswald'–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞span
      button class=hud-btn onclick=editorRenameMap()‚úébutton
    div
    !-- Map selector --
    div style=displayflex;align-itemscenter;gap6px;margin-left16px;
      span style=font-size9px;colorvar(--dim);font-family'Oswald';letter-spacing1px;–ö–ê–†–¢–êspan
      select id=editorMapSelect style=backgroundrgba(0,0,0,.6);border1px solid rgba(255,255,255,.12);color#fff;padding4px 8px;border-radius5px;font-size11px;font-family'Oswald',sans-serif; onchange=editorSwitchMap(this.value)
        option value=-1+ –ù–æ–≤–∞ –∫–∞—Ä—Ç–∞option
      select
    div
    div style=margin-leftauto;displayflex;gap6px;
      input type=file id=editorBgUpload2 accept=image style=displaynone onchange=editorLoadBg(this)
      button class=hud-btn onclick=document.getElementById('editorBgUpload2').click()üì∑ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Ñ–æ—Ç–æbutton
      button class=hud-btn onclick=editorUndoNew()‚Ü© –í—ñ–¥–º—ñ–Ω–∏—Ç–∏button
      button class=hud-btn style=border-colorrgba(34,197,94,.4);colorvar(--green2) onclick=editorSaveMap()üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç—Ébutton
      button class=hud-btn danger onclick=showScreen('screen-menu')‚Üê –ú–µ–Ω—ébutton
    div
  div
  div class=editor-body
    !-- CANVAS AREA --
    div class=editor-canvas-area id=editorCanvasArea
      canvas id=editorCanvascanvas
      div id=editorOverlaydiv
      div class=editor-cursor-hint id=editorCursorHint‚úèÔ∏è –í–∏–±–µ—Ä–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —ñ –º–∞–ª—é–π –º–∏—à–µ—édiv
      div class=editor-zoom-ind id=editorZoomInd100%div
    div
    !-- SIDEBAR TOOLS --
    div class=editor-sidebar

      !-- –ë–∞–∑–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ --
      div class=editor-tool-group
        div class=editor-group-label–Ü–ù–°–¢–†–£–ú–ï–ù–¢–òdiv
        button class=etool active id=etool-draw onclick=setETool('draw')‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏button
        button class=etool id=etool-erase onclick=setETool('erase')üßπ –°—Ç–µ—Ä—Ç–∏button
        button class=etool id=etool-fill onclick=setETool('fill')ü™£ –ó–∞–ª–∏–≤–∫–∞button
        button class=etool id=etool-move onclick=setETool('move')‚úã –ü–∞–Ω  –ó—É–ºbutton
      div

      !-- –¢–µ—Ä–µ–Ω --
      div class=editor-tool-group
        div class=editor-group-label–¢–ï–†–ï–ù (–º–∞–ª—é–≤–∞—Ç–∏ –ø–æ–≤–µ—Ä—Ö)div
        button class=etool water-tool id=etool-water onclick=setETool('water')üåä –í–æ–¥–∞button
        button class=etool bridge-tool id=etool-bridge onclick=setETool('bridge')üåâ –ú—ñ—Å—Çbutton
        button class=etool forest-tool id=etool-forest onclick=setETool('forest')üå≤ –õ—ñ—Å (–ø–æ–≤—ñ–ª—å–Ω–æ)button
        button class=etool road-tool id=etool-road onclick=setETool('road')üõ£Ô∏è –î–æ—Ä–æ–≥–∞ (—à–≤–∏–¥–∫–æ)button
      div

      !-- –ü–æ–∑–∏—Ü—ñ—ó --
      div class=editor-tool-group
        div class=editor-group-label–ü–û–ó–ò–¶–Ü–á (–∫–ª—ñ–∫–Ω—É—Ç–∏)div
        button class=etool id=etool-city onclick=setETool('city')üèôÔ∏è –ú—ñ—Å—Ç–æbutton
        button class=etool id=etool-base_blue onclick=setETool('base_blue')üè† –ë–∞–∑–∞ –°–ò–ù–Ü–•button
        button class=etool id=etool-base_red onclick=setETool('base_red')üèöÔ∏è –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•button
      div

      !-- –°—Ç–∞—Ä—Ç–æ–≤—ñ —é–Ω—ñ—Ç–∏ --
      div class=editor-tool-group
        div class=editor-group-label–°–¢–ê–†–¢–û–í–Ü –Æ–ù–Ü–¢–òdiv
        button class=etool id=etool-unit_blue onclick=setETool('unit_blue')üîµ –Æ–Ω—ñ—Ç –°–ò–ù–Ü–•button
        button class=etool id=etool-unit_red onclick=setETool('unit_red')üî¥ –Æ–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•button
        select id=editorUnitType2 style=width100%;margin4px 0;backgroundrgba(0,0,0,.5);border1px solid rgba(255,255,255,.1);color#fff;padding6px 8px;border-radius5px;font-size11px;
          option value=infantryüë• –ü—ñ—Ö–æ—Ç–∞option
          option value=apcüöõ –ë–¢–†option
          option value=tanküõ°Ô∏è –¢–∞–Ω–∫option
          option value=heliüöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Äoption
          option value=artilleryüí• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—èoption
          option value=stingerüöÄ –°—Ç—Ä—ñ–ª–µ—Ü—å ¬´–°–º–µ—Ä—á¬ªoption
        select
      div

      !-- –ü–µ–Ω–∑–µ–ª—å --
      div class=editor-tool-group
        div class=editor-group-label–†–û–ó–ú–Ü–† –ü–ï–ù–ó–õ–Ø span id=eBrushVal14spanpxdiv
        input type=range id=eBrushSize min=4 max=80 value=14 style=width100%
          oninput=document.getElementById('eBrushVal').textContent=this.value
      div

      !-- –î—ñ—ó --
      div class=editor-tool-group
        div class=editor-group-label–î–Ü–ádiv
        button class=etool onclick=editorClearTerrain()üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ—Ä–µ–Ωbutton
        button class=etool onclick=editorClearMarkers()üö´ –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏button
        button class=etool onclick=editorClearAll()üí• –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µbutton
      div

      !-- –°–ø–∏—Å–æ–∫ –º–∞—Ä–∫–µ—Ä—ñ–≤ --
      div class=editor-tool-group
        div class=editor-group-label–†–û–ó–ú–Ü–©–ï–ù–ûdiv
        div id=eMarkerList style=font-size10px;colorvar(--dim);max-height200px;overflow-yauto;displayflex;flex-directioncolumn;gap3px;div
      div

      !-- –õ–µ–≥–µ–Ω–¥–∞ --
      div class=editor-tool-group style=margin-topauto;padding-top10px;border-top1px solid rgba(255,255,255,.06);
        div class=editor-group-label–õ–ï–ì–ï–ù–î–êdiv
        div style=font-size9px;colorvar(--dim);line-height1.8;
          üåä –í–æ–¥–∞ = –±–ª–æ–∫—É—î —Ä—É—Ö (–∫—Ä—ñ–º üöÅ)br
          üåâ –ú—ñ—Å—Ç = –ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –≤–æ–¥—Ébr
          üå≤ –õ—ñ—Å = –®–Ü —É–Ω–∏–∫–∞—î, —é–Ω—ñ—Ç–∏ -40% —à–≤–∏–¥–∫–æ—Å—Ç—ñbr
          üõ£Ô∏è –î–æ—Ä–æ–≥–∞ = –®–Ü –Ω–∞–¥–∞—î –ø–µ—Ä–µ–≤–∞–≥—É (+30% —à–≤–∏–¥–∫–æ—Å—Ç—ñ)br
          –ü–ö–ú –Ω–∞ –º–∞—Ä–∫–µ—Ä—ñ = –≤–∏–¥–∞–ª–∏—Ç–∏
        div
      div
    div
  div
div

!-- LOBBY CREATE --
div class=screen id=screen-lobby-create
  div class=lobby-box
    div class=lobby-title‚öîÔ∏è –ù–û–í–ï –õ–û–ë–Üdiv
    div id=lcStatus class=status-box vis warn‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...div
    div class=lobby-code-display
      div class=lcd-label–ö–û–î –õ–û–ë–Üdiv
      div class=lcd-code id=lcCode----div
      div class=lcd-sub–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–ºdiv
      button onclick=copyLobbyCode() style=margin-top10px;backgroundrgba(34,197,94,.15);border1px solid rgba(34,197,94,.3);colorvar(--green2);padding6px 20px;border-radius6px;font-family'Oswald',sans-serif;font-size12px;font-weight700;letter-spacing2px;cursorpointer;width100%;transition.2s;üìã –°–ö–û–ü–Ü–Æ–í–ê–¢–ò –ö–û–îbutton
    div
    div class=lobby-players
      div class=lp-slot p1 filled
        div class=lps-iconüîµdiv
        div class=lps-label–°–ò–ù–Ü–ôdiv
        div class=lps-name id=lcP1Name–í–∏div
      div
      div class=lp-slot id=lcP2Slot
        div class=lps-icon‚è≥div
        div class=lps-label–ß–ï–†–í–û–ù–ò–ôdiv
        div class=lps-name id=lcP2Name–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...div
      div
    div
    div class=lobby-map-section
      div class=lms-title–ö–ê–†–¢–êdiv
      div id=lobbyGlobalMaps class=map-saved-list style=margin-bottom10px;div
      input type=file id=mapFileInput accept=image style=displaynone onchange=handleMapUpload(this)
      div class=map-upload-area onclick=document.getElementById('mapFileInput').click() id=mapUploadArea
        div style=font-size22px;margin-bottom4pxüìÅdiv
        div style=font-size11px;colorvar(--dim)–ê–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤–æ—î —Ñ–æ—Ç–æ –∫–∞—Ä—Ç–∏div
      div
      img id=mapPreview class=map-preview alt=
      div style=font-size10px;colorvar(--dim);margin-top5px;text-aligncenter id=mapUploadStatusdiv
    div
    div style=displayflex;gap8px;margin-top14px;
      button class=btn-primary id=lcStartBtn onclick=hostStartGame() disabled style=flex1‚ñ∂ –°–¢–ê–†–¢button
      button class=btn-secondary onclick=leaveLobby()‚Üê –ù–ê–ó–ê–îbutton
    div
  div
div

!-- LOBBY JOIN --
div class=screen id=screen-lobby-join
  div class=lobby-box
    div class=lobby-titleüîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨div
    div id=ljStatus class=status-box vis warn–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ª–æ–±—ñdiv
    div class=form-row
      input type=text class=form-input id=joinCodeInput placeholder=–ö–û–î –õ–û–ë–Ü
        maxlength=8 style=text-transformuppercase;letter-spacing4px;font-size18px;text-aligncenter
    div
    div class=form-row
      input type=text class=form-input id=joinNameInput placeholder=–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π maxlength=20
    div
    div style=displayflex;gap8px;margin-top8px;
      button class=btn-primary onclick=joinLobby() style=flex1üîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨button
      button class=btn-secondary onclick=showScreen('screen-menu')‚Üê –ù–ê–ó–ê–îbutton
    div
  div
div

!-- ADMIN PANEL --
div class=screen id=screen-admin
  div class=admin-header
    span class=admin-titleüëë –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨span
    div style=margin-leftauto;displayflex;gap8px;
      button class=hud-btn onclick=showScreen('screen-menu')‚Üê –ú–ï–ù–Æbutton
    div
  div
  div class=admin-body
    div class=admin-sidebar
      div class=admin-nav-btn active onclick=adminNav('maps') id=anav-mapsüó∫Ô∏è –ö–∞—Ä—Ç–∏div
      div class=admin-nav-btn onclick=adminNav('editor') id=anav-editor‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ädiv
      div class=admin-nav-btn onclick=adminNav('users') id=anav-usersüë• –ì—Ä–∞–≤—Ü—ñdiv
    div
    div class=admin-content
      !-- MAPS --
      div class=admin-section active id=asec-maps
        div class=admin-card
          div class=admin-card-titleüó∫Ô∏è –ì–õ–û–ë–ê–õ–¨–ù–Ü –ö–ê–†–¢–òdiv
          p style=font-size11px;colorvar(--dim);margin-bottom14px;–ö–∞—Ä—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤—Å—ñ–º –≥—Ä–∞–≤—Ü—è–º. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –†–ï–î–ê–ì–£–í–ê–¢–ò —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ –º—ñ—Å—Ç–∞, –≤–æ–¥—É —Ç–∞ –º–æ—Å—Ç–∏.p
          div style=displayflex;gap8px;margin-bottom14px;
            input type=file id=adminMapUpload accept=image style=displaynone onchange=adminUploadMap(this)
            button class=btn-gold onclick=document.getElementById('adminMapUpload').click()+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ä—Ç—Ébutton
            button class=btn-secondary onclick=adminNav('editor')‚úèÔ∏è –ù–æ–≤–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Äbutton
          div
          div id=adminMapsGrid class=admin-maps-griddiv
          div id=adminMapUploadStatus style=font-size11px;colorvar(--dim);margin-top8px;div
        div
      div
      !-- EDITOR --
      div class=admin-section id=asec-editor
        div class=admin-card style=heightcalc(100vh - 160px);displayflex;flex-directioncolumn;
          div style=displayflex;align-itemscenter;gap12px;margin-bottom10px;flex-shrink0;flex-wrapwrap;
            div class=admin-card-title style=margin-bottom0‚úèÔ∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–òdiv
            span style=font-size10px;colorvar(--dim)–ú–∞–ª—é–π—Ç–µ —Ç–µ—Ä–µ–Ω, –≤–æ–¥—É, –º–æ—Å—Ç–∏, –º—ñ—Å—Ç–∞, –±–∞–∑–∏span
            div style=margin-leftauto;displayflex;gap6px;
              input type=file id=editorBgUpload accept=image style=displaynone onchange=loadEditorBackground(this)
              button class=tool-btn style=widthauto;padding5px 12px onclick=document.getElementById('editorBgUpload').click()üì∑ –§–æ—Ç–æ –æ—Å–Ω–æ–≤–∞button
              button class=tool-btn style=widthauto;padding5px 12px onclick=editorUndo()‚Ü© –í—ñ–¥–º—ñ–Ω–∏—Ç–∏button
            div
          div
          div class=map-editor-wrap style=flex1;min-height0;
            div class=map-editor-canvas-wrap style=positionrelative;
              canvas id=adminMapCanvascanvas
              div id=editorMarkers style=positionabsolute;top0;left0;pointer-eventsnone;div
            div
            div class=map-editor-tools
              div class=sp-label–Ü–ù–°–¢–†–£–ú–ï–ù–¢div
              button class=tool-btn active onclick=setEditorTool('draw') id=tool-draw‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏button
              button class=tool-btn onclick=setEditorTool('erase') id=tool-eraseüßπ –°—Ç–µ—Ä—Ç–∏button
              button class=tool-btn onclick=setEditorTool('fill') id=tool-fillü™£ –ó–∞–ª–∏–≤–∫–∞button
              div class=editor-sepdiv
              div class=sp-label–¢–ï–†–ï–ùdiv
              button class=tool-btn onclick=setEditorTool('water') id=tool-water style=color#60a5faüåä –í–æ–¥–∞button
              button class=tool-btn onclick=setEditorTool('bridge') id=tool-bridge style=color#a16207üåâ –ú—ñ—Å—Çbutton
              button class=tool-btn onclick=setEditorTool('forest') id=tool-forest style=color#16a34aüå≤ –õ—ñ—Åbutton
              div class=editor-sepdiv
              div class=sp-label–†–û–ó–ú–Ü–©–ï–ù–ù–Ødiv
              button class=tool-btn onclick=setEditorTool('city') id=tool-cityüèôÔ∏è –ú—ñ—Å—Ç–æbutton
              button class=tool-btn onclick=setEditorTool('base_blue') id=tool-base_blueüè† –ë–∞–∑–∞ –°–ò–ù–Ü–•button
              button class=tool-btn onclick=setEditorTool('base_red') id=tool-base_redüèöÔ∏è –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•button
              div class=editor-sepdiv
              div class=sp-label–ü–û–ß–ê–¢–ö–û–í–Ü –Æ–ù–Ü–¢–òdiv
              button class=tool-btn onclick=setEditorTool('unit_blue') id=tool-unit_blueüîµ –Æ–Ω—ñ—Ç –°–ò–ù–Ü–•button
              button class=tool-btn onclick=setEditorTool('unit_red') id=tool-unit_redüî¥ –Æ–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•button
              select id=editorUnitType style=width100%;margin-top4px;backgroundrgba(0,0,0,.5);border1px solid rgba(255,255,255,.1);color#fff;padding5px 8px;border-radius5px;font-size11px;
                option value=infantryüë• –ü—ñ—Ö–æ—Ç–∞option
                option value=apcüöõ –ë–¢–†option
                option value=tanküõ°Ô∏è –¢–∞–Ω–∫option
                option value=heliüöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Äoption
                option value=artilleryüí• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—èoption
              select
              div class=editor-sepdiv
              div class=sp-label–ö–û–õ–Ü–† –ü–ï–ù–ó–õ–Ødiv
              div class=color-row id=colorSwatchesdiv
              div class=sp-label style=margin-top8px–†–û–ó–ú–Ü–† span id=brushSizeVal8spandiv
              input type=range id=brushSize min=2 max=60 value=8 style=width100% oninput=document.getElementById('brushSizeVal').textContent=this.value
              div style=margin-top10px;displayflex;flex-directioncolumn;gap5px;
                button class=tool-btn onclick=clearEditorCanvas()üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µbutton
                button class=tool-btn onclick=clearEditorMarkers()üö´ –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏button
                button class=btn-gold onclick=saveEditorAsMap() style=width100%;margin-top4pxüíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç—Ébutton
              div
              div class=sp-label style=margin-top10px–†–û–ó–ú–Ü–©–ï–ù–ûdiv
              div id=editorMarkerList style=font-size10px;colorvar(--dim);max-height120px;overflow-yauto;div
            div
          div
        div
      div
      !-- USERS --
      div class=admin-section id=asec-users
        div class=admin-card
          div class=admin-card-titleüë• –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –ì–†–ê–í–¶–Ø–ú–òdiv
          div id=adminUsersList style=displayflex;flex-directioncolumn;gap8px;div
          button class=btn-gold style=margin-top12px onclick=loadAdminUsers()üîÑ –û–Ω–æ–≤–∏—Ç–∏button
        div
      div
    div
  div
div

!-- GAME SCREEN --
div class=screen id=screen-game
  div class=game-hud
    div class=hud-logo‚öî –°–¢–†–ê–¢–ï–ì–Ü–Ødiv
    div class=hud-sepdiv
    div class=hud-stat
      span class=hud-stat-label–•–í–ò–õ–Øspan
      span class=hud-stat-val id=hudWave1span
    div
    div class=hud-sepdiv
    div class=hud-stat
      span class=hud-stat-labelüí∞span
      span class=hud-stat-val style=colorvar(--gold) id=hudFunds2000span
    div
    div class=hud-center
      div class=hud-timer id=hudTimer0000div
      div class=hud-turn id=hudPhase–†–û–ó–ú–Ü–©–ï–ù–ù–Ødiv
    div
    div class=hud-right
      div class=hud-statspan style=color#60a5faüîµspanspan class=hud-stat-val blue id=hudBlueUnits0spandiv
      div class=hud-statspan style=color#f87171üî¥spanspan class=hud-stat-val red id=hudRedUnits0spandiv
      div class=hud-sepdiv
      button class=hud-btn onclick=resetView()‚Ü∫ –í–ò–îbutton
      button class=hud-btn danger onclick=confirmQuit()–í–ò–ô–¢–òbutton
    div
  div
  div class=game-body id=gameBodyOuter
  div class=game-area id=gameBody
    canvas id=mapCanvascanvas
    canvas id=unitsCanvascanvas
    canvas id=frontCanvascanvas
    canvas id=uiCanvascanvas
    canvas id=interCanvascanvas
    div class=casualties-overlay
      div class=co-title–í–¢–†–ê–¢–òdiv
      div class=co-row
        span class=co-blueüîµ span id=casBlue0spanspan
        span class=co-redüî¥ span id=casRed0spanspan
      div
    div
    div class=sel-info id=selInfo
      div class=si-name id=siName‚Äîdiv
      div style=displayflex;justify-contentspace-between;margin-top3px;
        span style=font-size9px;colorvar(--dim)HPspan
        span style=font-family'Oswald',sans-serif;font-size11px id=siHPText‚Äîspan
      div
      div class=si-hp-bardiv class=si-hp-fill id=siHPBar style=width100%divdiv
      div class=si-stats
        div class=si-statspan–ê–¢–öspanb id=siAtk‚Äîbdiv
        div class=si-statspan–ó–ê–•spanb id=siDef‚Äîbdiv
        div class=si-statspan–®–íspanb id=siSpd‚Äîbdiv
        div class=si-statspan–†–ï–ñspanb id=siMode‚Äîbdiv
      div
      div style=displayflex;gap4px;margin-top6px;
        button onclick=cmdSelected('advance') style=flex1;padding3px;backgroundrgba(34,197,94,.1);border1px solid rgba(34,197,94,.3);colorvar(--green2);border-radius4px;font-family'Oswald';font-size9px;cursorpointer;letter-spacing1px;‚ñ∂ –ê–¢–öbutton
        button onclick=cmdSelected('defend') style=flex1;padding3px;backgroundrgba(59,130,246,.1);border1px solid rgba(59,130,246,.3);color#60a5fa;border-radius4px;font-family'Oswald';font-size9px;cursorpointer;letter-spacing1px;üõ° –ó–ê–•button
        button onclick=cmdSelected('hold') style=flex1;padding3px;backgroundrgba(245,158,11,.1);border1px solid rgba(245,158,11,.3);colorvar(--gold);border-radius4px;font-family'Oswald';font-size9px;cursorpointer;letter-spacing1px;‚è∏ –°–¢–Ü–ôbutton
      div
    div
    div class=zoom-ind id=zoomInd100%div
    div class=placement-hint id=placementHint–ö–õ–Ü–ö–ù–Ü–¢–¨ –ù–ê –°–í–û–á–ô –ü–û–õ–û–í–ò–ù–Üdiv
    !-- Command toolbar --
    div class=cmd-toolbar id=cmdToolbar
      div class=cmd-btn active id=cmdMove onclick=setInputMode('move') title=–ö–ª—ñ–∫ = –≤–∏–¥—ñ–ª–∏—Ç–∏–ø–µ—Ä–µ–º—ñ—â–∞—Ç–∏‚ö° –ü–ï–†–ï–ú–Ü–©–ï–ù–ù–Ødiv
      div class=cmd-btn attack-mode id=cmdAttack onclick=setInputMode('attack') title=–ö–ª—ñ–∫ = –Ω–∞–∫–∞–∑ –∞—Ç–∞–∫—É–≤–∞—Ç–∏ —Ü—ñ–ª—åüéØ –ê–¢–ê–ö–êdiv
      div class=cmd-btn id=cmdPatrol onclick=setInputMode('patrol') title=–î–≤–∞ –∫–ª—ñ–∫–∏ = –ø–∞—Ç—Ä—É–ª—å –º—ñ–∂ —Ç–æ—á–∫–∞–º–∏üîÑ –ü–ê–¢–†–£–õ–¨div
      div class=cmd-btn id=cmdSelectAll onclick=selectAll()‚ò∞ –í–°–Üdiv
      div class=cmd-btn id=cmdStop onclick=stopSelected()‚èπ –°–¢–û–üdiv
      div class=cmd-btn style=colorvar(--dim);font-size9px;cursordefault;border-colortransparent; title=–ó–∞–∂–º–∏ Shift —ñ –∫–ª—ñ–∫–∞–π —â–æ–± –≤–∏–¥—ñ–ª–∏—Ç–∏ –¥–µ–∫—ñ–ª—å–∫–∞ —é–Ω—ñ—Ç—ñ–≤‚áß SHIFT = –º—É–ª—å—Ç–∏div
    div
    !-- Income floaters container --
    div id=incomeFloaters style=positionabsolute;inset0;pointer-eventsnone;z-index50;overflowhidden;div
  div
  div class=side-panel id=sidePanel
    div class=sp-section
      div class=sp-label–†–ï–°–£–†–°–òdiv
      div class=sp-resources
        div class=sp-res-rowspan class=sp-res-labelüí∞ –§–û–ù–î–òspanspan class=sp-res-val style=colorvar(--gold) id=spFunds0spandiv
        div class=sp-res-rowspan class=sp-res-labelüèôÔ∏è –î–û–•–û–î–•–íspanspan class=sp-res-val style=colorvar(--green) id=spIncome0spandiv
        div class=sp-res-rowspan class=sp-res-label‚öîÔ∏è –Æ–ù–Ü–¢–òspanspan class=sp-res-val style=colorvar(--blue) id=spUnits0spandiv
        div class=sp-res-rowspan class=sp-res-labelüíÄ –í–¢–†–ê–¢–òspanspan class=sp-res-val style=colorvar(--red) id=spCasualties0spandiv
      div
    div
    !-- Cities list --
    div class=sp-section
      div class=sp-labelüèôÔ∏è –ú–Ü–°–¢–êdiv
      div id=citiesList class=cities-hud style=padding0;div
    div
    div class=sp-section
      div class=sp-label–†–û–ó–ú–Ü–°–¢–ò–¢–ò –Æ–ù–Ü–¢div
      div id=unitTypesListdiv
      button class=hud-btn style=width100%;margin-top6px;padding8px onclick=startBattle()‚ñ∂ –ü–û–ß–ê–¢–ò –ë–Ü–ô (Space)button
    div
    div class=sp-sectiondiv class=sp-label–ë–û–ô–û–í–ò–ô –ñ–£–†–ù–ê–õdivdiv
    div class=sp-log id=spLogdiv
  div
div

div class=result-overlay id=resultOverlay
  div class=result-box
    div class=result-emoji id=resultEmojiüèÜdiv
    div class=result-title id=resultTitle–ü–ï–†–ï–ú–û–ì–êdiv
    div class=result-sub id=resultSubdiv
    button class=btn-primary style=width100% onclick=backToMenu()‚Üê –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æbutton
  div
div
div class=toast id=toastdiv

script type=module
import{initializeApp}fromhttpswww.gstatic.comfirebasejs10.8.0firebase-app.js;
import{getFirestore,doc,setDoc,getDoc,updateDoc,onSnapshot,deleteDoc,collection,getDocs,serverTimestamp}fromhttpswww.gstatic.comfirebasejs10.8.0firebase-firestore.js;
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,updateProfile}fromhttpswww.gstatic.comfirebasejs10.8.0firebase-auth.js;

const fbApp=initializeApp({
  apiKeyAIzaSyAXTOcA4I5AYP0jfbVWb1de-lZjwf1DRhc,
  authDomainctratigia.firebaseapp.com,
  projectIdctratigia,
  storageBucketctratigia.firebasestorage.app,
  messagingSenderId71283939831,
  appId171283939831web6725da39c4b58c0065b6f2
});
const db=getFirestore(fbApp);
const auth=getAuth(fbApp);
const CL_CLOUD='dimpa9w8w',CL_PRESET='ctratigia_map';

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let uid=null,myName='–ì—Ä–∞–≤–µ—Ü—å',isAdmin=false,isAnon=true;
let lobbyId=null,myRole=null;
let lobbyUnsub=null,gameUnsub=null,presenceUnsub=null;
let isAI=false;
let aiMode='defense';  defense  attack  blitz  conquest
let aiTeam='red';  which team AI plays
let G={};
let mapBg=null,mapBgW=0,mapBgH=0;
let camX=0,camY=0,camScale=1;
let isDragging=false,dragLX=0,dragLY=0;
let selectedUnitId=null,placingType=null;
let gamePhase='placement';
let gameTimer=0,timerInterval=null;
let animFrame=null;
let gameOver=false;
let dcCountdown=null,dcSeconds=0;
let incomeInterval=null;
let editorHistoryStack=[];
let editorBg=null;  background image in editor

const UNIT_DEFS={
  infantry{name'–ü—ñ—Ö–æ—Ç–∞',emoji'üë•',radius8,hp100,maxHp100,atk12,def5,speed18,range40,cost150},
  apc{name'–ë–¢–†',emoji'üöõ',radius10,hp200,maxHp200,atk20,def15,speed28,range50,cost350},
  tank{name'–¢–∞–Ω–∫',emoji'üõ°Ô∏è',radius12,hp350,maxHp350,atk40,def30,speed20,range60,cost600},
  heli{name'–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä',emoji'üöÅ',radius9,hp150,maxHp150,atk35,def5,speed55,range80,cost500},
  artillery{name'–ê—Ä—Ç–∏–ª–µ—Ä—ñ—è',emoji'üí•',radius8,hp120,maxHp120,atk70,def3,speed10,range200,cost700},
  stinger{name'–°—Ç—Ä—ñ–ª–µ—Ü—å ¬´–°–º–µ—Ä—á¬ª',emoji'üöÄ',radius8,hp90,maxHp90,atk95,def2,speed8,range380,cost850,isMissiletrue},
};

 Input modes 'move'  'attack'  'patrol'
let inputMode='move';
let patrolPoint1=null;  for patrol mode
let selectedUnitIds=new Set();  multi-select
 Projectiles array
let projectiles=[];

 ‚îÄ‚îÄ‚îÄ COMMAND FUNCTIONS ‚îÄ‚îÄ‚îÄ
window.setInputMode=mode={
  inputMode=mode;
  ['cmdMove','cmdAttack','cmdPatrol'].forEach(id=document.getElementById(id).classList.remove('active'));
  const map={move'cmdMove',attack'cmdAttack',patrol'cmdPatrol'};
  document.getElementById(map[mode]).classList.add('active');
  patrolPoint1=null;
  const hints={move'–õ–ö–ú = –≤–∏–¥—ñ–ª–∏—Ç–∏ —é–Ω—ñ—Ç  –ü–ö–ú = –Ω–∞–∫–∞–∑ —Ä—É—Ö—É',attack'–õ–ö–ú = –≤–∏–¥—ñ–ª–∏—Ç–∏  –ü–ö–ú = –∞—Ç–∞–∫—É–≤–∞—Ç–∏ —Ü—ñ–ª—å',patrol'–ü–ö–ú = 1-–∞ —Ç–æ—á–∫–∞ ‚Üí —â–µ –ü–ö–ú = 2-–∞ —Ç–æ—á–∫–∞ –ø–∞—Ç—Ä—É–ª—é'};
  document.getElementById('placementHint').textContent=hints[mode];
  document.getElementById('placementHint').classList.add('vis');
  setTimeout(()={if(gamePhase==='battle')document.getElementById('placementHint').classList.remove('vis');},2000);
};
window.selectAll=()={
  selectedUnitIds=new Set(G.units.filter(u=u.owner===myRole&&!u._dead).map(u=u.id));
  selectedUnitId=selectedUnitIds.size[...selectedUnitIds][0]null;
  toast('‚ò∞ –í—Å—ñ —é–Ω—ñ—Ç–∏ –≤–∏–¥—ñ–ª–µ–Ω–æ '+selectedUnitIds.size);drawAll();
};
window.stopSelected=()={
  G.units.filter(u=selectedUnitIds.has(u.id)).forEach(u={u.state='hold';u.moveTarget=null;u.patrolA=null;u.patrolB=null;});
  toast('‚èπ –°—Ç–æ–ø!');
};
window.cmdSelected=cmd={
  G.units.filter(u=selectedUnitIds.has(u.id)).forEach(u={
    if(cmd==='advance'){u.state='advance';u.moveTarget=null;}
    else if(cmd==='defend'){u.state='defend';u.defendX=u.x;u.defendY=u.y;}
    else if(cmd==='hold'){u.state='hold';u.moveTarget=null;}
  });
  const labels={advance'‚öîÔ∏è –ê—Ç–∞–∫–∞',defend'üõ°Ô∏è –û–±–æ—Ä–æ–Ω–∞',hold'‚è∏ –°—Ç–æ–ø'};
  toast(labels[cmd]);
};

 City income per tick (every 15s)
const CITY_INCOME=150;
const BASE_INCOME=50;  base income per tick

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  AUTH
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLdText(t){const el=document.getElementById('ldText');if(el)el.textContent=t;}

window.addEventListener('DOMContentLoaded',async()={
  setLdText('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è...');
  await new Promise(r=setTimeout(r,500));
  if(!auth.currentUser){
    await signInAnonymously(auth).catch(()={});
  }
});

onAuthStateChanged(auth,async user={
  if(user){
    uid=user.uid;
    isAnon=user.isAnonymous;
    myName=user.displayName(isAnon'–ì—Ä–∞–≤–µ—Ü—å_'+uid.slice(-4).toUpperCase()user.email.split('@')[0]'–ì—Ä–∞–≤–µ—Ü—å');
    if(!isAnon){
      const usnap=await getDoc(doc(db,'users',uid)).catch(()=null);
      isAdmin=usnap.data().role==='admin';
    }else{isAdmin=false;}
    updateMenuUI();
    document.getElementById('loadingScreen').classList.add('hidden');
    showScreen('screen-menu');
    initGameCanvases();
    buildUnitList();
    loadGlobalMaps();
  }
});

function updateMenuUI(){
  document.getElementById('menuUserName').textContent=myName;
  const badge=document.getElementById('menuUserBadge');
  if(isAdmin){badge.textContent='–ê–î–ú–Ü–ù';badge.className='menu-user-badge badge-admin';}
  else if(!isAnon){badge.textContent='–ì–†–ê–í–ï–¶–¨';badge.className='menu-user-badge';}
  else{badge.textContent='–ì–Ü–°–¢–¨';badge.className='menu-user-badge badge-anon';}
  document.getElementById('adminMenuBtn').style.display=isAdmin'block''none';
  document.getElementById('authMenuBtn').style.display=isAnon'block''none';
  document.getElementById('logoutBtn').style.display=!isAnon'block''none';
}

window.showAuthModal=()=document.getElementById('authModal').classList.add('vis');
window.closeAuthModal=()=document.getElementById('authModal').classList.remove('vis');
window.switchAuthTab=tab={
  document.querySelectorAll('.modal-tab').forEach((t,i)=t.classList.toggle('active',i===(tab==='login'01)));
  document.querySelectorAll('.modal-tab-content').forEach((t,i)=t.classList.toggle('active',i===(tab==='login'01)));
};

window.doLogin=async()={
  const em=document.getElementById('loginEmail').value.trim();
  const pw=document.getElementById('loginPass').value;
  setStatus('loginStatus','‚ü≥ –í—Ö—ñ–¥...','warn');
  try{await signInWithEmailAndPassword(auth,em,pw);closeAuthModal();}
  catch(e){setStatus('loginStatus','‚ùå '+friendlyAuthErr(e),'err');}
};

window.doRegister=async()={
  const nm=document.getElementById('regName').value.trim();
  const em=document.getElementById('regEmail').value.trim();
  const pw=document.getElementById('regPass').value;
  if(!nm){setStatus('registerStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –ø–æ–∑–∏–≤–Ω–∏–π','err');return;}
  if(pw.length6){setStatus('registerStatus','‚ùå –ü–∞—Ä–æ–ª—å –º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤','err');return;}
  setStatus('registerStatus','‚ü≥ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...','warn');
  try{
    const cred=await createUserWithEmailAndPassword(auth,em,pw);
    await updateProfile(cred.user,{displayNamenm});
    await setDoc(doc(db,'users',cred.user.uid),{namenm,emailem,role'player',createdAtserverTimestamp()});
    closeAuthModal();
  }catch(e){setStatus('registerStatus','‚ùå '+friendlyAuthErr(e),'err');}
};

window.doLogout=async()={await signOut(auth);await signInAnonymously(auth);};

function friendlyAuthErr(e){
  if(e.code==='authemail-already-in-use')return'Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è';
  if(e.code==='authwrong-password'e.code==='authinvalid-credential')return'–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å';
  if(e.code==='authtoo-many-requests')return'–ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ';
  return e.message'–ü–æ–º–∏–ª–∫–∞';
}
function setStatus(id,msg,type){const el=document.getElementById(id);if(!el)return;el.textContent=msg;el.className='status-box vis';if(type)el.classList.add(type);}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  AI MODE SELECTION
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedAIMode='defense',selectedAITeam='blue';

window.showAIModeSelect=()={
  document.getElementById('aiModeModal').classList.add('vis');
};
window.closeAIModeModal=()={document.getElementById('aiModeModal').classList.remove('vis');};

window.selectAIMode=mode={
  selectedAIMode=mode;
  document.querySelectorAll('.ai-mode-card').forEach(c=c.classList.remove('selected'));
  document.getElementById('aimode-'+mode).classList.add('selected');
};
window.selectAITeam=team={
  selectedAITeam=team;
  document.getElementById('teamBtnBlue').classList.toggle('selected',team==='blue');
  document.getElementById('teamBtnRed').classList.toggle('selected',team==='red');
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  GLOBAL MAPS
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let globalMaps=[];
async function loadGlobalMaps(){
  try{
    const snap=await getDoc(doc(db,'appData','globalMaps'));
    globalMaps=snap.exists()(snap.data().maps[])[];
    renderLobbyGlobalMaps();
    if(isAdmin)renderAdminMaps();
    if(globalMaps.length0&&!mapBgW)loadMapFromUrl(globalMaps[0].url);
  }catch(e){}
}

function renderLobbyGlobalMaps(){
  const el=document.getElementById('lobbyGlobalMaps');
  if(!el)return;
  if(!globalMaps.length){el.innerHTML='div style=font-size10px;colorvar(--dim);text-aligncenter;padding8px–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∫–∞—Ä—Çdiv';return;}
  el.innerHTML=globalMaps.map((m,i)=`
    div class=map-saved-item onclick=selectGlobalMap(${i}) id=gmap_${i}
      img src=${m.url} class=msi-thumb onerror=this.style.display='none'
      div class=msi-info
        div class=msi-name${m.name}div
        div class=msi-date${m.date''} ${m.cities' üèôÔ∏è'+m.cities.length+' –º—ñ—Å—Ç'''}div
      div
    div`).join('');
}

window.selectGlobalMap=async(i)={
  const m=globalMaps[i];
  document.querySelectorAll('.map-saved-item').forEach(e=e.classList.remove('active'));
  document.getElementById('gmap_'+i).classList.add('active');
  loadMapFromUrl(m.url);
  if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrlm.url,mapIdxi,mapVerDate.now().toString()}).catch(()={});
  document.getElementById('mapPreview').style.display='none';
  document.getElementById('mapUploadArea').style.display='block';
  toast('‚úÖ –ö–∞—Ä—Ç–∞ –≤–∏–±—Ä–∞–Ω–∞ '+m.name);
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ADMIN - MAPS
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.adminUploadMap=async(input)={
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('adminMapUploadStatus');
  st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';
  try{
    const comp=await compressImage(file,3000,3000,.85);
    st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';
    const url=await uploadCloudinary(comp,'admin_map_'+Date.now());
    const name=file.name.replace(.[^.]+$,'').slice(0,30);
    const date=new Date().toLocaleDateString('uk-UA');
    globalMaps.push({url,name,date,cities[],water[],bridges[],spawnsnull});
    await setDoc(doc(db,'appData','globalMaps'),{mapsglobalMaps});
    st.textContent='‚úÖ –ö–∞—Ä—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –†–ï–î–ê–ì–£–í–ê–¢–ò –¥–ª—è –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è.';
    renderAdminMaps();renderLobbyGlobalMaps();
    toast('‚úÖ –ö–∞—Ä—Ç–∞ –¥–æ–¥–∞–Ω–∞!');
    input.value='';
  }catch(e){st.textContent='‚ùå '+e.message;}
};

function renderAdminMaps(){
  const el=document.getElementById('adminMapsGrid');if(!el)return;
  if(!globalMaps.length){el.innerHTML='div style=font-size11px;colorvar(--dim)–ö–∞—Ä—Ç –Ω–µ–º–∞—î. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ –ø–µ—Ä—à—É!div';return;}
  el.innerHTML=globalMaps.map((m,i)=`
    div class=admin-map-card id=amc_${i}
      img src=${m.url} class=amc-img onerror=this.src='dataimagesvg+xml,svg xmlns=%22httpwww.w3.org2000svg%22 viewBox=%220 0 1 1%22'
      div class=amc-info
        div class=amc-name${m.name}div
        div class=amc-meta${m.date''} ${m.cities'üèôÔ∏è'+m.cities.length'0'} –º—ñ—Å—Ç ${m.water'üíß''‚¨ú'}div
        div class=amc-actions
          button class=amc-btn set onclick=adminSetActiveMap(${i})‚úÖ –ê–∫—Ç–∏–≤–Ω–∞button
          button class=amc-btn edit onclick=adminEditMap(${i})‚úèÔ∏èbutton
          button class=amc-btn del onclick=adminDeleteMap(${i})üóëÔ∏èbutton
        div
      div
    div`).join('');
}

window.adminSetActiveMap=async(i)={
  const m=globalMaps.splice(i,1)[0];globalMaps.unshift(m);
  await setDoc(doc(db,'appData','globalMaps'),{mapsglobalMaps});
  renderAdminMaps();renderLobbyGlobalMaps();
  toast('‚úÖ –ö–∞—Ä—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—é');
};
window.adminDeleteMap=async(i)={
  if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏ –∫–∞—Ä—Ç—É '+globalMaps[i].name+''))return;
  globalMaps.splice(i,1);
  await setDoc(doc(db,'appData','globalMaps'),{mapsglobalMaps});
  renderAdminMaps();renderLobbyGlobalMaps();
  toast('üóëÔ∏è –ö–∞—Ä—Ç—É –≤–∏–¥–∞–ª–µ–Ω–æ');
};
window.adminEditMap=async(i)={
  adminNav('editor');
   Load this map into editor
  editorEditingMapIdx=i;
  const m=globalMaps[i];
  editorMarkers=[];
   Restore existing markers
  if(m.spawns){
    if(m.spawns.blueBase)editorMarkers.push({type'base',team'blue',nxm.spawns.blueBase.nx,nym.spawns.blueBase.ny,px0,py0});
    if(m.spawns.redBase)editorMarkers.push({type'base',team'red',nxm.spawns.redBase.nx,nym.spawns.redBase.ny,px0,py0});
    (m.spawns.units[]).forEach(u=editorMarkers.push({type'unit',teamu.team,unitTypeu.unitType,nxu.nx,nyu.ny,px0,py0}));
  }
  (m.cities[]).forEach(c=editorMarkers.push({type'city',nxc.nx,nyc.ny,namec.name,px0,py0}));
   Load bg image
  editorBg=null;
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()={
    editorBg=img;
    drawEditorBase();
     Convert px from normalized
    const cv=document.getElementById('adminMapCanvas');
    if(cv){
      editorMarkers.forEach(mk={mk.px=mk.nxcv.width;mk.py=mk.nycv.height;});
    }
    renderEditorMarkers();updateEditorMarkerList();
  };
  img.src=m.url;
  toast('‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è '+m.name);
};
let editorEditingMapIdx=-1;

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ADMIN - EDITOR
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let editorCtx,editorTool='draw',editorColor='#22c55e',editorSize=8;
let editorDrawing=false,editorLastX=0,editorLastY=0;
let editorMarkers=[];
const EDITOR_COLORS=['#22c55e','#3b82f6','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#ffffff','#1a2810','#5c3d1a','#1e3a5f','#0d2d4a','#000000','#6b7280'];

window.adminNav=section={
  document.querySelectorAll('.admin-section').forEach(s=s.classList.remove('active'));
  document.querySelectorAll('.admin-nav-btn').forEach(b=b.classList.remove('active'));
  document.getElementById('asec-'+section).classList.add('active');
  document.getElementById('anav-'+section).classList.add('active');
  if(section==='editor')initEditor();
  if(section==='maps'){renderAdminMaps();loadGlobalMaps();}
  if(section==='users')loadAdminUsers();
};

function initEditor(){
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  const wrap=cv.parentElement;
  cv.width=wrap.clientWidth900;cv.height=wrap.clientHeight550;
  editorCtx=cv.getContext('2d');
  editorHistoryStack=[];
  drawEditorBase();
  const sw=document.getElementById('colorSwatches');
  if(sw)sw.innerHTML=EDITOR_COLORS.map(c=`div class=color-swatch ${c===editorColor'active'''} style=background${c} onclick=setEditorColor('${c}')div`).join('');
  cv.onmousedown=e={
    if(editorTool.startsWith('base_')editorTool.startsWith('unit_')editorTool==='city'){
      placeEditorMarker(e.offsetX,e.offsetY);return;
    }
    if(editorTool==='fill'){floodFill(e.offsetX,e.offsetY);return;}
    saveEditorHistory();
    editorDrawing=true;editorLastX=e.offsetX;editorLastY=e.offsetY;
    editorCtx.beginPath();editorCtx.moveTo(editorLastX,editorLastY);
  };
  cv.onmousemove=e={
    if(!editorDrawing)return;
    if(editorTool==='water'){drawTerrainStroke(e,'#1e40af',editorSize);}
    else if(editorTool==='bridge'){drawTerrainStroke(e,'#92400e',editorSize.6);}
    else if(editorTool==='forest'){drawTerrainStroke(e,'#166534',editorSize);}
    else if(editorTool==='erase'){drawTerrainStroke(e,editorBgnull'#1a2810',editorSize2,true);}
    else{drawTerrainStroke(e,editorColor,editorSize);}
  };
  cv.onmouseup=cv.onmouseleave=()={editorDrawing=false;};
  const bs=document.getElementById('brushSize');
  if(bs)bs.oninput=e={editorSize=+e.target.value;};
}

function drawTerrainStroke(e,color,size,erase=false){
  if(erase&&editorBg){
     Restore from bg
    editorCtx.drawImage(editorBg,e.offsetX-size,e.offsetY-size,size2,size2,e.offsetX-size,e.offsetY-size,size2,size2);
  }else{
    editorCtx.strokeStyle=color;
    editorCtx.lineWidth=size;
    editorCtx.lineCap='round';editorCtx.lineJoin='round';
    editorCtx.beginPath();editorCtx.moveTo(editorLastX,editorLastY);editorCtx.lineTo(e.offsetX,e.offsetY);editorCtx.stroke();
  }
  editorLastX=e.offsetX;editorLastY=e.offsetY;
}

function floodFill(sx,sy){
  saveEditorHistory();
  const cv=document.getElementById('adminMapCanvas');
  const imgData=editorCtx.getImageData(0,0,cv.width,cv.height);
  const data=imgData.data;
  const idx=(x,y)=(ycv.width+x)4;
  const target=[data[idx(sx,sy)],data[idx(sx,sy)+1],data[idx(sx,sy)+2],data[idx(sx,sy)+3]];
  const fill=hexToRgb(editorColor);
  if(!fill)return;
  if(target[0]===fill.r&&target[1]===fill.g&&target[2]===fill.b)return;
  const stack=[[sx,sy]];const visited=new Uint8Array(cv.widthcv.height);
  while(stack.length){
    const [x,y]=stack.pop();
    if(x0x=cv.widthy0y=cv.height)continue;
    const i=idx(x,y);const vi=ycv.width+x;
    if(visited[vi])continue;visited[vi]=1;
    if(Math.abs(data[i]-target[0])30Math.abs(data[i+1]-target[1])30Math.abs(data[i+2]-target[2])30)continue;
    data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  editorCtx.putImageData(imgData,0,0);
}
function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};}

function saveEditorHistory(){
  const cv=document.getElementById('adminMapCanvas');if(!editorCtx!cv)return;
  editorHistoryStack.push(editorCtx.getImageData(0,0,cv.width,cv.height));
  if(editorHistoryStack.length30)editorHistoryStack.shift();
}

window.editorUndo=()={
  if(!editorHistoryStack.length){toast('‚ö†Ô∏è –ù–µ–º–∞ —â–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏');return;}
  const imgData=editorHistoryStack.pop();
  editorCtx.putImageData(imgData,0,0);
  renderEditorMarkers();
};

window.loadEditorBackground=input={
  const file=input.files[0];if(!file)return;
  const img=new Image();
  img.onload=()={
    editorBg=img;
    const cv=document.getElementById('adminMapCanvas');if(!cv)return;
    saveEditorHistory();
    editorCtx.clearRect(0,0,cv.width,cv.height);
    editorCtx.drawImage(img,0,0,cv.width,cv.height);
  };
  img.src=URL.createObjectURL(file);
  toast('üì∑ –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ —è–∫ –æ—Å–Ω–æ–≤–∞');
};

function drawEditorBase(){
  const cv=document.getElementById('adminMapCanvas');if(!editorCtx!cv)return;
  if(editorBg){editorCtx.drawImage(editorBg,0,0,cv.width,cv.height);return;}
   Default terrain
  editorCtx.fillStyle='#1a2810';editorCtx.fillRect(0,0,cv.width,cv.height);
  editorCtx.strokeStyle='rgba(255,255,255,.04)';editorCtx.lineWidth=1;
  for(let x=0;xcv.width;x+=50){editorCtx.beginPath();editorCtx.moveTo(x,0);editorCtx.lineTo(x,cv.height);editorCtx.stroke();}
  for(let y=0;ycv.height;y+=50){editorCtx.beginPath();editorCtx.moveTo(0,y);editorCtx.lineTo(cv.height,y);editorCtx.stroke();}
  editorCtx.strokeStyle='rgba(255,255,255,.18)';editorCtx.lineWidth=2;editorCtx.setLineDash([10,8]);
  editorCtx.beginPath();editorCtx.moveTo(cv.width2,0);editorCtx.lineTo(cv.width2,cv.height);editorCtx.stroke();editorCtx.setLineDash([]);
  editorCtx.fillStyle='rgba(59,130,246,.07)';editorCtx.fillRect(0,0,cv.width2,cv.height);
  editorCtx.fillStyle='rgba(239,68,68,.07)';editorCtx.fillRect(cv.width2,0,cv.width2,cv.height);
  editorCtx.font='bold 32px Oswald';editorCtx.textAlign='center';editorCtx.textBaseline='middle';
  editorCtx.fillStyle='rgba(59,130,246,.15)';editorCtx.fillText('–°–ò–ù–Ü',cv.width.25,cv.height2);
  editorCtx.fillStyle='rgba(239,68,68,.15)';editorCtx.fillText('–ß–ï–†–í–û–ù–Ü',cv.width.75,cv.height2);
}

function placeEditorMarker(px,py){
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  const isBase=editorTool.startsWith('base_');
  const team=editorTool.split('_')[1];
  const unitType=document.getElementById('editorUnitType').value'infantry';
  const nx=pxcv.width,ny=pycv.height;
  if(isBase){editorMarkers=editorMarkers.filter(m=!(m.type==='base'&&m.team===team));}
  if(editorTool==='city'){
    const name=prompt('–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞ (Enter = –ø—Ä–æ–ø—É—Å—Ç–∏—Ç–∏)','–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=m.type==='city').length+1))('–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=m.type==='city').length+1));
    editorMarkers.push({type'city',nx,ny,name,px,py});
  }else{
    editorMarkers.push({typeisBase'base''unit',teamisBaseteameditorTool.split('_')[1],unitTypeisBasenullunitType,nx,ny,px,py});
  }
  renderEditorMarkers();updateEditorMarkerList();
}

function renderEditorMarkers(){
  const wrap=document.getElementById('editorMarkers');
  const cv=document.getElementById('adminMapCanvas');
  if(!wrap!cv)return;
  wrap.innerHTML=editorMarkers.map((m,i)={
    let emoji,color;
    if(m.type==='city'){emoji='üèôÔ∏è';color='#f59e0b';}
    else if(m.type==='base'){emoji=m.team==='blue''üè†''üèöÔ∏è';color=m.team==='blue''#60a5fa''#f87171';}
    else{emoji=UNIT_DEFS[m.unitType].emoji'‚ö™';color=m.team==='blue''#60a5fa''#f87171';}
    const px=m.nxcv.width,py=m.nycv.height;
    return`div style=positionabsolute;left${px-14}px;top${py-14}px;font-size20px;cursorpointer;filterdrop-shadow(0 0 4px ${color});pointer-eventsauto title=${m.type} ${m.namem.team''} onclick=removeEditorMarker(${i})${emoji}div`;
  }).join('');
  wrap.style.pointerEvents='none';
}

function updateEditorMarkerList(){
  const el=document.getElementById('editorMarkerList');if(!el)return;
  if(!editorMarkers.length){el.textContent='–ù–µ–º–∞—î –º–∞—Ä–∫–µ—Ä—ñ–≤';return;}
  el.innerHTML=editorMarkers.map((m,i)={
    const label=m.type==='city'`üèôÔ∏è ${m.name}`m.type==='base'`–ë–∞–∑–∞ ${m.team}``${UNIT_DEFS[m.unitType].namem.unitType} (${m.team})`;
    return`div style=displayflex;justify-contentspace-between;padding2px 0;border-bottom1px solid rgba(255,255,255,.04)
      span${label}spanspan style=cursorpointer;color#f87171 onclick=removeEditorMarker(${i})‚úïspan
    div`;
  }).join('');
}

window.removeEditorMarker=i={editorMarkers.splice(i,1);renderEditorMarkers();updateEditorMarkerList();};
window.clearEditorMarkers=()={editorMarkers=[];renderEditorMarkers();updateEditorMarkerList();toast('üóëÔ∏è –ú–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');};
window.setEditorTool=t={
  editorTool=t;
  document.querySelectorAll('.tool-btn[id^=tool-]').forEach(b=b.classList.remove('active'));
  document.getElementById('tool-'+t).classList.add('active');
};
window.setEditorColor=c={
  editorColor=c;
  document.querySelectorAll('.color-swatch').forEach(s=s.classList.toggle('active',s.style.background===cs.style.backgroundColor===c));
};
window.clearEditorCanvas=()={
  if(!editorCtx)return;
  editorHistoryStack=[];editorBg=null;
  drawEditorBase();
  toast('üóëÔ∏è –ü–æ–ª–æ—Ç–Ω–æ –æ—á–∏—â–µ–Ω–æ');
};

window.saveEditorAsMap=async()={
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  let name='–ú–æ—è –∫–∞—Ä—Ç–∞';
  if(editorEditingMapIdx=0)name=globalMaps[editorEditingMapIdx].name;
  else{const n=prompt('–ù–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏','–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞');if(n===null)return;name=n'–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';}
  const dataUrl=cv.toDataURL('imagejpeg',.92);
  const st=document.getElementById('adminMapUploadStatus'){textContent''};
  st.textContent='‚ü≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
  toast('‚ü≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–∞—Ä—Ç—É...');
  try{
    const url=await uploadCloudinary(dataUrl,'editor_map_'+(editorEditingMapIdx=0'edit_'+editorEditingMapIdx'new_'+Date.now()));
    const date=new Date().toLocaleDateString('uk-UA');
    const spawns={
      blueBaseeditorMarkers.find(m=m.type==='base'&&m.team==='blue')null,
      redBaseeditorMarkers.find(m=m.type==='base'&&m.team==='red')null,
      unitseditorMarkers.filter(m=m.type==='unit').map(m=({teamm.team,unitTypem.unitType,nxm.nx,nym.ny})),
    };
    const cities=editorMarkers.filter(m=m.type==='city').map(m=({nxm.nx,nym.ny,namem.name}));
    const mapEntry={url,name,date,spawns,cities};
    if(editorEditingMapIdx=0){globalMaps[editorEditingMapIdx]=mapEntry;}
    else{globalMaps.push(mapEntry);}
    await setDoc(doc(db,'appData','globalMaps'),{mapsglobalMaps});
    toast('‚úÖ '+name+' –∑–±–µ—Ä–µ–∂–µ–Ω–∞!');
    editorMarkers=[];editorEditingMapIdx=-1;
    adminNav('maps');
  }catch(e){toast('‚ùå '+e.message);}
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  NEW STANDALONE MAP EDITOR (for all users, from menu)
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let eCtx=null;          editor canvas context
let eTool='draw';       active tool
let eDrawing=false;     mouse held
let eLX=0,eLY=0;       last mouse position (canvas coords)
let eHistory=[];        undo stack
let eBg=null,eBgX=0,eBgY=0,eBgW=0,eBgH=0; // bg image + position in canvas
let eMarkers=[];        placed markers (city  base  unit)
let eMapName='–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';
let eMapIdx=-1;         -1 = new map
 Camera for new editor
let eCamX=0,eCamY=0,eCamScale=1;
let eCamDrag=false,eCamLX=0,eCamLY=0;

 Terrain arrays stored separately from canvas (for game logic)
let eTerrain={roads[],forests[],water[],bridges[]};
 Each terrain entry {x,y,r} in normalized 0..1 coords

const ECOLORS_TERRAIN={
  water'rgba(30,64,175,0.75)',
  bridge'rgba(120,80,20,0.9)',
  forest'rgba(22,101,52,0.7)',
  road'rgba(180,140,60,0.85)',
  draw'#22c55e',
  erasenull,
};

window.openMapEditor=(mapIdx=-1)={
  showScreen('screen-editor');
  eMapIdx=mapIdx;
  initNewEditor();
  editorPopulateMapSelect();
   After init load the active map if any
  const loadIdx=mapIdx=0mapIdx(globalMaps.length00-1);
  if(loadIdx=0&&globalMaps[loadIdx]){
    eMapIdx=loadIdx;
    eMapName=globalMaps[loadIdx].name;
    const el=document.getElementById('editorMapName');
    if(el)el.textContent=eMapName;
    const sel=document.getElementById('editorMapSelect');
    if(sel)sel.value=String(loadIdx);
    setTimeout(()=eLoadMapForEditing(globalMaps[loadIdx]),80);
  }
};

function editorPopulateMapSelect(){
  const sel=document.getElementById('editorMapSelect');
  if(!sel)return;
  sel.innerHTML='option value=-1+ –ù–æ–≤–∞ –∫–∞—Ä—Ç–∞option';
  globalMaps.forEach((m,i)={
    const opt=document.createElement('option');
    opt.value=String(i);opt.textContent=m.name(i+1+'. –ö–∞—Ä—Ç–∞');
    sel.appendChild(opt);
  });
  if(eMapIdx=0)sel.value=String(eMapIdx);
}

window.editorSwitchMap=idxStr={
  const i=parseInt(idxStr);
  if(i0){
     New blank map
    eMapIdx=-1;eMapName='–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';
    eHistory=[];eTerrain={roads[],forests[],water[],bridges[]};
    eMarkers=[];eBg=null;
    eDrawDefaultBg();
    eRedrawMarkersOverlay();eUpdateMarkerList();
    document.getElementById('editorMapName').textContent=eMapName;
    return;
  }
  if(!globalMaps[i])return;
  eMapIdx=i;eMapName=globalMaps[i].name;
  document.getElementById('editorMapName').textContent=eMapName;
  eLoadMapForEditing(globalMaps[i]);
};

window.setETool=t={
  eTool=t;
  document.querySelectorAll('.etool').forEach(b=b.classList.remove('active'));
  document.getElementById('etool-'+t).classList.add('active');
  const hints={
    draw'–õ—ñ–≤–∞ –∫–Ω–æ–ø–∫–∞ –º–∏—à—ñ ‚Äî –º–∞–ª—é–≤–∞—Ç–∏',
    erase'–õ–ö–ú ‚Äî —Å—Ç–µ—Ä—Ç–∏. –ü–ö–ú ‚Äî –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏',
    fill'–õ–ö–ú ‚Äî –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –æ–±–ª–∞—Å—Ç—å –∫–æ–ª—å–æ—Ä–æ–º',
    move'–õ–ö–ú —Ç—è–≥–Ω–∏ ‚Äî –ø–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è, –∫–æ–ª—ñ—â–∞—Ç–∫–æ ‚Äî –∑—É–º',
    water'–õ–ö–ú ‚Äî –º–∞–ª—é–≤–∞—Ç–∏ –≤–æ–¥—É (—Å–∏–Ω—î = –Ω–µ –ø—Ä–æ–π—Ç–∏ –±–µ–∑ –º–æ—Å—Ç—É)',
    bridge'–õ–ö–ú ‚Äî –º–∞–ª—é–≤–∞—Ç–∏ –º—ñ—Å—Ç (–ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –≤–æ–¥—É)',
    forest'–õ–ö–ú ‚Äî –º–∞–ª—é–≤–∞—Ç–∏ –ª—ñ—Å (–®–Ü —É–Ω–∏–∫–∞—î, -40% —à–≤–∏–¥–∫—ñ—Å—Ç—å)',
    road'–õ–ö–ú ‚Äî –º–∞–ª—é–≤–∞—Ç–∏ –¥–æ—Ä–æ–≥—É (–®–Ü –Ω–∞–¥–∞—î –ø–µ—Ä–µ–≤–∞–≥—É, +30%)',
    city'–õ–ö–ú ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –º—ñ—Å—Ç–æ. –ü–ö–ú ‚Äî –≤–∏–¥–∞–ª–∏—Ç–∏',
    base_blue'–õ–ö–ú ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –±–∞–∑—É –°–ò–ù–Ü–•',
    base_red'–õ–ö–ú ‚Äî –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –±–∞–∑—É –ß–ï–†–í–û–ù–ò–•',
    unit_blue'–õ–ö–ú ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤–∏–π —é–Ω—ñ—Ç –°–ò–ù–Ü–•',
    unit_red'–õ–ö–ú ‚Äî —Å—Ç–∞—Ä—Ç–æ–≤–∏–π —é–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•',
  };
  const hint=document.getElementById('editorCursorHint');
  if(hint)hint.textContent=hints[t]'';
};

window.editorLoadBg=input={
  const file=input.files[0];if(!file)return;
  const img=new Image();
  img.onload=()={
    eBg=img;
    eHistoryPush();
    eCtx.clearRect(0,0,eCtx.canvas.width,eCtx.canvas.height);
    eCtx.drawImage(img,0,0,eCtx.canvas.width,eCtx.canvas.height);
    toast('üì∑ –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');
  };
  img.src=URL.createObjectURL(file);
};

window.editorRenameMap=()={
  const n=prompt('–ù–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏',eMapName);
  if(n)eMapName=n;
  const el=document.getElementById('editorMapName');
  if(el)el.textContent=eMapName;
};

window.editorUndoNew=()={
  if(!eHistory.length){toast('‚ö†Ô∏è –ù—ñ—á–æ–≥–æ –≤—ñ–¥–º—ñ–Ω—è—Ç–∏');return;}
  eCtx.putImageData(eHistory.pop(),0,0);
  eRedrawTerrainOverlay();
};

window.editorClearTerrain=()={
  eHistoryPush();
  eTerrain={roads[],forests[],water[],bridges[]};
  if(eBg){eCtx.drawImage(eBg,0,0,eCtx.canvas.width,eCtx.canvas.height);}
  else{eDrawDefaultBg();}
  toast('üóëÔ∏è –¢–µ—Ä–µ–Ω –æ—á–∏—â–µ–Ω–æ');
};
window.editorClearMarkers=()={eMarkers=[];eRedrawMarkersOverlay();toast('üö´ –ú–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');};
window.editorClearAll=()={
  eHistoryPush();
  eTerrain={roads[],forests[],water[],bridges[]};
  eMarkers=[];
  eBg=null;
  eDrawDefaultBg();
  eRedrawMarkersOverlay();
  toast('üí• –í—Å–µ –æ—á–∏—â–µ–Ω–æ');
};

function eHistoryPush(){
  if(!eCtx)return;
  const cv=eCtx.canvas;
  eHistory.push(eCtx.getImageData(0,0,cv.width,cv.height));
  if(eHistory.length25)eHistory.shift();
}

function initNewEditor(){
  const area=document.getElementById('editorCanvasArea');
  const cv=document.getElementById('editorCanvas');
  if(!area!cv)return;

   Size canvas to fill area
  const W=area.clientWidth;const H=area.clientHeight;
  cv.width=W;cv.height=H;
  cv.style.width=W+'px';cv.style.height=H+'px';
   Overlay
  const ov=document.getElementById('editorOverlay');
  if(ov){ov.style.width=W+'px';ov.style.height=H+'px';}

  eCtx=cv.getContext('2d');
  eHistory=[];eTerrain={roads[],forests[],water[],bridges[]};
  eMarkers=[];eCamX=0;eCamY=0;eCamScale=1;
  eBg=null;eMapIdx=-1;eMapName='–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';
  eDrawDefaultBg();
  eUpdateMarkerList();

   Events
  cv.onmousedown=eOnMD;
  cv.onmousemove=eOnMM;
  cv.onmouseup=cv.onmouseleave=eOnMU;
  cv.onwheel=e={e.preventDefault();const f=e.deltaY01.10.91;const r=cv.getBoundingClientRect();const mx=e.clientX-r.left,my=e.clientY-r.top;eCamScale=Math.max(.1,Math.min(8,eCamScalef));eCamX=mx-(mx-eCamX)f;eCamY=my-(my-eCamY)f;document.getElementById('editorZoomInd').textContent=Math.round(eCamScale100)+'%';};
  cv.oncontextmenu=e={e.preventDefault();eHandleRightClick(e);};

   If we have a map to load for editing
  if(eMapIdx=0&&globalMaps[eMapIdx]){
    eLoadMapForEditing(globalMaps[eMapIdx]);
  }
}

function eDrawDefaultBg(){
  if(!eCtx)return;
  const cv=eCtx.canvas;
  const W=cv.width,H=cv.height;
   Dark green terrain base
  eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,W,H);
   Grid
  eCtx.strokeStyle='rgba(255,255,255,.04)';eCtx.lineWidth=1;
  for(let x=0;xW;x+=50){eCtx.beginPath();eCtx.moveTo(x,0);eCtx.lineTo(x,H);eCtx.stroke();}
  for(let y=0;yH;y+=50){eCtx.beginPath();eCtx.moveTo(0,y);eCtx.lineTo(W,y);eCtx.stroke();}
   Half-line
  eCtx.strokeStyle='rgba(255,255,255,.2)';eCtx.lineWidth=2;eCtx.setLineDash([12,8]);
  eCtx.beginPath();eCtx.moveTo(W2,0);eCtx.lineTo(W2,H);eCtx.stroke();eCtx.setLineDash([]);
   Labels
  eCtx.font='bold 28px Oswald,sans-serif';eCtx.textAlign='center';eCtx.textBaseline='middle';
  eCtx.fillStyle='rgba(59,130,246,.12)';eCtx.fillText('–°–ò–ù–Ü',W.25,H2);
  eCtx.fillStyle='rgba(239,68,68,.12)';eCtx.fillText('–ß–ï–†–í–û–ù–Ü',W.75,H2);
}

function eOnMD(e){
  e.preventDefault();
  const{cx,cy}=eCanvasXY(e);
  if(eTool==='move'){eCamDrag=true;eCamLX=cx;eCamLY=cy;return;}
  if(eTool.startsWith('base_')eTool.startsWith('unit_')eTool==='city'){
    ePlaceMarker(cx,cy);return;
  }
  if(eTool==='fill'){eFloodFill(cx,cy);return;}
  eHistoryPush();
  eDrawing=true;eLX=cx;eLY=cy;
}

function eOnMM(e){
  e.preventDefault();
  const{cx,cy}=eCanvasXY(e);
  if(eCamDrag){
    const dx=cx-eCamLX,dy=cy-eCamLY;
    eCamX+=dx;eCamY+=dy;eCamLX=cx;eCamLY=cy;return;
  }
  if(!eDrawing)return;
  const brushPx=+(document.getElementById('eBrushSize').value14);
  if(eTool==='erase'){
    if(eBg&&eBgW>0){
      // Map canvas coords to image source coords
      const sx=(cx-eBgX)/eBgW*eBg.naturalWidth,sy=(cy-eBgY)/eBgH*eBg.naturalHeight;
      const sr=brushPx/eBgW*eBg.naturalWidth;
      eCtx.drawImage(eBg,sx-sr,sy-sr,sr*2,sr*2,cx-brushPx,cy-brushPx,brushPx*2,brushPx*2);
    }else{
      eCtx.fillStyle='#1a2810';eCtx.fillRect(cx-brushPx,cy-brushPx,brushPx*2,brushPx*2);
    }
     Remove terrain entries near this point
    const cv=eCtx.canvas;const nx=cxcv.width,ny=cycv.height,nr=brushPxcv.width;
    ['roads','forests','water','bridges'].forEach(k={
      eTerrain[k]=eTerrain[k].filter(t=Math.hypot(t.x-nx,t.y-ny)nr+t.r);
    });
  }else{
    const col=ECOLORS_TERRAIN[eTool]ECOLORS_TERRAIN.draw;
    eCtx.strokeStyle=col;eCtx.lineWidth=brushPx;
    eCtx.lineCap='round';eCtx.lineJoin='round';
    eCtx.globalAlpha=eTool==='erase'1(eTool==='road'eTool==='bridge'0.850.75);
    eCtx.beginPath();eCtx.moveTo(eLX,eLY);eCtx.lineTo(cx,cy);eCtx.stroke();
    eCtx.globalAlpha=1;
     Record terrain entry
    const cv=eCtx.canvas;
    const nx=(cx+eLX)(2cv.width),ny=(cy+eLY)(2cv.height);
    const nr=brushPx(2cv.width);
    const tKey={water'water',bridge'bridges',forest'forests',road'roads'}[eTool];
    if(tKey)eTerrain[tKey].push({xnx,yny,rnr});
  }
  eLX=cx;eLY=cy;
}

function eOnMU(e){eDrawing=false;eCamDrag=false;eRedrawMarkersOverlay();}

function eHandleRightClick(e){
  const{cx,cy}=eCanvasXY(e);
  const cv=eCtx.canvas;
  const nx=cxcv.width,ny=cycv.height;
   Find and remove nearest marker within 30px
  const idx=eMarkers.findIndex(m=Math.hypot(m.nxcv.width-cx,m.nycv.height-cy)30);
  if(idx=0){eMarkers.splice(idx,1);eRedrawMarkersOverlay();eUpdateMarkerList();toast('‚úï –ú–∞—Ä–∫–µ—Ä –≤–∏–¥–∞–ª–µ–Ω–æ');}
}

function eCanvasXY(e){
  const r=eCtx.canvas.getBoundingClientRect();
  return{cxe.clientX-r.left,cye.clientY-r.top};
}

function ePlaceMarker(cx,cy){
  const cv=eCtx.canvas;
  const nx=cxcv.width,ny=cycv.height;
  const isBase=eTool.startsWith('base_');
  if(isBase){
    const team=eTool.split('_')[1];
    eMarkers=eMarkers.filter(m=!(m.type==='base'&&m.team===team));
    eMarkers.push({type'base',team,nx,ny});
  }else if(eTool==='city'){
    const name=prompt('–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞ (Enter = –∞–≤—Ç–æ)',`–ú—ñ—Å—Ç–æ ${eMarkers.filter(m=m.type==='city').length+1}`)`–ú—ñ—Å—Ç–æ ${eMarkers.filter(m=m.type==='city').length+1}`;
    eMarkers.push({type'city',nx,ny,name});
  }else{
    const team=eTool.split('_')[1];
    const unitType=document.getElementById('editorUnitType2').value'infantry';
    eMarkers.push({type'unit',team,unitType,nx,ny});
  }
  eRedrawMarkersOverlay();eUpdateMarkerList();
}

function eFloodFill(cx,cy){
  eHistoryPush();
  const cv=eCtx.canvas;
  const imgData=eCtx.getImageData(0,0,cv.width,cv.height);const data=imgData.data;
  const idx=(x,y)=(ycv.width+x)4;
  const sx=Math.round(cx),sy=Math.round(cy);
  const target=[data[idx(sx,sy)],data[idx(sx,sy)+1],data[idx(sx,sy)+2]];
  const col=ECOLORS_TERRAIN[eTool]ECOLORS_TERRAIN.draw;
  const fill=hexOrRgbaToRgb(col);if(!fill)return;
  if(target[0]===fill.r&&target[1]===fill.g&&target[2]===fill.b)return;
  const stack=[[sx,sy]];const visited=new Uint8Array(cv.widthcv.height);
  while(stack.length){
    const[x,y]=stack.pop();
    if(x0x=cv.widthy0y=cv.height)continue;
    const i=idx(x,y);const vi=ycv.width+x;
    if(visited[vi])continue;visited[vi]=1;
    if(Math.abs(data[i]-target[0])30Math.abs(data[i+1]-target[1])30Math.abs(data[i+2]-target[2])30)continue;
    data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  eCtx.putImageData(imgData,0,0);
}

function hexOrRgbaToRgb(col){
  if(!col)return{r26,g40,b16};
  if(col.startsWith('#')){const r=parseInt(col.slice(1,3),16),g=parseInt(col.slice(3,5),16),b=parseInt(col.slice(5,7),16);return{r,g,b};}
  if(col.startsWith('rgba')){const m=col.match([d.]+g);return m{r+m[0],g+m[1],b+m[2]}null;}
  return null;
}

function eRedrawMarkersOverlay(){
  const ov=document.getElementById('editorOverlay');
  const cv=eCtx.canvas;
  if(!ov!cv)return;
  ov.style.width=cv.width+'px';ov.style.height=cv.height+'px';
  ov.innerHTML=eMarkers.map((m,i)={
    const px=m.nxcv.width,py=m.nycv.height;
    const emoji={city'üèôÔ∏è',base_blue'üè†',base_red'üèöÔ∏è'}[m.type+('_'+(m.team''))]
                 (m.type==='base'(m.team==='blue''üè†''üèöÔ∏è')
                 (m.type==='city''üèôÔ∏è'(UNIT_DEFS[m.unitType].emoji'‚ö™')));
    const glow=m.type==='city''#f59e0b'm.team==='blue''#60a5fa''#f87171';
    return`div class=editor-marker style=left${px}px;top${py}px;filterdrop-shadow(0 0 5px ${glow}) drop-shadow(0 0 2px #000);font-size22px;cursorpointer;pointer-eventsauto onclick=eRemoveMarker(${i}) title=–õ–ö–ú = –≤–∏–¥–∞–ª–∏—Ç–∏${emoji}div`;
  }).join('');
}

window.eRemoveMarker=i={eMarkers.splice(i,1);eRedrawMarkersOverlay();eUpdateMarkerList();};

function eRedrawTerrainOverlay(){ canvas IS terrain }

function eUpdateMarkerList(){
  const el=document.getElementById('eMarkerList');if(!el)return;
  if(!eMarkers.length){el.innerHTML='span style=colorvar(--dim);font-size10px–ú–∞—Ä–∫–µ—Ä—ñ–≤ –Ω–µ–º–∞—îspan';return;}
  el.innerHTML=eMarkers.map((m,i)={
    const label=m.type==='city'`üèôÔ∏è ${m.name}`
                m.type==='base'`${m.team==='blue''üè† –ë–∞–∑–∞ –°–∏–Ω—ñ—Ö''üèöÔ∏è –ë–∞–∑–∞ –ß–µ—Ä–≤–æ–Ω–∏—Ö'}`
                `${UNIT_DEFS[m.unitType].emoji'‚ö™'} ${UNIT_DEFS[m.unitType].namem.unitType} (${m.team==='blue''üîµ''üî¥'})`;
    return`div style=displayflex;justify-contentspace-between;align-itemscenter;padding3px 4px;border-radius4px;backgroundrgba(255,255,255,.02);
      span style=font-size10px${label}span
      span style=color#f87171;cursorpointer;font-size11px;padding0 4px onclick=eRemoveMarker(${i})‚úïspan
    div`;
  }).join('');
}

window.editorSaveMap=async()={
  const cv=eCtx.canvas;if(!cv){toast('‚ùå –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π');return;}
  toast('‚ü≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ...');
  try{
    const dataUrl=cv.toDataURL('imagejpeg',.92);
    const key='e_map_'+(eMapIdx=0eMapIdxDate.now());
    const url=await uploadCloudinary(dataUrl,key);
    const date=new Date().toLocaleDateString('uk-UA');
    const spawns={
      blueBaseeMarkers.find(m=m.type==='base'&&m.team==='blue')null,
      redBaseeMarkers.find(m=m.type==='base'&&m.team==='red')null,
      unitseMarkers.filter(m=m.type==='unit').map(m=({teamm.team,unitTypem.unitType,nxm.nx,nym.ny})),
    };
    const cities=eMarkers.filter(m=m.type==='city').map(m=({nxm.nx,nym.ny,namem.name}));
     Package terrain for game use
    const terrainData={
      watereTerrain.water,
      bridgeseTerrain.bridges,
      forestseTerrain.forests,
      roadseTerrain.roads,
    };
    const mapEntry={url,nameeMapName,date,spawns,cities,terrainterrainData};
    if(eMapIdx=0){globalMaps[eMapIdx]=mapEntry;}else{globalMaps.push(mapEntry);}
    await setDoc(doc(db,'appData','globalMaps'),{mapsglobalMaps});
    renderLobbyGlobalMaps();if(isAdmin)renderAdminMaps();
    toast('‚úÖ '+eMapName+' –∑–±–µ—Ä–µ–∂–µ–Ω–∞!');
    showScreen('screen-menu');
  }catch(e){toast('‚ùå '+e.message);}
};

function eLoadMapForEditing(m){
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()=>{
    eBg=img;
    const cv=eCtx.canvas;
    const sc=Math.min(cv.width/img.naturalWidth,cv.height/img.naturalHeight);
    eBgW=img.naturalWidth*sc;eBgH=img.naturalHeight*sc;
    eBgX=(cv.width-eBgW)/2;eBgY=(cv.height-eBgH)/2;
    eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,cv.width,cv.height);
    eCtx.drawImage(img,eBgX,eBgY,eBgW,eBgH);
     Restore terrain
    if(m.terrain){eTerrain={roadsm.terrain.roads[],forestsm.terrain.forests[],waterm.terrain.water[],bridgesm.terrain.bridges[]};}
     Restore markers
    eMarkers=[];
    if(m.spawns){
      if(m.spawns.blueBase)eMarkers.push({type'base',team'blue',nxm.spawns.blueBase.nx,nym.spawns.blueBase.ny});
      if(m.spawns.redBase)eMarkers.push({type'base',team'red',nxm.spawns.redBase.nx,nym.spawns.redBase.ny});
      (m.spawns.units[]).forEach(u=eMarkers.push({type'unit',teamu.team,unitTypeu.unitType,nxu.nx,nyu.ny}));
    }
    (m.cities[]).forEach(c=eMarkers.push({type'city',nxc.nx,nyc.ny,namec.name}));
    eMapName=m.name;
    const el=document.getElementById('editorMapName');if(el)el.textContent=eMapName;
    eRedrawMarkersOverlay();eUpdateMarkerList();
    toast('‚úèÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ '+m.name);
  };
  img.src=m.url;
}

 Allow admin to open new editor for a specific map
window.adminEditMapNew=i={
  eMapIdx=i;
  openMapEditor();
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  TERRAIN SYSTEM roads  forests affect movement
  Data loaded from map metadata terrain arrays
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let G_terrain={roads[],forests[],water[],bridges[]};

function loadTerrainFromMap(mapEntry){
  if(mapEntry.terrain){
    G_terrain={
      roadsmapEntry.terrain.roads[],
      forestsmapEntry.terrain.forests[],
      watermapEntry.terrain.water[],
      bridgesmapEntry.terrain.bridges[],
    };
  }else{
    G_terrain={roads[],forests[],water[],bridges[]};
  }
}

function getTerrainSpeedMultiplier(nx,ny){
   nx,ny in 0..1 normalized coords
  for(const r of G_terrain.roads){if(Math.hypot(r.x-nx,r.y-ny)r.r+0.02)return 1.3;} road +30%
  for(const f of G_terrain.forests){if(Math.hypot(f.x-nx,f.y-ny)f.r+0.02)return 0.55;} forest -45%
  return 1.0;
}

function isTerrainWater(nx,ny){
  return G_terrain.water.some(w=Math.hypot(w.x-nx,w.y-ny)w.r+0.01);
}

function isTerrainBridge(nx,ny){
  return G_terrain.bridges.some(b=Math.hypot(b.x-nx,b.y-ny)b.r+0.01);
}

function isTerrainForest(nx,ny){
  return G_terrain.forests.some(f=Math.hypot(f.x-nx,f.y-ny)f.r+0.02);
}

function isTerrainRoad(nx,ny){
  return G_terrain.roads.some(r=Math.hypot(r.x-nx,r.y-ny)r.r+0.02);
}

 AI pathfinding preference prefers roads, avoids forests
function aiMovePref(unit,tx,ty,dt){
  const mw=mapBgW2000,mh=mapBgH1200;
  const nx=unit.xmw,ny=unit.ymh;
  const tnx=txmw,tny=tymh;
  const dx=tnx-nx,dy=tny-ny,dist=Math.max(0.0001,Math.sqrt(dxdx+dydy));
  const stepSize=unit.speeddtmw;

   Check direct path terrain
  const midNx=nx+dx0.5,midNy=ny+dy0.5;
  const isForest=isTerrainForest(midNx,midNy);
  const isRoad=isTerrainRoad(midNx,midNy);

   If forest AI tries to go around (tries offset perpendicular)
  if(isForest&&!isRoad){
    const perpX=-dydist,perpY=dxdist;
    const offsets=[0.15,-0.15,0.3,-0.3];
    for(const off of offsets){
      const altNx=midNx+perpXoff,altNy=midNy+perpYoff;
      if(!isTerrainForest(altNx,altNy)){
        const altWx=altNxmw,altWy=altNymh;
        moveToward(unit,altWx,altWy,dt0.7);
        return;
      }
    }
  }

   Apply speed modifier
  const speedMult=isForest0.55(isRoad1.31.0);
  moveToward(unit,tx,ty,dtspeedMult);
}

 Visual draw terrain overlay on map canvas
function drawTerrainOverlay(ctx){
  if(!ctx)return;
  const mw=mapBgW1;const mh=mapBgH1;
   Roads ‚Äî tanyellow semi-transparent lines
  if(G_terrain.roads.length){
    ctx.globalAlpha=0.35;
    ctx.fillStyle='#d97706';
    for(const r of G_terrain.roads){ctx.beginPath();ctx.arc(r.xmw,r.ymh,r.rmw,0,Math.PI2);ctx.fill();}
    ctx.globalAlpha=1;
  }
   Forests ‚Äî green
  if(G_terrain.forests.length){
    ctx.globalAlpha=0.28;
    ctx.fillStyle='#166534';
    for(const f of G_terrain.forests){ctx.beginPath();ctx.arc(f.xmw,f.ymh,f.rmw,0,Math.PI2);ctx.fill();}
    ctx.globalAlpha=1;
  }
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  ADMIN - USERS
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.loadAdminUsers=async()={
  const el=document.getElementById('adminUsersList');
  el.innerHTML='div style=colorvar(--dim);font-size11px–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...div';
  try{
    const snaps=await getDocs(collection(db,'users'));
    if(snaps.empty){el.innerHTML='div style=colorvar(--dim);font-size11px–ù–µ–º–∞—î –∑–∞—Ä–µ—î—Å—Ç—Ä–æ–≤–∞–Ω–∏—Ö –≥—Ä–∞–≤—Ü—ñ–≤div';return;}
    el.innerHTML=snaps.docs.map(d={const u=d.data();
      return`div style=displayflex;align-itemscenter;gap10px;padding8px 10px;border-radius6px;backgroundrgba(255,255,255,.03);border1px solid rgba(255,255,255,.06);
        span style=font-size16px${u.role==='admin''üëë''üë§'}span
        div style=flex1div style=font-size12px;font-weight700;color#fff${u.name'‚Äî'}divdiv style=font-size10px;colorvar(--dim)${u.email'‚Äî'}divdiv
        span style=font-size10px;padding2px 8px;border-radius10px;${u.role==='admin''backgroundrgba(245,158,11,.15);colorvar(--gold);border1px solid rgba(245,158,11,.3)''backgroundrgba(100,116,139,.1);colorvar(--dim);border1px solid rgba(100,116,139,.2)'}${u.role'player'}span
        ${u.role!=='admin'`button class=amc-btn set onclick=grantAdmin('${d.id}')üëë –ê–¥–º—ñ–Ωbutton`''}
      div`;
    }).join('');
  }catch(e){el.innerHTML='div style=color#f87171;font-size11px‚ùå '+e.message+'div';}
};
window.grantAdmin=async(userId)={
  if(!confirm('–ù–∞–¥–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞'))return;
  await updateDoc(doc(db,'users',userId),{role'admin'});
  toast('‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞ –Ω–∞–¥–∞–Ω–æ');loadAdminUsers();
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  SCREENS
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showScreen=name={
  document.querySelectorAll('.screen').forEach(s=s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  LOBBY CREATE
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genCode(){return Array.from({length5},()='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()32)]).join('');}

window.copyLobbyCode=()={
  const code=document.getElementById('lcCode').textContent;
  const fb=()={const ta=document.createElement('textarea');ta.value=code;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);};
  if(navigator.clipboard){navigator.clipboard.writeText(code).then(()=toast('‚úÖ –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ '+code)).catch(()={fb();toast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');});}
  else{fb();toast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');}
};

function setLobbyMapHostOnly(isHost){
  const upload=document.getElementById('mapUploadArea');
  const fileInp=document.getElementById('mapFileInput');
  [upload,fileInp].forEach(el={if(el)el.style.display=isHost'''none';});
}

window.showLobbyCreate=async()={
  showScreen('screen-lobby-create');
  setStatus('lcStatus','‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...','warn');
  const code=genCode();lobbyId=code;myRole='blue';
  document.getElementById('lcCode').textContent=code;
  document.getElementById('lcP1Name').textContent=myName;
  document.getElementById('lcP2Name').textContent='–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...';
  document.getElementById('lcP2Slot').classList.remove('filled');
  document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='‚è≥';
  document.getElementById('lcStartBtn').disabled=true;
  mapBg=null;mapBgW=0;mapBgH=0;
  document.getElementById('mapPreview').style.display='none';
  document.getElementById('mapUploadArea').style.display='block';
  document.getElementById('mapUploadStatus').textContent='';
  renderLobbyGlobalMaps();setLobbyMapHostOnly(true);
  if(globalMaps.length0)loadMapFromUrl(globalMaps[0].url);
  try{
    await setDoc(doc(db,'lobbies',code),{
      code,hostuid,hostNamemyName,guestUidnull,guestNamenull,
      mapUrlglobalMaps[0].urlnull,mapIdx0,mapVer'0',status'waiting',
      createdAtserverTimestamp(),presence{blueDate.now(),red0}
    });
    setStatus('lcStatus','‚úÖ –õ–æ–±—ñ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ö–æ–¥ '+code,'ok');
    listenLobby(code,'host');
    startPresencePing(code,'blue');
  }catch(e){setStatus('lcStatus','‚ùå '+e.message,'err');}
};

window.showLobbyJoin=()={showScreen('screen-lobby-join');};

window.joinLobby=async()={
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase();
  const nm=document.getElementById('joinNameInput').value.trim()myName;
  if(!code){setStatus('ljStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!','err');return;}
  myName=nm;
  setStatus('ljStatus','‚ü≥ –ü–æ—à—É–∫...','warn');
  try{
    const snap=await getDoc(doc(db,'lobbies',code));
    if(!snap.exists()){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!','err');return;}
    const d=snap.data();
    if(d.status!=='waiting'&&d.status!=='ready'){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ','err');return;}
    if(d.guestUid&&d.guestUid!==uid){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ','err');return;}
    lobbyId=code;myRole='red';
    await updateDoc(doc(db,'lobbies',code),{guestUiduid,guestNamemyName,status'ready','presence.red'Date.now()});
    showScreen('screen-lobby-create');
    document.getElementById('lcCode').textContent=code;
    document.getElementById('lcP1Name').textContent=d.hostName'–•–æ—Å—Ç';
    document.getElementById('lcP2Name').textContent=myName;
    document.getElementById('lcP2Slot').classList.add('filled');
    document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';
    document.getElementById('lcStartBtn').disabled=true;
    mapBg=null;mapBgW=0;mapBgH=0;
    renderLobbyGlobalMaps();setLobbyMapHostOnly(false);
    setStatus('lcStatus','‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å! –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ä—Ç—É...','ok');
    listenLobby(code,'guest');
    startPresencePing(code,'red');
    if(d.mapUrl)loadMapFromUrl(d.mapUrl);
    else if(globalMaps.length0)loadMapFromUrl(globalMaps[0].url);
  }catch(e){setStatus('ljStatus','‚ùå '+e.message,'err');}
};

function listenLobby(code,role){
  if(lobbyUnsub)lobbyUnsub();
  lobbyUnsub=onSnapshot(doc(db,'lobbies',code),snap={
    if(!snap.exists())return;
    const d=snap.data();
    if(d.guestName){
      document.getElementById('lcP2Name').textContent=d.guestName;
      document.getElementById('lcP2Slot').classList.add('filled');
      document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';
      if(role==='host'){document.getElementById('lcStartBtn').disabled=false;setStatus('lcStatus','‚úÖ '+d.guestName+' –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –°–¢–ê–†–¢.','ok');}
    }
    if(d.mapUrl)loadMapFromUrl(d.mapUrl);
    if(d.status==='started'){
      if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
      startGame(code,role,d);
    }
  });
}

window.hostStartGame=async()={if(!lobbyId)return;await updateDoc(doc(db,'lobbies',lobbyId),{status'started'});};

window.leaveLobby=async()={
  if(lobbyId&&myRole==='blue'){await deleteDoc(doc(db,'lobbies',lobbyId)).catch(()={});}
  if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
  if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}
  lobbyId=null;myRole=null;showScreen('screen-menu');
};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  PRESENCE  DISCONNECT
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startPresencePing(code,role){
  if(presenceUnsub)clearInterval(presenceUnsub);
  presenceUnsub=setInterval(async()={
    if(!lobbyId)return;
    await updateDoc(doc(db,'games',code),{['presence.'+role]Date.now()}).catch(()={});
  },5000);
}

function monitorOpponentPresence(code){
  const oppRole=myRole==='blue''red''blue';
  setInterval(async()={
    if(gameOver!lobbyId)return;
    const snap=await getDoc(doc(db,'games',code)).catch(()=null);
    if(!snap.exists())return;
    const ts=snap.data().presence.[oppRole]0;
    const elapsed=(Date.now()-ts)1000;
    if(elapsed10&&elapsed75){showDcBanner(75-Math.floor(elapsed));}
    else if(elapsed=75){hideDcBanner();showResult(myRole,'–û–ø–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è');}
    else{hideDcBanner();}
  },3000);
}

let dcInterval=null;
function showDcBanner(sec){
  dcSeconds=sec;
  const b=document.getElementById('dcBanner');b.classList.add('vis');
  document.getElementById('dcTimer').textContent=sec;
  if(dcInterval)return;
  dcInterval=setInterval(()={dcSeconds--;document.getElementById('dcTimer').textContent=Math.max(0,dcSeconds);if(dcSeconds=0){clearInterval(dcInterval);dcInterval=null;}},1000);
}
function hideDcBanner(){
  document.getElementById('dcBanner').classList.remove('vis');
  if(dcInterval){clearInterval(dcInterval);dcInterval=null;}
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  VS AI
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startVsAI=()={
  aiMode=selectedAIMode;
   AI always plays the opposite team
  myRole=selectedAITeam;
  const oppTeam=myRole==='blue''red''blue';
  isAI=true;lobbyId='ai_'+Date.now();
  closeAIModeModal();
  const mapMeta=globalMaps[0]null;
  const mapUrl=mapMeta.urlnull;
  mapBg=null;mapBgW=0;mapBgH=0;
  initGameState(mapMeta,myRole);
  showScreen('screen-game');
  setTimeout(()={resizeCanvases();if(mapUrl)loadMapFromUrl(mapUrl);},50);
  startGameLoop();
  addLog(`ü§ñ –†–µ–∂–∏–º ${aiModeLabel(aiMode)}  –í–∏ ${myRole==='blue''üîµ –°–ò–ù–Ü''üî¥ –ß–ï–†–í–û–ù–Ü'}`,'warn');
};

function aiModeLabel(m){return{defense'üõ°Ô∏è –û–ë–û–†–û–ù–ê',attack'‚öîÔ∏è –ù–ê–°–¢–£–ü',blitz'‚ö° –ë–õ–Ü–¶–ö–†–ò–ì',conquest'üèÜ –ó–ê–í–û–Æ–í–ê–ù–ù–Ø'}[m]m;}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  GAME START
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(code,role,lobbyData){
  isAI=false;myRole=role;lobbyId=code;
  const mapIdx=lobbyData.mapIdx0;
  const mapUrl=lobbyData.mapUrlglobalMaps[0].urlnull;
  const mapMeta=mapIdx=0&&mapIdxglobalMaps.lengthglobalMaps[mapIdx](globalMaps.find(m=m.url===mapUrl)null);
  mapBg=null;mapBgW=0;mapBgH=0;
  initGameState(mapMeta,myRole);
  showScreen('screen-game');
  setTimeout(()={resizeCanvases();if(mapUrl)loadMapFromUrl(mapUrl);},50);
  startGameLoop();
  listenGameState(code);
  startPresencePing(code,role);
  monitorOpponentPresence(code);
}

function initGameState(mapData,playerRole){
  G={
    units[],
    funds{blue2000,red2000},
    casualties{blue0,red0},
    cities[],
    water[],bridges[],
    phase'placement',wave1,startTimeDate.now(),nextId1
  };
  gamePhase='placement';gameOver=false;gameTimer=0;
  if(timerInterval)clearInterval(timerInterval);
  timerInterval=setInterval(tickTimer,1000);
  if(incomeInterval)clearInterval(incomeInterval);
  incomeInterval=setInterval(tickIncome,15000);
  document.getElementById('hudPhase').textContent='–†–û–ó–ú–Ü–©–ï–ù–ù–Ø';
  document.getElementById('placementHint').classList.add('vis');
   Init cities from map metadata
  if(mapData.cities&&mapData.cities.length0){
     Cities loaded ‚Äî will be positioned after mapBg loads
    G._pendingCities=mapData.cities;
  }else{
     Default cities if map has none
    G._pendingCities=null;
  }
  if(mapData.spawns){
    G._pendingSpawns=mapData.spawns;
  }
   Water areas from map (we detect blue pixels) or use stored
  G._waterAreas=mapData.watermapData.terrain.water[];
  G._bridges=mapData.bridgesmapData.terrain.bridges[];
   Load roadforest terrain
  loadTerrainFromMap(mapData);
  updateHUD();updateCitiesPanel();
}

function applyMapData(){
  if(!mapBgW!mapBgH)return;
  const mw=mapBgW,mh=mapBgH;
   Apply cities
  if(G._pendingCities&&G._pendingCities.length0){
    G.cities=G._pendingCities.map((c,i)=({
      id'city_'+i,namec.name('–ú—ñ—Å—Ç–æ '+(i+1)),
      xc.nxmw,yc.nymh,nxc.nx,nyc.ny,
      owner'neutral',incomeCITY_INCOME,
      hp300,maxHp300,captureProgress{blue0,red0}
    }));
    G._pendingCities=null;
    addLog('üèôÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ '+G.cities.length+' –º—ñ—Å—Ç','info');
  }else if(!G.cities.length){
     Generate default cities spread across map
    G.cities=generateDefaultCities(mw,mh);
    addLog('üèôÔ∏è –ó–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ '+G.cities.length+' –º—ñ—Å—Ç','info');
  }
   Apply spawn data
  if(G._pendingSpawns){
    const spawns=G._pendingSpawns;
    if(spawns.blueBase){G.bases={...G.bases{},blue{xspawns.blueBase.nxmw,yspawns.blueBase.nymh}};}
    if(spawns.redBase){G.bases={...G.bases{},red{xspawns.redBase.nxmw,yspawns.redBase.nymh}};}
    (spawns.units[]).forEach(s={
      const def=UNIT_DEFS[s.unitType]UNIT_DEFS.infantry;
      G.units.push({idG.nextId++,types.unitType,owners.team,
        xs.nxmw,ys.nymh,txs.nxmw,tys.nymh,vx0,vy0,
        hpdef.hp,maxHpdef.hp,atkdef.atk,defdef.def,speeddef.speed,rangedef.range,radiusdef.radius,
        state'idle',attackTargetnull,lastAttack0,lastAttackAnim0});
    });
    G._pendingSpawns=null;
  }
   Default bases if not set
  if(!G.bases){
    G.bases={blue{xmw.12,ymh.5},red{xmw.88,ymh.5}};
  }
  updateHUD();updateCitiesPanel();
}

function generateDefaultCities(mw,mh){
  const positions=[
    {nx.5,ny.5,name'–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ'},
    {nx.3,ny.3,name'–õ—ñ—Å–∞'},
    {nx.7,ny.3,name'–°—Ö—ñ–¥'},
    {nx.3,ny.7,name'–ü—ñ–≤–¥–µ–Ω—å'},
    {nx.7,ny.7,name'–ì–æ—Ä–∏'},
  ];
  return positions.map((p,i)=({
    id'city_'+i,namep.name,xp.nxmw,yp.nymh,nxp.nx,nyp.ny,
    owner'neutral',incomeCITY_INCOME,hp300,maxHp300,captureProgress{blue0,red0}
  }));
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  INCOME SYSTEM
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickIncome(){
  if(gameOvergamePhase!=='battle')return;
  let blueIncome=BASE_INCOME,redIncome=BASE_INCOME;
  G.cities.forEach(c={
    if(c.owner==='blue')blueIncome+=c.income;
    else if(c.owner==='red')redIncome+=c.income;
  });
  G.funds.blue+=blueIncome;
  G.funds.red+=redIncome;
  updateHUD();
   Floating income text on canvas
  spawnIncomeFloat(myRole,myRole==='blue'blueIncomeredIncome);
  addLog(`üí∞ –î–æ—Ö–æ–¥ +${myRole==='blue'blueIncomeredIncome} ‚Ç¥ (${G.cities.filter(c=c.owner===myRole).length} –º—ñ—Å—Ç)`,'warn');
}

function getIncome(role){
  let inc=BASE_INCOME;
  G.cities.forEach(c={if(c.owner===role)inc+=c.income;});
  return inc;
}

function spawnIncomeFloat(role,amount){
  const body=document.getElementById('gameBody');
  const base=G.bases.[role];if(!base!body)return;
   Convert world to screen
  const sx=base.xcamScale+camX;
  const sy=base.ycamScale+camY;
  const el=document.createElement('div');
  el.className='income-float';
  el.textContent='+'+amount+'‚Ç¥';
  el.style.left=sx+'px';el.style.top=(sy-20)+'px';
  document.getElementById('incomeFloaters').appendChild(el);
  setTimeout(()=el.remove(),1600);
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  CITY CAPTURE
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCityCapture(dt){
  if(!G.cities)return;
  const now=performance.now();
  G.cities.forEach(city={
     Count units near city
    const captureRange=30;
    const blueNear=G.units.filter(u=u.owner==='blue'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)captureRange).length;
    const redNear=G.units.filter(u=u.owner==='red'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)captureRange).length;
    if(blueNear0&&redNear===0){
      city.captureProgress.blue=Math.min(100,(city.captureProgress.blue0)+dt15);
      city.captureProgress.red=Math.max(0,(city.captureProgress.red0)-dt10);
      if(city.captureProgress.blue=100&&city.owner!=='blue'){
        city.owner='blue';city.captureProgress={blue100,red0};
        addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –°–ò–ù–Ü–ú–ò!','good');
        toast('üèôÔ∏è '+city.name+' ‚Äî –Ω–∞—à–µ!');
        syncGameState();updateCitiesPanel();
      }
    }else if(redNear0&&blueNear===0){
      city.captureProgress.red=Math.min(100,(city.captureProgress.red0)+dt15);
      city.captureProgress.blue=Math.max(0,(city.captureProgress.blue0)-dt10);
      if(city.captureProgress.red=100&&city.owner!=='red'){
        city.owner='red';city.captureProgress={blue0,red100};
        addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –ß–ï–†–í–û–ù–ò–ú–ò!',myRole==='blue''bad''good');
        if(myRole==='blue')toast('‚ö†Ô∏è '+city.name+' ‚Äî –∑–∞—Ö–æ–ø–ª–µ–Ω–æ!');
        syncGameState();updateCitiesPanel();
      }
    }else{
       Decay slowly if contested or empty
      if(city.owner==='neutral'){
        city.captureProgress.blue=Math.max(0,(city.captureProgress.blue0)-dt3);
        city.captureProgress.red=Math.max(0,(city.captureProgress.red0)-dt3);
      }
    }
  });
}

function updateCitiesPanel(){
  const el=document.getElementById('citiesList');if(!el!G.cities)return;
  if(!G.cities.length){el.innerHTML='div style=font-size10px;colorvar(--dim)–ù–µ–º–∞—î –º—ñ—Å—Çdiv';return;}
  el.innerHTML=G.cities.map(c=`
    div class=city-row
      div class=city-dot ${c.owner==='neutral''neutral'c.owner}div
      span class=city-name${c.name}span
      ${c.owner!=='neutral'`span class=city-income+${c.income}‚Ç¥span`''}
    div`).join('');
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  TIMER
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickTimer(){
  gameTimer++;
  const m=Math.floor(gameTimer60),s=gameTimer%60;
  document.getElementById('hudTimer').textContent=String(m).padStart(2,'0')+''+String(s).padStart(2,'0');
   Wave system every 2 minutes advance wave
  if(isAI&&gameTimer%120===0&&!gameOver){
    G.wave++;
    document.getElementById('hudWave').textContent=G.wave;
    addLog('üåä –•–í–ò–õ–Ø '+G.wave+' ‚Äî –≤–æ—Ä–æ–≥ –ø–æ—Å–∏–ª—é—î—Ç—å—Å—è!','warn');
    if(gamePhase==='battle')spawnAIWave();
  }
   Blitz mode timer 5 min limit
  if(isAI&&aiMode==='blitz'&&gameTimer=300&&!gameOver){
    const myCities=G.cities.filter(c=c.owner===myRole).length;
    const oppCities=G.cities.filter(c=c.owner!=myRole&&c.owner!=='neutral').length;
    if(myCitiesoppCities)showResult(myRole,'–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å –∑–∞ –º—ñ—Å—Ç–∞–º–∏ —É –±–ª–∏—Ü–∫—Ä–∏–≥—É!');
    else showResult(myRole==='blue''red''blue','–ß–∞—Å –≤–∏–π—à–æ–≤ ‚Äî –≤–æ—Ä–æ–≥ –∫–æ–Ω—Ç—Ä–æ–ª—é—î –±—ñ–ª—å—à–µ –º—ñ—Å—Ç!');
  }
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  FIRESTORE SYNC
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let syncThrottle=null;
function syncGameState(){
  if(!lobbyIdisAI)return;
  if(syncThrottle)clearTimeout(syncThrottle);
  syncThrottle=setTimeout(async()={
    try{
      await setDoc(doc(db,'games',lobbyId),{
        unitsG.units.filter(u=!u._dead).map(u=({idu.id,typeu.type,owneru.owner,xMath.round(u.x),yMath.round(u.y),hpMath.round(u.hp)})),
        fundsG.funds,casualtiesG.casualties,
        citiesG.cities.map(c=({idc.id,ownerc.owner,captureProgressc.captureProgress})),
        phasegamePhase,waveG.wave,tsDate.now(),
        ['presence.'+myRole]Date.now()
      },{mergetrue});
    }catch(e){}
  },150);
}

function listenGameState(code){
  if(gameUnsub)gameUnsub();
  gameUnsub=onSnapshot(doc(db,'games',code),snap={
    if(!snap.exists())return;
    const d=snap.data();
    const oppRole=myRole==='blue''red''blue';
    const myUnits=G.units.filter(u=u.owner===myRole);
    const remOpp=(d.units[]).filter(u=u.owner===oppRole).map(u={
      const ex=G.units.find(x=x.id===u.id&&x.owner===oppRole);
      if(ex){ex.hp=u.hp;ex.tx=u.x;ex.ty=u.y;return ex;}
      const def=UNIT_DEFS[u.type]UNIT_DEFS.infantry;
      return{...def,...u,txu.x,tyu.y,vx0,vy0,state'idle',attackTargetnull,lastAttack0,lastAttackAnim0};
    });
    G.units=[...myUnits,...remOpp];
    if(d.funds)G.funds=d.funds;
    if(d.casualties)G.casualties=d.casualties;
     Sync city ownership
    if(d.cities&&G.cities){
      d.cities.forEach(dc={const lc=G.cities.find(c=c.id===dc.id);if(lc){lc.owner=dc.owner;lc.captureProgress=dc.captureProgress;}});
      updateCitiesPanel();
    }
    if(d.phase&&d.phase!==gamePhase){
      gamePhase=d.phase;
      if(gamePhase==='battle'){document.getElementById('hudPhase').textContent='–ë–Ü–ô';document.getElementById('placementHint').classList.remove('vis');}
    }
    updateHUD();
  });
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  MAP UPLOAD
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleMapUpload=async(input)={
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('mapUploadStatus');
  st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';
  try{
    const comp=await compressImage(file,3000,3000,.85);
    st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';
    const prev=document.getElementById('mapPreview');prev.src=comp;prev.style.display='block';
    document.getElementById('mapUploadArea').style.display='none';
    const url=await uploadCloudinary(comp,'lobby_map_'+lobbyId);
    if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrlurl,mapVerDate.now().toString()}).catch(()={});
    loadMapFromUrl(url);st.textContent='‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';
  }catch(e){st.textContent='‚ùå '+e.message;}
};

async function uploadCloudinary(base64,publicId){
  const fd=new FormData();fd.append('file',base64);fd.append('upload_preset',CL_PRESET);
  if(publicId)fd.append('public_id',publicId);
  const r=await fetch(`httpsapi.cloudinary.comv1_1${CL_CLOUD}imageupload`,{method'POST',bodyfd});
  if(!r.ok){const e=await r.json();throw new Error(e.error.message'Upload failed');}
  return(await r.json()).secure_url;
}

function compressImage(file,maxW,maxH,q){
  return new Promise(res={
    const img=new Image(),url=URL.createObjectURL(file);
    img.onload=()={
      URL.revokeObjectURL(url);
      let w=img.width,h=img.height;
      const r=Math.min(maxWw,maxHh,1);w=Math.round(wr);h=Math.round(hr);
      const cv=document.createElement('canvas');cv.width=w;cv.height=h;
      cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('imagejpeg',q));
    };img.src=url;
  });
}

function loadMapFromUrl(url){
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()={
    mapBg=img;mapBgW=img.naturalWidth;mapBgH=img.naturalHeight;
    centerMap();
    applyMapData();  apply citiesspawns now that we know dimensions
    drawAll();
  };
  img.src=url;
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  CANVAS ‚Äî FIX #1 no black walls
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mapCtx,unitsCtx,frontCtx,uiCtx,interCtx,CW=0,CH=0;

function initGameCanvases(){
  [mapCtx,unitsCtx,frontCtx,uiCtx,interCtx]=['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].map(id=document.getElementById(id).getContext('2d'));
  resizeCanvases();
  window.addEventListener('resize',()={if(document.getElementById('screen-game').classList.contains('active'))resizeCanvases();});
  setupInteraction();
}

function resizeCanvases(){
  const area=document.getElementById('gameBody');if(!area)return;
   Use the game-area div which is flex1 inside game-body
  CW=area.clientWidth;CH=area.clientHeight;
  CW=Math.max(1,CW);CH=Math.max(1,CH);
  ['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].forEach(id={
    const cv=document.getElementById(id);if(!cv)return;
    cv.width=CW;cv.height=CH;
    cv.style.width=CW+'px';cv.style.height=CH+'px';
  });
  if(mapBgW0)centerMap();
  drawAll();
}

function centerMap(){
  if(!mapBgW!CW!CH)return;
  const sc=Math.min(CWmapBgW,CHmapBgH,.95);
  camScale=sc;camX=(CW-mapBgWcamScale)2;camY=(CH-mapBgHcamScale)2;
}

function s2w(sx,sy){
   sx,sy are already canvas-relative (from canvasRelXY) ‚Äî just apply camera transform
  return{wx(sx-camX)camScale,wy(sy-camY)camScale};
}
window.resetView=()={if(mapBgW)centerMap();else{camScale=1;camX=0;camY=0;}drawAll();};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  INTERACTION
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupInteraction(){
  const cv=document.getElementById('interCanvas');
  cv.addEventListener('mousedown',onMD);cv.addEventListener('mousemove',onMM);cv.addEventListener('mouseup',onMU);
  cv.addEventListener('wheel',onWheel,{passivefalse});cv.addEventListener('contextmenu',e=e.preventDefault());
  cv.addEventListener('touchstart',onTStart,{passivefalse});cv.addEventListener('touchmove',onTMove,{passivefalse});cv.addEventListener('touchend',onTEnd,{passivefalse});
  window.addEventListener('keydown',onKey);
}

function canvasRelXY(clientX,clientY){
  const cv=document.getElementById('interCanvas');
  const rect=cvcv.getBoundingClientRect(){left0,top0};
  return{xclientX-rect.left,yclientY-rect.top};
}
let pinchDist=0;
function onTStart(e){e.preventDefault();if(e.touches.length===1){isDragging=false;const r=canvasRelXY(e.touches[0].clientX,e.touches[0].clientY);dragLX=r.x;dragLY=r.y;}else if(e.touches.length===2)pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
function onTMove(e){e.preventDefault();if(e.touches.length===1){const r=canvasRelXY(e.touches[0].clientX,e.touches[0].clientY);const dx=r.x-dragLX,dy=r.y-dragLY;if(Math.abs(dx)+Math.abs(dy)4)isDragging=true;if(isDragging){camX+=dx;camY+=dy;dragLX=r.x;dragLY=r.y;drawAll();}}else if(e.touches.length===2){const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);const mc=canvasRelXY((e.touches[0].clientX+e.touches[1].clientX)2,(e.touches[0].clientY+e.touches[1].clientY)2);zoom(ndpinchDist,mc.x,mc.y);pinchDist=nd;}}
function onTEnd(e){e.preventDefault();if(!isDragging&&e.changedTouches.length===1){const r=canvasRelXY(e.changedTouches[0].clientX,e.changedTouches[0].clientY);handleClick(r.x,r.y,false,false);}isDragging=false;}
function onWheel(e){e.preventDefault();const r=canvasRelXY(e.clientX,e.clientY);zoom(e.deltaY01.120.9,r.x,r.y);}
function zoom(f,mx,my){const ns=Math.max(.08,Math.min(10,camScalef));camX=mx-(mx-camX)(nscamScale);camY=my-(my-camY)(nscamScale);camScale=ns;document.getElementById('zoomInd').textContent=Math.round(camScale100)+'%';drawAll();}
function onMD(e){
  const r=canvasRelXY(e.clientX,e.clientY);
  if(e.button===1){e.preventDefault();isDragging=true;dragLX=r.x;dragLY=r.y;return;}
  if(e.button===2){isDragging=false;handleClick(r.x,r.y,true,e.shiftKey);return;}
  isDragging=false;dragLX=r.x;dragLY=r.y;
}
function onMM(e){
  const r=canvasRelXY(e.clientX,e.clientY);
  if(e.buttons===4){camX+=r.x-dragLX;camY+=r.y-dragLY;dragLX=r.x;dragLY=r.y;drawAll();return;}
  if(e.buttons===1&&!isDragging){const dx=r.x-dragLX,dy=r.y-dragLY;if(Math.abs(dx)+Math.abs(dy)>5)isDragging=true;}
  if(isDragging&&e.buttons===1){camX+=r.x-dragLX;camY+=r.y-dragLY;drawAll();}
  dragLX=r.x;dragLY=r.y;
}
function onMU(e){
  if(isDragging){isDragging=false;return;}
  const r=canvasRelXY(e.clientX,e.clientY);
  if(e.button===0)handleClick(r.x,r.y,false,e.shiftKey);
}
function onKey(e){
  if(e.code==='Escape'){placingType=null;document.getElementById('placementHint').classList.remove('vis');document.querySelectorAll('.sp-unit-btn').forEach(b=b.classList.remove('active'));}
  if(e.code==='Space'){e.preventDefault();if(gamePhase==='placement')startBattle();}
}

function handleClick(sx,sy,isRight,isShift=false){
  if(!G.units)return;
  const{wx,wy}=s2w(sx,sy);

   ‚îÄ‚îÄ‚îÄ PLACEMENT MODE ‚îÄ‚îÄ‚îÄ
  if(placingType&&!isRight){placeUnit(wx,wy);return;}
  if(placingType&&isRight){
    placingType=null;
    document.querySelectorAll('.sp-unit-btn').forEach(b=b.classList.remove('active'));
    document.getElementById('placementHint').classList.remove('vis');
    return;
  }

  if(!isRight){
     LEFT CLICK select unit
    const clicked=G.units.find(u=!u._dead&&Math.hypot(u.x-wx,u.y-wy)(UNIT_DEFS[u.type].radius10)1.5+4);
    if(clicked&&clicked.owner===myRole){
      if(isShift){
         Shift+click toggle unit inout of selection
        if(selectedUnitIds.has(clicked.id)){
          selectedUnitIds.delete(clicked.id);
          if(selectedUnitId===clicked.id)selectedUnitId=[...selectedUnitIds][0]null;
        }else{
          selectedUnitIds.add(clicked.id);
          selectedUnitId=clicked.id;
        }
      }else{
        selectedUnitId=clicked.id;
        selectedUnitIds=new Set([clicked.id]);
      }
       Show info for last selected
      const showU=G.units.find(u=u.id===selectedUnitId);
      if(showU)showSelInfo(showU);
       Update selection count indicator
      updateSelectionHUD();
    }else{
      if(inputMode==='attack'&&clicked&&clicked.owner!==myRole){
        G.units.filter(u=selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u={
          u.state='force_attack';u.forceTarget=clicked.id;u.attackTarget=clicked.id;
        });
        toast('üéØ –ê—Ç–∞–∫—É–≤–∞—Ç–∏ '+UNIT_DEFS[clicked.type].name'—Ü—ñ–ª—å');
      }else if(!isShift){
        selectedUnitId=null;selectedUnitIds=new Set();
        document.getElementById('selInfo').classList.remove('vis');
        updateSelectionHUD();
      }
    }
  }else{
     RIGHT CLICK issue order to selected units
    if(!selectedUnitIds.size&&selectedUnitId){selectedUnitIds=new Set([selectedUnitId]);}
    if(!selectedUnitIds.size)return;

    const targetEnemy=G.units.find(u=u.owner!==myRole&&!u._dead&&Math.hypot(u.x-wx,u.y-wy)(UNIT_DEFS[u.type].radius10)1.5+6);

    if(inputMode==='attack'&&targetEnemy){
      G.units.filter(u=selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u={
        u.state='force_attack';u.forceTarget=targetEnemy.id;
      });
      toast('üéØ –ê—Ç–∞–∫—É–≤–∞—Ç–∏ '+UNIT_DEFS[targetEnemy.type].name'—Ü—ñ–ª—å');
    }else if(inputMode==='patrol'){
      if(!patrolPoint1){
        patrolPoint1={xwx,ywy};
        toast('üìç –¢–æ—á–∫–∞ 1 –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞. –í–∫–∞–∂—ñ—Ç—å —Ç–æ—á–∫—É 2 –ü–ö–ú');
      }else{
        G.units.filter(u=selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u={
          u.state='patrol';u.patrolA={xpatrolPoint1.x,ypatrolPoint1.y};u.patrolB={xwx,ywy};u.patrolDir=1;u.moveTarget={xwx,ywy};
        });
        patrolPoint1=null;
        toast('üîÑ –ü–∞—Ç—Ä—É–ª—å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
      }
    }else{
       Default move order ‚Äî spread units in formation
      const myUnits=G.units.filter(u=selectedUnitIds.has(u.id)&&u.owner===myRole);
      const n=myUnits.length;
       Formation line perpendicular to direction of movement
      const angle=Math.atan2(wy-myUnits.reduce((s,u)=s+u.y,0)n, wx-myUnits.reduce((s,u)=s+u.x,0)n);
      const perp=angle+Math.PI2;
      const spacing=28;
      myUnits.forEach((u,i)={
        const offset=(i-(n-1)2)spacing;
        u.moveTarget={xwx+Math.cos(perp)offset, ywy+Math.sin(perp)offset};
        u.state='moving';
        u.forceTarget=null;
      });
    }
  }
  drawAll();
}

function updateSelectionHUD(){
  const n=selectedUnitIds.size;
  const el=document.getElementById('selInfo');
  if(n1){
    el.classList.add('vis');
    document.getElementById('siName').textContent=`‚ö° –í–∏–¥—ñ–ª–µ–Ω–æ ${n} —é–Ω—ñ—Ç—ñ–≤`;
    document.getElementById('siHPText').textContent='';
    document.getElementById('siHPBar').style.width='100%';
    document.getElementById('siAtk').textContent='‚Äî';
    document.getElementById('siDef').textContent='‚Äî';
    document.getElementById('siSpd').textContent='‚Äî';
    const modeEl=document.getElementById('siMode');if(modeEl)modeEl.textContent='–ì–†–£–ü–ê';
  }
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  UNIT PLACEMENT
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildUnitList(){
  document.getElementById('unitTypesList').innerHTML=Object.entries(UNIT_DEFS).map(([type,d])=`
    div class=sp-unit-btn onclick=selectUnitType('${type}') id=ubtn_${type}
      span class=sp-unit-icon${d.emoji}span
      div class=sp-unit-infodiv class=sp-unit-name${d.name}divdiv class=sp-unit-statHP${d.hp} ¬∑ –ê–¢–ö${d.atk}divdiv
      span class=sp-unit-cost${d.cost}span
    div`).join('');
}

window.selectUnitType=type={
   Allow buying during battle too (fix #3)
  const def=UNIT_DEFS[type];
  if(G.funds[myRole]def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤! ('+G.funds[myRole]+''+def.cost+')');return;}
  if(gamePhase==='battle'){
     In battle place near your base
    toast('üìç –ö–ª—ñ–∫–Ω—ñ—Ç—å –¥–µ —Ä–æ–∑–º—ñ—Å—Ç–∏—Ç–∏ '+def.name+' ('+def.cost+'‚Ç¥)');
  }
  placingType=type;
  document.querySelectorAll('.sp-unit-btn').forEach(b=b.classList.remove('active'));
  document.getElementById('ubtn_'+type).classList.add('active');
  document.getElementById('placementHint').classList.add('vis');
  document.getElementById('placementHint').textContent='–†–û–ó–ú–Ü–°–¢–Ü–¢–¨ '+def.name.toUpperCase()+' ('+def.cost+' ‚Ç¥)  –ü–ö–ú = —Å–∫–∞—Å—É–≤–∞—Ç–∏';
};

function isOnWater(wx,wy){
   Check against water areas stored in G
  if(!G._waterAreas!G._waterAreas.length)return false;
  return G._waterAreas.some(w=Math.hypot(wx-w.x,wy-w.y)w.r);
}

function isOnBridge(wx,wy){
  if(!G._bridges!G._bridges.length)return false;
  return G._bridges.some(b=Math.hypot(wx-b.x,wy-b.y)b.r);
}

function placeUnit(wx,wy){
  if(!placingType)return;
  const def=UNIT_DEFS[placingType];if(!def){placingType=null;return;}
  const mapW=mapBgW2000,halfW=mapW2;
  const validZone=myRole==='blue'wxhalfWwx=halfW;
  if(!validZone){toast('‚ö†Ô∏è –õ–∏—à–µ –Ω–∞ —Å–≤–æ—ó–π –ø–æ–ª–æ–≤–∏–Ω—ñ!');return;}
  if(G.funds[myRole]def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤!');return;}
  if(isOnWater(wx,wy)&&!isOnBridge(wx,wy)&&placingType!=='heli'){
    toast('üåä –õ–∏—à–µ –≥–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä –∞–±–æ –Ω–∞ –º–æ—Å—Ç—É!');return;
  }
  G.units.push({
    idG.nextId++,typeplacingType,ownermyRole,
    xwx,ywy,txwx,tywy,vx0,vy0,
    hpdef.hp,maxHpdef.hp,atkdef.atk,defdef.def,
    speeddef.speed,rangedef.range,radiusdef.radius,
    stategamePhase==='battle''advance''idle',
    attackTargetnull,forceTargetnull,moveTargetnull,
    lastAttack0,lastAttackAnim0,
  });
  G.funds[myRole]-=def.cost;
  addLog('üìç '+def.name+' —Ä–æ–∑–º—ñ—â–µ–Ω–æ'+(gamePhase==='battle'' [–ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è!]'''),'info');
  placingType=null;
  document.querySelectorAll('.sp-unit-btn').forEach(b=b.classList.remove('active'));
  document.getElementById('placementHint').classList.remove('vis');
  syncGameState();updateHUD();drawAll();
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  BATTLE
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startBattle=()=>{
  if(gamePhase==='battle')return;
  if(G.units.filter(u=>u.owner===myRole).length===0){toast('‚ö†Ô∏è –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å —Ö–æ—á–∞ –± 1 —é–Ω—ñ—Ç!');return;}
  gamePhase='battle';
  document.getElementById('hudPhase').textContent='–ë–Ü–ô';
  document.getElementById('placementHint').classList.remove('vis');
  addLog('‚öîÔ∏è –ë–Ü–ô –†–û–ó–ü–û–ß–ê–¢–û!','warn');
  if(incomeInterval)clearInterval(incomeInterval);
  incomeInterval=setInterval(tickIncome,15000);
  if(isAI)spawnAIUnits();
  syncGameState();
};

function spawnAIUnits(){
  const oppRole=myRole==='blue''red''blue';
  const mapW=mapBgW2000,mapH=mapBgH1200;
  const spawnX=oppRole==='red'mapW.8mapW.2;
   Different composition based on AI mode
  let types;
  if(aiMode==='defense')types=['infantry','infantry','infantry','apc','tank'];
  else if(aiMode==='attack')types=['tank','tank','apc','apc','infantry','artillery'];
  else if(aiMode==='blitz')types=['heli','heli','apc','apc','infantry'];
  else types=['infantry','apc','tank','heli','artillery','infantry'];
  types.forEach((t,i)={
    const def=UNIT_DEFS[t];
    G.units.push({idG.nextId++,typet,owneroppRole,
      xspawnX+rnd(-80,80),ymapH.15+i((mapH.7)types.length),
      tx0,ty0,vx0,vy0,
      hpdef.hp,maxHpdef.hp,atkdef.atk,defdef.def,
      speeddef.speed,rangedef.range,radiusdef.radius,
      stateaiMode==='defense''defend''advance',
      defendXspawnX,defendYmapH.5,
      attackTargetnull,lastAttack0,lastAttackAnim0});
  });
}

function spawnAIWave(){
  const oppRole=myRole==='blue''red''blue';
  const mapW=mapBgW2000,mapH=mapBgH1200;
  const spawnX=oppRole==='red'mapW.82mapW.18;
   Scale with wave
  const types=G.wave3['infantry','apc']G.wave5['apc','tank','infantry']['tank','tank','heli'];
  types.forEach((t,i)={
    const def=UNIT_DEFS[t];
    G.units.push({idG.nextId++,typet,owneroppRole,
      xspawnX+rnd(-40,40),ymapH.2+i120+rnd(-30,30),
      tx0,ty0,vx0,vy0,
      hpdef.hpMath.min(1+G.wave.1,2),maxHpdef.hpMath.min(1+G.wave.1,2),
      atkdef.atk,defdef.def,speeddef.speed,rangedef.range,radiusdef.radius,
      stateaiMode==='defense''defend''advance',
      defendXspawnX,defendYmapH.5,
      attackTargetnull,lastAttack0,lastAttackAnim0});
  });
}

function rnd(a,b){return a+Math.floor(Math.random()(b-a+1));}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  GAME LOOP
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastFrame=0;
function startGameLoop(){
  if(animFrame)cancelAnimationFrame(animFrame);
  lastFrame=performance.now();
  (function loop(ts){
    const dt=Math.min((ts-lastFrame)1000,.05);lastFrame=ts;
    if(gamePhase==='battle'){
      updateUnits(dt);
      updateAI(dt);
      updateProjectiles(dt);
      updateCityCapture(dt);
      checkWinCondition();
    }
    drawAll();
    animFrame=requestAnimationFrame(loop);
  })(performance.now());
}

function canMoveTo(x,y,unitType){
  if(unitType==='heli')return true;
  const mw=mapBgW2000,mh=mapBgH1200;
  const nx=xmw,ny=ymh;
   Old circle-based water detection
  if(isOnWater(x,y)&&!isOnBridge(x,y))return false;
   New terrain system water
  if(isTerrainWater(nx,ny)&&!isTerrainBridge(nx,ny))return false;
  return true;
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  UNIT LOGIC ‚Äî full state machine
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUnits(dt){
  const now=performance.now();
  for(const u of G.units.filter(u=u.owner===myRole&&!u._dead)){
    const opp=G.units.filter(e=e.owner!==myRole&&!e._dead);

     ‚îÄ‚îÄ Force attack chase specific target ‚îÄ‚îÄ
    if(u.state==='force_attack'&&u.forceTarget){
      const tgt=G.units.find(x=x.id===u.forceTarget&&!x._dead);
      if(!tgt){u.state='advance';u.forceTarget=null;}
      else{
        const d=Math.hypot(tgt.x-u.x,tgt.y-u.y);
        if(d=u.range){
          if(now-u.lastAttack1000){
            u.lastAttack=now;u.lastAttackAnim=now;
            doAttack(u,tgt);
          }
        }else{
          moveToward(u,tgt.x,tgt.y,dt);
        }
      }
      continue;
    }

     ‚îÄ‚îÄ HoldStop don't move, but shoot if in range ‚îÄ‚îÄ
    if(u.state==='hold'){
      if(opp.length){
        const near=nearestEnemy(u,opp);
        if(near&&near.d=u.range&&now-u.lastAttack1000){
          u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=near.unit.id;
          doAttack(u,near.unit);
        }
      }
      continue;
    }

     ‚îÄ‚îÄ Move to target ‚îÄ‚îÄ
    if(u.state==='moving'&&u.moveTarget){
      const dx=u.moveTarget.x-u.x,dy=u.moveTarget.y-u.y,d=Math.sqrt(dxdx+dydy);
      if(d6){u.state='advance';u.moveTarget=null;}
      else{
         Shoot at close enemies while moving
        if(opp.length){const ne=nearestEnemy(u,opp);if(ne&&ne.d=u.range&&now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
        moveToward(u,u.moveTarget.x,u.moveTarget.y,dt);
      }
      continue;
    }

     ‚îÄ‚îÄ Patrol ‚îÄ‚îÄ
    if(u.state==='patrol'&&u.patrolA&&u.patrolB){
       Attack enemies in range first
      if(opp.length){const ne=nearestEnemy(u,opp);if(ne&&ne.d=u.range&&now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
      const dest=u.patrolDir0u.patrolBu.patrolA;
      const dx=dest.x-u.x,dy=dest.y-u.y,d=Math.sqrt(dxdx+dydy);
      if(d8)u.patrolDir=-1;
      else moveToward(u,dest.x,dest.y,dt);
      continue;
    }

     ‚îÄ‚îÄ Defend stay near defend point, engage threats ‚îÄ‚îÄ
    if(u.state==='defend'){
      const defX=u.defendXu.x,defY=u.defendYu.y;
      if(opp.length){
        const ne=nearestEnemy(u,opp);
        if(ne&&ne.d=u.range){
          if(now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}
        }else if(ne&&ne.d=u.range2.5){
           Chase threat but return if too far from defend point
          const distFromBase=Math.hypot(ne.unit.x-defX,ne.unit.y-defY);
          if(distFromBaseu.range3)moveToward(u,ne.unit.x,ne.unit.y,dt.6);
        }
      }
       Drift back to defend point
      const dBack=Math.hypot(u.x-defX,u.y-defY);
      if(dBack40)moveToward(u,defX,defY,dt.3);
      continue;
    }

     ‚îÄ‚îÄ Advance (default) FRONT LINE SYSTEM ‚îÄ‚îÄ
     Each unit advances as part of a coordinated front.
     The front is a horizontal line; units spread along Y-axis,
     advance X until they hit enemy range, then hold and fire.
    if(!opp.length){continue;}

     1. Find all friendly advance-state units
    const frontUnits=G.units.filter(v=v.owner===myRole&&!v._dead&&(v.state==='advance'v.state==='front'));
    const myIdx=frontUnits.findIndex(v=v.id===u.id);
    const nFront=frontUnits.length;

     2. Find frontmost X position on enemy side (the most advanced friendly unit)
    const frontX=myRole==='blue'
       Math.max(...frontUnits.map(v=v.x))
       Math.min(...frontUnits.map(v=v.x));

     3. Assign Y-slot sort front units by Y, each gets an even slice
    const sortedByY=[...frontUnits].sort((a,b)=a.y-b.y);
    const mySlot=sortedByY.findIndex(v=v.id===u.id);
    const mapH=mapBgH1200;
    const margin=mapH.08;
    const slotY=nFront=1mapH2(margin+mySlot(mapH-margin2)(Math.max(1,nFront-1)));

     4. Target front X either advance toward enemy front, or hold at range
    const ne=nearestEnemy(u,opp);
    if(!ne)continue;

     The advance X is the front of the enemy
    const enemyFrontX=myRole==='blue'
       Math.min(...opp.map(v=v.x))
       Math.max(...opp.map(v=v.x));

     Stop X offset ‚Äî units stop when they can shoot
    const stopDist=u.range0.85;
    const targetX=myRole==='blue'
       enemyFrontX - stopDist
       enemyFrontX + stopDist;

     5. Move toward (targetX, slotY)
    const distToTarget=Math.hypot(u.x-targetX,u.y-slotY);
    const atTargetX=myRole==='blue'u.x=targetXu.x=targetX;

    if(atTargetX&&Math.abs(u.y-slotY)20){
       In position ‚Äî hold and fire
      u.state='front';
      u.attackTarget=ne.unit.id;
      if(ne.d=u.range&&now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;doAttack(u,ne.unit);}
    }else{
      u.state='advance';
       Move toward slot prioritize Y alignment first within 60px X tolerance,
       then advance X together
      const xBehindFront=myRole==='blue'u.xfrontX-50u.xfrontX+50;
      let mx=targetX,my=slotY;
      if(xBehindFront){
         Advance X but also correct Y
        mx=targetX;my=slotY;
      }
      moveToward(u,mx,my,dt);
       Also fire if enemy in range while moving
      if(ne.d=u.range&&now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}
    }
    u.state='advance';  keep state name consistent for front line drawing
  }
  G.units=G.units.filter(u=!u._dead);
}

function nearestEnemy(u,opp){
  let nearest=null,nd=Infinity;
  for(const e of opp){const d=Math.hypot(e.x-u.x,e.y-u.y);if(dnd){nd=d;nearest=e;}}
  return nearest{unitnearest,dnd}null;
}

function moveToward(u,tx,ty,dt){
  const dx=tx-u.x,dy=ty-u.y,dist=Math.max(1,Math.sqrt(dxdx+dydy));
  const mw=mapBgW2000,mh=mapBgH1200;
  const nx=u.xmw,ny=u.ymh;
  const speedMult=getTerrainSpeedMultiplier(nx,ny);
  const step=u.speeddtspeedMult;
  const nx2=u.x+(dxdist)step;
  const ny2=u.y+(dydist)step;
  if(canMoveTo(nx2,ny2,u.type)){u.x=nx2;u.y=ny2;}
  else if(canMoveTo(nx2,u.y,u.type)){u.x=nx2;}
  else if(canMoveTo(u.x,ny2,u.type)){u.y=ny2;}
}

function doAttack(attacker,target){
  const def=UNIT_DEFS[attacker.type];
  if(def.isMissile){
     Launch missile projectile
    projectiles.push({
      idDate.now()+'_'+Math.random(),
      oxattacker.x,oyattacker.y,
      txtarget.x+rnd(-5,5),tytarget.y+rnd(-5,5),
      targetIdtarget.id,
      ownerattacker.owner,
      progress0,
      damageMath.max(1,attacker.atk+rnd(-5,5)),
      speed3.5, progress per frame (0-1 normalized)
      trail[],
    });
    addLog('üöÄ ¬´–°–º–µ—Ä—á¬ª –ø—É—Å–∫!',attacker.owner===myRole'info''warn');
    return;
  }
  const dmg=Math.max(1,attacker.atk-Math.floor(target.def3)+rnd(-3,3));
  target.hp-=dmg;
  if(target.hp=0)killUnit(target);
}

function updateProjectiles(dt){
  const speed=dt280;  pixels per second
  for(const p of projectiles){
     Move progress
    const totalDist=Math.hypot(p.tx-p.ox,p.ty-p.oy);
    p.progress+=speedMath.max(1,totalDist);
     Save trail
    const cx=p.ox+(p.tx-p.ox)p.progress;
    const cy=p.oy+(p.ty-p.oy)p.progress;
    p.trail.push({xcx,ycy});
    if(p.trail.length12)p.trail.shift();
     Hit
    if(p.progress=1){
      p._done=true;
      const tgt=G.units.find(u=u.id===p.targetId&&!u._dead);
      if(tgt){
        tgt.hp-=p.damage;tgt.lastAttackAnim=performance.now();
        if(tgt.hp=0)killUnit(tgt);
      }
       Splash on nearby units
      G.units.filter(u=u.id!==p.targetId&&!u._dead&&Math.hypot(u.x-p.tx,u.y-p.ty)30&&u.owner!==p.owner).forEach(u={
        const splash=Math.round(p.damage.3);u.hp-=splash;if(u.hp=0)killUnit(u);
      });
    }
  }
  projectiles=projectiles.filter(p=!p._done);
}

function killUnit(u){
  u._dead=true;
  G.casualties[u.owner]=(G.casualties[u.owner]0)+1;
  addLog('üíÄ '+UNIT_DEFS[u.type].name+' –∑–Ω–∏—â–µ–Ω–æ!',u.owner===myRole'bad''good');
  updateHUD();
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  AI LOGIC ‚Äî mode-aware
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAI(dt){
  if(!isAI)return;
  const oppRole=myRole==='blue''red''blue';
  const now=performance.now();
  const mapW=mapBgW2000;
  const mapH=mapBgH1200;

  const pl=G.units.filter(e=e.owner===myRole&&!e._dead);
  const aiUnits=G.units.filter(u=u.owner===oppRole&&!u._dead);
  if(!aiUnits.length)return;

  const enemyCities=G.cities.filter(c=c.owner===myRole)[];
  const neutralCities=G.cities.filter(c=c.owner==='neutral')[];

   Sort AI units by Y for slot assignment
  const sortedAIByY=[...aiUnits].sort((a,b)=a.y-b.y);
  const nAI=aiUnits.length;

   Player frontmost X (how far ahead the player is)
  const plFrontX=pl.length(oppRole==='red'
     Math.max(...pl.map(v=v.x))
     Math.min(...pl.map(v=v.x)))mapW2;

  for(const u of aiUnits){
    const ne=nearestFrom(u,pl);

    if(aiMode==='defense'){
      const base=G.bases.[oppRole];
      const baseX=basebase.x(oppRole==='red'mapW.85mapW.15);
      const baseY=basebase.ymapH.5;
      if(ne&&ne.d280){
        if(ne.d=u.range){if(now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
        else{aiMovePref(u,ne.unit.x,ne.unit.y,dt.8);}
      }else if(Math.hypot(u.x-baseX,u.y-baseY)120){
        aiMovePref(u,baseX+rnd(-60,60),baseY+rnd(-60,60),dt.4);
      }else if(ne&&ne.d=u.range&&now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}
      continue;
    }

     ‚îÄ‚îÄ FRONT LINE formation for attackblitzconquest ‚îÄ‚îÄ
    const slotIdx=sortedAIByY.findIndex(v=v.id===u.id);
    const margin=mapH.08;
    const slotY=nAI=1mapH2(margin+slotIdx(mapH-margin2)(Math.max(1,nAI-1)));

     Stop X unit halts at shoot range from player front
    const stopDist=u.range0.85;
    const targetX=oppRole==='red'
       plFrontX - stopDist
       plFrontX + stopDist;

     Conquestblitz occasionally break off to take objectives
    let objectiveTarget=null;
    if((aiMode==='conquest'aiMode==='blitz')&&slotIdx%3===0){
      const allT=[...neutralCities,...enemyCities];
      if(allT.length){
        let nc=null,nd2=Infinity;
        for(const c of allT){const d=Math.hypot(c.x-u.x,c.y-u.y);if(dnd2){nd2=d;nc=c;}}
        if(nc&&(!nend2ne.d0.7))objectiveTarget=nc;
      }
    }

    const atTargetX=oppRole==='red'u.x=targetXu.x=targetX;
    const atSlotY=Math.abs(u.y-slotY)25;

     Always fire if in range
    if(ne&&ne.d=u.range){
      if(now-u.lastAttack1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}
    }

    if(objectiveTarget){
      aiMovePref(u,objectiveTarget.x,objectiveTarget.y,dt);
      u.state='advance';
    }else if(atTargetX&&atSlotY){
      u.state='front';  hold position
    }else{
      u.state='advance';
      aiMovePref(u,targetX,slotY,dt);
    }
  }
}

function nearestFrom(u,arr){
  let nearest=null,nd=Infinity;
  for(const e of arr){const d=Math.hypot(e.x-u.x,e.y-u.y);if(dnd){nd=d;nearest=e;}}
  return nearest{unitnearest,dnd}null;
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  WIN CONDITION ‚Äî cities + base
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkWinCondition(){
  if(gameOver)return;
  const bl=G.units.filter(u=u.owner==='blue'&&!u._dead);
  const rd=G.units.filter(u=u.owner==='red'&&!u._dead);
  if(!bl.length&&rd.length)showResult('red','–í—Å—ñ —Å–∏–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');
  else if(!rd.length&&bl.length)showResult('blue','–í—Å—ñ —á–µ—Ä–≤–æ–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');
  else if(!bl.length&&!rd.length)return;  draw, keep going

   Check base capture (if bases defined, unit standing on enemy base for 3+ seconds)
  if(G.bases){
    ['blue','red'].forEach(team={
      const enemyBase=G.bases[team==='blue''red''blue'];
      if(!enemyBase)return;
      const inBase=G.units.filter(u=u.owner===team&&!u._dead&&Math.hypot(u.x-enemyBase.x,u.y-enemyBase.y)40);
      if(inBase.length=2){
        if(!G._baseTimer){G._baseTimer={team,startDate.now()};}
        else if(G._baseTimer.team===team&&(Date.now()-G._baseTimer.start)5000){
          showResult(team,'–ë–∞–∑–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤–∑—è—Ç–∞!');
        }
      }else if(G._baseTimer.team===team){G._baseTimer=null;}
    });
  }

   Conquest win when all cities captured
  if(isAI&&aiMode==='conquest'&&G.cities.length0){
    const oppRole=myRole==='blue''red''blue';
    if(G.cities.every(c=c.owner===myRole))showResult(myRole,'–í—Å—ñ –º—ñ—Å—Ç–∞ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º!');
    else if(G.cities.every(c=c.owner===oppRole))showResult(oppRole,'–í–æ—Ä–æ–≥ –∑–∞—Ö–æ–ø–∏–≤ –≤—Å—ñ –º—ñ—Å—Ç–∞!');
  }
}

function showResult(winner,reason=''){
  if(gameOver)return;gameOver=true;
  if(timerInterval)clearInterval(timerInterval);
  if(incomeInterval)clearInterval(incomeInterval);
  const isWinner=winner===myRole;
  document.getElementById('resultEmoji').textContent=isWinner'üèÜ''üíÄ';
  document.getElementById('resultTitle').textContent=isWinner'–ü–ï–†–ï–ú–û–ì–ê!''–ü–û–†–ê–ó–ö–ê';
  document.getElementById('resultTitle').style.color=isWinner'var(--green)''var(--red)';
  const blueCities=G.cities.filter(c=c.owner==='blue').length0;
  const redCities=G.cities.filter(c=c.owner==='red').length0;
  document.getElementById('resultSub').textContent=
    (reasonreason+'n''')+
    `üîµ –í—Ç—Ä–∞—Ç–∏ ${G.casualties.blue0} ¬∑ –ú—ñ—Å—Ç ${blueCities}n`+
    `üî¥ –í—Ç—Ä–∞—Ç–∏ ${G.casualties.red0} ¬∑ –ú—ñ—Å—Ç ${redCities}n`+
    `‚è± ${document.getElementById('hudTimer').textContent}`;
  document.getElementById('resultOverlay').classList.add('vis');
}

window.backToMenu=()={
  document.getElementById('resultOverlay').classList.remove('vis');
  if(animFrame)cancelAnimationFrame(animFrame);
  if(timerInterval)clearInterval(timerInterval);
  if(incomeInterval)clearInterval(incomeInterval);
  if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}
  if(gameUnsub){gameUnsub();gameUnsub=null;}
  if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}
  hideDcBanner();
  G={};gameOver=false;placingType=null;isAI=false;lobbyId=null;
  showScreen('screen-menu');
};
window.confirmQuit=()={if(confirm('–í–∏–π—Ç–∏ –∑ –≥—Ä–∏'))backToMenu();};

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  DRAW ENGINE
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawAll(){drawMap();drawFrontLine();drawUnits();drawProjectilesLayer();drawUI();}

function drawMap(){
  if(!mapCtx!CW!CH)return;
  mapCtx.clearRect(0,0,CW,CH);
   FIX background color matches map area ‚Äî no black bars
  mapCtx.fillStyle='#06090d';mapCtx.fillRect(0,0,CW,CH);
  mapCtx.save();mapCtx.translate(camX,camY);mapCtx.scale(camScale,camScale);
  const w=mapBgW2000,h=mapBgH1200;

  if(mapBg&&mapBgW0){
     Draw map background
    mapCtx.drawImage(mapBg,0,0,w,h);
     ‚îÄ‚îÄ WATER OVERLAY detect and render blue water areas from stored data
    if(G._waterAreas&&G._waterAreas.length){
       Water already defined via editor or detection
    }
     Draw water from detected areas (painted blue in editor)
     If map has no stored water, try to auto-detect large blue regions
     (done lazily via canvas pixel analysis ‚Äî only once)
    if(!G._waterDetected&&mapBg){
      detectWaterAreas();
      G._waterDetected=true;
    }
     Draw water shimmer overlay
    if(G._waterAreas&&G._waterAreas.length){
      const t=Date.now()1000;
      G._waterAreas.forEach(w2={
        mapCtx.beginPath();mapCtx.arc(w2.x,w2.y,w2.r,0,Math.PI2);
        mapCtx.fillStyle=`rgba(30,64,175,${0.12+Math.sin(t1.5+w2.x.01).04})`;
        mapCtx.fill();
      });
    }
     Draw bridges (tan color strips)
    if(G._bridges&&G._bridges.length){
      G._bridges.forEach(b={
        mapCtx.fillStyle='rgba(146,64,14,.6)';
        mapCtx.beginPath();mapCtx.arc(b.x,b.y,b.r,0,Math.PI2);mapCtx.fill();
        mapCtx.strokeStyle='rgba(251,191,36,.5)';mapCtx.lineWidth=2;mapCtx.stroke();
        mapCtx.font='12px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
        mapCtx.fillText('üåâ',b.x,b.y);
      });
    }
     Draw terrain overlay (roads  forests from editor)
    drawTerrainOverlay(mapCtx);
  }else{
     Default beautiful terrain map
    mapCtx.fillStyle='#141e0e';mapCtx.fillRect(0,0,w,h);
     Forest patches
    for(let i=0;i20;i++){
      mapCtx.fillStyle=`rgba(${20+Math.sin(i)8},${40+Math.cos(i)15},${12},.7)`;
      mapCtx.beginPath();mapCtx.ellipse(w(.05+.9(i%10)10),h(.1+.8Math.floor(i10)2),w.07,h.05,i.4,0,Math.PI2);mapCtx.fill();
    }
     Water body (river in center)
    const riverGrad=mapCtx.createLinearGradient(w.45,0,w.55,0);
    riverGrad.addColorStop(0,'rgba(30,64,175,.6)');riverGrad.addColorStop(.5,'rgba(37,99,235,.7)');riverGrad.addColorStop(1,'rgba(30,64,175,.6)');
    mapCtx.fillStyle=riverGrad;
    mapCtx.beginPath();
    mapCtx.moveTo(w.46,0);mapCtx.bezierCurveTo(w.44,h.25,w.52,h.5,w.48,h.75);mapCtx.lineTo(w.48,h);
    mapCtx.lineTo(w.54,h);mapCtx.bezierCurveTo(w.56,h.75,w.48,h.5,w.52,h.25);mapCtx.lineTo(w.54,0);
    mapCtx.fill();
     Bridge
    mapCtx.fillStyle='rgba(146,64,14,.8)';mapCtx.fillRect(w.45,h.48,w.1,h.04);
    mapCtx.strokeStyle='rgba(251,191,36,.7)';mapCtx.lineWidth=3;mapCtx.strokeRect(w.45,h.48,w.1,h.04);
     Default water areas stored in G
    G._waterAreas=[{xw.5,yh.3,rw.06},{xw.5,yh.5,rw.05},{xw.5,yh.7,rw.06}];
    G._bridges=[{xw.5,yh.5,r15}];
     Grid
    mapCtx.strokeStyle='rgba(34,197,94,.03)';mapCtx.lineWidth=1;
    for(let x=0;xw;x+=80){mapCtx.beginPath();mapCtx.moveTo(x,0);mapCtx.lineTo(x,h);mapCtx.stroke();}
    for(let y=0;yh;y+=80){mapCtx.beginPath();mapCtx.moveTo(0,y);mapCtx.lineTo(w,y);mapCtx.stroke();}
  }

   Placement highlight
  if(gamePhase==='placement'&&placingType){
    const zx=myRole==='blue'0w2;
    mapCtx.fillStyle='rgba(34,197,94,.06)';mapCtx.fillRect(zx,0,w2,h);
    mapCtx.strokeStyle='rgba(34,197,94,.35)';mapCtx.lineWidth=3;mapCtx.setLineDash([10,8]);
    mapCtx.strokeRect(zx+2,2,w2-4,h-4);mapCtx.setLineDash([]);
  }

   Draw bases
  if(G.bases){
    ['blue','red'].forEach(team={
      const base=G.bases[team];if(!base)return;
      const color=team==='blue''rgba(59,130,246,.9)''rgba(239,68,68,.9)';
       Pulsing ring
      const pulse=.8+Math.sin(Date.now().003).2;
      mapCtx.beginPath();mapCtx.arc(base.x,base.y,24pulse,0,Math.PI2);
      mapCtx.fillStyle=team==='blue''rgba(59,130,246,.1)''rgba(239,68,68,.1)';mapCtx.fill();
      mapCtx.strokeStyle=color;mapCtx.lineWidth=2.5;mapCtx.stroke();
      mapCtx.font='24px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
      mapCtx.fillText(team==='blue''üè†''üèöÔ∏è',base.x,base.y);
       Label
      mapCtx.font='bold 10px Oswald';mapCtx.fillStyle=team==='blue''#60a5fa''#f87171';
      mapCtx.fillText('–ë–ê–ó–ê',base.x,base.y+22);
    });
  }

   Draw cities ‚Äî FIX #5 cities are the main objective
  if(G.cities){
    const t=Date.now();
    G.cities.forEach(city={
      const clr=city.owner==='blue''#3b82f6'city.owner==='red''#ef4444''#94a3b8';
      const glowClr=city.owner==='blue''rgba(59,130,246,.3)'city.owner==='red''rgba(239,68,68,.3)''rgba(148,163,184,.1)';
       Glow
      mapCtx.beginPath();mapCtx.arc(city.x,city.y,28,0,Math.PI2);
      mapCtx.fillStyle=glowClr;mapCtx.fill();
       City icon
      mapCtx.font='22px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';
      mapCtx.fillText('üèôÔ∏è',city.x,city.y);
       Ownership ring
      mapCtx.beginPath();mapCtx.arc(city.x,city.y,18,0,Math.PI2);
      mapCtx.strokeStyle=clr;mapCtx.lineWidth=2.5;mapCtx.stroke();
       Name
      mapCtx.font='bold 9px Share Tech Mono';mapCtx.textAlign='center';mapCtx.textBaseline='top';
      mapCtx.fillStyle='rgba(255,255,255,.8)';
      mapCtx.fillText(city.name,city.x,city.y+20);
       Capture progress bar
      const progress=city.captureProgress;
      if(progress){
        const barW=36,barH=4;
        const bx=city.x-barW2,by=city.y-28;
        mapCtx.fillStyle='rgba(0,0,0,.5)';mapCtx.fillRect(bx,by,barW,barH);
        if(progress.blue0){mapCtx.fillStyle='#3b82f6';mapCtx.fillRect(bx,by,barW(progress.blue100),barH);}
        if(progress.red0){mapCtx.fillStyle='#ef4444';mapCtx.fillRect(bx+barW(1-progress.red100),by,barW(progress.red100),barH);}
      }
       Income badge
      if(city.owner!=='neutral'){
        mapCtx.fillStyle=city.owner==='blue''rgba(59,130,246,.8)''rgba(239,68,68,.8)';
        const badge='+'+city.income+'‚Ç¥';
        mapCtx.font='bold 8px Oswald';mapCtx.textAlign='center';mapCtx.textBaseline='bottom';
        mapCtx.fillText(badge,city.x,city.y-20);
      }
    });
  }

  mapCtx.restore();
}

 Auto-detect water from map image (looks for blue-dominant pixels)
function detectWaterAreas(){
  if(!mapBg!mapBgW)return;
   Create offscreen canvas to sample pixels
  const oc=document.createElement('canvas');oc.width=100;oc.height=Math.round(100mapBgHmapBgW);
  const oc2=oc.getContext('2d');oc2.drawImage(mapBg,0,0,oc.width,oc.height);
  const data=oc2.getImageData(0,0,oc.width,oc.height).data;
  const waterRegions=[];
  const step=5;
  for(let y=0;yoc.height;y+=step){
    for(let x=0;xoc.width;x+=step){
      const i=(yoc.width+x)4;
      const r=data[i],g=data[i+1],b=data[i+2];
       Water blue dominant, not too dark
      if(b120&&br1.4&&bg1.2&&r120){
        const wx=(xoc.width)mapBgW;
        const wy=(yoc.height)mapBgH;
        waterRegions.push({xwx,ywy,rmapBgWoc.widthstep1.5});
      }
    }
  }
  if(waterRegions.length0)G._waterAreas=waterRegions;
}

function drawFrontLine(){
  if(!frontCtx!CW!CH)return;
  frontCtx.clearRect(0,0,CW,CH);
  if(gamePhase!=='battle')return;
  const bl=G.units.filter(u=u.owner==='blue'&&!u._dead);
  const rd=G.units.filter(u=u.owner==='red'&&!u._dead);
  if(!bl.length!rd.length)return;

  frontCtx.save();frontCtx.translate(camX,camY);frontCtx.scale(camScale,camScale);

  const mapH=mapBgH1200;
   Scan horizontal strips. For each strip find rightmost-Blue & leftmost-Red ‚Üí midpoint X.
  const stripH=60;
  const rawPts=[];

  for(let sy=0;symapH;sy+=stripH){
    const ey=sy+stripH;
    const bInStrip=bl.filter(u=u.y=sy&&u.yey);
    const rInStrip=rd.filter(u=u.y=sy&&u.yey);
    if(!bInStrip.length!rInStrip.length)continue;
    const rightBlueX=Math.max(...bInStrip.map(u=u.x));
    const leftRedX=Math.min(...rInStrip.map(u=u.x));
    rawPts.push({x(rightBlueX+leftRedX)2,ysy+stripH2});
  }

   If too few points from strips, fallback global average midpoint per Y-bucket
  if(rawPts.length2){
    const bucketSize=100;
    const buckets={};
    [...bl,...rd].forEach(u={
      const b=Math.floor(u.ybucketSize);
      if(!buckets[b])buckets[b]={blue[],red[]};
      buckets[b][u.owner].push(u);
    });
    for(const [b,d] of Object.entries(buckets)){
      if(!d.blue.length!d.red.length)continue;
      const bx=d.blue.reduce((s,u)=s+u.x,0)d.blue.length;
      const rx=d.red.reduce((s,u)=s+u.x,0)d.red.length;
      rawPts.push({x(bx+rx)2,y(+b+.5)bucketSize});
    }
  }

  if(rawPts.length2){frontCtx.restore();return;}

  rawPts.sort((a,b)=a.y-b.y);
   Smooth X with running average to remove jitter
  const pts=rawPts.map((p,i,arr)={
    const slice=arr.slice(Math.max(0,i-2),Math.min(arr.length,i+3));
    return{xslice.reduce((s,v)=s+v.x,0)slice.length,yp.y};
  });

  const lw=3camScale;
  frontCtx.lineCap='round';frontCtx.lineJoin='round';
   Wide glow
  frontCtx.shadowColor='rgba(255,200,50,.8)';frontCtx.shadowBlur=20camScale;
  frontCtx.strokeStyle='rgba(255,200,50,.2)';frontCtx.lineWidth=lw5;
  drawSmoothLine(frontCtx,pts);
   Mid
  frontCtx.shadowBlur=8camScale;
  frontCtx.strokeStyle='rgba(255,220,60,.6)';frontCtx.lineWidth=lw2;
  drawSmoothLine(frontCtx,pts);
   Core
  frontCtx.shadowBlur=4camScale;
  frontCtx.strokeStyle='rgba(255,240,100,1)';frontCtx.lineWidth=lw;
  drawSmoothLine(frontCtx,pts);
  frontCtx.shadowBlur=0;
  frontCtx.restore();
}

function drawSmoothLine(ctx,pts){
  ctx.beginPath();ctx.moveTo(pts[0].x,pts[0].y);
  if(pts.length===2){ctx.lineTo(pts[1].x,pts[1].y);}
  else{for(let i=0;ipts.length-1;i++){const mx=(pts[i].x+pts[i+1].x)2,my=(pts[i].y+pts[i+1].y)2;if(i===0)ctx.lineTo(mx,my);else ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);}ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);}
  ctx.stroke();
}

function drawUnits(){
  if(!unitsCtx!CW!CH)return;
  unitsCtx.clearRect(0,0,CW,CH);
  if(!G.units.length)return;
  const now=performance.now();
  unitsCtx.save();unitsCtx.translate(camX,camY);unitsCtx.scale(camScale,camScale);
  for(const u of G.units){
    if(u._dead)continue;
    const def=UNIT_DEFS[u.type]UNIT_DEFS.infantry;
    const r=def.radius,isBlue=u.owner==='blue',isSel=selectedUnitIds.has(u.id)u.id===selectedUnitId;
    const hp=u.hpu.maxHp,isAtk=now-u.lastAttackAnim250;
    if(isAtk){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r2.5,0,Math.PI2);unitsCtx.fillStyle=isBlue'rgba(59,130,246,.15)''rgba(239,68,68,.15)';unitsCtx.fill();}
    if(isSel){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r+6,0,Math.PI2);unitsCtx.strokeStyle='rgba(255,255,255,.9)';unitsCtx.lineWidth=2camScale;unitsCtx.stroke();}
    unitsCtx.beginPath();unitsCtx.arc(u.x+1.5,u.y+2.5,r,0,Math.PI2);unitsCtx.fillStyle='rgba(0,0,0,.5)';unitsCtx.fill();
    unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r,0,Math.PI2);
    const g=unitsCtx.createRadialGradient(u.x-r.3,u.y-r.35,0,u.x,u.y,r);
    g.addColorStop(0,isBlue'#93c5fd''#fca5a5');g.addColorStop(1,isBlue'#1d4ed8''#b91c1c');
    unitsCtx.fillStyle=g;unitsCtx.fill();
    unitsCtx.strokeStyle=isBlue'#3b82f6''#ef4444';unitsCtx.lineWidth=1.5camScale;unitsCtx.stroke();
    unitsCtx.font=`bold ${r1.25}px serif`;unitsCtx.textAlign='center';unitsCtx.textBaseline='alphabetic';
    unitsCtx.fillText(def.emoji,u.x,u.y+r.35);  alphabetic baseline centers emoji better in circle
     HP bar
    const bw=r2.5,bh=Math.max(2,3camScale),bx=u.x-bw2,by=u.y-r-7camScale;
    unitsCtx.fillStyle='rgba(0,0,0,.6)';unitsCtx.fillRect(bx-1,by-1,bw+2,bh+2);
    unitsCtx.fillStyle='#1a1a1a';unitsCtx.fillRect(bx,by,bw,bh);
    unitsCtx.fillStyle=hp.6'#22c55e'hp.3'#f59e0b''#ef4444';unitsCtx.fillRect(bx,by,bwhp,bh);
     Attack line
    if(u.attackTarget&&isAtk){
      const tgt=G.units.find(x=x.id===u.attackTarget);
      if(tgt){unitsCtx.beginPath();unitsCtx.moveTo(u.x,u.y);unitsCtx.lineTo(tgt.x,tgt.y);
        unitsCtx.strokeStyle=isBlue'rgba(96,165,250,.6)''rgba(248,113,113,.6)';
        unitsCtx.lineWidth=1.5camScale;unitsCtx.setLineDash([4camScale,4camScale]);unitsCtx.stroke();unitsCtx.setLineDash([]);}
    }
     State badge (small icon below unit)
    if(isSel&&isBlue){
      const stateIco={advance'‚öî',hold'‚è∏',defend'üõ°',moving'‚û§',patrol'üîÑ',force_attack'üéØ'}[u.state]'';
      if(stateIco){
        unitsCtx.font=`${r0.9}px serif`;unitsCtx.textAlign='center';unitsCtx.textBaseline='top';
        unitsCtx.fillText(stateIco,u.x,u.y+r+4camScale);
      }
    }
     Stinger range ring when selected
    if(isSel&&def.isMissile){
      unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,u.range,0,Math.PI2);
      unitsCtx.strokeStyle='rgba(248,113,113,.25)';unitsCtx.lineWidth=1.5camScale;
      unitsCtx.setLineDash([8camScale,4camScale]);unitsCtx.stroke();unitsCtx.setLineDash([]);
    }
  }
  unitsCtx.restore();
}

function drawProjectilesLayer(){
  if(!frontCtx!projectiles.length)return;
  frontCtx.save();frontCtx.translate(camX,camY);frontCtx.scale(camScale,camScale);
  const now=performance.now();
  for(const p of projectiles){
    const cx=p.ox+(p.tx-p.ox)p.progress;
    const cy=p.oy+(p.ty-p.oy)p.progress;
     Trail
    if(p.trail.length1){
      frontCtx.beginPath();frontCtx.moveTo(p.trail[0].x,p.trail[0].y);
      for(let i=1;ip.trail.length;i++)frontCtx.lineTo(p.trail[i].x,p.trail[i].y);
      frontCtx.strokeStyle=p.owner==='blue''rgba(96,165,250,.5)''rgba(248,113,113,.5)';
      frontCtx.lineWidth=2camScale;frontCtx.lineCap='round';frontCtx.stroke();
    }
     Missile dot
    frontCtx.beginPath();frontCtx.arc(cx,cy,5camScale,0,Math.PI2);
    frontCtx.fillStyle=p.owner==='blue''#60a5fa''#f87171';
    frontCtx.shadowColor=p.owner==='blue''rgba(96,165,250,.9)''rgba(248,113,113,.9)';
    frontCtx.shadowBlur=10camScale;frontCtx.fill();
    frontCtx.shadowBlur=0;
     Arrow head direction
    const ang=Math.atan2(p.ty-p.oy,p.tx-p.ox);
    frontCtx.save();frontCtx.translate(cx,cy);frontCtx.rotate(ang);
    frontCtx.fillStyle='#fff';
    frontCtx.font=`${12camScale}px serif`;frontCtx.textAlign='center';frontCtx.textBaseline='middle';
    frontCtx.fillText('üöÄ',0,0);
    frontCtx.restore();
  }
  frontCtx.restore();
}

 ‚îÄ‚îÄ UI LAYER move order markers ‚îÄ‚îÄ
function drawUI(){
  if(!uiCtx!CW!CH)return;
  uiCtx.clearRect(0,0,CW,CH);
  if(!G.units)return;
  uiCtx.save();uiCtx.translate(camX,camY);uiCtx.scale(camScale,camScale);
   Draw move targets for selected units
  G.units.filter(u=selectedUnitIds.has(u.id)&&u.moveTarget).forEach(u={
    const t=u.moveTarget;
    uiCtx.beginPath();uiCtx.arc(t.x,t.y,8camScale,0,Math.PI2);
    uiCtx.strokeStyle='rgba(34,197,94,.7)';uiCtx.lineWidth=1.5camScale;uiCtx.stroke();
    uiCtx.beginPath();uiCtx.moveTo(u.x,u.y);uiCtx.lineTo(t.x,t.y);
    uiCtx.strokeStyle='rgba(34,197,94,.25)';uiCtx.lineWidth=1camScale;
    uiCtx.setLineDash([6camScale,4camScale]);uiCtx.stroke();uiCtx.setLineDash([]);
  });
   Patrol paths
  G.units.filter(u=u.state==='patrol'&&u.patrolA&&u.patrolB&&selectedUnitIds.has(u.id)).forEach(u={
    uiCtx.beginPath();uiCtx.moveTo(u.patrolA.x,u.patrolA.y);uiCtx.lineTo(u.patrolB.x,u.patrolB.y);
    uiCtx.strokeStyle='rgba(168,85,247,.5)';uiCtx.lineWidth=1.5camScale;
    uiCtx.setLineDash([8camScale,4camScale]);uiCtx.stroke();uiCtx.setLineDash([]);
    [u.patrolA,u.patrolB].forEach(pt={
      uiCtx.beginPath();uiCtx.arc(pt.x,pt.y,7camScale,0,Math.PI2);
      uiCtx.fillStyle='rgba(168,85,247,.3)';uiCtx.fill();
      uiCtx.strokeStyle='rgba(168,85,247,.8)';uiCtx.lineWidth=1.5camScale;uiCtx.stroke();
    });
  });
   Defend zone
  G.units.filter(u=u.state==='defend'&&u.defendX!==undefined&&selectedUnitIds.has(u.id)).forEach(u={
    uiCtx.beginPath();uiCtx.arc(u.defendX,u.defendY,u.range.8,0,Math.PI2);
    uiCtx.strokeStyle='rgba(59,130,246,.3)';uiCtx.lineWidth=1.5camScale;
    uiCtx.setLineDash([5camScale,5camScale]);uiCtx.stroke();uiCtx.setLineDash([]);
  });
  uiCtx.restore();
}

 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  HUD
 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){
  if(!G.units)return;
  const myUnits=G.units.filter(u=u.owner===myRole&&!u._dead).length;
  document.getElementById('hudBlueUnits').textContent=G.units.filter(u=u.owner==='blue'&&!u._dead).length;
  document.getElementById('hudRedUnits').textContent=G.units.filter(u=u.owner==='red'&&!u._dead).length;
  document.getElementById('hudWave').textContent=G.wave1;
  document.getElementById('hudFunds').textContent=G.funds.[myRole]0;
  document.getElementById('spFunds').textContent=G.funds.[myRole]0;
  document.getElementById('spIncome').textContent='+'+getIncome(myRole)+'15—Å';
  document.getElementById('spUnits').textContent=myUnits;
  document.getElementById('spCasualties').textContent=G.casualties.[myRole]0;
  document.getElementById('casBlue').textContent=G.casualties.blue0;
  document.getElementById('casRed').textContent=G.casualties.red0;
}

function showSelInfo(u){
  const def=UNIT_DEFS[u.type];
  document.getElementById('selInfo').classList.add('vis');
  document.getElementById('siName').textContent=def.emoji+' '+def.name;
  document.getElementById('siHPText').textContent=Math.round(u.hp)+''+u.maxHp;
  document.getElementById('siHPBar').style.width=(u.hpu.maxHp100)+'%';
  document.getElementById('siHPBar').style.background=u.hpu.maxHp.5'var(--green)'u.hpu.maxHp.25'var(--gold)''var(--red)';
  document.getElementById('siAtk').textContent=u.atk;
  document.getElementById('siDef').textContent=u.def;
  document.getElementById('siSpd').textContent=u.speed;
  const stateLabels={advance'‚öî –ê–¢–ö',hold'‚è∏ –°–¢–û–ü',defend'üõ° –û–ë',moving'‚û§ –†–£–•',patrol'üîÑ –ü–ê–¢',force_attack'üéØ –¶–Ü–õ–¨',idle'‚Äî –°–¢–Ü–ô'};
  const modeEl=document.getElementById('siMode');if(modeEl)modeEl.textContent=stateLabels[u.state]u.state;
}

function addLog(msg,type='info'){
  const el=document.getElementById('spLog');
  const d=document.createElement('div');d.className='log-entry '+type;d.textContent=msg;
  el.appendChild(d);el.scrollTop=el.scrollHeight;
  if(el.children.length80)el.removeChild(el.firstChild);
}

window.toast=(msg,dur=2500)={
  const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';
  clearTimeout(t._t);t._t=setTimeout(()=t.style.display='none',dur);
};

 Continuous render loop
requestAnimationFrame(function loop(){drawAll();requestAnimationFrame(loop);});
script
body
html
