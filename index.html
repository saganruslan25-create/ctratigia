<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–°–¢–†–ê–¢–ï–ì–Ü–Ø | –û–ü–ï–†–ê–¶–Ü–Ø –î–ù–Ü–ü–†–û</title>
<link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Oswald:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
:root{--bg:#040608;--panel:#080c10;--border:rgba(34,197,94,.18);--green:#22c55e;--green2:#4ade80;--red:#ef4444;--blue:#3b82f6;--gold:#f59e0b;--teal:#14b8a6;--purple:#a855f7;--water:#1e40af;--text:#e2e8f0;--dim:#64748b;--dark:#020305;}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:'Share Tech Mono',monospace;height:100vh;overflow:hidden;user-select:none;}
input,select,textarea{user-select:text!important;-webkit-user-select:text!important;}
.screen{position:fixed;inset:0;display:none;z-index:100;}.screen.active{display:flex;}
#screen-menu{flex-direction:column;align-items:center;justify-content:center;background:radial-gradient(ellipse at 20% 30%,rgba(34,197,94,.07) 0%,transparent 50%),radial-gradient(ellipse at 80% 70%,rgba(59,130,246,.05) 0%,transparent 50%),var(--bg);}
.menu-bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(34,197,94,.04) 1px,transparent 1px),linear-gradient(90deg,rgba(34,197,94,.04) 1px,transparent 1px);background-size:40px 40px;mask-image:radial-gradient(ellipse at center,black 40%,transparent 80%);}
.menu-logo{position:relative;z-index:1;text-align:center;margin-bottom:40px;}
.menu-logo-top{font-family:'Oswald',sans-serif;font-size:11px;font-weight:400;color:var(--green);letter-spacing:8px;margin-bottom:8px;opacity:.7;}
.menu-logo-title{font-family:'Oswald',sans-serif;font-size:56px;font-weight:700;line-height:.9;letter-spacing:2px;background:linear-gradient(135deg,#fff 30%,var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.menu-logo-sub{font-size:12px;color:var(--dim);letter-spacing:4px;margin-top:10px;}
.menu-user{position:relative;z-index:1;margin-bottom:20px;padding:8px 20px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:20px;font-size:11px;color:var(--dim);display:flex;align-items:center;gap:8px;}
.menu-user-badge{font-size:10px;padding:2px 8px;border-radius:10px;font-family:'Oswald',sans-serif;letter-spacing:1px;}
.badge-admin{background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3);}
.badge-anon{background:rgba(100,116,139,.1);color:var(--dim);border:1px solid rgba(100,116,139,.2);}
.menu-btns{position:relative;z-index:1;display:flex;flex-direction:column;gap:8px;width:320px;}
.mbtn{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);color:var(--text);font-family:'Oswald',sans-serif;font-size:15px;font-weight:500;letter-spacing:2px;padding:13px 24px;cursor:pointer;transition:all .2s;text-align:left;position:relative;overflow:hidden;border-radius:4px;}
.mbtn::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--green);transform:scaleY(0);transition:transform .2s;}
.mbtn:hover{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);color:#fff;}.mbtn:hover::before{transform:scaleY(1);}
.mbtn .mico{margin-right:14px;font-size:16px;}
.mbtn.primary{background:rgba(34,197,94,.1);border-color:rgba(34,197,94,.4);color:var(--green2);}
.mbtn.primary:hover{background:rgba(34,197,94,.2);}
.mbtn.admin-btn{background:rgba(245,158,11,.05);border-color:rgba(245,158,11,.2);color:var(--gold);}
.mbtn.admin-btn:hover{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.4);}
.menu-auth-btns{position:relative;z-index:1;display:flex;gap:8px;margin-top:8px;}
.menu-ver{position:absolute;bottom:16px;right:20px;font-size:10px;color:#1a2a1a;}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.8);display:none;align-items:center;justify-content:center;z-index:8000;backdrop-filter:blur(6px);}
.modal-overlay.vis{display:flex;}
.modal-box{background:rgba(8,12,16,.98);border:1px solid var(--border);border-radius:12px;padding:28px;width:100%;max-width:480px;margin:16px;}
.modal-title{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:var(--green2);letter-spacing:2px;margin-bottom:20px;}
.modal-tabs{display:flex;gap:0;margin-bottom:20px;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;}
.modal-tab{flex:1;padding:9px;text-align:center;cursor:pointer;font-family:'Oswald',sans-serif;font-size:13px;font-weight:600;letter-spacing:1px;color:var(--dim);transition:.2s;}
.modal-tab.active{background:rgba(34,197,94,.12);color:var(--green2);}
.modal-tab-content{display:none;}.modal-tab-content.active{display:block;}
.ai-mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.ai-mode-card{background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:16px;cursor:pointer;transition:.2s;text-align:center;}
.ai-mode-card:hover{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.05);}
.ai-mode-card.selected{border-color:var(--green);background:rgba(34,197,94,.1);}
.ai-mode-emoji{font-size:32px;margin-bottom:8px;}
.ai-mode-title{font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;color:#fff;margin-bottom:4px;}
.ai-mode-desc{font-size:10px;color:var(--dim);line-height:1.5;}
.ai-team-sel{display:flex;gap:8px;margin-bottom:14px;}
.ai-team-btn{flex:1;padding:10px;border-radius:6px;border:1px solid rgba(255,255,255,.1);font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:.2s;text-align:center;}
.ai-team-btn.blue-team{background:rgba(59,130,246,.08);color:#60a5fa;border-color:rgba(59,130,246,.3);}
.ai-team-btn.blue-team.selected{background:rgba(59,130,246,.25);border-color:#3b82f6;}
.ai-team-btn.red-team{background:rgba(239,68,68,.08);color:#f87171;border-color:rgba(239,68,68,.3);}
.ai-team-btn.red-team.selected{background:rgba(239,68,68,.25);border-color:#ef4444;}
.lobby-box{background:rgba(8,12,16,.9);border:1px solid var(--border);border-radius:12px;padding:28px;width:100%;max-width:480px;}
.lobby-title{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:var(--green2);letter-spacing:2px;margin-bottom:20px;}
.lobby-code-display{background:rgba(34,197,94,.08);border:2px solid rgba(34,197,94,.3);border-radius:8px;padding:18px;text-align:center;margin-bottom:16px;}
.lcd-label{font-size:10px;color:var(--dim);letter-spacing:3px;margin-bottom:6px;}
.lcd-code{font-family:'Oswald',sans-serif;font-size:40px;font-weight:700;color:var(--green);letter-spacing:8px;}
.lcd-sub{font-size:11px;color:var(--dim);margin-top:4px;}
.lobby-players{display:flex;gap:10px;margin-bottom:16px;}
.lp-slot{flex:1;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:12px;text-align:center;}
.lp-slot.filled{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);}
.lp-slot.p1{border-color:rgba(59,130,246,.3);background:rgba(59,130,246,.05);}
.lps-icon{font-size:22px;margin-bottom:4px;}.lps-label{font-size:10px;color:var(--dim);letter-spacing:2px;}.lps-name{font-size:12px;font-weight:700;margin-top:3px;color:#fff;}
.form-row{display:flex;gap:8px;margin-bottom:10px;}
.form-input{flex:1;background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.1);color:#fff;padding:9px 13px;border-radius:6px;font-family:'Share Tech Mono',monospace;font-size:13px;outline:none;transition:.2s;}
.form-input:focus{border-color:var(--green);}
.form-label{font-size:10px;color:var(--dim);letter-spacing:2px;margin-bottom:5px;display:block;}
.btn-primary{background:var(--green);color:#000;border:none;padding:10px 18px;border-radius:6px;font-family:'Oswald',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;white-space:nowrap;}
.btn-primary:hover{background:var(--green2);}
.btn-secondary{background:transparent;color:var(--dim);border:1px solid rgba(255,255,255,.1);padding:10px 18px;border-radius:6px;font-family:'Oswald',sans-serif;font-weight:600;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;}
.btn-secondary:hover{border-color:rgba(255,255,255,.3);color:#fff;}
.btn-gold{background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3);padding:10px 18px;border-radius:6px;font-family:'Oswald',sans-serif;font-weight:700;font-size:13px;letter-spacing:1px;cursor:pointer;transition:.2s;}
.btn-gold:hover{background:rgba(245,158,11,.25);}
.status-box{padding:7px 12px;border-radius:6px;font-size:11px;margin-bottom:10px;display:none;}
.status-box.vis{display:block;}
.status-box.ok{background:rgba(34,197,94,.08);border:1px solid rgba(34,197,94,.2);color:var(--green2);}
.status-box.err{background:rgba(239,68,68,.08);border:1px solid rgba(239,68,68,.2);color:#f87171;}
.status-box.warn{background:rgba(245,158,11,.08);border:1px solid rgba(245,158,11,.2);color:var(--gold);}
.lobby-map-section{border-top:1px solid rgba(255,255,255,.06);padding-top:14px;margin-top:4px;}
.lms-title{font-size:10px;color:var(--dim);letter-spacing:3px;margin-bottom:8px;}
.map-upload-area{border:2px dashed rgba(255,255,255,.1);border-radius:8px;padding:16px;text-align:center;cursor:pointer;transition:.2s;}
.map-upload-area:hover{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.03);}
.map-preview{width:100%;height:70px;object-fit:cover;border-radius:6px;border:1px solid var(--border);display:none;}
.map-saved-list{display:flex;flex-direction:column;gap:6px;max-height:120px;overflow-y:auto;}
.map-saved-item{display:flex;align-items:center;gap:8px;padding:6px 10px;border-radius:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);cursor:pointer;transition:.2s;}
.map-saved-item:hover,.map-saved-item.active{border-color:rgba(34,197,94,.3);background:rgba(34,197,94,.05);}
.msi-thumb{width:40px;height:28px;object-fit:cover;border-radius:4px;flex-shrink:0;}
.msi-info{flex:1;}.msi-name{font-size:12px;font-weight:700;color:#fff;}.msi-date{font-size:10px;color:var(--dim);}
.disconnect-banner{position:fixed;top:0;left:0;right:0;z-index:7000;background:rgba(239,68,68,.95);padding:12px 20px;display:none;flex-direction:column;align-items:center;gap:6px;border-bottom:2px solid #f87171;}
.disconnect-banner.vis{display:flex;}
.dc-title{font-family:'Oswald',sans-serif;font-size:16px;font-weight:700;color:#fff;letter-spacing:2px;}
.dc-timer{font-family:'Oswald',sans-serif;font-size:28px;font-weight:700;color:#fff;}
.dc-sub{font-size:11px;color:rgba(255,255,255,.8);}
#screen-admin{flex-direction:column;background:var(--bg);}
.admin-header{height:52px;background:rgba(8,12,16,.98);border-bottom:1px solid rgba(245,158,11,.2);display:flex;align-items:center;padding:0 20px;gap:14px;flex-shrink:0;}
.admin-title{font-family:'Oswald',sans-serif;font-size:18px;font-weight:700;color:var(--gold);letter-spacing:3px;}
.admin-body{flex:1;display:flex;gap:0;overflow:hidden;}
.admin-sidebar{width:200px;background:rgba(4,6,8,.8);border-right:1px solid rgba(255,255,255,.06);padding:16px;display:flex;flex-direction:column;gap:6px;flex-shrink:0;}
.admin-nav-btn{padding:9px 12px;border-radius:6px;cursor:pointer;font-size:13px;color:var(--dim);transition:.2s;border:1px solid transparent;}
.admin-nav-btn:hover,.admin-nav-btn.active{background:rgba(245,158,11,.08);border-color:rgba(245,158,11,.2);color:var(--gold);}
.admin-content{flex:1;padding:20px;overflow-y:auto;}
.admin-section{display:none;}.admin-section.active{display:block;}
.admin-card{background:rgba(8,12,16,.8);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:20px;margin-bottom:16px;}
.admin-card-title{font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;color:var(--gold);letter-spacing:2px;margin-bottom:14px;}
.admin-maps-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
.admin-map-card{border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;cursor:pointer;transition:.2s;background:rgba(0,0,0,.3);}
.admin-map-card:hover{border-color:rgba(245,158,11,.4);}
.amc-img{width:100%;height:100px;object-fit:cover;}.amc-info{padding:8px 10px;}.amc-name{font-size:12px;font-weight:700;color:#fff;margin-bottom:3px;}.amc-meta{font-size:10px;color:var(--dim);}
.amc-actions{display:flex;gap:4px;margin-top:6px;flex-wrap:wrap;}
.amc-btn{flex:1;padding:4px 8px;border-radius:4px;font-family:'Oswald',sans-serif;font-size:10px;font-weight:700;letter-spacing:1px;cursor:pointer;border:none;transition:.2s;white-space:nowrap;}
.amc-btn.set{background:rgba(34,197,94,.2);color:var(--green2);}.amc-btn.set:hover{background:var(--green);color:#000;}
.amc-btn.del{background:rgba(239,68,68,.1);color:#f87171;}.amc-btn.del:hover{background:var(--red);color:#fff;}
.amc-btn.edit{background:rgba(59,130,246,.15);color:#60a5fa;}.amc-btn.edit:hover{background:var(--blue);color:#fff;}
.map-editor-wrap{display:flex;gap:16px;height:100%;}
.map-editor-canvas-wrap{flex:1;position:relative;border:1px solid rgba(255,255,255,.08);border-radius:8px;overflow:hidden;background:#111;}
#adminMapCanvas{width:100%;height:100%;display:block;}
.map-editor-tools{width:200px;flex-shrink:0;display:flex;flex-direction:column;gap:6px;overflow-y:auto;}
.tool-btn{padding:8px 12px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;cursor:pointer;border:1px solid rgba(255,255,255,.1);color:var(--dim);background:transparent;transition:.2s;width:100%;}
.tool-btn:hover,.tool-btn.active{background:rgba(245,158,11,.1);border-color:rgba(245,158,11,.3);color:var(--gold);}
.color-row{display:flex;gap:4px;flex-wrap:wrap;}
.color-swatch{width:24px;height:24px;border-radius:4px;cursor:pointer;border:2px solid transparent;transition:.15s;}
.color-swatch:hover,.color-swatch.active{border-color:#fff;}
.editor-sep{height:1px;background:rgba(255,255,255,.06);margin:4px 0;}
#screen-editor{flex-direction:column;background:var(--bg);}
.editor-topbar{height:50px;background:rgba(4,6,8,.97);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 16px;gap:12px;flex-shrink:0;}
.editor-topbar-title{font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;color:var(--gold);letter-spacing:2px;}
.editor-body{flex:1;display:flex;overflow:hidden;}
.editor-canvas-area{flex:1;position:relative;background:#0a0e12;overflow:hidden;}
#editorCanvas{position:absolute;top:0;left:0;}
#editorOverlay{position:absolute;top:0;left:0;pointer-events:none;}
.editor-sidebar{width:230px;flex-shrink:0;background:rgba(4,6,8,.97);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;padding:10px;}
.editor-tool-group{margin-bottom:8px;}
.editor-group-label{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:5px;padding:0 2px;}
.etool{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,.06);background:transparent;color:var(--dim);font-family:'Oswald',sans-serif;font-size:12px;font-weight:600;letter-spacing:1px;transition:.2s;width:100%;margin-bottom:3px;text-align:left;}
.etool:hover{background:rgba(255,255,255,.04);color:#fff;}
.etool.active{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.4);color:var(--gold);}
.etool.water-tool.active{background:rgba(59,130,246,.12);border-color:rgba(59,130,246,.4);color:#60a5fa;}
.etool.forest-tool.active{background:rgba(22,163,74,.12);border-color:rgba(22,163,74,.4);color:#4ade80;}
.etool.road-tool.active{background:rgba(161,119,53,.12);border-color:rgba(161,119,53,.4);color:#d97706;}
.etool.meadow-tool.active{background:rgba(134,179,80,.12);border-color:rgba(134,179,80,.4);color:#86b350;}
.etool.bridge-tool.active{background:rgba(146,64,14,.12);border-color:rgba(146,64,14,.4);color:#a16207;}
.editor-cursor-hint{position:absolute;bottom:12px;left:12px;background:rgba(4,6,8,.9);border:1px solid var(--border);border-radius:6px;padding:6px 12px;font-size:10px;color:var(--dim);pointer-events:none;z-index:20;}
.editor-zoom-ind{position:absolute;bottom:12px;right:12px;background:rgba(4,6,8,.8);border:1px solid rgba(255,255,255,.06);border-radius:6px;padding:4px 10px;font-size:10px;color:var(--dim);}
.editor-marker{position:absolute;transform:translate(-50%,-50%);font-size:18px;pointer-events:none;text-shadow:0 0 4px rgba(0,0,0,.9),0 0 10px rgba(0,0,0,.7);filter:drop-shadow(0 2px 3px rgba(0,0,0,.8));}
#screen-game{flex-direction:column;}
.game-hud{height:46px;background:rgba(4,6,8,.97);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 12px;gap:10px;flex-shrink:0;position:relative;z-index:50;}
.hud-logo{font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;color:var(--green);letter-spacing:2px;flex-shrink:0;}
.hud-sep{width:1px;height:18px;background:rgba(255,255,255,.08);}
.hud-stat{display:flex;align-items:center;gap:5px;font-size:11px;}
.hud-stat-label{color:var(--dim);font-size:9px;letter-spacing:1px;}
.hud-stat-val{font-family:'Oswald',sans-serif;font-size:14px;font-weight:600;}
.hud-stat-val.blue{color:#60a5fa;}.hud-stat-val.red{color:#f87171;}
.hud-center{position:absolute;left:50%;transform:translateX(-50%);display:flex;align-items:center;flex-direction:column;}
.hud-timer{font-family:'Oswald',sans-serif;font-size:20px;font-weight:700;color:#fff;letter-spacing:2px;}
.hud-turn{font-size:9px;color:var(--dim);letter-spacing:2px;}
.hud-right{margin-left:auto;display:flex;align-items:center;gap:6px;}
.hud-btn{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.1);color:var(--text);padding:4px 10px;border-radius:5px;font-family:'Oswald',sans-serif;font-size:10px;font-weight:600;letter-spacing:1px;cursor:pointer;transition:.2s;}
.hud-btn:hover{border-color:rgba(34,197,94,.4);color:var(--green2);}
.hud-btn.danger:hover{border-color:rgba(239,68,68,.4);color:#f87171;}
.game-area{flex:1;position:relative;overflow:hidden;background:#06090d;min-width:0;}
.game-body{display:flex;flex:1;overflow:hidden;}
#mapCanvas,#unitsCanvas,#frontCanvas,#uiCanvas,#interCanvas{position:absolute;top:0;left:0;}
#interCanvas{touch-action:none;}
#unitsCanvas,#frontCanvas,#uiCanvas{pointer-events:none;}
.side-panel{width:220px;min-width:220px;max-width:220px;background:rgba(4,6,8,.97);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow-y:auto;flex-shrink:0;position:relative;z-index:10;}
.cmd-toolbar{position:absolute;bottom:55px;left:50%;transform:translateX(-50%);display:flex;gap:6px;z-index:60;pointer-events:auto;}
.cmd-btn{background:rgba(8,12,16,.95);border:1px solid rgba(255,255,255,.15);color:var(--dim);padding:6px 14px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:11px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:.2s;white-space:nowrap;}
.cmd-btn:hover{border-color:rgba(34,197,94,.5);color:var(--green2);}
.cmd-btn.active{background:rgba(34,197,94,.15);border-color:var(--green);color:var(--green2);}
.cmd-btn.attack-mode{border-color:rgba(239,68,68,.4);color:#f87171;}
.cmd-btn.missile-active{color:#a855f7;border-color:#a855f7;background:rgba(168,85,247,.15);animation:pulse-missile 1s infinite;}
@keyframes pulse-missile{0%,100%{box-shadow:0 0 0 0 rgba(168,85,247,.4);}50%{box-shadow:0 0 0 6px rgba(168,85,247,0);}}
.cmd-btn.attack-mode:hover,.cmd-btn.attack-mode.active{background:rgba(239,68,68,.15);border-color:#ef4444;}
.sp-section{padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.04);}
.sp-label{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:7px;}
.sp-unit-btn{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);cursor:pointer;transition:.2s;margin-bottom:4px;}
.sp-unit-btn:hover,.sp-unit-btn.active{background:rgba(59,130,246,.08);border-color:rgba(59,130,246,.3);}
.sp-unit-btn.active{border-color:var(--blue);}
.sp-unit-icon{font-size:16px;width:22px;text-align:center;}
.sp-unit-info{flex:1;}.sp-unit-name{font-size:11px;font-weight:700;color:#fff;}.sp-unit-stat{font-size:9px;color:var(--dim);}
.sp-unit-cost{font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;color:var(--gold);}
.sp-resources{display:flex;flex-direction:column;gap:5px;}
.sp-res-row{display:flex;justify-content:space-between;align-items:center;}
.sp-res-label{font-size:9px;color:var(--dim);}.sp-res-val{font-family:'Oswald',sans-serif;font-size:13px;font-weight:700;}
.sp-log{flex:1;overflow-y:auto;padding:6px 10px;display:flex;flex-direction:column;gap:2px;}
.log-entry{font-size:10px;color:var(--dim);line-height:1.4;padding:2px 0;}
.log-entry.good{color:#4ade80;}.log-entry.bad{color:#f87171;}.log-entry.info{color:#60a5fa;}.log-entry.warn{color:var(--gold);}
.cities-hud{padding:8px 12px;border-bottom:1px solid rgba(255,255,255,.04);}
.city-row{display:flex;align-items:center;gap:5px;padding:3px 0;font-size:10px;}
.city-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.city-dot.blue{background:#3b82f6;}.city-dot.red{background:#ef4444;}.city-dot.neutral{background:#64748b;}
.city-name{flex:1;color:var(--dim);}.city-income{font-family:'Oswald',sans-serif;font-size:10px;font-weight:700;color:var(--gold);}
.placement-hint{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);background:rgba(4,6,8,.95);border:1px solid rgba(34,197,94,.4);border-radius:8px;padding:8px 18px;font-size:12px;color:var(--green2);pointer-events:none;z-index:100;display:none;letter-spacing:1px;font-family:'Oswald',sans-serif;}
.placement-hint.vis{display:block;}
.casualties-overlay{position:absolute;bottom:14px;left:14px;background:rgba(4,6,8,.85);border:1px solid rgba(255,255,255,.08);border-radius:8px;padding:10px 14px;pointer-events:none;z-index:30;}
.co-title{font-size:9px;color:var(--dim);letter-spacing:3px;margin-bottom:5px;}
.co-row{display:flex;align-items:center;gap:10px;font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;}
.co-blue{color:#60a5fa;}.co-red{color:#f87171;}
.sel-info{position:absolute;top:8px;left:14px;background:rgba(4,6,8,.93);border:1px solid var(--border);border-radius:8px;padding:10px 14px;min-width:150px;pointer-events:none;z-index:30;display:none;}
.sel-info.vis{display:block;}
.si-name{font-family:'Oswald',sans-serif;font-size:15px;font-weight:700;color:#fff;}
.si-hp-bar{height:4px;background:rgba(255,255,255,.1);border-radius:4px;overflow:hidden;margin-top:5px;}
.si-hp-fill{height:100%;background:var(--green);border-radius:4px;transition:width .3s;}
.si-stats{display:flex;gap:8px;margin-top:5px;font-size:10px;color:var(--dim);}
.si-stat{display:flex;flex-direction:column;align-items:center;gap:1px;}.si-stat b{font-family:'Oswald',sans-serif;font-size:12px;color:#fff;}
.zoom-ind{position:absolute;bottom:14px;right:234px;background:rgba(4,6,8,.8);border:1px solid rgba(255,255,255,.06);border-radius:6px;padding:4px 8px;font-size:10px;color:var(--dim);pointer-events:none;z-index:30;}
.result-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;flex-direction:column;align-items:center;justify-content:center;z-index:9000;backdrop-filter:blur(10px);}
.result-overlay.vis{display:flex;}
.result-box{background:rgba(8,12,16,.98);border:1px solid var(--border);border-radius:16px;padding:36px;text-align:center;max-width:420px;}
.result-emoji{font-size:58px;margin-bottom:14px;}.result-title{font-family:'Oswald',sans-serif;font-size:34px;font-weight:700;letter-spacing:3px;margin-bottom:8px;}
.result-sub{font-size:13px;color:var(--dim);margin-bottom:22px;line-height:1.8;white-space:pre-line;}
.toast{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);background:rgba(8,12,16,.97);border:1px solid var(--green);padding:9px 18px;border-radius:8px;font-size:12px;font-weight:700;color:var(--green2);z-index:9999;display:none;box-shadow:0 0 20px rgba(34,197,94,.2);white-space:nowrap;}
.loading-screen{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;}
.loading-screen.hidden{display:none;}
.ld-title{font-family:'Oswald',sans-serif;font-size:30px;font-weight:700;color:var(--green);letter-spacing:4px;margin-bottom:18px;}
.ld-bar{width:180px;height:3px;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;}
.ld-fill{height:100%;background:var(--green);animation:ldanim 1.4s ease-in-out infinite;}
@keyframes ldanim{0%{width:0;margin-left:0}50%{width:100%;margin-left:0}100%{width:0;margin-left:100%}}
.ld-text{margin-top:10px;font-size:10px;color:var(--dim);letter-spacing:2px;}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:rgba(34,197,94,.2);border-radius:4px;}
@keyframes incomeFloat{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-30px)}}
.income-float{position:absolute;font-family:'Oswald',sans-serif;font-size:14px;font-weight:700;color:var(--gold);pointer-events:none;z-index:200;animation:incomeFloat 1.5s ease-out forwards;}
@media(max-width:700px){.side-panel{display:none;}.menu-logo-title{font-size:38px;}.menu-btns{width:90%;}}
</style>
</head>
<body>
<div class="loading-screen" id="loadingScreen">
  <div class="ld-title">–°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
  <div class="ld-bar"><div class="ld-fill"></div></div>
  <div class="ld-text" id="ldText">–ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø...</div>
</div>
<div class="disconnect-banner" id="dcBanner">
  <div class="dc-title">‚ö†Ô∏è –û–ü–û–ù–ï–ù–¢ –í–Ü–î–ö–õ–Æ–ß–ò–í–°–Ø</div>
  <div class="dc-timer" id="dcTimer">60</div>
  <div class="dc-sub">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è...</div>
</div>
<!-- MENU -->
<div class="screen" id="screen-menu">
  <div class="menu-bg-grid"></div>
  <div class="menu-logo">
    <div class="menu-logo-top">–û–ø–µ—Ä–∞—Ü—ñ—è</div>
    <div class="menu-logo-title">–°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
    <div class="menu-logo-sub">–¢–ê–ö–¢–ò–ß–ù–ê –ë–û–ô–û–í–ê –°–ò–°–¢–ï–ú–ê v3.1</div>
  </div>
  <div class="menu-user" id="menuUser">
    <span id="menuUserName">–ê–Ω–æ–Ω—ñ–º</span>
    <span class="menu-user-badge badge-anon" id="menuUserBadge">–ì–Ü–°–¢–¨</span>
  </div>
  <div class="menu-btns">
    <button class="mbtn primary" onclick="showLobbyCreate()"><span class="mico">‚öîÔ∏è</span>–°–¢–í–û–†–ò–¢–ò –õ–û–ë–Ü</button>
    <button class="mbtn" onclick="showLobbyJoin()"><span class="mico">üîó</span>–ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>
    <button class="mbtn" onclick="showAIModeSelect()"><span class="mico">ü§ñ</span>–ü–†–û–¢–ò –Ü–Ü</button>
    <button class="mbtn" onclick="openMapEditor()"><span class="mico">üó∫Ô∏è</span>–†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–ò</button>
    <button class="mbtn admin-btn" id="adminMenuBtn" style="display:none" onclick="showScreen('screen-admin');adminNav('maps')"><span class="mico">üëë</span>–ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨</button>
  </div>
  <div class="menu-auth-btns">
    <button class="btn-secondary" id="authMenuBtn" onclick="showAuthModal()">üîê –£–≤—ñ–π—Ç–∏ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</button>
    <button class="btn-secondary" id="logoutBtn" style="display:none" onclick="doLogout()">–í–∏–π—Ç–∏</button>
  </div>
  <div class="menu-ver">v3.1 | –°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
</div>
<!-- AUTH MODAL -->
<div class="modal-overlay" id="authModal">
  <div class="modal-box">
    <div class="modal-title">üîê –ê–í–¢–û–†–ò–ó–ê–¶–Ü–Ø</div>
    <div class="modal-tabs">
      <div class="modal-tab active" onclick="switchAuthTab('login')">–£–í–Ü–ô–¢–ò</div>
      <div class="modal-tab" onclick="switchAuthTab('register')">–†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø</div>
    </div>
    <div class="modal-tab-content active" id="tab-login">
      <div id="loginStatus" class="status-box"></div>
      <div class="form-label">EMAIL</div>
      <div class="form-row"><input class="form-input" id="loginEmail" type="email" placeholder="email@example.com"></div>
      <div class="form-label">–ü–ê–†–û–õ–¨</div>
      <div class="form-row"><input class="form-input" id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button class="btn-primary" onclick="doLogin()" style="flex:1">‚ñ∂ –£–í–Ü–ô–¢–ò</button>
        <button class="btn-secondary" onclick="closeAuthModal()">‚úï</button>
      </div>
    </div>
    <div class="modal-tab-content" id="tab-register">
      <div id="registerStatus" class="status-box"></div>
      <div class="form-label">–ü–û–ó–ò–í–ù–ò–ô</div>
      <div class="form-row"><input class="form-input" id="regName" placeholder="–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π" maxlength="20"></div>
      <div class="form-label">EMAIL</div>
      <div class="form-row"><input class="form-input" id="regEmail" type="email" placeholder="email@example.com"></div>
      <div class="form-label">–ü–ê–†–û–õ–¨</div>
      <div class="form-row"><input class="form-input" id="regPass" type="password" placeholder="–º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤"></div>
      <div style="display:flex;gap:8px;margin-top:4px;">
        <button class="btn-primary" onclick="doRegister()" style="flex:1">‚úÖ –ó–ê–†–ï–Ñ–°–¢–†–£–í–ê–¢–ò–°–¨</button>
        <button class="btn-secondary" onclick="closeAuthModal()">‚úï</button>
      </div>
    </div>
  </div>
</div>
<!-- AI MODE MODAL -->
<div class="modal-overlay" id="aiModeModal">
  <div class="modal-box" style="max-width:520px;">
    <div class="modal-title">ü§ñ –†–ï–ñ–ò–ú –ü–†–û–¢–ò –Ü–Ü</div>
    <div class="form-label" style="margin-bottom:10px;">–û–ë–ï–†–Ü–¢–¨ –í–ê–®–£ –°–¢–û–†–û–ù–£</div>
    <div class="ai-team-sel">
      <div class="ai-team-btn blue-team selected" id="teamBtnBlue" onclick="selectAITeam('blue')">üîµ –°–ò–ù–Ü</div>
      <div class="ai-team-btn red-team" id="teamBtnRed" onclick="selectAITeam('red')">üî¥ –ß–ï–†–í–û–ù–Ü</div>
    </div>
    <div class="form-label" style="margin-bottom:10px;">–û–ë–ï–†–Ü–¢–¨ –†–ï–ñ–ò–ú –ì–†–ò</div>
    <div class="ai-mode-grid">
      <div class="ai-mode-card selected" id="aimode-defense" onclick="selectAIMode('defense')"><div class="ai-mode-emoji">üõ°Ô∏è</div><div class="ai-mode-title">–û–ë–û–†–û–ù–ê</div><div class="ai-mode-desc">–ó–∞—Ö–∏—â–∞–π—Ç–µ —Å–≤–æ—ó –º—ñ—Å—Ç–∞ –≤—ñ–¥ –∞—Ç–∞–∫ –≤–æ—Ä–æ–∂–æ–≥–æ –Ü–Ü.</div></div>
      <div class="ai-mode-card" id="aimode-attack" onclick="selectAIMode('attack')"><div class="ai-mode-emoji">‚öîÔ∏è</div><div class="ai-mode-title">–ù–ê–°–¢–£–ü</div><div class="ai-mode-desc">–ê—Ç–∞–∫—É–π—Ç–µ –≤–æ—Ä–æ–∂—É –±–∞–∑—É —Ç–∞ –∑–∞—Ö–æ–ø–ª—é–π—Ç–µ –º—ñ—Å—Ç–∞.</div></div>
      <div class="ai-mode-card" id="aimode-blitz" onclick="selectAIMode('blitz')"><div class="ai-mode-emoji">‚ö°</div><div class="ai-mode-title">–ë–õ–Ü–¶–ö–†–ò–ì</div><div class="ai-mode-desc">–®–≤–∏–¥–∫–∞ –≥—Ä–∞: –∑–∞—Ö–æ–ø—ñ—Ç—å 3+ –º—ñ—Å—Ç–∞ –∑–∞ 5 —Ö–≤–∏–ª–∏–Ω.</div></div>
      <div class="ai-mode-card" id="aimode-conquest" onclick="selectAIMode('conquest')"><div class="ai-mode-emoji">üèÜ</div><div class="ai-mode-title">–ó–ê–í–û–Æ–í–ê–ù–ù–Ø</div><div class="ai-mode-desc">–ö–æ–Ω—Ç—Ä–æ–ª—å—Ç–µ –≤—Å—ñ –º—ñ—Å—Ç–∞ –Ω–∞ –∫–∞—Ä—Ç—ñ.</div></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:4px;">
      <button class="btn-primary" onclick="startVsAI()" style="flex:1">‚ñ∂ –ü–û–ß–ê–¢–ò</button>
      <button class="btn-secondary" onclick="closeAIModeModal()">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>
<!-- STANDALONE MAP EDITOR -->
<div class="screen" id="screen-editor">
  <div class="editor-topbar">
    <span class="editor-topbar-title">üó∫Ô∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–ò</span>
    <div style="display:flex;align-items:center;gap:8px;margin-left:12px;">
      <span id="editorMapName" style="font-size:11px;color:var(--dim);font-family:'Oswald'">–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞</span>
      <button class="hud-btn" onclick="editorRenameMap()">‚úé</button>
    </div>
    <div style="display:flex;align-items:center;gap:6px;margin-left:16px;">
      <span style="font-size:9px;color:var(--dim);font-family:'Oswald';letter-spacing:1px;">–ö–ê–†–¢–ê:</span>
      <select id="editorMapSelect" style="background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);color:#fff;padding:4px 8px;border-radius:5px;font-size:11px;font-family:'Oswald',sans-serif;" onchange="editorSwitchMap(this.value)">
        <option value="-1">+ –ù–æ–≤–∞ –∫–∞—Ä—Ç–∞</option>
      </select>
    </div>
    <div style="margin-left:auto;display:flex;gap:6px;">
      <input type="file" id="editorBgUpload2" accept="image/*" style="display:none" onchange="editorLoadBg(this)">
      <button class="hud-btn" onclick="document.getElementById('editorBgUpload2').click()">üì∑ –§–æ—Ç–æ</button>
      <button class="hud-btn" onclick="editorUndoNew()" title="Ctrl+Z">‚Ü© –í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
      <button class="hud-btn" onclick="eZoomIn()">üîç+</button>
      <button class="hud-btn" onclick="eZoomOut()">üîç-</button>
      <button class="hud-btn" onclick="eZoomReset()">‚Ü∫ –í–ò–î</button>
      <button class="hud-btn" style="border-color:rgba(34,197,94,.4);color:var(--green2)" onclick="editorSaveMap()">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏</button>
      <button class="hud-btn danger" onclick="showScreen('screen-menu')">‚Üê –ú–µ–Ω—é</button>
    </div>
  </div>
  <div class="editor-body">
    <div class="editor-canvas-area" id="editorCanvasArea">
      <!-- FIX: wrap canvas in a zoomable container -->
      <div id="editorZoomWrap" style="position:absolute;top:0;left:0;transform-origin:0 0;">
        <canvas id="editorCanvas"></canvas>
        <div id="editorOverlay" style="position:absolute;top:0;left:0;pointer-events:none;"></div>
      </div>
      <div class="editor-cursor-hint" id="editorCursorHint">‚úèÔ∏è –í–∏–±–µ—Ä–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —ñ –º–∞–ª—é–π –º–∏—à–µ—é</div>
      <div class="editor-zoom-ind" id="editorZoomInd">100%</div>
    </div>
    <div class="editor-sidebar">
      <div class="editor-tool-group">
        <div class="editor-group-label">–Ü–ù–°–¢–†–£–ú–ï–ù–¢–ò</div>
        <button class="etool active" id="etool-draw" onclick="setETool('draw')">‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏</button>
        <button class="etool" id="etool-erase" onclick="setETool('erase')">üßπ –°—Ç–µ—Ä—Ç–∏</button>
        <button class="etool" id="etool-fill" onclick="setETool('fill')">ü™£ –ó–∞–ª–∏–≤–∫–∞</button>
        <button class="etool" id="etool-move" onclick="setETool('move')">‚úã –ü–∞–Ω / –ó—É–º</button>
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–¢–ï–†–ï–ù</div>
        <button class="etool water-tool" id="etool-water" onclick="setETool('water')">üåä –í–æ–¥–∞</button>
        <button class="etool bridge-tool" id="etool-bridge" onclick="setETool('bridge')">üåâ –ú—ñ—Å—Ç</button>
        <button class="etool forest-tool" id="etool-forest" onclick="setETool('forest')">üå≤ –õ—ñ—Å</button>
        <button class="etool road-tool" id="etool-road" onclick="setETool('road')">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</button>
        <button class="etool meadow-tool" id="etool-meadow" onclick="setETool('meadow')">üåø –õ—É–≥ (–ø–æ–ª–µ)</button>
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–ü–û–ó–ò–¶–Ü–á</div>
        <button class="etool" id="etool-city" onclick="setETool('city')">üèôÔ∏è –ú—ñ—Å—Ç–æ</button>
        <button class="etool" id="etool-base_blue" onclick="setETool('base_blue')">üè† –ë–∞–∑–∞ –°–ò–ù–Ü–•</button>
        <button class="etool" id="etool-base_red" onclick="setETool('base_red')">üèöÔ∏è –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•</button>
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–°–¢–ê–†–¢–û–í–Ü –Æ–ù–Ü–¢–ò</div>
        <button class="etool" id="etool-unit_blue" onclick="setETool('unit_blue')">üîµ –Æ–Ω—ñ—Ç –°–ò–ù–Ü–•</button>
        <button class="etool" id="etool-unit_red" onclick="setETool('unit_red')">üî¥ –Æ–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•</button>
        <select id="editorUnitType2" style="width:100%;margin:4px 0;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.1);color:#fff;padding:6px 8px;border-radius:5px;font-size:11px;">
          <option value="infantry">üë• –ü—ñ—Ö–æ—Ç–∞</option>
          <option value="apc">üöõ –ë–¢–†</option>
          <option value="tank">üõ°Ô∏è –¢–∞–Ω–∫</option>
          <option value="heli">üöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
          <option value="artillery">üí• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è</option>
          <option value="stinger">üöÄ –°—Ç—Ä—ñ–ª–µ—Ü—å ¬´–°–º–µ—Ä—á¬ª</option>
        </select>
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–†–û–ó–ú–Ü–† –ü–ï–ù–ó–õ–Ø: <span id="eBrushVal">14</span>px</div>
        <input type="range" id="eBrushSize" min="4" max="80" value="14" style="width:100%" oninput="document.getElementById('eBrushVal').textContent=this.value">
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–î–Ü–á</div>
        <button class="etool" onclick="editorClearTerrain()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ —Ç–µ—Ä–µ–Ω</button>
        <button class="etool" onclick="editorClearMarkers()">üö´ –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏</button>
        <button class="etool" onclick="editorClearAll()">üí• –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
      </div>
      <div class="editor-tool-group">
        <div class="editor-group-label">–†–û–ó–ú–Ü–©–ï–ù–û</div>
        <div id="eMarkerList" style="font-size:10px;color:var(--dim);max-height:200px;overflow-y:auto;display:flex;flex-direction:column;gap:3px;"></div>
      </div>
      <div class="editor-tool-group" style="margin-top:auto;padding-top:10px;border-top:1px solid rgba(255,255,255,.06);">
        <div class="editor-group-label">–õ–ï–ì–ï–ù–î–ê</div>
        <div style="font-size:9px;color:var(--dim);line-height:2;">
          <span style="display:inline-block;width:10px;height:10px;background:#1e40af;border-radius:2px;vertical-align:middle"></span> –í–æ–¥–∞ = –±–ª–æ–∫—É—î —Ä—É—Ö<br>
          <span style="display:inline-block;width:10px;height:10px;background:#92400e;border-radius:2px;vertical-align:middle"></span> –ú—ñ—Å—Ç = –ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –≤–æ–¥—É<br>
          <span style="display:inline-block;width:10px;height:10px;background:#166534;border-radius:2px;vertical-align:middle"></span> –õ—ñ—Å = -50% —à–≤–∏–¥–∫–æ—Å—Ç—ñ<br>
          <span style="display:inline-block;width:10px;height:10px;background:#b45309;border-radius:2px;vertical-align:middle"></span> –î–æ—Ä–æ–≥–∞ = +40% –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç<br>
          <span style="display:inline-block;width:10px;height:10px;background:#86b350;border-radius:2px;vertical-align:middle"></span> –õ—É–≥ = –Ω–æ—Ä–º–∞<br>
          –õ–ö–ú –Ω–∞ –º–∞—Ä–∫–µ—Ä—ñ = –≤–∏–¥–∞–ª–∏—Ç–∏<br>
          üßπ –°—Ç–µ—Ä—Ç–∏ = –≤—ñ–¥–Ω–æ–≤–ª—é—î —Ñ–æ—Ç–æ
        </div>
      </div>
    </div>
  </div>
</div>
<!-- LOBBY CREATE -->
<div class="screen" id="screen-lobby-create">
  <div class="lobby-box">
    <div class="lobby-title">‚öîÔ∏è –ù–û–í–ï –õ–û–ë–Ü</div>
    <div id="lcStatus" class="status-box vis warn">‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...</div>
    <div class="lobby-code-display">
      <div class="lcd-label">–ö–û–î –õ–û–ë–Ü</div>
      <div class="lcd-code" id="lcCode">----</div>
      <div class="lcd-sub">–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è –∫–æ–¥–æ–º –∑ –¥—Ä—É–≥–æ–º</div>
      <button onclick="copyLobbyCode()" style="margin-top:10px;background:rgba(34,197,94,.15);border:1px solid rgba(34,197,94,.3);color:var(--green2);padding:6px 20px;border-radius:6px;font-family:'Oswald',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;cursor:pointer;width:100%;transition:.2s;">üìã –°–ö–û–ü–Ü–Æ–í–ê–¢–ò –ö–û–î</button>
    </div>
    <div class="lobby-players">
      <div class="lp-slot p1 filled"><div class="lps-icon">üîµ</div><div class="lps-label">–°–ò–ù–Ü–ô</div><div class="lps-name" id="lcP1Name">–í–∏</div></div>
      <div class="lp-slot" id="lcP2Slot"><div class="lps-icon">‚è≥</div><div class="lps-label">–ß–ï–†–í–û–ù–ò–ô</div><div class="lps-name" id="lcP2Name">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...</div></div>
    </div>
    <div class="lobby-map-section">
      <div class="lms-title">–ö–ê–†–¢–ê</div>
      <div id="lobbyGlobalMaps" class="map-saved-list" style="margin-bottom:10px;"></div>
      <input type="file" id="mapFileInput" accept="image/*" style="display:none" onchange="handleMapUpload(this)">
      <div class="map-upload-area" onclick="document.getElementById('mapFileInput').click()" id="mapUploadArea">
        <div style="font-size:22px;margin-bottom:4px">üìÅ</div>
        <div style="font-size:11px;color:var(--dim)">–ê–±–æ –∑–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ —Å–≤–æ—î —Ñ–æ—Ç–æ –∫–∞—Ä—Ç–∏</div>
      </div>
      <img id="mapPreview" class="map-preview" alt="">
      <div style="font-size:10px;color:var(--dim);margin-top:5px;text-align:center" id="mapUploadStatus"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:14px;">
      <button class="btn-primary" id="lcStartBtn" onclick="hostStartGame()" disabled style="flex:1">‚ñ∂ –°–¢–ê–†–¢</button>
      <button class="btn-secondary" onclick="leaveLobby()">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>
<!-- LOBBY JOIN -->
<div class="screen" id="screen-lobby-join">
  <div class="lobby-box">
    <div class="lobby-title">üîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</div>
    <div id="ljStatus" class="status-box vis warn">–í–≤–µ–¥—ñ—Ç—å –∫–æ–¥ –ª–æ–±—ñ</div>
    <div class="form-row"><input type="text" class="form-input" id="joinCodeInput" placeholder="–ö–û–î –õ–û–ë–Ü" maxlength="8" style="text-transform:uppercase;letter-spacing:4px;font-size:18px;text-align:center"></div>
    <div class="form-row"><input type="text" class="form-input" id="joinNameInput" placeholder="–í–∞—à –ø–æ–∑–∏–≤–Ω–∏–π" maxlength="20"></div>
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button class="btn-primary" onclick="joinLobby()" style="flex:1">üîó –ü–†–ò–Ñ–î–ù–ê–¢–ò–°–¨</button>
      <button class="btn-secondary" onclick="showScreen('screen-menu')">‚Üê –ù–ê–ó–ê–î</button>
    </div>
  </div>
</div>
<!-- ADMIN -->
<div class="screen" id="screen-admin">
  <div class="admin-header">
    <span class="admin-title">üëë –ê–î–ú–Ü–ù –ü–ê–ù–ï–õ–¨</span>
    <div style="margin-left:auto;"><button class="hud-btn" onclick="showScreen('screen-menu')">‚Üê –ú–ï–ù–Æ</button></div>
  </div>
  <div class="admin-body">
    <div class="admin-sidebar">
      <div class="admin-nav-btn active" onclick="adminNav('maps')" id="anav-maps">üó∫Ô∏è –ö–∞—Ä—Ç–∏</div>
      <div class="admin-nav-btn" onclick="adminNav('editor')" id="anav-editor">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–æ—Ä</div>
      <div class="admin-nav-btn" onclick="adminNav('users')" id="anav-users">üë• –ì—Ä–∞–≤—Ü—ñ</div>
    </div>
    <div class="admin-content">
      <div class="admin-section active" id="asec-maps">
        <div class="admin-card">
          <div class="admin-card-title">üó∫Ô∏è –ì–õ–û–ë–ê–õ–¨–ù–Ü –ö–ê–†–¢–ò</div>
          <div style="display:flex;gap:8px;margin-bottom:14px;">
            <input type="file" id="adminMapUpload" accept="image/*" style="display:none" onchange="adminUploadMap(this)">
            <button class="btn-gold" onclick="document.getElementById('adminMapUpload').click()">+ –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ä—Ç—É</button>
            <button class="btn-secondary" onclick="adminNav('editor')">‚úèÔ∏è –ù–æ–≤–∏–π —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
          </div>
          <div id="adminMapsGrid" class="admin-maps-grid"></div>
          <div id="adminMapUploadStatus" style="font-size:11px;color:var(--dim);margin-top:8px;"></div>
        </div>
      </div>
      <div class="admin-section" id="asec-editor">
        <div class="admin-card" style="height:calc(100vh - 160px);display:flex;flex-direction:column;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:10px;flex-shrink:0;flex-wrap:wrap;">
            <div class="admin-card-title" style="margin-bottom:0">‚úèÔ∏è –†–ï–î–ê–ö–¢–û–† –ö–ê–†–¢–ò</div>
            <div style="margin-left:auto;display:flex;gap:6px;">
              <input type="file" id="editorBgUpload" accept="image/*" style="display:none" onchange="loadEditorBackground(this)">
              <button class="tool-btn" style="width:auto;padding:5px 12px" onclick="document.getElementById('editorBgUpload').click()">üì∑ –§–æ—Ç–æ</button>
              <button class="tool-btn" style="width:auto;padding:5px 12px" onclick="editorUndo()">‚Ü© –í—ñ–¥–º—ñ–Ω–∏—Ç–∏</button>
            </div>
          </div>
          <div class="map-editor-wrap" style="flex:1;min-height:0;">
            <div class="map-editor-canvas-wrap" style="position:relative;">
              <canvas id="adminMapCanvas"></canvas>
              <div id="editorMarkers" style="position:absolute;top:0;left:0;pointer-events:none;"></div>
            </div>
            <div class="map-editor-tools">
              <div class="sp-label">–Ü–ù–°–¢–†–£–ú–ï–ù–¢</div>
              <button class="tool-btn active" onclick="setEditorTool('draw')" id="tool-draw">‚úèÔ∏è –ú–∞–ª—é–≤–∞—Ç–∏</button>
              <button class="tool-btn" onclick="setEditorTool('erase')" id="tool-erase">üßπ –°—Ç–µ—Ä—Ç–∏</button>
              <button class="tool-btn" onclick="setEditorTool('fill')" id="tool-fill">ü™£ –ó–∞–ª–∏–≤–∫–∞</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–¢–ï–†–ï–ù</div>
              <button class="tool-btn" onclick="setEditorTool('water')" id="tool-water" style="color:#60a5fa">üåä –í–æ–¥–∞</button>
              <button class="tool-btn" onclick="setEditorTool('bridge')" id="tool-bridge" style="color:#a16207">üåâ –ú—ñ—Å—Ç</button>
              <button class="tool-btn" onclick="setEditorTool('forest')" id="tool-forest" style="color:#16a34a">üå≤ –õ—ñ—Å</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–†–û–ó–ú–Ü–©–ï–ù–ù–Ø</div>
              <button class="tool-btn" onclick="setEditorTool('city')" id="tool-city">üèôÔ∏è –ú—ñ—Å—Ç–æ</button>
              <button class="tool-btn" onclick="setEditorTool('base_blue')" id="tool-base_blue">üè† –ë–∞–∑–∞ –°–ò–ù–Ü–•</button>
              <button class="tool-btn" onclick="setEditorTool('base_red')" id="tool-base_red">üèöÔ∏è –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•</button>
              <div class="editor-sep"></div>
              <div class="sp-label">–ü–û–ß–ê–¢–ö–û–í–Ü –Æ–ù–Ü–¢–ò</div>
              <button class="tool-btn" onclick="setEditorTool('unit_blue')" id="tool-unit_blue">üîµ –Æ–Ω—ñ—Ç –°–ò–ù–Ü–•</button>
              <button class="tool-btn" onclick="setEditorTool('unit_red')" id="tool-unit_red">üî¥ –Æ–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•</button>
              <select id="editorUnitType" style="width:100%;margin-top:4px;background:rgba(0,0,0,.5);border:1px solid rgba(255,255,255,.1);color:#fff;padding:5px 8px;border-radius:5px;font-size:11px;">
                <option value="infantry">üë• –ü—ñ—Ö–æ—Ç–∞</option><option value="apc">üöõ –ë–¢–†</option>
                <option value="tank">üõ°Ô∏è –¢–∞–Ω–∫</option><option value="heli">üöÅ –ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä</option>
                <option value="artillery">üí• –ê—Ä—Ç–∏–ª–µ—Ä—ñ—è</option>
              </select>
              <div class="editor-sep"></div>
              <div class="sp-label">–ö–û–õ–Ü–†</div>
              <div class="color-row" id="colorSwatches"></div>
              <div class="sp-label" style="margin-top:8px">–†–û–ó–ú–Ü–†: <span id="brushSizeVal">8</span></div>
              <input type="range" id="brushSize" min="2" max="60" value="8" style="width:100%" oninput="document.getElementById('brushSizeVal').textContent=this.value">
              <div style="margin-top:10px;display:flex;flex-direction:column;gap:5px;">
                <button class="tool-btn" onclick="clearEditorCanvas()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å–µ</button>
                <button class="tool-btn" onclick="clearEditorMarkers()">üö´ –í–∏–¥–∞–ª–∏—Ç–∏ –º–∞—Ä–∫–µ—Ä–∏</button>
                <button class="btn-gold" onclick="saveEditorAsMap()" style="width:100%;margin-top:4px">üíæ –ó–±–µ—Ä–µ–≥—Ç–∏ –∫–∞—Ä—Ç—É</button>
              </div>
              <div class="sp-label" style="margin-top:10px">–†–û–ó–ú–Ü–©–ï–ù–û</div>
              <div id="editorMarkerList" style="font-size:10px;color:var(--dim);max-height:120px;overflow-y:auto;"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="admin-section" id="asec-users">
        <div class="admin-card">
          <div class="admin-card-title">üë• –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –ì–†–ê–í–¶–Ø–ú–ò</div>
          <div id="adminUsersList" style="display:flex;flex-direction:column;gap:8px;"></div>
          <button class="btn-gold" style="margin-top:12px" onclick="loadAdminUsers()">üîÑ –û–Ω–æ–≤–∏—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- GAME SCREEN -->
<div class="screen" id="screen-game">
  <div class="game-hud">
    <div class="hud-logo">‚öî –°–¢–†–ê–¢–ï–ì–Ü–Ø</div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="hud-stat-label">–•–í–ò–õ–Ø</span><span class="hud-stat-val" id="hudWave">1</span></div>
    <div class="hud-sep"></div>
    <div class="hud-stat"><span class="hud-stat-label">üí∞</span><span class="hud-stat-val" style="color:var(--gold)" id="hudFunds">2000</span></div>
    <div class="hud-center">
      <div class="hud-timer" id="hudTimer">00:00</div>
      <div class="hud-turn" id="hudPhase">–†–û–ó–ú–Ü–©–ï–ù–ù–Ø</div>
    </div>
    <div class="hud-right">
      <div class="hud-stat"><span style="color:#60a5fa">üîµ</span><span class="hud-stat-val blue" id="hudBlueUnits">0</span></div>
      <div class="hud-stat"><span style="color:#f87171">üî¥</span><span class="hud-stat-val red" id="hudRedUnits">0</span></div>
      <div class="hud-sep"></div>
      <button class="hud-btn" onclick="resetView()">‚Ü∫ –í–ò–î</button>
      <button class="hud-btn danger" onclick="confirmQuit()">–í–ò–ô–¢–ò</button>
    </div>
  </div>
  <div class="game-body" id="gameBodyOuter">
    <div class="game-area" id="gameBody">
      <canvas id="mapCanvas"></canvas>
      <canvas id="unitsCanvas"></canvas>
      <canvas id="frontCanvas"></canvas>
      <canvas id="uiCanvas"></canvas>
      <canvas id="interCanvas"></canvas>
      <div class="casualties-overlay">
        <div class="co-title">–í–¢–†–ê–¢–ò</div>
        <div class="co-row"><span class="co-blue">üîµ <span id="casBlue">0</span></span><span class="co-red">üî¥ <span id="casRed">0</span></span></div>
      </div>
      <div class="sel-info" id="selInfo">
        <div class="si-name" id="siName">‚Äî</div>
        <div style="display:flex;justify-content:space-between;margin-top:3px;">
          <span style="font-size:9px;color:var(--dim)">HP</span>
          <span style="font-family:'Oswald',sans-serif;font-size:11px" id="siHPText">‚Äî</span>
        </div>
        <div class="si-hp-bar"><div class="si-hp-fill" id="siHPBar" style="width:100%"></div></div>
        <div class="si-stats">
          <div class="si-stat"><span>–ê–¢–ö</span><b id="siAtk">‚Äî</b></div>
          <div class="si-stat"><span>–ó–ê–•</span><b id="siDef">‚Äî</b></div>
          <div class="si-stat"><span>–®–í</span><b id="siSpd">‚Äî</b></div>
          <div class="si-stat"><span>–†–ï–ñ</span><b id="siMode">‚Äî</b></div>
        </div>
        <div style="display:flex;gap:4px;margin-top:6px;">
          <button onclick="cmdSelected('advance')" style="flex:1;padding:3px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);color:var(--green2);border-radius:4px;font-family:'Oswald';font-size:9px;cursor:pointer;letter-spacing:1px;">‚ñ∂ –ê–¢–ö</button>
          <button onclick="cmdSelected('defend')" style="flex:1;padding:3px;background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3);color:#60a5fa;border-radius:4px;font-family:'Oswald';font-size:9px;cursor:pointer;letter-spacing:1px;">üõ° –ó–ê–•</button>
          <button onclick="cmdSelected('hold')" style="flex:1;padding:3px;background:rgba(245,158,11,.1);border:1px solid rgba(245,158,11,.3);color:var(--gold);border-radius:4px;font-family:'Oswald';font-size:9px;cursor:pointer;letter-spacing:1px;">‚è∏ –°–¢–Ü–ô</button>
        </div>
      </div>
      <div class="zoom-ind" id="zoomInd">100%</div>
      <div class="placement-hint" id="placementHint">–ö–õ–Ü–ö–ù–Ü–¢–¨ –ù–ê –°–í–û–á–ô –ü–û–õ–û–í–ò–ù–Ü</div>
      <div class="cmd-toolbar" id="cmdToolbar">
        <div class="cmd-btn active" id="cmdMove" onclick="setInputMode('move')">‚ö° –ü–ï–†–ï–ú–Ü–©–ï–ù–ù–Ø</div>
        <div class="cmd-btn attack-mode" id="cmdAttack" onclick="setInputMode('attack')">üéØ –ê–¢–ê–ö–ê</div>
        <div class="cmd-btn" id="cmdPatrol" onclick="setInputMode('patrol')">üîÑ –ü–ê–¢–†–£–õ–¨</div>
        <div class="cmd-btn" id="cmdSelectAll" onclick="selectAll()">‚ò∞ –í–°–Ü</div>
        <div class="cmd-btn" id="cmdStop" onclick="stopSelected()">‚èπ –°–¢–û–ü</div>
        <div class="cmd-btn" id="cmdMissile" onclick="activateMissileMode()" style="color:#a855f7;border-color:rgba(168,85,247,.4)">üöÄ –†–ê–ö–ï–¢–ê</div>
        <div id="missileStatus" style="display:none;font-size:9px;color:#a855f7;padding:4px 6px;background:rgba(168,85,247,.1);border:1px solid rgba(168,85,247,.3);border-radius:4px;font-family:'Oswald';letter-spacing:1px;">üéØ –ö–õ–Ü–ö–ù–Ü–¢–¨ –¶–Ü–õ–¨</div>
        <div class="cmd-btn" style="color:var(--dim);font-size:9px;cursor:default;border-color:transparent;">‚áß SHIFT = –º—É–ª—å—Ç–∏</div>
      </div>
      <div id="incomeFloaters" style="position:absolute;inset:0;pointer-events:none;z-index:50;overflow:hidden;"></div>
    </div>
    <div class="side-panel" id="sidePanel">
      <div class="sp-section">
        <div class="sp-label">–†–ï–°–£–†–°–ò</div>
        <div class="sp-resources">
          <div class="sp-res-row"><span class="sp-res-label">üí∞ –§–û–ù–î–ò</span><span class="sp-res-val" style="color:var(--gold)" id="spFunds">0</span></div>
          <div class="sp-res-row"><span class="sp-res-label">üèôÔ∏è –î–û–•–û–î/15—Å</span><span class="sp-res-val" style="color:var(--green)" id="spIncome">0</span></div>
          <div class="sp-res-row"><span class="sp-res-label">‚öîÔ∏è –Æ–ù–Ü–¢–ò</span><span class="sp-res-val" style="color:var(--blue)" id="spUnits">0</span></div>
          <div class="sp-res-row"><span class="sp-res-label">üíÄ –í–¢–†–ê–¢–ò</span><span class="sp-res-val" style="color:var(--red)" id="spCasualties">0</span></div>
        </div>
      </div>
      <div class="sp-section">
        <div class="sp-label">üèôÔ∏è –ú–Ü–°–¢–ê</div>
        <div id="citiesList" class="cities-hud" style="padding:0;"></div>
      </div>
      <div class="sp-section">
        <div class="sp-label">–†–û–ó–ú–Ü–°–¢–ò–¢–ò –Æ–ù–Ü–¢</div>
        <div id="unitTypesList"></div>
        <button class="hud-btn" style="width:100%;margin-top:6px;padding:8px" onclick="startBattle()">‚ñ∂ –ü–û–ß–ê–¢–ò –ë–Ü–ô (Space)</button>
      </div>
      <div class="sp-section"><div class="sp-label">–ë–û–ô–û–í–ò–ô –ñ–£–†–ù–ê–õ</div></div>
      <div class="sp-log" id="spLog"></div>
    </div>
  </div>
  <div class="result-overlay" id="resultOverlay">
    <div class="result-box">
      <div class="result-emoji" id="resultEmoji">üèÜ</div>
      <div class="result-title" id="resultTitle">–ü–ï–†–ï–ú–û–ì–ê</div>
      <div class="result-sub" id="resultSub"></div>
      <button class="btn-primary" style="width:100%" onclick="backToMenu()">‚Üê –ì–û–õ–û–í–ù–ï –ú–ï–ù–Æ</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>

<script type="module">
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import{getFirestore,doc,setDoc,getDoc,updateDoc,onSnapshot,deleteDoc,collection,getDocs,serverTimestamp}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
import{getAuth,signInAnonymously,onAuthStateChanged,createUserWithEmailAndPassword,signInWithEmailAndPassword,signOut,updateProfile}from"https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

const fbApp=initializeApp({apiKey:"AIzaSyAXTOcA4I5AYP0jfbVWb1de-lZjwf1DRhc",authDomain:"ctratigia.firebaseapp.com",projectId:"ctratigia",storageBucket:"ctratigia.firebasestorage.app",messagingSenderId:"71283939831",appId:"1:71283939831:web:6725da39c4b58c0065b6f2"});
const db=getFirestore(fbApp);const auth=getAuth(fbApp);
const CL_CLOUD='dimpa9w8w',CL_PRESET='ctratigia_map';

let uid=null,myName='–ì—Ä–∞–≤–µ—Ü—å',isAdmin=false,isAnon=true;
let lobbyId=null,myRole=null,lobbyUnsub=null,gameUnsub=null,presenceUnsub=null;
let isAI=false,aiMode='defense',aiTeam='red';
let G={};
let mapBg=null,mapBgW=0,mapBgH=0;
let camX=0,camY=0,camScale=1;
let isDragging=false,dragLX=0,dragLY=0;
let selectedUnitId=null,placingType=null;
let gamePhase='placement',gameTimer=0,timerInterval=null,animFrame=null,gameOver=false;
let dcInterval=null,incomeInterval=null;
let editorHistoryStack=[],editorBg=null;
// ‚îÄ‚îÄ‚îÄ Editor zoom state ‚îÄ‚îÄ‚îÄ
let eCtx=null,eTool='draw',eDrawing=false,eLX=0,eLY=0;
let eHistory=[],eBg=null,eBgX=0,eBgY=0,eBgW=0,eBgH=0;
let eMarkers=[],eMapName='–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞',eMapIdx=-1;
// NEW: editor uses CSS transform zoom instead of camera math
let eScale=1,ePanX=0,ePanY=0,ePanning=false,ePanLX=0,ePanLY=0;
let eTerrainCtx=null; // separate offscreen canvas for terrain strokes only
let editorEditingMapIdx=-1,editorMarkers=[],editorCtx=null,editorTool='draw',editorColor='#22c55e',editorSize=8,editorDrawing=false,editorLastX=0,editorLastY=0;
let inputMode='move',patrolPoint1=null,selectedUnitIds=new Set(),projectiles=[],missileTargetMode=false;
// G_terrain replaced by pixel-based system (G_terrainPixels)

const UNIT_DEFS={
  infantry:{name:'–ü—ñ—Ö–æ—Ç–∞',emoji:'üë•',radius:8,hp:100,maxHp:100,atk:12,def:5,speed:18,range:40,cost:150},
  apc:{name:'–ë–¢–†',emoji:'üöõ',radius:10,hp:200,maxHp:200,atk:20,def:15,speed:28,range:50,cost:350},
  tank:{name:'–¢–∞–Ω–∫',emoji:'üõ°Ô∏è',radius:12,hp:350,maxHp:350,atk:40,def:30,speed:20,range:60,cost:600},
  heli:{name:'–ì–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä',emoji:'üöÅ',radius:9,hp:150,maxHp:150,atk:35,def:5,speed:55,range:80,cost:500},
  artillery:{name:'–ê—Ä—Ç–∏–ª–µ—Ä—ñ—è',emoji:'üí•',radius:8,hp:120,maxHp:120,atk:70,def:3,speed:10,range:200,cost:700},
  stinger:{name:'–°—Ç—Ä—ñ–ª–µ—Ü—å ¬´–°–º–µ—Ä—á¬ª',emoji:'üöÄ',radius:8,hp:90,maxHp:90,atk:95,def:2,speed:8,range:380,cost:850,isMissile:true},
};
const CITY_INCOME=150,BASE_INCOME=50;
const EDITOR_COLORS=['#22c55e','#3b82f6','#ef4444','#f59e0b','#8b5cf6','#06b6d4','#ffffff','#1a2810','#5c3d1a','#1e3a5f','#0d2d4a','#000000','#6b7280'];
// Terrain paint colors ‚Äî stored AS-IS in canvas pixels, sampled at runtime for logic
const TERRAIN_COLORS={
  water:  {r:30, g:64, b:175},   // #1e40af blue
  forest: {r:22, g:101,b:52},    // #166534 dark green  
  road:   {r:180,g:83, b:9},     // #b45309 amber
  bridge: {r:146,g:64, b:14},    // #92400e dark amber
  meadow: {r:134,g:179,b:80},    // #86b350 light green (normal speed field)
};
const ECOLORS_TERRAIN={
  water:  '#1e40af',
  forest: '#166534',
  road:   '#b45309',
  bridge: '#92400e',
  meadow: '#86b350',
  draw:   '#22c55e',
  erase:  null
};
// Terrain pixel map (sampled from editor canvas, used for fast game-time lookup)
let G_terrainPixels=null,G_terrainW=0,G_terrainH=0;
function sampleTerrainAt(wx,wy){
  if(!G_terrainPixels||!G_terrainW||!G_terrainH)return'none';
  const mw=mapBgW||2000,mh=mapBgH||1200;
  const px=Math.round(wx/mw*G_terrainW),py=Math.round(wy/mh*G_terrainH);
  if(px<0||py<0||px>=G_terrainW||py>=G_terrainH)return'none';
  const i=(py*G_terrainW+px)*4;
  const r=G_terrainPixels[i],g=G_terrainPixels[i+1],b=G_terrainPixels[i+2],a=G_terrainPixels[i+3];
  if(a<30)return'none';
  // Match by color distance
  let best='none',bestD=60;
  for(const[name,c]of Object.entries(TERRAIN_COLORS)){
    const d=Math.sqrt((r-c.r)**2+(g-c.g)**2+(b-c.b)**2);
    if(d<bestD){bestD=d;best=name;}
  }
  return best;
}
function buildTerrainPixelMap(terrainCanvas){
  if(!terrainCanvas)return;
  const W=256,H=Math.round(256*(mapBgH||1200)/(mapBgW||2000));
  const oc=document.createElement('canvas');oc.width=W;oc.height=H;
  const ctx=oc.getContext('2d');
  ctx.drawImage(terrainCanvas,0,0,W,H);
  G_terrainPixels=ctx.getImageData(0,0,W,H).data;
  G_terrainW=W;G_terrainH=H;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLdText(t){const el=document.getElementById('ldText');if(el)el.textContent=t;}
window.addEventListener('DOMContentLoaded',async()=>{setLdText('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è...');await new Promise(r=>setTimeout(r,500));if(!auth.currentUser)await signInAnonymously(auth).catch(()=>{});});
onAuthStateChanged(auth,async user=>{
  if(user){
    uid=user.uid;isAnon=user.isAnonymous;
    myName=user.displayName||(isAnon?'–ì—Ä–∞–≤–µ—Ü—å_'+uid.slice(-4).toUpperCase():user.email?.split('@')[0]||'–ì—Ä–∞–≤–µ—Ü—å');
    if(!isAnon){const usnap=await getDoc(doc(db,'users',uid)).catch(()=>null);isAdmin=usnap?.data()?.role==='admin';}else{isAdmin=false;}
    updateMenuUI();document.getElementById('loadingScreen').classList.add('hidden');showScreen('screen-menu');initGameCanvases();buildUnitList();loadGlobalMaps();
  }
});
function updateMenuUI(){
  document.getElementById('menuUserName').textContent=myName;
  const badge=document.getElementById('menuUserBadge');
  if(isAdmin){badge.textContent='–ê–î–ú–Ü–ù';badge.className='menu-user-badge badge-admin';}
  else if(!isAnon){badge.textContent='–ì–†–ê–í–ï–¶–¨';badge.className='menu-user-badge';}
  else{badge.textContent='–ì–Ü–°–¢–¨';badge.className='menu-user-badge badge-anon';}
  document.getElementById('adminMenuBtn').style.display=isAdmin?'block':'none';
  document.getElementById('authMenuBtn').style.display=isAnon?'block':'none';
  document.getElementById('logoutBtn').style.display=!isAnon?'block':'none';
}
window.showAuthModal=()=>document.getElementById('authModal').classList.add('vis');
window.closeAuthModal=()=>document.getElementById('authModal').classList.remove('vis');
window.switchAuthTab=tab=>{
  document.querySelectorAll('.modal-tab').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
  document.querySelectorAll('.modal-tab-content').forEach((t,i)=>t.classList.toggle('active',i===(tab==='login'?0:1)));
};
window.doLogin=async()=>{const em=document.getElementById('loginEmail').value.trim(),pw=document.getElementById('loginPass').value;setStatus('loginStatus','‚ü≥ –í—Ö—ñ–¥...','warn');try{await signInWithEmailAndPassword(auth,em,pw);closeAuthModal();}catch(e){setStatus('loginStatus','‚ùå '+friendlyAuthErr(e),'err');}};
window.doRegister=async()=>{
  const nm=document.getElementById('regName').value.trim(),em=document.getElementById('regEmail').value.trim(),pw=document.getElementById('regPass').value;
  if(!nm){setStatus('registerStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –ø–æ–∑–∏–≤–Ω–∏–π','err');return;}
  if(pw.length<6){setStatus('registerStatus','‚ùå –ü–∞—Ä–æ–ª—å –º—ñ–Ω. 6 —Å–∏–º–≤–æ–ª—ñ–≤','err');return;}
  setStatus('registerStatus','‚ü≥ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è...','warn');
  try{const cred=await createUserWithEmailAndPassword(auth,em,pw);await updateProfile(cred.user,{displayName:nm});await setDoc(doc(db,'users',cred.user.uid),{name:nm,email:em,role:'player',createdAt:serverTimestamp()});closeAuthModal();}
  catch(e){setStatus('registerStatus','‚ùå '+friendlyAuthErr(e),'err');}
};
window.doLogout=async()=>{await signOut(auth);await signInAnonymously(auth);};
function friendlyAuthErr(e){
  if(e.code==='auth/email-already-in-use')return'Email –≤–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è';
  if(e.code==='auth/wrong-password'||e.code==='auth/invalid-credential')return'–ù–µ–≤—ñ—Ä–Ω–∏–π email –∞–±–æ –ø–∞—Ä–æ–ª—å';
  if(e.code==='auth/too-many-requests')return'–ó–∞–±–∞–≥–∞—Ç–æ —Å–ø—Ä–æ–±. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ';
  return e.message||'–ü–æ–º–∏–ª–∫–∞';
}
function setStatus(id,msg,type){const el=document.getElementById(id);if(!el)return;el.textContent=msg;el.className='status-box vis';if(type)el.classList.add(type);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI MODE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedAIMode='defense',selectedAITeam='blue';
window.showAIModeSelect=()=>document.getElementById('aiModeModal').classList.add('vis');
window.closeAIModeModal=()=>document.getElementById('aiModeModal').classList.remove('vis');
window.selectAIMode=mode=>{selectedAIMode=mode;document.querySelectorAll('.ai-mode-card').forEach(c=>c.classList.remove('selected'));document.getElementById('aimode-'+mode)?.classList.add('selected');};
window.selectAITeam=team=>{selectedAITeam=team;document.getElementById('teamBtnBlue').classList.toggle('selected',team==='blue');document.getElementById('teamBtnRed').classList.toggle('selected',team==='red');};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL MAPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let globalMaps=[];
async function loadGlobalMaps(){
  try{const snap=await getDoc(doc(db,'appData','globalMaps'));globalMaps=snap.exists()?(snap.data().maps||[]):[];renderLobbyGlobalMaps();if(isAdmin)renderAdminMaps();if(globalMaps.length>0&&!mapBgW)loadMapFromUrl(globalMaps[0].url);}catch(e){}
}
function renderLobbyGlobalMaps(){
  const el=document.getElementById('lobbyGlobalMaps');if(!el)return;
  if(!globalMaps.length){el.innerHTML='<div style="font-size:10px;color:var(--dim);text-align:center;padding:8px">–ù–µ–º–∞—î –∑–±–µ—Ä–µ–∂–µ–Ω–∏—Ö –∫–∞—Ä—Ç</div>';return;}
  el.innerHTML=globalMaps.map((m,i)=>`<div class="map-saved-item" onclick="selectGlobalMap(${i})" id="gmap_${i}"><img src="${m.url}" class="msi-thumb" onerror="this.style.display='none'"><div class="msi-info"><div class="msi-name">${m.name}</div><div class="msi-date">${m.date||''} ${m.cities?'| üèôÔ∏è'+m.cities.length+' –º—ñ—Å—Ç':''}</div></div></div>`).join('');
}
window.selectGlobalMap=async(i)=>{
  const m=globalMaps[i];
  document.querySelectorAll('.map-saved-item').forEach(e=>e.classList.remove('active'));
  document.getElementById('gmap_'+i)?.classList.add('active');
  loadMapFromUrl(m.url);
  if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrl:m.url,mapIdx:i,mapVer:Date.now().toString()}).catch(()=>{});
  document.getElementById('mapPreview').style.display='none';document.getElementById('mapUploadArea').style.display='block';
  toast('‚úÖ –ö–∞—Ä—Ç–∞ –≤–∏–±—Ä–∞–Ω–∞: '+m.name);
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN MAPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.adminUploadMap=async(input)=>{
  const file=input.files[0];if(!file)return;
  const st=document.getElementById('adminMapUploadStatus');st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';
  try{const comp=await compressImage(file,3000,3000,.85);st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';const url=await uploadCloudinary(comp,'admin_map_'+Date.now());const name=file.name.replace(/\.[^.]+$/,'').slice(0,30);const date=new Date().toLocaleDateString('uk-UA');globalMaps.push({url,name,date,cities:[],water:[],bridges:[],spawns:null});await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});st.textContent='‚úÖ –ö–∞—Ä—Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–∞!';renderAdminMaps();renderLobbyGlobalMaps();toast('‚úÖ –ö–∞—Ä—Ç–∞ –¥–æ–¥–∞–Ω–∞!');input.value='';}
  catch(e){st.textContent='‚ùå '+e.message;}
};
function renderAdminMaps(){
  const el=document.getElementById('adminMapsGrid');if(!el)return;
  if(!globalMaps.length){el.innerHTML='<div style="font-size:11px;color:var(--dim)">–ù–µ–º–∞—î –∫–∞—Ä—Ç.</div>';return;}
  el.innerHTML=globalMaps.map((m,i)=>`<div class="admin-map-card" id="amc_${i}"><img src="${m.url}" class="amc-img" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1 1%22/>'"><div class="amc-info"><div class="amc-name">${m.name}</div><div class="amc-meta">${m.date||''} ${m.cities?'üèôÔ∏è'+m.cities.length:'0'} –º—ñ—Å—Ç</div><div class="amc-actions"><button class="amc-btn set" onclick="adminSetActiveMap(${i})">‚úÖ</button><button class="amc-btn edit" onclick="adminEditMap(${i})">‚úèÔ∏è</button><button class="amc-btn del" onclick="adminDeleteMap(${i})">üóëÔ∏è</button></div></div></div>`).join('');
}
window.adminSetActiveMap=async(i)=>{const m=globalMaps.splice(i,1)[0];globalMaps.unshift(m);await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});renderAdminMaps();renderLobbyGlobalMaps();toast('‚úÖ –ê–∫—Ç–∏–≤–Ω–∞ –∫–∞—Ä—Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');};
window.adminDeleteMap=async(i)=>{if(!confirm('–í–∏–¥–∞–ª–∏—Ç–∏?'))return;globalMaps.splice(i,1);await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});renderAdminMaps();renderLobbyGlobalMaps();toast('üóëÔ∏è –í–∏–¥–∞–ª–µ–Ω–æ');};
window.adminEditMap=async(i)=>{adminNav('editor');editorEditingMapIdx=i;const m=globalMaps[i];editorMarkers=[];if(m.spawns){if(m.spawns.blueBase)editorMarkers.push({type:'base',team:'blue',nx:m.spawns.blueBase.nx,ny:m.spawns.blueBase.ny,px:0,py:0});if(m.spawns.redBase)editorMarkers.push({type:'base',team:'red',nx:m.spawns.redBase.nx,ny:m.spawns.redBase.ny,px:0,py:0});(m.spawns.units||[]).forEach(u=>editorMarkers.push({type:'unit',team:u.team,unitType:u.unitType,nx:u.nx,ny:u.ny,px:0,py:0}));}(m.cities||[]).forEach(c=>editorMarkers.push({type:'city',nx:c.nx,ny:c.ny,name:c.name,px:0,py:0}));editorBg=null;const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{editorBg=img;drawEditorBase();const cv=document.getElementById('adminMapCanvas');if(cv){editorMarkers.forEach(mk=>{mk.px=mk.nx*cv.width;mk.py=mk.ny*cv.height;});}renderEditorMarkers();updateEditorMarkerList();};img.src=m.url;toast('‚úèÔ∏è –†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è: '+m.name);};
window.adminNav=section=>{document.querySelectorAll('.admin-section').forEach(s=>s.classList.remove('active'));document.querySelectorAll('.admin-nav-btn').forEach(b=>b.classList.remove('active'));document.getElementById('asec-'+section)?.classList.add('active');document.getElementById('anav-'+section)?.classList.add('active');if(section==='editor')initEditor();if(section==='maps'){renderAdminMaps();loadGlobalMaps();}if(section==='users')loadAdminUsers();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN EDITOR (in admin panel)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initEditor(){
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  const wrap=cv.parentElement;cv.width=wrap.clientWidth||900;cv.height=wrap.clientHeight||550;
  editorCtx=cv.getContext('2d');editorHistoryStack=[];drawEditorBase();
  const sw=document.getElementById('colorSwatches');if(sw)sw.innerHTML=EDITOR_COLORS.map(c=>`<div class="color-swatch ${c===editorColor?'active':''}" style="background:${c}" onclick="setEditorColor('${c}')"></div>`).join('');
  cv.onmousedown=e=>{if(editorTool.startsWith('base_')||editorTool.startsWith('unit_')||editorTool==='city'){placeEditorMarker(e.offsetX,e.offsetY);return;}if(editorTool==='fill'){floodFill(e.offsetX,e.offsetY);return;}saveEditorHistory();editorDrawing=true;editorLastX=e.offsetX;editorLastY=e.offsetY;};
  cv.onmousemove=e=>{if(!editorDrawing)return;if(editorTool==='water')drawTerrainStroke(e,'#1e40af',editorSize);else if(editorTool==='bridge')drawTerrainStroke(e,'#92400e',editorSize*.6);else if(editorTool==='forest')drawTerrainStroke(e,'#166534',editorSize);else if(editorTool==='erase')drawTerrainStroke(e,editorBg?null:'#1a2810',editorSize*2,true);else drawTerrainStroke(e,editorColor,editorSize);};
  cv.onmouseup=cv.onmouseleave=()=>{editorDrawing=false;};
  const bs=document.getElementById('brushSize');if(bs)bs.oninput=e=>{editorSize=+e.target.value;};
}
function drawTerrainStroke(e,color,size,erase=false){
  if(erase&&editorBg){editorCtx.drawImage(editorBg,e.offsetX-size,e.offsetY-size,size*2,size*2,e.offsetX-size,e.offsetY-size,size*2,size*2);}
  else{editorCtx.strokeStyle=color;editorCtx.lineWidth=size;editorCtx.lineCap='round';editorCtx.lineJoin='round';editorCtx.beginPath();editorCtx.moveTo(editorLastX,editorLastY);editorCtx.lineTo(e.offsetX,e.offsetY);editorCtx.stroke();}
  editorLastX=e.offsetX;editorLastY=e.offsetY;
}
function floodFill(sx,sy){
  saveEditorHistory();const cv=document.getElementById('adminMapCanvas');const imgData=editorCtx.getImageData(0,0,cv.width,cv.height);const data=imgData.data;const idx=(x,y)=>(y*cv.width+x)*4;const target=[data[idx(sx,sy)],data[idx(sx,sy)+1],data[idx(sx,sy)+2],data[idx(sx,sy)+3]];const fill=hexToRgb(editorColor);if(!fill)return;if(target[0]===fill.r&&target[1]===fill.g&&target[2]===fill.b)return;const stack=[[sx,sy]];const visited=new Uint8Array(cv.width*cv.height);while(stack.length){const[x,y]=stack.pop();if(x<0||x>=cv.width||y<0||y>=cv.height)continue;const i=idx(x,y);const vi=y*cv.width+x;if(visited[vi])continue;visited[vi]=1;if(Math.abs(data[i]-target[0])>30||Math.abs(data[i+1]-target[1])>30||Math.abs(data[i+2]-target[2])>30)continue;data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=255;stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);}editorCtx.putImageData(imgData,0,0);
}
function hexToRgb(hex){const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return{r,g,b};}
function saveEditorHistory(){const cv=document.getElementById('adminMapCanvas');if(!editorCtx||!cv)return;editorHistoryStack.push(editorCtx.getImageData(0,0,cv.width,cv.height));if(editorHistoryStack.length>30)editorHistoryStack.shift();}
window.editorUndo=()=>{if(!editorHistoryStack.length){toast('‚ö†Ô∏è –ù–µ–º–∞ —â–æ –≤—ñ–¥–º—ñ–Ω–∏—Ç–∏');return;}const imgData=editorHistoryStack.pop();editorCtx.putImageData(imgData,0,0);renderEditorMarkers();};
window.loadEditorBackground=input=>{const file=input.files[0];if(!file)return;const img=new Image();img.onload=()=>{editorBg=img;const cv=document.getElementById('adminMapCanvas');if(!cv)return;saveEditorHistory();editorCtx.clearRect(0,0,cv.width,cv.height);editorCtx.drawImage(img,0,0,cv.width,cv.height);};img.src=URL.createObjectURL(file);toast('üì∑ –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ');};
function drawEditorBase(){const cv=document.getElementById('adminMapCanvas');if(!editorCtx||!cv)return;if(editorBg){editorCtx.drawImage(editorBg,0,0,cv.width,cv.height);return;}editorCtx.fillStyle='#1a2810';editorCtx.fillRect(0,0,cv.width,cv.height);editorCtx.strokeStyle='rgba(255,255,255,.18)';editorCtx.lineWidth=2;editorCtx.setLineDash([10,8]);editorCtx.beginPath();editorCtx.moveTo(cv.width/2,0);editorCtx.lineTo(cv.width/2,cv.height);editorCtx.stroke();editorCtx.setLineDash([]);}
function placeEditorMarker(px,py){const cv=document.getElementById('adminMapCanvas');if(!cv)return;const isBase=editorTool.startsWith('base_');const team=editorTool.split('_')[1];const unitType=document.getElementById('editorUnitType')?.value||'infantry';const nx=px/cv.width,ny=py/cv.height;if(isBase){editorMarkers=editorMarkers.filter(m=>!(m.type==='base'&&m.team===team));}if(editorTool==='city'){const name=prompt('–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞:','–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=>m.type==='city').length+1))||('–ú—ñ—Å—Ç–æ '+(editorMarkers.filter(m=>m.type==='city').length+1));editorMarkers.push({type:'city',nx,ny,name,px,py});}else{editorMarkers.push({type:isBase?'base':'unit',team:isBase?team:editorTool.split('_')[1],unitType:isBase?null:unitType,nx,ny,px,py});}renderEditorMarkers();updateEditorMarkerList();}
function renderEditorMarkers(){const wrap=document.getElementById('editorMarkers');const cv=document.getElementById('adminMapCanvas');if(!wrap||!cv)return;wrap.innerHTML=editorMarkers.map((m,i)=>{let emoji;if(m.type==='city')emoji='üèôÔ∏è';else if(m.type==='base')emoji=m.team==='blue'?'üè†':'üèöÔ∏è';else emoji=UNIT_DEFS[m.unitType]?.emoji||'‚ö™';const px=m.nx*cv.width,py=m.ny*cv.height;return`<div style="position:absolute;left:${px-14}px;top:${py-14}px;font-size:20px;cursor:pointer;pointer-events:auto" onclick="removeEditorMarker(${i})">${emoji}</div>`;}).join('');wrap.style.pointerEvents='none';}
function updateEditorMarkerList(){const el=document.getElementById('editorMarkerList');if(!el)return;if(!editorMarkers.length){el.textContent='–ù–µ–º–∞—î –º–∞—Ä–∫–µ—Ä—ñ–≤';return;}el.innerHTML=editorMarkers.map((m,i)=>{const label=m.type==='city'?`üèôÔ∏è ${m.name}`:m.type==='base'?`–ë–∞–∑–∞ ${m.team}`:`${UNIT_DEFS[m.unitType]?.name||m.unitType} (${m.team})`;return`<div style="display:flex;justify-content:space-between;padding:2px 0;border-bottom:1px solid rgba(255,255,255,.04)"><span>${label}</span><span style="cursor:pointer;color:#f87171" onclick="removeEditorMarker(${i})">‚úï</span></div>`;}).join('');}
window.removeEditorMarker=i=>{editorMarkers.splice(i,1);renderEditorMarkers();updateEditorMarkerList();};
window.clearEditorMarkers=()=>{editorMarkers=[];renderEditorMarkers();updateEditorMarkerList();toast('üóëÔ∏è –ú–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');};
window.setEditorTool=t=>{editorTool=t;document.querySelectorAll('.tool-btn[id^="tool-"]').forEach(b=>b.classList.remove('active'));document.getElementById('tool-'+t)?.classList.add('active');};
window.setEditorColor=c=>{editorColor=c;document.querySelectorAll('.color-swatch').forEach(s=>s.classList.toggle('active',s.style.background===c||s.style.backgroundColor===c));};
window.clearEditorCanvas=()=>{if(!editorCtx)return;editorHistoryStack=[];editorBg=null;drawEditorBase();toast('üóëÔ∏è –ü–æ–ª–æ—Ç–Ω–æ –æ—á–∏—â–µ–Ω–æ');};
window.saveEditorAsMap=async()=>{
  const cv=document.getElementById('adminMapCanvas');if(!cv)return;
  let name='–ú–æ—è –∫–∞—Ä—Ç–∞';if(editorEditingMapIdx>=0)name=globalMaps[editorEditingMapIdx].name;else{const n=prompt('–ù–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏:','–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞');if(n===null)return;name=n||'–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';}
  const dataUrl=cv.toDataURL('image/jpeg',.92);toast('‚ü≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ...');
  try{const url=await uploadCloudinary(dataUrl,'editor_map_'+(editorEditingMapIdx>=0?'edit_'+editorEditingMapIdx:'new_'+Date.now()));const date=new Date().toLocaleDateString('uk-UA');const spawns={blueBase:editorMarkers.find(m=>m.type==='base'&&m.team==='blue')||null,redBase:editorMarkers.find(m=>m.type==='base'&&m.team==='red')||null,units:editorMarkers.filter(m=>m.type==='unit').map(m=>({team:m.team,unitType:m.unitType,nx:m.nx,ny:m.ny}))};const cities=editorMarkers.filter(m=>m.type==='city').map(m=>({nx:m.nx,ny:m.ny,name:m.name}));const mapEntry={url,name,date,spawns,cities};if(editorEditingMapIdx>=0){globalMaps[editorEditingMapIdx]=mapEntry;}else{globalMaps.push(mapEntry);}await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});toast('‚úÖ "'+name+'" –∑–±–µ—Ä–µ–∂–µ–Ω–∞!');editorMarkers=[];editorEditingMapIdx=-1;adminNav('maps');}
  catch(e){toast('‚ùå '+e.message);}
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NEW STANDALONE MAP EDITOR  ‚Üê FIX #4: proper zoom via CSS transform
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.openMapEditor=(mapIdx=-1)=>{
  showScreen('screen-editor');eMapIdx=mapIdx;initNewEditor();editorPopulateMapSelect();
  const loadIdx=mapIdx>=0?mapIdx:(globalMaps.length>0?0:-1);
  if(loadIdx>=0&&globalMaps[loadIdx]){eMapIdx=loadIdx;eMapName=globalMaps[loadIdx].name;const el=document.getElementById('editorMapName');if(el)el.textContent=eMapName;const sel=document.getElementById('editorMapSelect');if(sel)sel.value=String(loadIdx);setTimeout(()=>eLoadMapForEditing(globalMaps[loadIdx]),80);}
};
function editorPopulateMapSelect(){
  const sel=document.getElementById('editorMapSelect');if(!sel)return;
  sel.innerHTML='<option value="-1">+ –ù–æ–≤–∞ –∫–∞—Ä—Ç–∞</option>';
  globalMaps.forEach((m,i)=>{const opt=document.createElement('option');opt.value=String(i);opt.textContent=m.name||(i+1+'. –ö–∞—Ä—Ç–∞');sel.appendChild(opt);});
  if(eMapIdx>=0)sel.value=String(eMapIdx);
}
window.editorSwitchMap=idxStr=>{
  const i=parseInt(idxStr);
  if(i<0){eMapIdx=-1;eMapName='–ù–æ–≤–∞ –∫–∞—Ä—Ç–∞';eHistory=[];eMarkers=[];eBg=null;eDrawDefaultBg();eRedrawMarkersOverlay();eUpdateMarkerList();document.getElementById('editorMapName').textContent=eMapName;return;}
  if(!globalMaps[i])return;eMapIdx=i;eMapName=globalMaps[i].name;document.getElementById('editorMapName').textContent=eMapName;eLoadMapForEditing(globalMaps[i]);
};

// Editor uses a native high-res canvas (4K) ‚Äî CSS transform zooms it without pixelation
const EDITOR_NATIVE_W=3840,EDITOR_NATIVE_H=2160;
let eInitScale=1; // scale that fits canvas to viewport at 100%

function initNewEditor(){
  const area=document.getElementById('editorCanvasArea');
  const cv=document.getElementById('editorCanvas');
  if(!area||!cv)return;
  const aW=Math.max(1,area.clientWidth),aH=Math.max(1,area.clientHeight);
  // Canvas is always 4K ‚Äî no pixelation at any zoom level
  cv.width=EDITOR_NATIVE_W;cv.height=EDITOR_NATIVE_H;
  cv.style.width=EDITOR_NATIVE_W+'px';cv.style.height=EDITOR_NATIVE_H+'px';
  const ov=document.getElementById('editorOverlay');
  if(ov){ov.style.width=EDITOR_NATIVE_W+'px';ov.style.height=EDITOR_NATIVE_H+'px';}
  const wrap=document.getElementById('editorZoomWrap');
  if(wrap){wrap.style.width=EDITOR_NATIVE_W+'px';wrap.style.height=EDITOR_NATIVE_H+'px';}
  eCtx=cv.getContext('2d');
  eCtx.imageSmoothingEnabled=true;eCtx.imageSmoothingQuality='high';
  // Separate terrain canvas ‚Äî only strokes, no background
  const terrainCv=document.createElement('canvas');
  terrainCv.width=EDITOR_NATIVE_W;terrainCv.height=EDITOR_NATIVE_H;
  eTerrainCtx=terrainCv.getContext('2d');
  eTerrainCtx.imageSmoothingEnabled=true;eTerrainCtx.imageSmoothingQuality='high';
  eHistory=[];eMarkers=[];
  // Fit canvas to area at init
  eInitScale=Math.min(aW/EDITOR_NATIVE_W,aH/EDITOR_NATIVE_H);
  eScale=eInitScale;ePanX=0;ePanY=0;ePanning=false;eBg=null;
  eDrawDefaultBg();eUpdateMarkerList();
  applyEditorTransform();
  area.onmousedown=eOnMD;area.onmousemove=eOnMM;area.onmouseup=area.onmouseleave=eOnMU;
  area.onwheel=e=>{
    e.preventDefault();
    const r=area.getBoundingClientRect();
    const mx=e.clientX-r.left,my=e.clientY-r.top;
    const f=e.deltaY<0?1.12:0.89;
    const ns=Math.max(eInitScale*.3,Math.min(8,eScale*f));
    ePanX=mx-(mx-ePanX)*(ns/eScale);
    ePanY=my-(my-ePanY)*(ns/eScale);
    eScale=ns;
    applyEditorTransform();
    document.getElementById('editorZoomInd').textContent=Math.round(eScale/eInitScale*100)+'%';
  };
  area.oncontextmenu=e=>{e.preventDefault();eHandleRightClick(e);};
  document.addEventListener('keydown',eKeyHandler);
}

function applyEditorTransform(){
  const wrap=document.getElementById('editorZoomWrap');if(!wrap)return;
  wrap.style.transform=`translate(${ePanX}px,${ePanY}px) scale(${eScale})`;
  // Overlay must match
  const ov=document.getElementById('editorOverlay');
  if(ov&&eCtx){ov.style.width=eCtx.canvas.width+'px';ov.style.height=eCtx.canvas.height+'px';}
}

// Convert screen coords ‚Üí canvas coords (accounting for pan+zoom)
function screenToCanvas(sx,sy){
  return{cx:(sx-ePanX)/eScale,cy:(sy-ePanY)/eScale};
}

window.eZoomIn=()=>eZoom(1.2);
window.eZoomOut=()=>eZoom(0.85);
function eZoom(f){
  if(!eCtx)return;
  const area=document.getElementById('editorCanvasArea');
  const cx=(area?.clientWidth||800)/2,cy=(area?.clientHeight||600)/2;
  const ns=Math.max(eInitScale*.3,Math.min(8,eScale*f));
  ePanX=cx-(cx-ePanX)*(ns/eScale);ePanY=cy-(cy-ePanY)*(ns/eScale);eScale=ns;
  applyEditorTransform();
  document.getElementById('editorZoomInd').textContent=Math.round(eScale/eInitScale*100)+'%';
}
window.eZoomReset=()=>{eScale=eInitScale;ePanX=0;ePanY=0;applyEditorTransform();document.getElementById('editorZoomInd').textContent='100%';};

function eOnMD(e){
  e.preventDefault();
  const area=document.getElementById('editorCanvasArea');const r=area.getBoundingClientRect();
  const sx=e.clientX-r.left,sy=e.clientY-r.top;
  const{cx,cy}=screenToCanvas(sx,sy);
  if(eTool==='move'||e.button===1){ePanning=true;ePanLX=sx;ePanLY=sy;return;}
  if(eTool.startsWith('base_')||eTool.startsWith('unit_')||eTool==='city'){ePlaceMarker(cx,cy);return;}
  if(eTool==='fill'){eFloodFill(Math.round(cx),Math.round(cy));return;}
  eHistoryPush();eDrawing=true;eLX=cx;eLY=cy;
}
function eOnMM(e){
  e.preventDefault();
  const area=document.getElementById('editorCanvasArea');const r=area.getBoundingClientRect();
  const sx=e.clientX-r.left,sy=e.clientY-r.top;
  if(ePanning){ePanX+=sx-ePanLX;ePanY+=sy-ePanLY;ePanLX=sx;ePanLY=sy;applyEditorTransform();return;}
  if(!eDrawing)return;
  const{cx,cy}=screenToCanvas(sx,sy);
  const brushPx=+(document.getElementById('eBrushSize')?.value||14);
  if(eTool==='erase'){
    // Erase terrain strokes on terrain canvas
    if(eTerrainCtx){
      eTerrainCtx.globalCompositeOperation='destination-out';
      eTerrainCtx.beginPath();eTerrainCtx.arc(cx,cy,brushPx*1.5,0,Math.PI*2);
      eTerrainCtx.fillStyle='rgba(0,0,0,1)';eTerrainCtx.fill();
      eTerrainCtx.globalCompositeOperation='source-over';
    }
  }else if(!eTool.startsWith('base_')&&eTool!=='unit_blue'&&eTool!=='unit_red'&&eTool!=='city'&&eTool!=='move'&&eTool!=='fill'){
    // Draw terrain stroke on TERRAIN CANVAS only
    const col=ECOLORS_TERRAIN[eTool]||ECOLORS_TERRAIN.draw;
    if(col&&eTerrainCtx){
      eTerrainCtx.strokeStyle=col;eTerrainCtx.lineWidth=brushPx;
      eTerrainCtx.lineCap='round';eTerrainCtx.lineJoin='round';
      eTerrainCtx.globalAlpha=1;
      eTerrainCtx.beginPath();eTerrainCtx.moveTo(eLX,eLY);eTerrainCtx.lineTo(cx,cy);eTerrainCtx.stroke();
    }
  }
  // Composite result onto main canvas
  eRedrawAll();
  eLX=cx;eLY=cy;
}
function eOnMU(e){eDrawing=false;ePanning=false;eRedrawMarkersOverlay();}
function eKeyHandler(e){
  if(!document.getElementById('screen-editor').classList.contains('active'))return;
  // Works for both English (z) and Ukrainian (—è) keyboard layouts
  const isZ=e.key.toLowerCase()==='z'||e.key==='—è'||e.code==='KeyZ';
  if((e.ctrlKey||e.metaKey)&&isZ){e.preventDefault();editorUndoNew();}
}
function eHandleRightClick(e){
  const area=document.getElementById('editorCanvasArea');const r=area.getBoundingClientRect();
  const sx=e.clientX-r.left,sy=e.clientY-r.top;
  const{cx,cy}=screenToCanvas(sx,sy);
  const cv=eCtx?.canvas;if(!cv)return;
  // Find marker near canvas click pos
  const idx=eMarkers.findIndex(m=>Math.hypot(m.nx*cv.width-cx,m.ny*cv.height-cy)<30);
  if(idx>=0){eMarkers.splice(idx,1);eRedrawMarkersOverlay();eUpdateMarkerList();toast('‚úï –ú–∞—Ä–∫–µ—Ä –≤–∏–¥–∞–ª–µ–Ω–æ');}
}

function eHistoryPush(){
  if(!eTerrainCtx)return;
  const cv=eTerrainCtx.canvas;
  eHistory.push(eTerrainCtx.getImageData(0,0,cv.width,cv.height));
  if(eHistory.length>25)eHistory.shift();
}
window.editorUndoNew=()=>{
  if(!eHistory.length){toast('‚ö†Ô∏è –ù—ñ—á–æ–≥–æ –≤—ñ–¥–º—ñ–Ω—è—Ç–∏');return;}
  if(eTerrainCtx)eTerrainCtx.putImageData(eHistory.pop(),0,0);
  eRedrawAll(); // redraw bg + terrain
};

function eRedrawAll(){
  // Composite: bg photo + terrain overlay
  if(!eCtx)return;
  const cv=eCtx.canvas;
  eCtx.clearRect(0,0,cv.width,cv.height);
  eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,cv.width,cv.height);
  if(eBg&&eBgW>0){eCtx.drawImage(eBg,eBgX,eBgY,eBgW,eBgH);}else{eDrawDefaultBg();return;}
  // Draw terrain on top with 70% opacity so photo shows through
  if(eTerrainCtx){
    eCtx.globalAlpha=0.75;
    eCtx.drawImage(eTerrainCtx.canvas,0,0);
    eCtx.globalAlpha=1;
  }
}
function eDrawDefaultBg(){
  if(!eCtx)return;const cv=eCtx.canvas;const W=cv.width,H=cv.height;
  eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,W,H);
  eCtx.strokeStyle='rgba(255,255,255,.04)';eCtx.lineWidth=1;
  for(let x=0;x<W;x+=50){eCtx.beginPath();eCtx.moveTo(x,0);eCtx.lineTo(x,H);eCtx.stroke();}
  for(let y=0;y<H;y+=50){eCtx.beginPath();eCtx.moveTo(0,y);eCtx.lineTo(W,y);eCtx.stroke();}
  eCtx.strokeStyle='rgba(255,255,255,.2)';eCtx.lineWidth=2;eCtx.setLineDash([12,8]);
  eCtx.beginPath();eCtx.moveTo(W/2,0);eCtx.lineTo(W/2,H);eCtx.stroke();eCtx.setLineDash([]);
  eCtx.font='bold 28px Oswald,sans-serif';eCtx.textAlign='center';eCtx.textBaseline='middle';
  eCtx.fillStyle='rgba(59,130,246,.12)';eCtx.fillText('–°–ò–ù–Ü',W*.25,H/2);
  eCtx.fillStyle='rgba(239,68,68,.12)';eCtx.fillText('–ß–ï–†–í–û–ù–Ü',W*.75,H/2);
}
window.setETool=t=>{
  eTool=t;document.querySelectorAll('.etool').forEach(b=>b.classList.remove('active'));document.getElementById('etool-'+t)?.classList.add('active');
  const hints={draw:'–õ–ö–ú ‚Äî –º–∞–ª—é–≤–∞—Ç–∏',erase:'–õ–ö–ú ‚Äî —Å—Ç–µ—Ä—Ç–∏',fill:'–õ–ö–ú ‚Äî –∑–∞–ª–∏–≤–∫–∞',move:'–õ–ö–ú —Ç—è–≥–Ω–∏ ‚Äî pan | –ö–æ–ª—ñ—â–∞—Ç–∫–æ ‚Äî zoom',water:'–õ–ö–ú ‚Äî –≤–æ–¥–∞ (–±–ª–æ–∫—É—î —Ä—É—Ö)',bridge:'–õ–ö–ú ‚Äî –º—ñ—Å—Ç (–ø—Ä–æ—Ö—ñ–¥ —á–µ—Ä–µ–∑ –≤–æ–¥—É)',forest:'–õ–ö–ú ‚Äî –ª—ñ—Å (-50% —à–≤–∏–¥–∫—ñ—Å—Ç—å)',road:'–õ–ö–ú ‚Äî –¥–æ—Ä–æ–≥–∞ (+40% —à–≤–∏–¥–∫—ñ—Å—Ç—å)',meadow:'–õ–ö–ú ‚Äî –ª—É–≥ (–Ω–æ—Ä–º–∞–ª—å–Ω–∞ —à–≤–∏–¥–∫—ñ—Å—Ç—å)',city:'–õ–ö–ú ‚Äî –º—ñ—Å—Ç–æ',base_blue:'–õ–ö–ú ‚Äî –ë–∞–∑–∞ –°–ò–ù–Ü–•',base_red:'–õ–ö–ú ‚Äî –ë–∞–∑–∞ –ß–ï–†–í–û–ù–ò–•',unit_blue:'–õ–ö–ú ‚Äî —é–Ω—ñ—Ç –°–ò–ù–Ü–•',unit_red:'–õ–ö–ú ‚Äî —é–Ω—ñ—Ç –ß–ï–†–í–û–ù–ò–•'};
  const hint=document.getElementById('editorCursorHint');if(hint)hint.textContent=hints[t]||'';
};
window.editorLoadBg=input=>{
  const file=input.files[0];if(!file)return;
  const img=new Image();
  img.onload=()=>{
    eHistoryPush();
    eBg=img;
    const cv=eCtx.canvas;
    const sc=Math.min(cv.width/img.naturalWidth,cv.height/img.naturalHeight);
    eBgW=img.naturalWidth*sc;eBgH=img.naturalHeight*sc;
    eBgX=(cv.width-eBgW)/2;eBgY=(cv.height-eBgH)/2;
    // Clear terrain when new bg loaded (fresh start)
    if(eTerrainCtx)eTerrainCtx.clearRect(0,0,eTerrainCtx.canvas.width,eTerrainCtx.canvas.height);
    eRedrawAll();
    toast('üì∑ –§–æ—Ç–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ ‚Äî –º–∞–ª—é–π—Ç–µ —Ç–µ—Ä–µ–Ω –ø–æ–≤–µ—Ä—Ö!');
  };
  img.src=URL.createObjectURL(file);
};
window.editorRenameMap=()=>{const n=prompt('–ù–∞–∑–≤–∞ –∫–∞—Ä—Ç–∏:',eMapName);if(n)eMapName=n;const el=document.getElementById('editorMapName');if(el)el.textContent=eMapName;};
window.editorClearTerrain=()=>{
  eHistoryPush();
  if(eTerrainCtx)eTerrainCtx.clearRect(0,0,eTerrainCtx.canvas.width,eTerrainCtx.canvas.height);
  eRedrawAll();
  toast('üóëÔ∏è –¢–µ—Ä–µ–Ω –æ—á–∏—â–µ–Ω–æ');
};
window.editorClearMarkers=()=>{eMarkers=[];eRedrawMarkersOverlay();toast('üö´ –ú–∞—Ä–∫–µ—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–æ');};
window.editorClearAll=()=>{
  eHistoryPush();eMarkers=[];eBg=null;
  if(eTerrainCtx)eTerrainCtx.clearRect(0,0,eTerrainCtx.canvas.width,eTerrainCtx.canvas.height);
  if(eCtx){const cv=eCtx.canvas;eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,cv.width,cv.height);eDrawDefaultBg();}
  eRedrawMarkersOverlay();toast('üí• –í—Å–µ –æ—á–∏—â–µ–Ω–æ');
};
function ePlaceMarker(cx,cy){
  const cv=eCtx.canvas;const nx=cx/cv.width,ny=cy/cv.height;
  const isBase=eTool.startsWith('base_');
  if(isBase){const team=eTool.split('_')[1];eMarkers=eMarkers.filter(m=>!(m.type==='base'&&m.team===team));eMarkers.push({type:'base',team,nx,ny});}
  else if(eTool==='city'){const name=prompt('–ù–∞–∑–≤–∞ –º—ñ—Å—Ç–∞:',`–ú—ñ—Å—Ç–æ ${eMarkers.filter(m=>m.type==='city').length+1}`)||`–ú—ñ—Å—Ç–æ ${eMarkers.filter(m=>m.type==='city').length+1}`;eMarkers.push({type:'city',nx,ny,name});}
  else{const team=eTool.split('_')[1];const unitType=document.getElementById('editorUnitType2')?.value||'infantry';eMarkers.push({type:'unit',team,unitType,nx,ny});}
  eRedrawMarkersOverlay();eUpdateMarkerList();
}
function eFloodFill(cx,cy){
  if(!eTerrainCtx)return;
  eHistoryPush();
  const col=ECOLORS_TERRAIN[eTool]||ECOLORS_TERRAIN.draw;
  if(!col)return;
  // For fill tool, draw on terrain canvas with a large filled rect matching the drawing area
  // Simple approach: paint entire canvas if fill tool selected, clipped to bg area
  // More accurate: flood-fill on terrain canvas
  const tcv=eTerrainCtx.canvas;
  const imgData=eTerrainCtx.getImageData(0,0,tcv.width,tcv.height);
  const data=imgData.data;
  const idx=(x,y)=>(y*tcv.width+x)*4;
  // Clamp to canvas bounds
  const scx=Math.max(0,Math.min(tcv.width-1,cx));
  const scy=Math.max(0,Math.min(tcv.height-1,cy));
  const target=[data[idx(scx,scy)],data[idx(scx,scy)+1],data[idx(scx,scy)+2],data[idx(scx,scy)+3]];
  const fill=hexOrRgbaToRgb(col);if(!fill)return;
  if(target[0]===fill.r&&target[1]===fill.g&&target[2]===fill.b&&target[3]>200)return;
  const stack=[[scx,scy]];
  const visited=new Uint8Array(tcv.width*tcv.height);
  while(stack.length){
    const[x,y]=stack.pop();
    if(x<0||x>=tcv.width||y<0||y>=tcv.height)continue;
    const i=idx(x,y);const vi=y*tcv.width+x;if(visited[vi])continue;visited[vi]=1;
    const a=data[i+3];
    if(a>30&&(Math.abs(data[i]-target[0])>40||Math.abs(data[i+1]-target[1])>40||Math.abs(data[i+2]-target[2])>40))continue;
    data[i]=fill.r;data[i+1]=fill.g;data[i+2]=fill.b;data[i+3]=255;
    stack.push([x+1,y],[x-1,y],[x,y+1],[x,y-1]);
  }
  eTerrainCtx.putImageData(imgData,0,0);
  eRedrawAll();
}
function hexOrRgbaToRgb(col){if(!col)return{r:26,g:40,b:16};if(col.startsWith('#')){const r=parseInt(col.slice(1,3),16),g=parseInt(col.slice(3,5),16),b=parseInt(col.slice(5,7),16);return{r,g,b};}if(col.startsWith('rgba')){const m=col.match(/[\d.]+/g);return m?{r:+m[0],g:+m[1],b:+m[2]}:null;}return null;}
function eRedrawMarkersOverlay(){
  const ov=document.getElementById('editorOverlay');const cv=eCtx?.canvas;if(!ov||!cv)return;
  ov.style.width=cv.width+'px';ov.style.height=cv.height+'px';
  ov.innerHTML=eMarkers.map((m,i)=>{
    const px=m.nx*cv.width,py=m.ny*cv.height;
    const emoji=m.type==='city'?'üèôÔ∏è':m.type==='base'?(m.team==='blue'?'üè†':'üèöÔ∏è'):(UNIT_DEFS[m.unitType]?.emoji||'‚ö™');
    const glow=m.type==='city'?'#f59e0b':m.team==='blue'?'#60a5fa':'#f87171';
    return`<div style="position:absolute;left:${px}px;top:${py}px;transform:translate(-50%,-50%);font-size:22px;cursor:pointer;filter:drop-shadow(0 0 5px ${glow});pointer-events:auto" onclick="eRemoveMarker(${i})">${emoji}</div>`;
  }).join('');
}
window.eRemoveMarker=i=>{eMarkers.splice(i,1);eRedrawMarkersOverlay();eUpdateMarkerList();};
function eUpdateMarkerList(){
  const el=document.getElementById('eMarkerList');if(!el)return;
  if(!eMarkers.length){el.innerHTML='<span style="color:var(--dim);font-size:10px">–ú–∞—Ä–∫–µ—Ä—ñ–≤ –Ω–µ–º–∞—î</span>';return;}
  el.innerHTML=eMarkers.map((m,i)=>{const label=m.type==='city'?`üèôÔ∏è ${m.name}`:m.type==='base'?`${m.team==='blue'?'üè† –ë–∞–∑–∞ –°–∏–Ω—ñ—Ö':'üèöÔ∏è –ë–∞–∑–∞ –ß–µ—Ä–≤–æ–Ω–∏—Ö'}`:`${UNIT_DEFS[m.unitType]?.emoji||'‚ö™'} ${UNIT_DEFS[m.unitType]?.name||m.unitType} (${m.team==='blue'?'üîµ':'üî¥'})`;return`<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 4px;border-radius:4px;background:rgba(255,255,255,.02);"><span style="font-size:10px">${label}</span><span style="color:#f87171;cursor:pointer;font-size:11px;padding:0 4px" onclick="eRemoveMarker(${i})">‚úï</span></div>`;}).join('');
}
window.editorSaveMap=async()=>{
  const cv=eCtx?.canvas;if(!cv){toast('‚ùå –†–µ–¥–∞–∫—Ç–æ—Ä –Ω–µ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π');return;}
  // Validate required markers
  const hasBlue=eMarkers.some(m=>m.type==='base'&&m.team==='blue');
  const hasRed=eMarkers.some(m=>m.type==='base'&&m.team==='red');
  if(!hasBlue||!hasRed){toast('‚ö†Ô∏è –î–æ–¥–∞–π—Ç–µ –ë–∞–∑—É –°–ò–ù–Ü–• —Ç–∞ –ß–ï–†–í–û–ù–ò–• –ø–µ—Ä–µ–¥ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º!');return;}
  toast('‚ü≥ –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –∫–∞—Ä—Ç—É...');
  try{
    // Save background photo as map image (user uploaded photo IS the map)
    let bgUrl=eMapIdx>=0?globalMaps[eMapIdx]?.url:null;
    if(eBg&&!bgUrl){
      // New map with photo ‚Äî upload the bg
      const bgCanvas=document.createElement('canvas');bgCanvas.width=eBg.naturalWidth;bgCanvas.height=eBg.naturalHeight;
      bgCanvas.getContext('2d').drawImage(eBg,0,0);
      bgUrl=await uploadCloudinary(bgCanvas.toDataURL('image/jpeg',.92),'bg_map_'+Date.now());
    }
    if(!bgUrl&&eBg){bgUrl=eBg.src;}

    // Save terrain layer directly from the separate terrain canvas (reliable, no compositing tricks)
    const TERRAIN_RES=512;
    const terrainCanvas=document.createElement('canvas');
    terrainCanvas.width=TERRAIN_RES;
    terrainCanvas.height=Math.round(TERRAIN_RES*EDITOR_NATIVE_H/EDITOR_NATIVE_W);
    const tCtx=terrainCanvas.getContext('2d');
    if(eTerrainCtx){
      tCtx.drawImage(eTerrainCtx.canvas,0,0,terrainCanvas.width,terrainCanvas.height);
    }
    const terrainDataUrl=terrainCanvas.toDataURL('image/png');

    const date=new Date().toLocaleDateString('uk-UA');
    const spawns={
      blueBase:eMarkers.find(m=>m.type==='base'&&m.team==='blue')||null,
      redBase:eMarkers.find(m=>m.type==='base'&&m.team==='red')||null,
      units:eMarkers.filter(m=>m.type==='unit').map(m=>({team:m.team,unitType:m.unitType,nx:m.nx,ny:m.ny}))
    };
    const cities=eMarkers.filter(m=>m.type==='city').map(m=>({nx:m.nx,ny:m.ny,name:m.name}));
    const mapEntry={url:bgUrl||cv.toDataURL('image/jpeg',.85),name:eMapName,date,spawns,cities,terrainDataUrl};
    if(eMapIdx>=0){globalMaps[eMapIdx]=mapEntry;}else{globalMaps.push(mapEntry);}
    await setDoc(doc(db,'appData','globalMaps'),{maps:globalMaps});
    renderLobbyGlobalMaps();if(isAdmin)renderAdminMaps();
    toast('‚úÖ "'+eMapName+'" –∑–±–µ—Ä–µ–∂–µ–Ω–∞!');showScreen('screen-menu');
  }
  catch(e){toast('‚ùå '+e.message);console.error(e);}
};
function eLoadMapForEditing(m){
  const img=new Image();img.crossOrigin='anonymous';
  img.onload=()=>{
    eBg=img;
    const cv=eCtx.canvas;
    // Scale bg to fill the native canvas while preserving aspect ratio
    const sc=Math.min(cv.width/img.naturalWidth,cv.height/img.naturalHeight);
    eBgW=img.naturalWidth*sc;eBgH=img.naturalHeight*sc;
    eBgX=(cv.width-eBgW)/2;eBgY=(cv.height-eBgH)/2;
    // Draw bg (photo = the map)
    eCtx.fillStyle='#1a2810';eCtx.fillRect(0,0,cv.width,cv.height);
    eCtx.drawImage(img,eBgX,eBgY,eBgW,eBgH);
    // Restore terrain layer onto separate terrain canvas
    if(eTerrainCtx){
      eTerrainCtx.clearRect(0,0,eTerrainCtx.canvas.width,eTerrainCtx.canvas.height);
      if(m.terrainDataUrl){
        const timg=new Image();
        timg.onload=()=>{
          // Draw terrain scaled to match where bg is drawn on canvas
          eTerrainCtx.drawImage(timg,eBgX,eBgY,eBgW,eBgH);
          eRedrawAll();
        };
        timg.src=m.terrainDataUrl;
      }
    }
    eMarkers=[];
    if(m.spawns){
      if(m.spawns.blueBase)eMarkers.push({type:'base',team:'blue',nx:m.spawns.blueBase.nx,ny:m.spawns.blueBase.ny});
      if(m.spawns.redBase)eMarkers.push({type:'base',team:'red',nx:m.spawns.redBase.nx,ny:m.spawns.redBase.ny});
      (m.spawns.units||[]).forEach(u=>eMarkers.push({type:'unit',team:u.team,unitType:u.unitType,nx:u.nx,ny:u.ny}));
    }
    (m.cities||[]).forEach(c=>eMarkers.push({type:'city',nx:c.nx,ny:c.ny,name:c.name}));
    eMapName=m.name;
    const el=document.getElementById('editorMapName');if(el)el.textContent=eMapName;
    eRedrawMarkersOverlay();eUpdateMarkerList();
    toast('‚úèÔ∏è –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ: '+m.name);
  };
  img.src=m.url;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCREENS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.showScreen=name=>{
  if(document.getElementById('screen-editor')?.classList.contains('active')&&name!=='screen-editor')document.removeEventListener('keydown',eKeyHandler);
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById(name)?.classList.add('active');
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LOBBY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function genCode(){return Array.from({length:5},()=>'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');}
window.copyLobbyCode=()=>{const code=document.getElementById('lcCode').textContent;if(navigator.clipboard)navigator.clipboard.writeText(code).then(()=>toast('‚úÖ –ö–æ–¥ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ: '+code));else{const ta=document.createElement('textarea');ta.value=code;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);toast('‚úÖ –°–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');}};
function setLobbyMapHostOnly(isHost){['mapUploadArea','mapFileInput'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display=isHost?'':'none';});}
window.showLobbyCreate=async()=>{
  showScreen('screen-lobby-create');setStatus('lcStatus','‚ü≥ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –ª–æ–±—ñ...','warn');
  const code=genCode();lobbyId=code;myRole='blue';
  document.getElementById('lcCode').textContent=code;document.getElementById('lcP1Name').textContent=myName;
  document.getElementById('lcP2Name').textContent='–û—á—ñ–∫—É–≤–∞–Ω–Ω—è...';document.getElementById('lcP2Slot').classList.remove('filled');document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='‚è≥';
  document.getElementById('lcStartBtn').disabled=true;mapBg=null;mapBgW=0;mapBgH=0;
  document.getElementById('mapPreview').style.display='none';document.getElementById('mapUploadArea').style.display='block';document.getElementById('mapUploadStatus').textContent='';
  renderLobbyGlobalMaps();setLobbyMapHostOnly(true);if(globalMaps.length>0)loadMapFromUrl(globalMaps[0].url);
  try{await setDoc(doc(db,'lobbies',code),{code,host:uid,hostName:myName,guestUid:null,guestName:null,mapUrl:globalMaps[0]?.url||null,mapIdx:0,mapVer:'0',status:'waiting',createdAt:serverTimestamp(),presence:{blue:Date.now(),red:0}});setStatus('lcStatus','‚úÖ –õ–æ–±—ñ —Å—Ç–≤–æ—Ä–µ–Ω–æ! –ö–æ–¥: '+code,'ok');listenLobby(code,'host');startPresencePing(code,'blue');}
  catch(e){setStatus('lcStatus','‚ùå '+e.message,'err');}
};
window.showLobbyJoin=()=>showScreen('screen-lobby-join');
window.joinLobby=async()=>{
  const code=document.getElementById('joinCodeInput').value.trim().toUpperCase(),nm=document.getElementById('joinNameInput').value.trim()||myName;
  if(!code){setStatus('ljStatus','‚ùå –í–≤–µ–¥—ñ—Ç—å –∫–æ–¥!','err');return;}myName=nm;setStatus('ljStatus','‚ü≥ –ü–æ—à—É–∫...','warn');
  try{const snap=await getDoc(doc(db,'lobbies',code));if(!snap.exists()){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!','err');return;}const d=snap.data();if(d.status!=='waiting'&&d.status!=='ready'){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–µ','err');return;}if(d.guestUid&&d.guestUid!==uid){setStatus('ljStatus','‚ùå –õ–æ–±—ñ –∑–∞–ø–æ–≤–Ω–µ–Ω–µ','err');return;}lobbyId=code;myRole='red';await updateDoc(doc(db,'lobbies',code),{guestUid:uid,guestName:myName,status:'ready','presence.red':Date.now()});showScreen('screen-lobby-create');document.getElementById('lcCode').textContent=code;document.getElementById('lcP1Name').textContent=d.hostName||'–•–æ—Å—Ç';document.getElementById('lcP2Name').textContent=myName;document.getElementById('lcP2Slot').classList.add('filled');document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';document.getElementById('lcStartBtn').disabled=true;mapBg=null;mapBgW=0;mapBgH=0;renderLobbyGlobalMaps();setLobbyMapHostOnly(false);setStatus('lcStatus','‚úÖ –ü—Ä–∏—î–¥–Ω–∞–ª–∏—Å—å! –û—á—ñ–∫—É—î–º–æ —Å—Ç–∞—Ä—Ç—É...','ok');listenLobby(code,'guest');startPresencePing(code,'red');if(d.mapUrl)loadMapFromUrl(d.mapUrl);else if(globalMaps.length>0)loadMapFromUrl(globalMaps[0].url);}
  catch(e){setStatus('ljStatus','‚ùå '+e.message,'err');}
};
function listenLobby(code,role){
  if(lobbyUnsub)lobbyUnsub();
  lobbyUnsub=onSnapshot(doc(db,'lobbies',code),snap=>{if(!snap.exists())return;const d=snap.data();if(d.guestName){document.getElementById('lcP2Name').textContent=d.guestName;document.getElementById('lcP2Slot').classList.add('filled');document.getElementById('lcP2Slot').querySelector('.lps-icon').textContent='üî¥';if(role==='host'){document.getElementById('lcStartBtn').disabled=false;setStatus('lcStatus','‚úÖ '+d.guestName+' –ø—Ä–∏—î–¥–Ω–∞–≤—Å—è! –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –°–¢–ê–†–¢.','ok');}}if(d.mapUrl)loadMapFromUrl(d.mapUrl);if(d.status==='started'){if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}startGame(code,role,d);}});
}
window.hostStartGame=async()=>{if(!lobbyId)return;await updateDoc(doc(db,'lobbies',lobbyId),{status:'started'});};
window.leaveLobby=async()=>{if(lobbyId&&myRole==='blue')await deleteDoc(doc(db,'lobbies',lobbyId)).catch(()=>{});if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}lobbyId=null;myRole=null;showScreen('screen-menu');};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PRESENCE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startPresencePing(code,role){if(presenceUnsub)clearInterval(presenceUnsub);presenceUnsub=setInterval(async()=>{if(!lobbyId)return;await updateDoc(doc(db,'games',code),{['presence.'+role]:Date.now()}).catch(()=>{});},5000);}
function monitorOpponentPresence(code){const oppRole=myRole==='blue'?'red':'blue';setInterval(async()=>{if(gameOver||!lobbyId)return;const snap=await getDoc(doc(db,'games',code)).catch(()=>null);if(!snap?.exists())return;const ts=snap.data()?.presence?.[oppRole]||0;const elapsed=(Date.now()-ts)/1000;if(elapsed>10&&elapsed<75)showDcBanner(75-Math.floor(elapsed));else if(elapsed>=75){hideDcBanner();showResult(myRole,'–û–ø–æ–Ω–µ–Ω—Ç –Ω–µ –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è');}else hideDcBanner();},3000);}
function showDcBanner(sec){dcSeconds=sec;const b=document.getElementById('dcBanner');b.classList.add('vis');document.getElementById('dcTimer').textContent=sec;if(dcInterval)return;dcInterval=setInterval(()=>{dcSeconds--;document.getElementById('dcTimer').textContent=Math.max(0,dcSeconds);if(dcSeconds<=0){clearInterval(dcInterval);dcInterval=null;}},1000);}
function hideDcBanner(){document.getElementById('dcBanner').classList.remove('vis');if(dcInterval){clearInterval(dcInterval);dcInterval=null;}}
let dcSeconds=0;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VS AI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startVsAI=()=>{
  aiMode=selectedAIMode;myRole=selectedAITeam;isAI=true;lobbyId='ai_'+Date.now();closeAIModeModal();
  const mapMeta=globalMaps[0]||null;initGameState(mapMeta,myRole);showScreen('screen-game');
  setTimeout(()=>{resizeCanvases();if(mapMeta?.url)loadMapFromUrl(mapMeta.url);},50);
  startGameLoop();addLog(`ü§ñ –†–µ–∂–∏–º: ${aiModeLabel(aiMode)} | –í–∏: ${myRole==='blue'?'üîµ –°–ò–ù–Ü':'üî¥ –ß–ï–†–í–û–ù–Ü'}`,'warn');
};
function aiModeLabel(m){return{defense:'üõ°Ô∏è –û–ë–û–†–û–ù–ê',attack:'‚öîÔ∏è –ù–ê–°–¢–£–ü',blitz:'‚ö° –ë–õ–Ü–¶–ö–†–ò–ì',conquest:'üèÜ –ó–ê–í–û–Æ–í–ê–ù–ù–Ø'}[m]||m;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME START
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function startGame(code,role,lobbyData){
  isAI=false;myRole=role;lobbyId=code;
  const mapIdx=lobbyData?.mapIdx||0;const mapUrl=lobbyData?.mapUrl||globalMaps[0]?.url||null;
  const mapMeta=mapIdx>=0&&mapIdx<globalMaps.length?globalMaps[mapIdx]:(globalMaps.find(m=>m.url===mapUrl)||null);
  mapBg=null;mapBgW=0;mapBgH=0;initGameState(mapMeta,myRole);showScreen('screen-game');
  setTimeout(()=>{resizeCanvases();if(mapUrl)loadMapFromUrl(mapUrl);},50);
  startGameLoop();listenGameState(code);startPresencePing(code,role);monitorOpponentPresence(code);
}

function initGameState(mapData,playerRole){
  G={units:[],funds:{blue:2000,red:2000},casualties:{blue:0,red:0},cities:[],phase:'placement',wave:1,startTime:Date.now(),nextId:1};
  gamePhase='placement';gameOver=false;gameTimer=0;
  if(timerInterval)clearInterval(timerInterval);timerInterval=setInterval(tickTimer,1000);
  if(incomeInterval)clearInterval(incomeInterval);incomeInterval=setInterval(tickIncome,15000);
  document.getElementById('hudPhase').textContent='–†–û–ó–ú–Ü–©–ï–ù–ù–Ø';document.getElementById('placementHint').classList.add('vis');
  if(mapData?.cities?.length>0)G._pendingCities=mapData.cities;else G._pendingCities=null;
  if(mapData?.spawns)G._pendingSpawns=mapData.spawns;
  // terrain loaded via pixel map in loadTerrainFromMap
  loadTerrainFromMap(mapData);updateHUD();updateCitiesPanel();
}
function loadTerrainFromMap(mapEntry){
  G_terrainPixels=null;G_terrainW=0;G_terrainH=0;
  if(mapEntry?.terrainDataUrl){
    const img=new Image();
    img.onload=()=>{
      const W=256,H=Math.round(256*(mapBgH||1200)/(mapBgW||2000));
      const oc=document.createElement('canvas');oc.width=W;oc.height=H;
      const ctx=oc.getContext('2d');ctx.drawImage(img,0,0,W,H);
      G_terrainPixels=ctx.getImageData(0,0,W,H).data;G_terrainW=W;G_terrainH=H;
    };
    img.src=mapEntry.terrainDataUrl;
  }
}
function applyMapData(){
  if(!mapBgW||!mapBgH)return;const mw=mapBgW,mh=mapBgH;
  if(G._pendingCities?.length>0){G.cities=G._pendingCities.map((c,i)=>({id:'city_'+i,name:c.name||('–ú—ñ—Å—Ç–æ '+(i+1)),x:c.nx*mw,y:c.ny*mh,nx:c.nx,ny:c.ny,owner:'neutral',income:CITY_INCOME,hp:300,maxHp:300,captureProgress:{blue:0,red:0}}));G._pendingCities=null;addLog('üèôÔ∏è '+G.cities.length+' –º—ñ—Å—Ç','info');}
  else if(!G.cities.length){G.cities=generateDefaultCities(mw,mh);addLog('üèôÔ∏è '+G.cities.length+' –º—ñ—Å—Ç (–∞–≤—Ç–æ)','info');}
  if(G._pendingSpawns){const s=G._pendingSpawns;if(s.blueBase)G.bases={...G.bases||{},blue:{x:s.blueBase.nx*mw,y:s.blueBase.ny*mh}};if(s.redBase)G.bases={...G.bases||{},red:{x:s.redBase.nx*mw,y:s.redBase.ny*mh}};
  (s.units||[]).forEach(u=>{const def=UNIT_DEFS[u.unitType]||UNIT_DEFS.infantry;G.units.push({id:G.nextId++,type:u.unitType,owner:u.team,x:u.nx*mw,y:u.ny*mh,tx:u.nx*mw,ty:u.ny*mh,vx:0,vy:0,hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,state:'idle',attackTarget:null,lastAttack:0,lastAttackAnim:0});});G._pendingSpawns=null;}
  if(!G.bases)G.bases={blue:{x:mw*.12,y:mh*.5},red:{x:mw*.88,y:mh*.5}};
  updateHUD();updateCitiesPanel();
}
function generateDefaultCities(mw,mh){return[{nx:.5,ny:.5,name:'–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–µ'},{nx:.3,ny:.3,name:'–õ—ñ—Å–∞'},{nx:.7,ny:.3,name:'–°—Ö—ñ–¥'},{nx:.3,ny:.7,name:'–ü—ñ–≤–¥–µ–Ω—å'},{nx:.7,ny:.7,name:'–ì–æ—Ä–∏'}].map((p,i)=>({id:'city_'+i,name:p.name,x:p.nx*mw,y:p.ny*mh,nx:p.nx,ny:p.ny,owner:'neutral',income:CITY_INCOME,hp:300,maxHp:300,captureProgress:{blue:0,red:0}}));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INCOME
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickIncome(){if(gameOver||gamePhase!=='battle')return;let bi=BASE_INCOME,ri=BASE_INCOME;G.cities.forEach(c=>{if(c.owner==='blue')bi+=c.income;else if(c.owner==='red')ri+=c.income;});G.funds.blue+=bi;G.funds.red+=ri;updateHUD();spawnIncomeFloat(myRole,myRole==='blue'?bi:ri);addLog(`üí∞ +${myRole==='blue'?bi:ri}‚Ç¥`,'warn');}
function getIncome(role){let inc=BASE_INCOME;G.cities?.forEach(c=>{if(c.owner===role)inc+=c.income;});return inc;}
function spawnIncomeFloat(role,amount){const body=document.getElementById('gameBody');const base=G.bases?.[role];if(!base||!body)return;const sx=base.x*camScale+camX,sy=base.y*camScale+camY;const el=document.createElement('div');el.className='income-float';el.textContent='+'+amount+'‚Ç¥';el.style.left=sx+'px';el.style.top=(sy-20)+'px';document.getElementById('incomeFloaters').appendChild(el);setTimeout(()=>el.remove(),1600);}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CITY CAPTURE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateCityCapture(dt){
  if(!G.cities)return;
  G.cities.forEach(city=>{
    const r=30;const bn=G.units.filter(u=>u.owner==='blue'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)<r).length;const rn=G.units.filter(u=>u.owner==='red'&&!u._dead&&Math.hypot(u.x-city.x,u.y-city.y)<r).length;
    if(bn>0&&rn===0){city.captureProgress.blue=Math.min(100,(city.captureProgress.blue||0)+dt*15);city.captureProgress.red=Math.max(0,(city.captureProgress.red||0)-dt*10);if(city.captureProgress.blue>=100&&city.owner!=='blue'){city.owner='blue';city.captureProgress={blue:100,red:0};addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –°–ò–ù–Ü–ú–ò!','good');toast('üèôÔ∏è '+city.name+' ‚Äî –Ω–∞—à–µ!');syncGameState();updateCitiesPanel();}}
    else if(rn>0&&bn===0){city.captureProgress.red=Math.min(100,(city.captureProgress.red||0)+dt*15);city.captureProgress.blue=Math.max(0,(city.captureProgress.blue||0)-dt*10);if(city.captureProgress.red>=100&&city.owner!=='red'){city.owner='red';city.captureProgress={blue:0,red:100};addLog('üèôÔ∏è '+city.name+' –∑–∞—Ö–æ–ø–ª–µ–Ω–æ –ß–ï–†–í–û–ù–ò–ú–ò!',myRole==='blue'?'bad':'good');if(myRole==='blue')toast('‚ö†Ô∏è '+city.name+' ‚Äî –∑–∞—Ö–æ–ø–ª–µ–Ω–æ!');syncGameState();updateCitiesPanel();}}
    else{if(city.owner==='neutral'){city.captureProgress.blue=Math.max(0,(city.captureProgress.blue||0)-dt*3);city.captureProgress.red=Math.max(0,(city.captureProgress.red||0)-dt*3);}}
  });
}
function updateCitiesPanel(){const el=document.getElementById('citiesList');if(!el||!G.cities)return;if(!G.cities.length){el.innerHTML='<div style="font-size:10px;color:var(--dim)">–ù–µ–º–∞—î –º—ñ—Å—Ç</div>';return;}el.innerHTML=G.cities.map(c=>`<div class="city-row"><div class="city-dot ${c.owner==='neutral'?'neutral':c.owner}"></div><span class="city-name">${c.name}</span>${c.owner!=='neutral'?`<span class="city-income">+${c.income}‚Ç¥</span>`:''}</div>`).join('');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TIMER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function tickTimer(){
  gameTimer++;const m=Math.floor(gameTimer/60),s=gameTimer%60;document.getElementById('hudTimer').textContent=String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  if(isAI&&gameTimer%120===0&&!gameOver){G.wave++;document.getElementById('hudWave').textContent=G.wave;addLog('üåä –•–í–ò–õ–Ø '+G.wave+'!','warn');if(gamePhase==='battle')spawnAIWave();}
  if(isAI&&aiMode==='blitz'&&gameTimer>=300&&!gameOver){const mc=G.cities.filter(c=>c.owner===myRole).length,oc=G.cities.filter(c=>c.owner!=myRole&&c.owner!=='neutral').length;if(mc>oc)showResult(myRole,'–ü–µ—Ä–µ–º–æ–∂–µ—Ü—å –∑–∞ –º—ñ—Å—Ç–∞–º–∏!');else showResult(myRole==='blue'?'red':'blue','–ß–∞—Å –≤–∏–π—à–æ–≤!');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIRESTORE SYNC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let syncThrottle=null;
function syncGameState(){
  if(!lobbyId||isAI)return;if(syncThrottle)clearTimeout(syncThrottle);
  syncThrottle=setTimeout(async()=>{try{await setDoc(doc(db,'games',lobbyId),{units:G.units.filter(u=>!u._dead).map(u=>({id:u.id,type:u.type,owner:u.owner,x:Math.round(u.x),y:Math.round(u.y),hp:Math.round(u.hp)})),funds:G.funds,casualties:G.casualties,cities:G.cities.map(c=>({id:c.id,owner:c.owner,captureProgress:c.captureProgress})),phase:gamePhase,wave:G.wave,ts:Date.now(),['presence.'+myRole]:Date.now()},{merge:true});}catch(e){}},150);
}
function listenGameState(code){
  if(gameUnsub)gameUnsub();
  gameUnsub=onSnapshot(doc(db,'games',code),snap=>{if(!snap.exists())return;const d=snap.data();const oppRole=myRole==='blue'?'red':'blue';const myUnits=G.units.filter(u=>u.owner===myRole);const remOpp=(d.units||[]).filter(u=>u.owner===oppRole).map(u=>{const ex=G.units.find(x=>x.id===u.id&&x.owner===oppRole);if(ex){ex.hp=u.hp;ex.tx=u.x;ex.ty=u.y;return ex;}const def=UNIT_DEFS[u.type]||UNIT_DEFS.infantry;return{...def,...u,tx:u.x,ty:u.y,vx:0,vy:0,state:'idle',attackTarget:null,lastAttack:0,lastAttackAnim:0};});G.units=[...myUnits,...remOpp];if(d.funds)G.funds=d.funds;if(d.casualties)G.casualties=d.casualties;if(d.cities&&G.cities){d.cities.forEach(dc=>{const lc=G.cities.find(c=>c.id===dc.id);if(lc){lc.owner=dc.owner;lc.captureProgress=dc.captureProgress;}});updateCitiesPanel();}if(d.phase&&d.phase!==gamePhase){gamePhase=d.phase;if(gamePhase==='battle'){document.getElementById('hudPhase').textContent='–ë–Ü–ô';document.getElementById('placementHint').classList.remove('vis');}}updateHUD();});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAP UPLOAD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.handleMapUpload=async(input)=>{const file=input.files[0];if(!file)return;const st=document.getElementById('mapUploadStatus');st.textContent='‚ü≥ –°—Ç–∏—Å–∫–∞—î–º–æ...';try{const comp=await compressImage(file,3000,3000,.85);st.textContent='‚ü≥ –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ...';const prev=document.getElementById('mapPreview');prev.src=comp;prev.style.display='block';document.getElementById('mapUploadArea').style.display='none';const url=await uploadCloudinary(comp,'lobby_map_'+lobbyId);if(lobbyId)await updateDoc(doc(db,'lobbies',lobbyId),{mapUrl:url,mapVer:Date.now().toString()}).catch(()=>{});loadMapFromUrl(url);st.textContent='‚úÖ –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ!';}catch(e){st.textContent='‚ùå '+e.message;}};
async function uploadCloudinary(base64,publicId){const fd=new FormData();fd.append('file',base64);fd.append('upload_preset',CL_PRESET);if(publicId)fd.append('public_id',publicId);const r=await fetch(`https://api.cloudinary.com/v1_1/${CL_CLOUD}/image/upload`,{method:'POST',body:fd});if(!r.ok){const e=await r.json();throw new Error(e.error?.message||'Upload failed');}return(await r.json()).secure_url;}
function compressImage(file,maxW,maxH,q){return new Promise(res=>{const img=new Image(),url=URL.createObjectURL(file);img.onload=()=>{URL.revokeObjectURL(url);let w=img.width,h=img.height;const r=Math.min(maxW/w,maxH/h,1);w=Math.round(w*r);h=Math.round(h*r);const cv=document.createElement('canvas');cv.width=w;cv.height=h;cv.getContext('2d').drawImage(img,0,0,w,h);res(cv.toDataURL('image/jpeg',q));};img.src=url;});}
function loadMapFromUrl(url){const img=new Image();img.crossOrigin='anonymous';img.onload=()=>{mapBg=img;mapBgW=img.naturalWidth;mapBgH=img.naturalHeight;centerMap();applyMapData();drawAll();};img.src=url;}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CANVAS INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let mapCtx,unitsCtx,frontCtx,uiCtx,interCtx,CW=0,CH=0;
function initGameCanvases(){
  [mapCtx,unitsCtx,frontCtx,uiCtx,interCtx]=['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].map(id=>document.getElementById(id).getContext('2d'));
  resizeCanvases();window.addEventListener('resize',()=>{if(document.getElementById('screen-game').classList.contains('active'))resizeCanvases();});
  setupInteraction();
}
function resizeCanvases(){const area=document.getElementById('gameBody');if(!area)return;CW=Math.max(1,area.clientWidth);CH=Math.max(1,area.clientHeight);['mapCanvas','unitsCanvas','frontCanvas','uiCanvas','interCanvas'].forEach(id=>{const cv=document.getElementById(id);if(!cv)return;cv.width=CW;cv.height=CH;cv.style.width=CW+'px';cv.style.height=CH+'px';});if(mapBgW>0)centerMap();drawAll();}
function centerMap(){if(!mapBgW||!CW||!CH)return;const sc=Math.min(CW/mapBgW,CH/mapBgH);camScale=sc;camX=(CW-mapBgW*camScale)/2;camY=(CH-mapBgH*camScale)/2;}
function s2w(sx,sy){return{wx:(sx-camX)/camScale,wy:(sy-camY)/camScale};}
window.resetView=()=>{if(mapBgW)centerMap();else{camScale=1;camX=0;camY=0;}drawAll();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INPUT / COMMANDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.setInputMode=mode=>{inputMode=mode;['cmdMove','cmdAttack','cmdPatrol'].forEach(id=>document.getElementById(id)?.classList.remove('active'));const map={move:'cmdMove',attack:'cmdAttack',patrol:'cmdPatrol'};document.getElementById(map[mode])?.classList.add('active');patrolPoint1=null;};
window.activateMissileMode=()=>{
  const stingers=G.units.filter(u=>u.owner===myRole&&!u._dead&&u.type==='stinger'&&selectedUnitIds.has(u.id));
  if(!stingers.length){const all=G.units.filter(u=>u.owner===myRole&&!u._dead&&u.type==='stinger');if(!all.length){toast('‚ö†Ô∏è –ù–µ–º–∞—î –°—Ç—Ä—ñ–ª—å—Ü—ñ–≤ ¬´–°–º–µ—Ä—á¬ª!');return;}all.forEach(u=>selectedUnitIds.add(u.id));selectedUnitId=all[0].id;}
  const now=performance.now();const ready=G.units.filter(u=>u.owner===myRole&&!u._dead&&u.type==='stinger'&&selectedUnitIds.has(u.id)&&(!u.lastMissile||now-u.lastMissile>60000));
  if(!ready.length){const sec=Math.ceil(Math.min(...G.units.filter(u=>u.owner===myRole&&!u._dead&&u.type==='stinger'&&selectedUnitIds.has(u.id)).map(u=>Math.max(0,60000-(now-(u.lastMissile||0)))))/1000);toast('‚è≥ –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞: —â–µ '+sec+'—Å');return;}
  missileTargetMode=true;document.getElementById('cmdMissile').classList.add('missile-active');document.getElementById('missileStatus').style.display='';toast('üöÄ '+ready.length+' —Ä–∞–∫–µ—Ç –≥–æ—Ç–æ–≤–æ! –ö–ª—ñ–∫–Ω—ñ—Ç—å —Ü—ñ–ª—å.');
};
window.selectAll=()=>{selectedUnitIds=new Set(G.units.filter(u=>u.owner===myRole&&!u._dead).map(u=>u.id));selectedUnitId=selectedUnitIds.size?[...selectedUnitIds][0]:null;toast('‚ò∞ –í—Å—ñ –≤–∏–¥—ñ–ª–µ–Ω–æ: '+selectedUnitIds.size);drawAll();};
window.stopSelected=()=>{G.units.filter(u=>selectedUnitIds.has(u.id)).forEach(u=>{u.state='hold';u.moveTarget=null;u.patrolA=null;u.patrolB=null;});toast('‚èπ –°—Ç–æ–ø!');};
window.cmdSelected=cmd=>{G.units.filter(u=>selectedUnitIds.has(u.id)).forEach(u=>{if(cmd==='advance'){u.state='advance';u.moveTarget=null;}else if(cmd==='defend'){u.state='defend';u.defendX=u.x;u.defendY=u.y;}else if(cmd==='hold'){u.state='hold';u.moveTarget=null;}});const l={advance:'‚öîÔ∏è –ê—Ç–∞–∫–∞',defend:'üõ°Ô∏è –û–±–æ—Ä–æ–Ω–∞',hold:'‚è∏ –°—Ç–æ–ø'};toast(l[cmd]);};
function updateSelectionHUD(){const n=selectedUnitIds.size;const el=document.getElementById('selInfo');if(n>1){el.classList.add('vis');document.getElementById('siName').textContent=`‚ö° –í–∏–¥—ñ–ª–µ–Ω–æ ${n} —é–Ω—ñ—Ç—ñ–≤`;document.getElementById('siHPText').textContent='';document.getElementById('siHPBar').style.width='100%';document.getElementById('siAtk').textContent='‚Äî';document.getElementById('siDef').textContent='‚Äî';document.getElementById('siSpd').textContent='‚Äî';const me=document.getElementById('siMode');if(me)me.textContent='–ì–†–£–ü–ê';}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UNIT PLACEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildUnitList(){document.getElementById('unitTypesList').innerHTML=Object.entries(UNIT_DEFS).map(([type,d])=>`<div class="sp-unit-btn" onclick="selectUnitType('${type}')" id="ubtn_${type}"><span class="sp-unit-icon">${d.emoji}</span><div class="sp-unit-info"><div class="sp-unit-name">${d.name}</div><div class="sp-unit-stat">HP:${d.hp} ¬∑ –ê–¢–ö:${d.atk}</div></div><span class="sp-unit-cost">${d.cost}</span></div>`).join('');}
window.selectUnitType=type=>{const def=UNIT_DEFS[type];if(G.funds[myRole]<def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤!');return;}placingType=type;document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));document.getElementById('ubtn_'+type)?.classList.add('active');document.getElementById('placementHint').classList.add('vis');document.getElementById('placementHint').textContent='–†–û–ó–ú–Ü–°–¢–Ü–¢–¨ '+def.name.toUpperCase()+' ('+def.cost+' ‚Ç¥) | –ü–ö–ú = —Å–∫–∞—Å—É–≤–∞—Ç–∏';};
// isOnWater replaced by pixel-based isTerrainWater
// isOnBridge replaced by pixel-based isTerrainBridge
const SPAWN_BASE_RADIUS=140;  // px around friendly base
const SPAWN_CITY_RADIUS=90;   // px around friendly/neutral city

function isValidSpawnPoint(wx,wy){
  // Check distance to friendly base
  const base=G.bases?.[myRole];
  if(base&&Math.hypot(wx-base.x,wy-base.y)<=SPAWN_BASE_RADIUS)return true;
  // Check distance to friendly or neutral cities
  for(const city of(G.cities||[])){
    if(city.owner===myRole||city.owner==='neutral'){
      if(Math.hypot(wx-city.x,wy-city.y)<=SPAWN_CITY_RADIUS)return true;
    }
  }
  return false;
}

function placeUnit(wx,wy){
  if(!placingType)return;const def=UNIT_DEFS[placingType];if(!def){placingType=null;return;}
  if(G.funds[myRole]<def.cost){toast('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ñ–æ–Ω–¥—ñ–≤!');return;}
  // Boundary check
  const mapW=mapBgW||2000,mapH=mapBgH||1200;
  if(wx<0||wx>mapW||wy<0||wy>mapH){toast('‚ö†Ô∏è –ó–∞ –º–µ–∂–∞–º–∏ –∫–∞—Ä—Ç–∏!');return;}
  // Spawn zone check ‚Äî must be near base or city
  if(!isValidSpawnPoint(wx,wy)){
    toast('‚ö†Ô∏è –†–æ–∑–º—ñ—â–µ–Ω–Ω—è –ª–∏—à–µ –±—ñ–ª—è —Å–≤–æ—î—ó –±–∞–∑–∏ –∞–±–æ –º—ñ—Å—Ç–∞!');return;
  }
  if(isTerrainWater(wx,wy)&&!isTerrainBridge(wx,wy)&&placingType!=='heli'){toast('üåä –õ–∏—à–µ –≥–µ–ª—ñ–∫–æ–ø—Ç–µ—Ä –∞–±–æ –Ω–∞ –º–æ—Å—Ç—É!');return;}
  G.units.push({id:G.nextId++,type:placingType,owner:myRole,x:wx,y:wy,tx:wx,ty:wy,vx:0,vy:0,hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,state:'idle',attackTarget:null,forceTarget:null,moveTarget:null,lastAttack:0,lastAttackAnim:0});
  G.funds[myRole]-=def.cost;addLog('üìç '+def.name+' —Ä–æ–∑–º—ñ—â–µ–Ω–æ'+(gamePhase==='battle'?' [–ø—ñ–¥–∫—Ä—ñ–ø–ª–µ–Ω–Ω—è]':''),'info');
  placingType=null;document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));document.getElementById('placementHint').classList.remove('vis');
  syncGameState();updateHUD();drawAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BATTLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.startBattle=()=>{
  if(gamePhase==='battle')return;if(G.units.filter(u=>u.owner===myRole).length===0){toast('‚ö†Ô∏è –†–æ–∑–º—ñ—Å—Ç—ñ—Ç—å —Ö–æ—á–∞ –± 1 —é–Ω—ñ—Ç!');return;}
  gamePhase='battle';document.getElementById('hudPhase').textContent='–ë–Ü–ô';document.getElementById('placementHint').classList.remove('vis');
  addLog('‚öîÔ∏è –ë–Ü–ô –†–û–ó–ü–û–ß–ê–¢–û!','warn');if(incomeInterval)clearInterval(incomeInterval);incomeInterval=setInterval(tickIncome,15000);
  if(isAI)spawnAIUnits();syncGameState();
};
function spawnAIUnits(){
  const oppRole=myRole==='blue'?'red':'blue';
  const mapW=mapBgW||2000,mapH=mapBgH||1200;
  // Use actual base position from map data
  const base=G.bases?.[oppRole];
  const spawnX=base?base.x:(oppRole==='red'?mapW*.85:mapW*.15);
  const spawnY=base?base.y:mapH*.5;
  let types;
  if(aiMode==='defense')types=['infantry','infantry','infantry','apc','tank'];
  else if(aiMode==='attack')types=['tank','tank','apc','apc','infantry','artillery'];
  else if(aiMode==='blitz')types=['heli','heli','apc','apc','infantry'];
  else types=['infantry','apc','tank','heli','artillery','infantry'];
  const n=types.length;
  types.forEach((t,i)=>{
    const def=UNIT_DEFS[t];
    const angle=(i/n)*Math.PI*2;
    const r=50+rnd(0,40);
    const sx=spawnX+Math.cos(angle)*r,sy=spawnY+Math.sin(angle)*r;
    const clampedX=Math.max(10,Math.min(mapW-10,sx));
    const clampedY=Math.max(10,Math.min(mapH-10,sy));
    G.units.push({id:G.nextId++,type:t,owner:oppRole,x:clampedX,y:clampedY,tx:0,ty:0,vx:0,vy:0,hp:def.hp,maxHp:def.hp,atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,state:'advance',defendX:spawnX,defendY:spawnY,attackTarget:null,lastAttack:0,lastAttackAnim:0,lastMissile:0});
  });
}
function spawnAIWave(){
  const oppRole=myRole==='blue'?'red':'blue';const mapW=mapBgW||2000,mapH=mapBgH||1200;
  const base=G.bases?.[oppRole];
  const spawnX=base?base.x:(oppRole==='red'?mapW*.85:mapW*.15);
  const spawnY=base?base.y:mapH*.5;
  const types=G.wave<3?['infantry','apc']:G.wave<5?['apc','tank','infantry']:['tank','tank','heli'];
  types.forEach((t,i)=>{
    const def=UNIT_DEFS[t];
    const sx=spawnX+rnd(-60,60),sy=spawnY+rnd(-60,60);
    const clampedX=Math.max(10,Math.min(mapW-10,sx));
    const clampedY=Math.max(10,Math.min(mapH-10,sy));
    G.units.push({id:G.nextId++,type:t,owner:oppRole,x:clampedX,y:clampedY,tx:0,ty:0,vx:0,vy:0,hp:def.hp*Math.min(1+G.wave*.1,2),maxHp:def.hp*Math.min(1+G.wave*.1,2),atk:def.atk,def:def.def,speed:def.speed,range:def.range,radius:def.radius,state:'advance',defendX:spawnX,defendY:spawnY,attackTarget:null,lastAttack:0,lastAttackAnim:0});
  });
}
function rnd(a,b){return a+Math.floor(Math.random()*(b-a+1));}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TERRAIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Pixel-based terrain functions ‚Äî fast and accurate
function getTerrainAt(wx,wy){return sampleTerrainAt(wx,wy);}
function getTerrainSpeedMultiplier(wx,wy){
  const t=getTerrainAt(wx,wy);
  if(t==='road')return 1.4;
  if(t==='forest')return 0.5;
  if(t==='meadow')return 1.0;
  if(t==='water')return 0; // blocked
  if(t==='bridge')return 1.0;
  return 1.0;
}
function isTerrainWater(wx,wy){return getTerrainAt(wx,wy)==='water';}
function isTerrainBridge(wx,wy){return getTerrainAt(wx,wy)==='bridge';}
function isTerrainForest(wx,wy){return getTerrainAt(wx,wy)==='forest';}
function isTerrainRoad(wx,wy){return getTerrainAt(wx,wy)==='road';}
function canMoveTo(x,y,unitType){
  if(unitType==='heli')return true;
  const t=getTerrainAt(x,y);
  if(t==='water')return false; // water blocks ground
  return true;
}
// Road pathfinding ‚Äî try to stay on roads when possible
function roadAwareMove(u,tx,ty,dt){
  const mw=mapBgW||2000,mh=mapBgH||1200;
  const dx=tx-u.x,dy=ty-u.y,dist=Math.max(1,Math.sqrt(dx*dx+dy*dy));
  if(dist<4){u.x=tx;u.y=ty;return;}
  const t=getTerrainAt(u.x,u.y);
  const onRoad=(t==='road'||t==='bridge');
  // If not on road, check if there's a road nearby to detour onto
  if(!onRoad){
    const searchR=80;
    for(const angle of[0,-0.4,0.4,-0.8,0.8,-1.2,1.2]){
      const nx2=u.x+Math.cos(Math.atan2(dy,dx)+angle)*searchR;
      const ny2=u.y+Math.sin(Math.atan2(dy,dx)+angle)*searchR;
      if(getTerrainAt(nx2,ny2)==='road'&&canMoveTo(nx2,ny2,u.type)){
        // Nudge toward road
        const rdx=nx2-u.x,rdy=ny2-u.y,rd=Math.max(1,Math.sqrt(rdx*rdx+rdy*rdy));
        const blendX=(dx/dist*0.6+rdx/rd*0.4),blendY=(dy/dist*0.6+rdy/rd*0.4);
        const bl=Math.max(1,Math.sqrt(blendX*blendX+blendY*blendY));
        const speedMult=getTerrainSpeedMultiplier(u.x,u.y)||1.0;
        const step=u.speed*dt*speedMult;
        const nx3=u.x+(blendX/bl)*step,ny3=u.y+(blendY/bl)*step;
        if(canMoveTo(nx3,ny3,u.type)){u.x=nx3;u.y=ny3;return;}
        break;
      }
    }
  }
  moveToward(u,tx,ty,dt);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GAME LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let lastFrame=0;
function startGameLoop(){if(animFrame)cancelAnimationFrame(animFrame);lastFrame=performance.now();(function loop(ts){const dt=Math.min((ts-lastFrame)/1000,.05);lastFrame=ts;if(gamePhase==='battle'){updateUnits(dt);updateAI(dt);updateProjectiles(dt);updateCityCapture(dt);checkWinCondition();}drawAll();animFrame=requestAnimationFrame(loop);})(performance.now());}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIX #3: UNIT LOGIC ‚Äî —é–Ω—ñ—Ç–∏ –ù–ï —Ä—É—Ö–∞—é—Ç—å—Å—è —Å–∞–º–æ—Å—Ç—ñ–π–Ω–æ
//  –°—Ç–∞–Ω 'idle' = —Å—Ç–æ—è—Ç—å —ñ –ù–ï –∞—Ç–∞–∫—É—é—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
//  –°—Ç—Ä—ñ–ª–µ—Ü—å ¬´–°–º–µ—Ä—á¬ª (stinger) ‚Äî –ë–ï–ó –∞–≤—Ç–æ–∞—Ç–∞–∫–∏ –ø—Ä–∏ –Ω–∞–±–ª–∏–∂–µ–Ω–Ω—ñ
//  –¢—ñ–ª—å–∫–∏ advance / moving / patrol / defend / force_attack / hold ‚Äî –∞–∫—Ç–∏–≤–Ω—ñ —Å—Ç–∞–Ω–∏
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUnits(dt){
  const now=performance.now();
  for(const u of G.units.filter(u=>u.owner===myRole&&!u._dead)){
    // IDLE ‚Äî —Å—Ç–æ—è—Ç—å –Ω–∞ –º—ñ—Å—Ü—ñ, –Ω–µ —Å—Ç—Ä—ñ–ª—è—é—Ç—å (FIX #3)
    if(u.state==='idle')continue;

    const opp=G.units.filter(e=>e.owner!==myRole&&!e._dead);

    // HOLD ‚Äî —Å—Ç–æ—è—Ç—å, –Ω–µ —Ä—É—Ö–∞—é—Ç—å—Å—è, –Ω–µ —Å—Ç—Ä—ñ–ª—è—é—Ç—å (FIX #2 for stinger: HOLD=no auto shoot)
    if(u.state==='hold')continue;

    // FORCE ATTACK
    if(u.state==='force_attack'&&u.forceTarget){
      const tgt=G.units.find(x=>x.id===u.forceTarget&&!x._dead);
      if(!tgt){u.state='idle';u.forceTarget=null;}
      else{const d=Math.hypot(tgt.x-u.x,tgt.y-u.y);if(d<=u.range){if(now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;doAttack(u,tgt);}}else{moveToward(u,tgt.x,tgt.y,dt);}}
      continue;
    }

    // MOVE ‚Äî —Ä—É—Ö –¥–æ —Ç–æ—á–∫–∏, —Å—Ç—Ä—ñ–ª—è—Ç–∏ –ø–æ–∫–∏ —Ä—É—Ö–∞—î–º–æ—Å—å (–∫—Ä—ñ–º stinger ‚Äî FIX #2)
    if(u.state==='moving'&&u.moveTarget){
      const dx=u.moveTarget.x-u.x,dy=u.moveTarget.y-u.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<6){u.state='idle';u.moveTarget=null;}
      else{
        // –°—Ç—Ä–µ–ª—è—î–º–æ –Ω–∞ —Ö–æ–¥—É (–ù–ï –¥–ª—è stinger)
        if(!UNIT_DEFS[u.type]?.isMissile&&opp.length){const ne=nearestEnemy(u,opp);if(ne&&ne.d<=u.range&&now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
        moveToward(u,u.moveTarget.x,u.moveTarget.y,dt);
      }
      continue;
    }

    // PATROL
    if(u.state==='patrol'&&u.patrolA&&u.patrolB){
      if(!UNIT_DEFS[u.type]?.isMissile&&opp.length){const ne=nearestEnemy(u,opp);if(ne&&ne.d<=u.range&&now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
      const dest=u.patrolDir>0?u.patrolB:u.patrolA;const dx=dest.x-u.x,dy=dest.y-u.y,d=Math.sqrt(dx*dx+dy*dy);
      if(d<8)u.patrolDir*=-1;else moveToward(u,dest.x,dest.y,dt);continue;
    }

    // DEFEND ‚Äî —Å—Ç–æ—è—Ç—å near —Ç–æ—á—Ü—ñ, –∞—Ç–∞–∫—É—é—Ç—å –∑–∞–≥—Ä–æ–∑–∏ (–∫—Ä—ñ–º stinger)
    if(u.state==='defend'){
      const defX=u.defendX||u.x,defY=u.defendY||u.y;
      if(!UNIT_DEFS[u.type]?.isMissile&&opp.length){
        const ne=nearestEnemy(u,opp);
        if(ne&&ne.d<=u.range){if(now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
        else if(ne&&ne.d<=u.range*2.5){const distFromBase=Math.hypot(ne.unit.x-defX,ne.unit.y-defY);if(distFromBase<u.range*3)moveToward(u,ne.unit.x,ne.unit.y,dt*.6);}
      }
      const dBack=Math.hypot(u.x-defX,u.y-defY);if(dBack>40)moveToward(u,defX,defY,dt*.3);continue;
    }

    // ADVANCE ‚Äî —Ñ—Ä–æ–Ω—Ç –ª–∞–π–Ω (–∫—Ä—ñ–º stinger –±–µ–∑ –∞–≤—Ç–æ–∞—Ç–∞–∫–∏)
    if(u.state==='advance'||u.state==='front'){
      if(!opp.length)continue;
      const frontUnits=G.units.filter(v=>v.owner===myRole&&!v._dead&&(v.state==='advance'||v.state==='front'));
      const mySlot=[...frontUnits].sort((a,b)=>a.y-b.y).findIndex(v=>v.id===u.id);
      const nFront=frontUnits.length;
      const mapH=mapBgH||1200;const margin=mapH*.08;
      const slotY=nFront<=1?mapH/2:(margin+mySlot*(mapH-margin*2)/(Math.max(1,nFront-1)));
      const ne=nearestEnemy(u,opp);if(!ne)continue;
      const stopDist=u.range*0.85;
      const targetX=myRole==='blue'?ne.unit.x-stopDist:ne.unit.x+stopDist;
      const atTargetX=myRole==='blue'?u.x>=targetX:u.x<=targetX;
      // –ê—Ç–∞–∫–∞: –¥–ª—è stinger ‚Äî –ù–ï –∞–≤—Ç–æ–∞—Ç–∞–∫–∞ (FIX #2)
      if(!UNIT_DEFS[u.type]?.isMissile&&ne.d<=u.range&&now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}
      if(atTargetX&&Math.abs(u.y-slotY)<20){u.state='front';}
      else{u.state='advance';moveToward(u,targetX,slotY,dt);}
    }
  }
  G.units=G.units.filter(u=>!u._dead);
}
function nearestEnemy(u,opp){let n=null,nd=Infinity;for(const e of opp){const d=Math.hypot(e.x-u.x,e.y-u.y);if(d<nd){nd=d;n=e;}}return n?{unit:n,d:nd}:null;}
function moveToward(u,tx,ty,dt){
  const dx=tx-u.x,dy=ty-u.y,dist=Math.max(1,Math.sqrt(dx*dx+dy*dy));
  const rawMult=getTerrainSpeedMultiplier(u.x,u.y);
  const speedMult=Math.max(0.1,rawMult||1.0);
  const step=u.speed*dt*speedMult;
  const nx2=u.x+(dx/dist)*step,ny2=u.y+(dy/dist)*step;
  // Map boundary clamp
  const mw=mapBgW||2000,mh=mapBgH||1200;
  const cx2=Math.max(0,Math.min(mw,nx2)),cy2=Math.max(0,Math.min(mh,ny2));
  if(canMoveTo(cx2,cy2,u.type)){u.x=cx2;u.y=cy2;}
  else if(canMoveTo(cx2,u.y,u.type)){u.x=cx2;}
  else if(canMoveTo(u.x,cy2,u.type)){u.y=cy2;}
}
function doAttack(attacker,target){
  if(UNIT_DEFS[attacker.type]?.isMissile){projectiles.push({id:Date.now()+'_'+Math.random(),ox:attacker.x,oy:attacker.y,tx:target.x+rnd(-5,5),ty:target.y+rnd(-5,5),targetId:target.id,owner:attacker.owner,progress:0,damage:Math.max(1,attacker.atk+rnd(-5,5)),trail:[],isGround:false});addLog('üöÄ ¬´–°–º–µ—Ä—á¬ª –ø—É—Å–∫!',attacker.owner===myRole?'info':'warn');return;}
  const dmg=Math.max(1,attacker.atk-Math.floor(target.def/3)+rnd(-3,3));target.hp-=dmg;if(target.hp<=0)killUnit(target);
}
function updateProjectiles(dt){const speed=dt*280;for(const p of projectiles){const totalDist=Math.hypot(p.tx-p.ox,p.ty-p.oy);p.progress+=speed/Math.max(1,totalDist);const cx=p.ox+(p.tx-p.ox)*p.progress,cy=p.oy+(p.ty-p.oy)*p.progress;p.trail.push({x:cx,y:cy});if(p.trail.length>12)p.trail.shift();if(p.progress>=1){p._done=true;const tgt=G.units.find(u=>u.id===p.targetId&&!u._dead);if(tgt){tgt.hp-=p.damage;tgt.lastAttackAnim=performance.now();if(tgt.hp<=0)killUnit(tgt);}const splashR=p.isGround?55:30;G.units.filter(u=>u.id!==p.targetId&&!u._dead&&Math.hypot(u.x-p.tx,u.y-p.ty)<splashR&&u.owner!==p.owner).forEach(u=>{const splash=Math.round(p.damage*(p.isGround?.5:.3));u.hp-=splash;if(u.hp<=0)killUnit(u);});}}projectiles=projectiles.filter(p=>!p._done);}
function killUnit(u){u._dead=true;G.casualties[u.owner]=(G.casualties[u.owner]||0)+1;addLog('üíÄ '+UNIT_DEFS[u.type]?.name+' –∑–Ω–∏—â–µ–Ω–æ!',u.owner===myRole?'bad':'good');updateHUD();}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AI LOGIC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateAI(dt){
  if(!isAI)return;const oppRole=myRole==='blue'?'red':'blue';const now=performance.now();const mapW=mapBgW||2000,mapH=mapBgH||1200;
  const pl=G.units.filter(e=>e.owner===myRole&&!e._dead);const aiUnits=G.units.filter(u=>u.owner===oppRole&&!u._dead);if(!aiUnits.length)return;
  const enemyCities=G.cities?.filter(c=>c.owner===myRole)||[];const neutralCities=G.cities?.filter(c=>c.owner==='neutral')||[];
  // AI stinger missile: —Ä–∞–∑ –Ω–∞ 60—Å
  for(const u of aiUnits.filter(u=>u.type==='stinger')){if(!u.lastMissile)u.lastMissile=0;if(now-u.lastMissile>60000&&pl.length){const tgt=[...pl].sort((a,b)=>b.hp-a.hp)[0];if(tgt&&Math.hypot(tgt.x-u.x,tgt.y-u.y)<=u.range*1.2){u.lastMissile=now;u.lastAttack=now;doAttack(u,tgt);addLog('ü§ñüöÄ –®–Ü –ø—É—Å–∫ —Ä–∞–∫–µ—Ç–∏!','warn');}}}
  const sortedAIByY=[...aiUnits].sort((a,b)=>a.y-b.y);const nAI=aiUnits.length;
  const plFrontX=pl.length?(oppRole==='red'?Math.max(...pl.map(v=>v.x)):Math.min(...pl.map(v=>v.x))):mapW/2;
  const globalStopDist=(oppRole==='red'?1:-1)*(aiMode==='defense'?40:aiMode==='blitz'?10:30);const globalFrontX=plFrontX+globalStopDist;
  for(const u of aiUnits){
    const ne=nearestFrom(u,pl);
    if(aiMode==='defense'){
      const base=G.bases?.[oppRole];const baseX=base?base.x:(oppRole==='red'?mapW*.85:mapW*.15);
      const slotIdx=sortedAIByY.findIndex(v=>v.id===u.id);const margin=mapH*.1;const slotY=nAI<=1?mapH/2:(margin+slotIdx*(mapH-2*margin)/(Math.max(1,nAI-1)));
      const defLineX=oppRole==='red'?baseX-150:baseX+150;const holdX=oppRole==='red'?Math.min(defLineX,plFrontX-u.range*.6):Math.max(defLineX,plFrontX+u.range*.6);
      if(!UNIT_DEFS[u.type]?.isMissile&&ne&&ne.d<=u.range){if(now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
      else if(ne&&ne.d<u.range*2)aiMovePref(u,ne.unit.x,ne.unit.y,dt*.7);
      else{const atLine=Math.abs(u.x-holdX)<30&&Math.abs(u.y-slotY)<30;if(!atLine)aiMovePref(u,holdX,slotY,dt*.5);}
      u.state='defend';continue;
    }
    const slotIdx=sortedAIByY.findIndex(v=>v.id===u.id);const margin=mapH*.06;const slotY=nAI<=1?mapH/2:(margin+slotIdx*(mapH-2*margin)/(Math.max(1,nAI-1)));
    const typeOffset=(u.type==='artillery'?u.range*.6:u.type==='stinger'?u.range*.7:0);const personalFrontX=oppRole==='red'?globalFrontX+typeOffset:globalFrontX-typeOffset;
    let objectiveTarget=null;
    if((aiMode==='conquest'||aiMode==='blitz')&&slotIdx%3===0){const allT=[...neutralCities,...enemyCities];if(allT.length){let nc=null,nd2=Infinity;for(const c of allT){const d=Math.hypot(c.x-u.x,c.y-u.y);if(d<nd2){nd2=d;nc=c;}}if(nc&&(!ne||nd2<ne.d*0.8))objectiveTarget=nc;}}
    if(!UNIT_DEFS[u.type]?.isMissile&&ne&&ne.d<=u.range){if(now-u.lastAttack>1000){u.lastAttack=now;u.lastAttackAnim=now;u.attackTarget=ne.unit.id;doAttack(u,ne.unit);}}
    const atFrontX=oppRole==='red'?u.x<=personalFrontX+15:u.x>=personalFrontX-15;const atSlotY=Math.abs(u.y-slotY)<20;
    if(objectiveTarget){aiMovePref(u,objectiveTarget.x,objectiveTarget.y,dt);u.state='advance';}
    else if(atFrontX&&atSlotY){u.state='front';if(aiMode==='blitz'&&ne&&ne.d<u.range*1.5){aiMovePref(u,ne.unit.x,ne.unit.y,dt*.6);u.state='advance';}}
    else{u.state='advance';const yDelta=Math.abs(u.y-slotY);const xDelta=Math.abs(u.x-personalFrontX);if(yDelta>50&&xDelta<80)aiMovePref(u,u.x,slotY,dt);else aiMovePref(u,personalFrontX,slotY,dt);}
  }
}
function nearestFrom(u,arr){let n=null,nd=Infinity;for(const e of arr){const d=Math.hypot(e.x-u.x,e.y-u.y);if(d<nd){nd=d;n=e;}}return n?{unit:n,d:nd}:null;}
function aiMovePref(u,tx,ty,dt){
  // AI prefers roads over direct path
  const midX=(u.x+tx)/2,midY=(u.y+ty)/2;
  const midTerrain=getTerrainAt(midX,midY);
  const onRoad=(getTerrainAt(u.x,u.y)==='road'||midTerrain==='road');
  if(midTerrain==='forest'){
    // Avoid forest ‚Äî try perpendicular detour
    const dx=tx-u.x,dy=ty-u.y,dist=Math.max(1,Math.sqrt(dx*dx+dy*dy));
    const perpX=-dy/dist,perpY=dx/dist;
    for(const off of[60,-60,120,-120]){
      const ax=midX+perpX*off,ay=midY+perpY*off;
      if(getTerrainAt(ax,ay)!=='forest'&&canMoveTo(ax,ay,u.type)){moveToward(u,ax,ay,dt*.8);return;}
    }
  }
  roadAwareMove(u,tx,ty,dt);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WIN CONDITION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function checkWinCondition(){
  if(gameOver)return;const bl=G.units.filter(u=>u.owner==='blue'&&!u._dead);const rd=G.units.filter(u=>u.owner==='red'&&!u._dead);
  if(!bl.length&&rd.length)showResult('red','–í—Å—ñ —Å–∏–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');else if(!rd.length&&bl.length)showResult('blue','–í—Å—ñ —á–µ—Ä–≤–æ–Ω—ñ –∑–Ω–∏—â–µ–Ω—ñ');
  if(G.bases){['blue','red'].forEach(team=>{const eb=G.bases[team==='blue'?'red':'blue'];if(!eb)return;const inBase=G.units.filter(u=>u.owner===team&&!u._dead&&Math.hypot(u.x-eb.x,u.y-eb.y)<40);if(inBase.length>=2){if(!G._baseTimer)G._baseTimer={team,start:Date.now()};else if(G._baseTimer.team===team&&(Date.now()-G._baseTimer.start)>5000)showResult(team,'–ë–∞–∑–∞ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –≤–∑—è—Ç–∞!');}else if(G._baseTimer?.team===team)G._baseTimer=null;});}
  if(isAI&&aiMode==='conquest'&&G.cities.length>0){const oppRole=myRole==='blue'?'red':'blue';if(G.cities.every(c=>c.owner===myRole))showResult(myRole,'–í—Å—ñ –º—ñ—Å—Ç–∞ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º!');else if(G.cities.every(c=>c.owner===oppRole))showResult(oppRole,'–í–æ—Ä–æ–≥ –∑–∞—Ö–æ–ø–∏–≤ –≤—Å—ñ –º—ñ—Å—Ç–∞!');}
}
function showResult(winner,reason=''){if(gameOver)return;gameOver=true;if(timerInterval)clearInterval(timerInterval);if(incomeInterval)clearInterval(incomeInterval);const isWinner=winner===myRole;document.getElementById('resultEmoji').textContent=isWinner?'üèÜ':'üíÄ';document.getElementById('resultTitle').textContent=isWinner?'–ü–ï–†–ï–ú–û–ì–ê!':'–ü–û–†–ê–ó–ö–ê';document.getElementById('resultTitle').style.color=isWinner?'var(--green)':'var(--red)';const bc=G.cities?.filter(c=>c.owner==='blue').length||0,rc=G.cities?.filter(c=>c.owner==='red').length||0;document.getElementById('resultSub').textContent=(reason?reason+'\n':'')+`üîµ –í—Ç—Ä–∞—Ç–∏: ${G.casualties?.blue||0} ¬∑ –ú—ñ—Å—Ç: ${bc}\nüî¥ –í—Ç—Ä–∞—Ç–∏: ${G.casualties?.red||0} ¬∑ –ú—ñ—Å—Ç: ${rc}\n‚è± ${document.getElementById('hudTimer').textContent}`;document.getElementById('resultOverlay').classList.add('vis');}
window.backToMenu=()=>{document.getElementById('resultOverlay').classList.remove('vis');if(animFrame)cancelAnimationFrame(animFrame);if(timerInterval)clearInterval(timerInterval);if(incomeInterval)clearInterval(incomeInterval);if(lobbyUnsub){lobbyUnsub();lobbyUnsub=null;}if(gameUnsub){gameUnsub();gameUnsub=null;}if(presenceUnsub){clearInterval(presenceUnsub);presenceUnsub=null;}hideDcBanner();G={};gameOver=false;placingType=null;isAI=false;lobbyId=null;showScreen('screen-menu');};
window.confirmQuit=()=>{if(confirm('–í–∏–π—Ç–∏ –∑ –≥—Ä–∏?'))backToMenu();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MOUSE INTERACTION (GAME)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setupInteraction(){
  const cv=document.getElementById('interCanvas');
  cv.addEventListener('mousedown',onMD);cv.addEventListener('mousemove',onMM);cv.addEventListener('mouseup',onMU);
  cv.addEventListener('wheel',onWheel,{passive:false});cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('touchstart',onTStart,{passive:false});cv.addEventListener('touchmove',onTMove,{passive:false});cv.addEventListener('touchend',onTEnd,{passive:false});
  window.addEventListener('keydown',onKey);
}
function canvasRelXY(clientX,clientY){const cv=document.getElementById('interCanvas');const rect=cv?cv.getBoundingClientRect():{left:0,top:0};return{x:clientX-rect.left,y:clientY-rect.top};}
let pinchDist=0;
function onTStart(e){e.preventDefault();if(e.touches.length===1){isDragging=false;const r=canvasRelXY(e.touches[0].clientX,e.touches[0].clientY);dragLX=r.x;dragLY=r.y;}else if(e.touches.length===2)pinchDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
function onTMove(e){e.preventDefault();if(e.touches.length===1){const r=canvasRelXY(e.touches[0].clientX,e.touches[0].clientY);const dx=r.x-dragLX,dy=r.y-dragLY;if(Math.abs(dx)+Math.abs(dy)>4)isDragging=true;if(isDragging){camX+=dx;camY+=dy;clampCamera();dragLX=r.x;dragLY=r.y;drawAll();}}else if(e.touches.length===2){const nd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);const mc=canvasRelXY((e.touches[0].clientX+e.touches[1].clientX)/2,(e.touches[0].clientY+e.touches[1].clientY)/2);zoom(nd/pinchDist,mc.x,mc.y);pinchDist=nd;}}
function onTEnd(e){e.preventDefault();if(!isDragging&&e.changedTouches.length===1){const r=canvasRelXY(e.changedTouches[0].clientX,e.changedTouches[0].clientY);handleClick(r.x,r.y,false,false);}isDragging=false;}
function onWheel(e){e.preventDefault();const r=canvasRelXY(e.clientX,e.clientY);zoom(e.deltaY<0?1.12:0.9,r.x,r.y);}
function clampCamera(){
  if(!mapBgW||!CW||!CH)return;
  // Min scale: map fits in viewport (no zooming out beyond fit)
  const minScale=Math.min(CW/mapBgW,CH/mapBgH);
  camScale=Math.max(minScale,Math.min(8,camScale));
  const mw=mapBgW*camScale,mh=mapBgH*camScale;
  // Clamp pan so map fills viewport (can't pan beyond edges)
  if(mw>=CW){camX=Math.min(0,Math.max(CW-mw,camX));}else{camX=(CW-mw)/2;}
  if(mh>=CH){camY=Math.min(0,Math.max(CH-mh,camY));}else{camY=(CH-mh)/2;}
}
function zoom(f,mx,my){
  const minScale=mapBgW?Math.min(CW/mapBgW,CH/mapBgH):0.08;
  const ns=Math.max(minScale,Math.min(8,camScale*f));
  camX=mx-(mx-camX)*(ns/camScale);camY=my-(my-camY)*(ns/camScale);camScale=ns;
  clampCamera();
  document.getElementById('zoomInd').textContent=Math.round(camScale*100)+'%';drawAll();
}
function onMD(e){const r=canvasRelXY(e.clientX,e.clientY);if(e.button===1){e.preventDefault();isDragging=true;dragLX=r.x;dragLY=r.y;return;}if(e.button===2){isDragging=false;handleClick(r.x,r.y,true,e.shiftKey);return;}isDragging=false;dragLX=r.x;dragLY=r.y;}
function onMM(e){const r=canvasRelXY(e.clientX,e.clientY);if(e.buttons===4){camX+=r.x-dragLX;camY+=r.y-dragLY;clampCamera();dragLX=r.x;dragLY=r.y;drawAll();return;}if(e.buttons===1){const dx=r.x-dragLX,dy=r.y-dragLY;if(!isDragging&&Math.abs(dx)+Math.abs(dy)>5)isDragging=true;if(isDragging){camX+=r.x-dragLX;camY+=r.y-dragLY;clampCamera();drawAll();}}dragLX=r.x;dragLY=r.y;}
function onMU(e){if(isDragging){isDragging=false;return;}const r=canvasRelXY(e.clientX,e.clientY);if(e.button===0)handleClick(r.x,r.y,false,e.shiftKey);}
function onKey(e){
  if(e.code==='Escape'){placingType=null;document.getElementById('placementHint').classList.remove('vis');document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));}
  if(e.code==='Space'){e.preventDefault();if(gamePhase==='placement')startBattle();}
  // Ctrl+Z: undo last unit placement (works EN + UK layout)
  const isZ=e.key.toLowerCase()==='z'||e.key==='—è'||e.code==='KeyZ';
  if((e.ctrlKey||e.metaKey)&&isZ&&gamePhase==='placement'){
    e.preventDefault();
    const myUnits=G.units.filter(u=>u.owner===myRole&&!u._dead);
    if(myUnits.length){
      const last=myUnits[myUnits.length-1];
      const def=UNIT_DEFS[last.type];G.funds[myRole]+=(def?.cost||0);
      G.units=G.units.filter(u=>u.id!==last.id);
      addLog('‚Ü© –°–∫–∞—Å–æ–≤–∞–Ω–æ: '+def?.name,'warn');toast('‚Ü© –°–∫–∞—Å–æ–≤–∞–Ω–æ: '+(def?.name||'—é–Ω—ñ—Ç'));
      syncGameState();updateHUD();drawAll();
    }
  }
}

function handleClick(sx,sy,isRight,isShift=false){
  if(!G.units)return;const{wx,wy}=s2w(sx,sy);
  // MISSILE MODE
  if(missileTargetMode&&!isRight){
    missileTargetMode=false;document.getElementById('cmdMissile').classList.remove('missile-active');document.getElementById('missileStatus').style.display='none';
    const now=performance.now();const ready=G.units.filter(u=>u.owner===myRole&&!u._dead&&u.type==='stinger'&&selectedUnitIds.has(u.id)&&(!u.lastMissile||now-u.lastMissile>60000));
    if(!ready.length){toast('‚ö†Ô∏è –ù–µ–º–∞—î –≥–æ—Ç–æ–≤–∏—Ö —Ä–∞–∫–µ—Ç');return;}
    const targetUnit=G.units.find(u=>u.owner!==myRole&&!u._dead&&Math.hypot(u.x-wx,u.y-wy)<(UNIT_DEFS[u.type]?.radius||10)*2+20);
    ready.forEach(u=>{u.lastMissile=now;u.lastAttack=now;u.lastAttackAnim=now;if(targetUnit)doAttack(u,targetUnit);else projectiles.push({id:Date.now()+'_'+Math.random(),ox:u.x,oy:u.y,tx:wx,ty:wy,targetId:null,owner:u.owner,progress:0,damage:Math.max(1,u.atk+rnd(-5,5)),trail:[],isGround:true});});
    toast('üí• –†–∞–∫–µ—Ç –≤–∏–ø—É—â–µ–Ω–æ: '+ready.length);drawAll();return;
  }
  if(missileTargetMode&&isRight){missileTargetMode=false;document.getElementById('cmdMissile').classList.remove('missile-active');document.getElementById('missileStatus').style.display='none';toast('‚ùå –°–∫–∞—Å–æ–≤–∞–Ω–æ');return;}
  // PLACEMENT
  if(placingType&&!isRight){placeUnit(wx,wy);return;}
  if(placingType&&isRight){placingType=null;document.querySelectorAll('.sp-unit-btn').forEach(b=>b.classList.remove('active'));document.getElementById('placementHint').classList.remove('vis');return;}
  if(!isRight){
    const clicked=G.units.find(u=>!u._dead&&Math.hypot(u.x-wx,u.y-wy)<(UNIT_DEFS[u.type]?.radius||10)*1.5+4);
    if(clicked&&clicked.owner===myRole){
      if(isShift){if(selectedUnitIds.has(clicked.id)){selectedUnitIds.delete(clicked.id);if(selectedUnitId===clicked.id)selectedUnitId=[...selectedUnitIds][0]||null;}else{selectedUnitIds.add(clicked.id);selectedUnitId=clicked.id;}}
      else{selectedUnitId=clicked.id;selectedUnitIds=new Set([clicked.id]);}
      const showU=G.units.find(u=>u.id===selectedUnitId);if(showU)showSelInfo(showU);updateSelectionHUD();
    }else{
      if(inputMode==='attack'&&clicked&&clicked.owner!==myRole){G.units.filter(u=>selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u=>{u.state='force_attack';u.forceTarget=clicked.id;u.attackTarget=clicked.id;});toast('üéØ –ê—Ç–∞–∫—É–≤–∞—Ç–∏');}
      else if(!isShift){selectedUnitId=null;selectedUnitIds=new Set();document.getElementById('selInfo').classList.remove('vis');updateSelectionHUD();}
    }
  }else{
    if(!selectedUnitIds.size&&selectedUnitId)selectedUnitIds=new Set([selectedUnitId]);
    if(!selectedUnitIds.size)return;
    const targetEnemy=G.units.find(u=>u.owner!==myRole&&!u._dead&&Math.hypot(u.x-wx,u.y-wy)<(UNIT_DEFS[u.type]?.radius||10)*1.5+8);
    if(targetEnemy){G.units.filter(u=>selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u=>{u.state='force_attack';u.forceTarget=targetEnemy.id;u.attackTarget=targetEnemy.id;});toast('üéØ –ê—Ç–∞–∫—É–≤–∞—Ç–∏: '+(UNIT_DEFS[targetEnemy.type]?.name||'—Ü—ñ–ª—å'));drawAll();return;}
    else if(inputMode==='patrol'){
      if(!patrolPoint1){patrolPoint1={x:wx,y:wy};toast('üìç –¢–æ—á–∫–∞ 1. –í–∫–∞–∂—ñ—Ç—å —Ç–æ—á–∫—É 2 –ü–ö–ú');}
      else{G.units.filter(u=>selectedUnitIds.has(u.id)&&u.owner===myRole).forEach(u=>{u.state='patrol';u.patrolA={x:patrolPoint1.x,y:patrolPoint1.y};u.patrolB={x:wx,y:wy};u.patrolDir=1;u.moveTarget={x:wx,y:wy};});patrolPoint1=null;toast('üîÑ –ü–∞—Ç—Ä—É–ª—å!');}
    }else{
      const myUnits=G.units.filter(u=>selectedUnitIds.has(u.id)&&u.owner===myRole);const n=myUnits.length;
      const angle=Math.atan2(wy-myUnits.reduce((s,u)=>s+u.y,0)/n,wx-myUnits.reduce((s,u)=>s+u.x,0)/n);const perp=angle+Math.PI/2;const spacing=28;
      myUnits.forEach((u,i)=>{const offset=(i-(n-1)/2)*spacing;u.moveTarget={x:wx+Math.cos(perp)*offset,y:wy+Math.sin(perp)*offset};u.state='moving';u.forceTarget=null;});
    }
  }
  drawAll();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADMIN USERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.loadAdminUsers=async()=>{
  const el=document.getElementById('adminUsersList');el.innerHTML='<div style="color:var(--dim);font-size:11px">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>';
  try{const snaps=await getDocs(collection(db,'users'));if(snaps.empty){el.innerHTML='<div style="color:var(--dim);font-size:11px">–ù–µ–º–∞—î –≥—Ä–∞–≤—Ü—ñ–≤</div>';return;}el.innerHTML=snaps.docs.map(d=>{const u=d.data();return`<div style="display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:6px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.06);"><span style="font-size:16px">${u.role==='admin'?'üëë':'üë§'}</span><div style="flex:1"><div style="font-size:12px;font-weight:700;color:#fff">${u.name||'‚Äî'}</div><div style="font-size:10px;color:var(--dim)">${u.email||'‚Äî'}</div></div><span style="font-size:10px;padding:2px 8px;border-radius:10px;${u.role==='admin'?'background:rgba(245,158,11,.15);color:var(--gold);border:1px solid rgba(245,158,11,.3)':'background:rgba(100,116,139,.1);color:var(--dim);border:1px solid rgba(100,116,139,.2)'}">${u.role||'player'}</span>${u.role!=='admin'?`<button class="amc-btn set" onclick="grantAdmin('${d.id}')">üëë –ê–¥–º—ñ–Ω</button>`:''}</div>`;}).join('');}
  catch(e){el.innerHTML='<div style="color:#f87171;font-size:11px">‚ùå '+e.message+'</div>';}
};
window.grantAdmin=async(userId)=>{if(!confirm('–ù–∞–¥–∞—Ç–∏ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞?'))return;await updateDoc(doc(db,'users',userId),{role:'admin'});toast('‚úÖ –ü—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω–∞ –Ω–∞–¥–∞–Ω–æ');loadAdminUsers();};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FIX #1: FRONT LINE ‚Äî –¥–µ—Ñ–æ—Ä–º—É—î—Ç—å—Å—è –∑–∞ –ø–æ–∑–∏—Ü—ñ—î—é —é–Ω—ñ—Ç—ñ–≤
//  –ê–ª–≥–æ—Ä–∏—Ç–º: –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ —é–Ω—ñ—Ç–∞ –°–ò–ù–Ü–• –∑–Ω–∞—Ö–æ–¥–∏–º–æ
//  –Ω–∞–π–±–ª–∏–∂—á–∏–π –ß–ï–†–í–û–ù–ò–ô —ñ –º–∞–ª—é—î–º–æ —Ç–æ—á–∫—É –ø–æ—Å–µ—Ä–µ–¥–∏–Ω—ñ –º—ñ–∂ –Ω–∏–º–∏.
//  –ü–æ—Ç—ñ–º –∑'—î–¥–Ω—É—î–º–æ —Ü—ñ —Ç–æ—á–∫–∏ –ø–ª–∞–≤–Ω–æ—é –ª—ñ–Ω—ñ—î—é.
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FIX: Front line ‚Äî grid-based, covers full map height, black, no glow
// At each Y slice we find the weighted midpoint between blue and red units
// Only considers nearby units (influence radius), so line only deforms where units actually are
function drawFrontLine(){
  if(!frontCtx||!CW||!CH)return;frontCtx.clearRect(0,0,CW,CH);
  if(gamePhase!=='battle')return;
  const bl=G.units?.filter(u=>u.owner==='blue'&&!u._dead);
  const rd=G.units?.filter(u=>u.owner==='red'&&!u._dead);
  if(!bl?.length||!rd?.length)return;

  const mW=mapBgW||2000,mH=mapBgH||1200;
  const STEPS=120; // number of horizontal slices = resolution of line
  const INFLUENCE=mW*0.35; // max distance a unit affects its Y slice
  const pts=[];

  // Global fallback X: weighted average of all blues vs reds
  const blMeanX=bl.reduce((s,u)=>s+u.x,0)/bl.length;
  const rdMeanX=rd.reduce((s,u)=>s+u.x,0)/rd.length;
  const globalMidX=(blMeanX+rdMeanX)/2;

  for(let i=0;i<=STEPS;i++){
    const y=mH*(i/STEPS);
    // For this Y-slice, gather influence from nearby blue and red units
    let bSum=0,bW=0,rSum=0,rW=0;
    for(const u of bl){
      const dy=Math.abs(u.y-y);if(dy>INFLUENCE)continue;
      const w=1-dy/INFLUENCE;bSum+=u.x*w;bW+=w;
    }
    for(const u of rd){
      const dy=Math.abs(u.y-y);if(dy>INFLUENCE)continue;
      const w=1-dy/INFLUENCE;rSum+=u.x*w;rW+=w;
    }
    let midX;
    if(bW>0&&rW>0){
      // Both sides have influence here ‚Äî real front
      midX=(bSum/bW+rSum/rW)/2;
    } else if(bW>0){
      // Only blue nearby ‚Äî line trends toward globalMidX
      const bX=bSum/bW;midX=(bX+globalMidX*2)/3;
    } else if(rW>0){
      // Only red nearby
      const rX=rSum/rW;midX=(rX+globalMidX*2)/3;
    } else {
      // No units nearby ‚Äî use global midpoint
      midX=globalMidX;
    }
    pts.push({x:midX,y});
  }

  // Light smoothing (preserve deformation but remove jitter)
  for(let pass=0;pass<4;pass++){
    for(let i=1;i<pts.length-1;i++){
      pts[i].x=(pts[i-1].x*0.25+pts[i].x*0.5+pts[i+1].x*0.25);
    }
  }

  frontCtx.save();frontCtx.translate(camX,camY);frontCtx.scale(camScale,camScale);

  // Draw black line only ‚Äî no glow, no shadow (FIX #4)
  const lw=Math.max(1.5,2.5/camScale);
  frontCtx.beginPath();
  frontCtx.moveTo(pts[0].x,pts[0].y);
  for(let i=1;i<pts.length-1;i++){
    const mx=(pts[i].x+pts[i+1].x)/2,my=(pts[i].y+pts[i+1].y)/2;
    frontCtx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
  }
  frontCtx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  frontCtx.strokeStyle='rgba(0,0,0,0.85)';
  frontCtx.lineWidth=lw;
  frontCtx.lineCap='round';frontCtx.lineJoin='round';
  frontCtx.shadowBlur=0;
  frontCtx.stroke();

  frontCtx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAW ENGINE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function drawAll(){drawMap();drawFrontLine();drawUnits();drawProjectilesLayer();drawUI();}
function drawMap(){
  if(!mapCtx||!CW||!CH)return;mapCtx.clearRect(0,0,CW,CH);mapCtx.fillStyle='#06090d';mapCtx.fillRect(0,0,CW,CH);
  mapCtx.save();mapCtx.translate(camX,camY);mapCtx.scale(camScale,camScale);
  const w=mapBgW||2000,h=mapBgH||1200;
  if(mapBg&&mapBgW>0){
    // Draw the photo ‚Äî it IS the map, no terrain overlays (terrain is already visual in the photo)
    mapCtx.drawImage(mapBg,0,0,w,h);
  }else{
    mapCtx.fillStyle='#141e0e';mapCtx.fillRect(0,0,w,h);
    for(let i=0;i<20;i++){mapCtx.fillStyle=`rgba(${20+Math.sin(i)*8},${40+Math.cos(i)*15},12,.7)`;mapCtx.beginPath();mapCtx.ellipse(w*(.05+.9*(i%10)/10),h*(.1+.8*Math.floor(i/10)/2),w*.07,h*.05,i*.4,0,Math.PI*2);mapCtx.fill();}
    const rg=mapCtx.createLinearGradient(w*.45,0,w*.55,0);rg.addColorStop(0,'rgba(30,64,175,.6)');rg.addColorStop(.5,'rgba(37,99,235,.7)');rg.addColorStop(1,'rgba(30,64,175,.6)');mapCtx.fillStyle=rg;mapCtx.beginPath();mapCtx.moveTo(w*.46,0);mapCtx.bezierCurveTo(w*.44,h*.25,w*.52,h*.5,w*.48,h*.75);mapCtx.lineTo(w*.48,h);mapCtx.lineTo(w*.54,h);mapCtx.bezierCurveTo(w*.56,h*.75,w*.48,h*.5,w*.52,h*.25);mapCtx.lineTo(w*.54,0);mapCtx.fill();
    // No map loaded ‚Äî generate placeholder
  }
  // Spawn zones ‚Äî highlight base and city radii when placing
  if(gamePhase==='placement'&&placingType){
    // Friendly base zone
    const base=G.bases?.[myRole];
    if(base){
      mapCtx.beginPath();mapCtx.arc(base.x,base.y,SPAWN_BASE_RADIUS,0,Math.PI*2);
      mapCtx.fillStyle='rgba(34,197,94,.12)';mapCtx.fill();
      mapCtx.strokeStyle='rgba(34,197,94,.5)';mapCtx.lineWidth=2;mapCtx.setLineDash([8,5]);mapCtx.stroke();mapCtx.setLineDash([]);
    }
    // City zones
    (G.cities||[]).filter(c=>c.owner===myRole||c.owner==='neutral').forEach(c=>{
      mapCtx.beginPath();mapCtx.arc(c.x,c.y,SPAWN_CITY_RADIUS,0,Math.PI*2);
      mapCtx.fillStyle='rgba(245,158,11,.1)';mapCtx.fill();
      mapCtx.strokeStyle='rgba(245,158,11,.45)';mapCtx.lineWidth=1.5;mapCtx.setLineDash([5,4]);mapCtx.stroke();mapCtx.setLineDash([]);
    });
  }
  // Bases
  if(G.bases){['blue','red'].forEach(team=>{const base=G.bases[team];if(!base)return;const color=team==='blue'?'rgba(59,130,246,.9)':'rgba(239,68,68,.9)';const pulse=.8+Math.sin(Date.now()*.003)*.2;mapCtx.beginPath();mapCtx.arc(base.x,base.y,24*pulse,0,Math.PI*2);mapCtx.fillStyle=team==='blue'?'rgba(59,130,246,.1)':'rgba(239,68,68,.1)';mapCtx.fill();mapCtx.strokeStyle=color;mapCtx.lineWidth=2.5;mapCtx.stroke();mapCtx.font='24px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';mapCtx.fillText(team==='blue'?'üè†':'üèöÔ∏è',base.x,base.y);mapCtx.font='bold 10px Oswald';mapCtx.fillStyle=team==='blue'?'#60a5fa':'#f87171';mapCtx.fillText('–ë–ê–ó–ê',base.x,base.y+22);});}
  // Cities
  if(G.cities){G.cities.forEach(city=>{const clr=city.owner==='blue'?'#3b82f6':city.owner==='red'?'#ef4444':'#94a3b8';const glowClr=city.owner==='blue'?'rgba(59,130,246,.3)':city.owner==='red'?'rgba(239,68,68,.3)':'rgba(148,163,184,.1)';mapCtx.beginPath();mapCtx.arc(city.x,city.y,28,0,Math.PI*2);mapCtx.fillStyle=glowClr;mapCtx.fill();mapCtx.font='22px serif';mapCtx.textAlign='center';mapCtx.textBaseline='middle';mapCtx.fillText('üèôÔ∏è',city.x,city.y);mapCtx.beginPath();mapCtx.arc(city.x,city.y,18,0,Math.PI*2);mapCtx.strokeStyle=clr;mapCtx.lineWidth=2.5;mapCtx.stroke();mapCtx.font='bold 9px Share Tech Mono';mapCtx.textAlign='center';mapCtx.textBaseline='top';mapCtx.fillStyle='rgba(255,255,255,.8)';mapCtx.fillText(city.name,city.x,city.y+20);const p=city.captureProgress;if(p){const bw=36,bh=4,bx=city.x-bw/2,by=city.y-28;mapCtx.fillStyle='rgba(0,0,0,.5)';mapCtx.fillRect(bx-1,by-1,bw+2,bh+2);mapCtx.fillStyle='#1a1a1a';mapCtx.fillRect(bx,by,bw,bh);if(p.blue>0){mapCtx.fillStyle='#3b82f6';mapCtx.fillRect(bx,by,bw*(p.blue/100),bh);}if(p.red>0){mapCtx.fillStyle='#ef4444';mapCtx.fillRect(bx+bw*(1-p.red/100),by,bw*(p.red/100),bh);}}if(city.owner!=='neutral'){mapCtx.fillStyle=city.owner==='blue'?'rgba(59,130,246,.8)':'rgba(239,68,68,.8)';mapCtx.font='bold 8px Oswald';mapCtx.textAlign='center';mapCtx.textBaseline='bottom';mapCtx.fillText('+'+city.income+'‚Ç¥',city.x,city.y-20);}});}
  mapCtx.restore();
}
// detectWaterAreas removed ‚Äî terrain is now pixel-based from editor canvas
function drawUnits(){
  if(!unitsCtx||!CW||!CH)return;unitsCtx.clearRect(0,0,CW,CH);if(!G.units?.length)return;
  const now=performance.now();unitsCtx.save();unitsCtx.translate(camX,camY);unitsCtx.scale(camScale,camScale);
  for(const u of G.units){if(u._dead)continue;const def=UNIT_DEFS[u.type]||UNIT_DEFS.infantry;const r=def.radius,isBlue=u.owner==='blue',isSel=selectedUnitIds.has(u.id)||u.id===selectedUnitId;const hp=u.hp/u.maxHp,isAtk=now-u.lastAttackAnim<250;
    if(isAtk){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r*2.5,0,Math.PI*2);unitsCtx.fillStyle=isBlue?'rgba(59,130,246,.15)':'rgba(239,68,68,.15)';unitsCtx.fill();}
    if(isSel){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r+6,0,Math.PI*2);unitsCtx.strokeStyle='rgba(255,255,255,.9)';unitsCtx.lineWidth=2/camScale;unitsCtx.stroke();}
    unitsCtx.beginPath();unitsCtx.arc(u.x+1.5,u.y+2.5,r,0,Math.PI*2);unitsCtx.fillStyle='rgba(0,0,0,.5)';unitsCtx.fill();
    unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,r,0,Math.PI*2);const g=unitsCtx.createRadialGradient(u.x-r*.3,u.y-r*.35,0,u.x,u.y,r);g.addColorStop(0,isBlue?'#93c5fd':'#fca5a5');g.addColorStop(1,isBlue?'#1d4ed8':'#b91c1c');unitsCtx.fillStyle=g;unitsCtx.fill();unitsCtx.strokeStyle=isBlue?'#3b82f6':'#ef4444';unitsCtx.lineWidth=1.5/camScale;unitsCtx.stroke();
    unitsCtx.font=`bold ${r*1.25}px serif`;unitsCtx.textAlign='center';unitsCtx.textBaseline='alphabetic';unitsCtx.fillText(def.emoji,u.x,u.y+r*.35);
    const bw=r*2.5,bh=Math.max(2,3/camScale),bx=u.x-bw/2,by=u.y-r-7/camScale;unitsCtx.fillStyle='rgba(0,0,0,.6)';unitsCtx.fillRect(bx-1,by-1,bw+2,bh+2);unitsCtx.fillStyle='#1a1a1a';unitsCtx.fillRect(bx,by,bw,bh);unitsCtx.fillStyle=hp>.6?'#22c55e':hp>.3?'#f59e0b':'#ef4444';unitsCtx.fillRect(bx,by,bw*hp,bh);
    if(u.attackTarget&&isAtk){const tgt=G.units.find(x=>x.id===u.attackTarget);if(tgt){unitsCtx.beginPath();unitsCtx.moveTo(u.x,u.y);unitsCtx.lineTo(tgt.x,tgt.y);unitsCtx.strokeStyle=isBlue?'rgba(96,165,250,.6)':'rgba(248,113,113,.6)';unitsCtx.lineWidth=1.5/camScale;unitsCtx.setLineDash([4/camScale,4/camScale]);unitsCtx.stroke();unitsCtx.setLineDash([]);}}
    if(isSel&&isBlue){const stateIco={advance:'‚öî',hold:'‚è∏',defend:'üõ°',moving:'‚û§',patrol:'üîÑ',force_attack:'üéØ',idle:'‚Äî'}[u.state]||'';if(stateIco){unitsCtx.font=`${r*.9}px serif`;unitsCtx.textAlign='center';unitsCtx.textBaseline='top';unitsCtx.fillText(stateIco,u.x,u.y+r+4/camScale);}}
    if(isSel&&def.isMissile){unitsCtx.beginPath();unitsCtx.arc(u.x,u.y,u.range,0,Math.PI*2);unitsCtx.strokeStyle='rgba(168,85,247,.25)';unitsCtx.lineWidth=1.5/camScale;unitsCtx.setLineDash([8/camScale,4/camScale]);unitsCtx.stroke();unitsCtx.setLineDash([]);}
  }
  unitsCtx.restore();
}
function drawProjectilesLayer(){
  if(!frontCtx||!projectiles.length)return;frontCtx.save();frontCtx.translate(camX,camY);frontCtx.scale(camScale,camScale);
  for(const p of projectiles){const cx=p.ox+(p.tx-p.ox)*p.progress,cy=p.oy+(p.ty-p.oy)*p.progress;if(p.trail.length>1){frontCtx.beginPath();frontCtx.moveTo(p.trail[0].x,p.trail[0].y);for(let i=1;i<p.trail.length;i++)frontCtx.lineTo(p.trail[i].x,p.trail[i].y);frontCtx.strokeStyle=p.owner==='blue'?'rgba(96,165,250,.5)':'rgba(248,113,113,.5)';frontCtx.lineWidth=2/camScale;frontCtx.lineCap='round';frontCtx.stroke();}
  frontCtx.beginPath();frontCtx.arc(cx,cy,5/camScale,0,Math.PI*2);frontCtx.fillStyle=p.owner==='blue'?'#60a5fa':'#f87171';frontCtx.shadowColor=p.owner==='blue'?'rgba(96,165,250,.9)':'rgba(248,113,113,.9)';frontCtx.shadowBlur=10/camScale;frontCtx.fill();frontCtx.shadowBlur=0;const ang=Math.atan2(p.ty-p.oy,p.tx-p.ox);frontCtx.save();frontCtx.translate(cx,cy);frontCtx.rotate(ang);frontCtx.font=`${12/camScale}px serif`;frontCtx.textAlign='center';frontCtx.textBaseline='middle';frontCtx.fillText('üöÄ',0,0);frontCtx.restore();}
  frontCtx.restore();
}
function drawUI(){
  if(!uiCtx||!CW||!CH)return;uiCtx.clearRect(0,0,CW,CH);if(!G.units)return;
  uiCtx.save();uiCtx.translate(camX,camY);uiCtx.scale(camScale,camScale);
  G.units.filter(u=>selectedUnitIds.has(u.id)&&u.moveTarget).forEach(u=>{const t=u.moveTarget;uiCtx.beginPath();uiCtx.arc(t.x,t.y,8/camScale,0,Math.PI*2);uiCtx.strokeStyle='rgba(34,197,94,.7)';uiCtx.lineWidth=1.5/camScale;uiCtx.stroke();uiCtx.beginPath();uiCtx.moveTo(u.x,u.y);uiCtx.lineTo(t.x,t.y);uiCtx.strokeStyle='rgba(34,197,94,.25)';uiCtx.lineWidth=1/camScale;uiCtx.setLineDash([6/camScale,4/camScale]);uiCtx.stroke();uiCtx.setLineDash([]);});
  G.units.filter(u=>u.state==='patrol'&&u.patrolA&&u.patrolB&&selectedUnitIds.has(u.id)).forEach(u=>{uiCtx.beginPath();uiCtx.moveTo(u.patrolA.x,u.patrolA.y);uiCtx.lineTo(u.patrolB.x,u.patrolB.y);uiCtx.strokeStyle='rgba(168,85,247,.5)';uiCtx.lineWidth=1.5/camScale;uiCtx.setLineDash([8/camScale,4/camScale]);uiCtx.stroke();uiCtx.setLineDash([]);[u.patrolA,u.patrolB].forEach(pt=>{uiCtx.beginPath();uiCtx.arc(pt.x,pt.y,7/camScale,0,Math.PI*2);uiCtx.fillStyle='rgba(168,85,247,.3)';uiCtx.fill();uiCtx.strokeStyle='rgba(168,85,247,.8)';uiCtx.lineWidth=1.5/camScale;uiCtx.stroke();});});
  G.units.filter(u=>u.state==='defend'&&u.defendX!==undefined&&selectedUnitIds.has(u.id)).forEach(u=>{uiCtx.beginPath();uiCtx.arc(u.defendX,u.defendY,u.range*.8,0,Math.PI*2);uiCtx.strokeStyle='rgba(59,130,246,.3)';uiCtx.lineWidth=1.5/camScale;uiCtx.setLineDash([5/camScale,5/camScale]);uiCtx.stroke();uiCtx.setLineDash([]);});
  uiCtx.restore();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateHUD(){if(!G.units)return;document.getElementById('hudBlueUnits').textContent=G.units.filter(u=>u.owner==='blue'&&!u._dead).length;document.getElementById('hudRedUnits').textContent=G.units.filter(u=>u.owner==='red'&&!u._dead).length;document.getElementById('hudWave').textContent=G.wave||1;document.getElementById('hudFunds').textContent=G.funds?.[myRole]||0;document.getElementById('spFunds').textContent=G.funds?.[myRole]||0;document.getElementById('spIncome').textContent='+'+getIncome(myRole)+'/15—Å';document.getElementById('spUnits').textContent=G.units.filter(u=>u.owner===myRole&&!u._dead).length;document.getElementById('spCasualties').textContent=G.casualties?.[myRole]||0;document.getElementById('casBlue').textContent=G.casualties?.blue||0;document.getElementById('casRed').textContent=G.casualties?.red||0;}
function showSelInfo(u){const def=UNIT_DEFS[u.type];document.getElementById('selInfo').classList.add('vis');document.getElementById('siName').textContent=def.emoji+' '+def.name;document.getElementById('siHPText').textContent=Math.round(u.hp)+'/'+u.maxHp;document.getElementById('siHPBar').style.width=(u.hp/u.maxHp*100)+'%';document.getElementById('siHPBar').style.background=u.hp/u.maxHp>.5?'var(--green)':u.hp/u.maxHp>.25?'var(--gold)':'var(--red)';document.getElementById('siAtk').textContent=u.atk;document.getElementById('siDef').textContent=u.def;document.getElementById('siSpd').textContent=u.speed;const me=document.getElementById('siMode');if(me){if(u.type==='stinger'){const now=performance.now();const cd=u.lastMissile?Math.max(0,Math.ceil((60000-(now-u.lastMissile))/1000)):0;me.textContent=cd>0?('‚è≥ '+cd+'—Å'):('üöÄ –ì–û–¢–û–í–û');me.style.color=cd>0?'var(--gold)':'#a855f7';}else{const l={advance:'‚öî –ê–¢–ö',hold:'‚è∏ –°–¢–û–ü',defend:'üõ° –û–ë',moving:'‚û§ –†–£–•',patrol:'üîÑ –ü–ê–¢',force_attack:'üéØ –¶–Ü–õ–¨',idle:'‚Äî –°–¢–Ü–ô',front:'‚öî –§–†–û–ù–¢'};me.textContent=l[u.state]||u.state;me.style.color='';}}}
function addLog(msg,type='info'){const el=document.getElementById('spLog');const d=document.createElement('div');d.className='log-entry '+type;d.textContent=msg;el.appendChild(d);el.scrollTop=el.scrollHeight;if(el.children.length>80)el.removeChild(el.firstChild);}
window.toast=(msg,dur=2500)=>{const t=document.getElementById('toast');t.textContent=msg;t.style.display='block';clearTimeout(t._t);t._t=setTimeout(()=>t.style.display='none',dur);};

requestAnimationFrame(function loop(){drawAll();requestAnimationFrame(loop);});
</script>
</body>
</html>
